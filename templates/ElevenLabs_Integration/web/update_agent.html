{% extends 'Web/base.html' %}

{% block content %}
    <div class="wrapper">
        {% include 'Web/sidebar.html' %}

        <!-- Page Content  -->
        <div id="content" class="page_content position-relative">
            <button type="button"
                        class="sidebarCollapse mobile_hamburger_btn hamburger_btn bg-transparent border-0 position-absolute ms-2">
                        <img src="{{ host }}/static/Web/images/hamburger-icon.svg" class="img-fluid">
                    </button>
            <div class="agent_data_outer d-flex align-items-center gap-3 justify-content-between">
                <div class="d-flex align-items-center gap-3 w-100">
                    <a href="{{ host }}/dashboard" class="page_back_arrow d-flex align-items-center justify-content-center"><img
                            src="{{ host }}/static/Web/images/left-arrow.svg" class="img-fluid"></a>
                    <div class="">
                        <h3 id="agent-name" class="mb-0 d-flex gap-1">{% if agent %}{{ agent.agent_name }}{% else %}Agent{% endif %}
                            <span onclick="editHeading()" class="edit-heading-icon">
                                <img src="{{ host }}/static/Web/images/pencil-icon.svg" style="cursor: pointer;">
                            </span>
                        </h3>
                    </div>
                </div>
                {% if not agent %}
                <div>
                    <button type="button" class="help-ai-btn" data-bs-toggle="modal" data-bs-target="#helpAiModal">
                       <span><img src="{{ host }}/static/Web/images/btn-star-icon.svg" class="img-fluid"> Help from AI</span>
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="agent_type_box">
                <div class="agent_type_dropdown d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <div class="agent_select_box position-relative">
                            <select class="form-select" id="selected-model" onchange="updateAgentSetting('selected_llm_model_id', this.value)">
                                {% for llm_model in llm_models %}
                                    <option value="{{ llm_model.id }}" 
                                        {% if agent and agent.selected_model == llm_model.id %}selected{% endif %}>
                                        {{ llm_model.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="agent_type_select_icon">
                                <img src="{{ host }}/static/Web/images/ai-icon.svg" class="img-fluid">
                            </div>
                            <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer" onclick="openDialog()">
                                <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                            </div>
                        </div>
                        <div class="agent_select_box position-relative">
                            <select class="form-select" id="selected-voice" onchange="updateAgentSetting('selected_voice_id', this.value)">
                                {% for voice in voices %}
                                    <option value="{{ voice.id }}" 
                                        {% if agent and agent.selected_voice == voice.id %}selected{% endif %}>
                                        {{ voice.voice_name }}
                                    </option>
                                {% endfor %}
                            </select>                            
                            <div class="agent_type_select_icon">
                                <img src="{{ host }}/static/Web/images/jack-img.svg" class="img-fluid">
                            </div>
                            <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer">
                                <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                            </div>
                        </div>
                        <div class="agent_select_box position-relative">
                            <select class="form-select" id = "selected-language" onchange="updateAgentSetting('selected_language_code', this.value)">
                                {% for language in allowed_languages %}
                                    <option value="{{ language.code }}" 
                                        {% if agent and agent.selected_language == language.code %}selected{% endif %}>
                                        {{ language.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="agent_type_select_icon">
                                <img src="{{ host }}/static/Web/images/lang-icon.svg" class="img-fluid">
                            </div>
                            <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer">
                                <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                            </div>
                        </div>
                        <div class="agent_select_box position-relative">
                            <select name="knowledge_base" id="selected-knowledge-base" class="form-select" onchange="updateKnowledgeBase(this.value)">
                                    <option value="" disabled {% if not selected_knowledge %}selected{% endif %}>
                                        Select Knowledge Base
                                    </option>
                                    {% for knowledge_base in knowledge_bases %}
                                        <option value="{{ knowledge_base.id }}"
                                            {% if selected_knowledge and selected_knowledge.id == knowledge_base.id %}selected{% endif %}>
                                            {{ knowledge_base.knowledge_base_name }}
                                        </option>
                                    {% endfor %}
                                    {% if selected_knowledge and selected_knowledge.id == "elevenlabs_virtual" %}
                                        <option value="elevenlabs_virtual" selected>
                                            {{ selected_knowledge.knowledge_base_name }}
                                        </option>
                                    {% endif %}
                            </select>
                            <script>
                                function updateKnowledgeBase(knowledgeBaseId) {
                                    const currentUrl = new URL(window.location.href);
                                    const agentId = currentUrl.searchParams.get("agent_id");
                                    
                                    // Handle virtual knowledge base case
                                    if (knowledgeBaseId === "elevenlabs_virtual") {
                                        toastr.info("This knowledge base is managed directly in ElevenLabs and cannot be changed from here");
                                        return;
                                    }
                                    
                                    fetch(`${host}/elevenlabs/api/v1/attach-knowledge-base`, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRFToken": getCSRFToken()
                                        },
                                        body: JSON.stringify({
                                            agent_id: agentId,
                                            knowledge_base_id: knowledgeBaseId
                                        })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if(data.status === "success") {
                                            toastr.success("Knowledge base updated successfully");
                                        } else {
                                            toastr.error("Failed to update knowledge base");
                                        }
                                    })
                                    .catch(error => {
                                        console.error("Error:", error);
                                        toastr.error("Something went wrong!");
                                    });
                                }
                            </script>
                            <div class="agent_type_select_icon">
                                <img src="{{ host }}/static/Web/images/jack-img.svg" class="img-fluid">
                            </div>
                            <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer">
                                <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                            </div>
                        </div>
                    </div>
                 
                    {% if request.url.path == '/elevenlabs/web/v1/update_agent' %}                    
                    <div class="agent_select_box position-relative d-flex align-items-center gap-2">
                        <div class="functions_dropdown">
                            <div class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="outside">Functions</a>
                                <ul class="dropdown-menu dropdown-menu-end shadow mt-2 dropbottom">
                                    <div id="function-list">
                                    {% for function in custom_functions %}
                                    <li class="dropdown-item gap-3 d-flex align-items-center justify-content-between mb-2" id="function-{{ function.id }}">
                                        <div class="functionNameDivBlock">{{ function.tool_name }}</div>
                                        <div class="d-flex align-items-center gap-2">
                                            <button class="edit-function-btn bg-transparent border-0 p-0" onclick="editFunction(`{{ function.id }}`)"><img src="{{ host }}/static/Web/images/edit-icon.svg" class="img-fluid"></button>   
                                            <button class="delete-function-btn bg-transparent border-0 p-0" onclick="deleteFunction(`{{ function.id }}`)"><img src="{{ host }}/static/Web/images/black-dlt-icon.svg" class="img-fluid"></button>
                                        </div>
                                    </li>
                                    {% endfor %}
                                    </div>
                                    <li class="">
                                        <a href="#" class="dropdown-item dropdown-toggle text-start" data-bs-toggle="dropdown">+ Add</a>
                                        <ul class="dropdown-menu shadow mt-2">
                                            <!-- <li class="mb-2">
                                                <a class="dropdown-item d-flex align-items-center gap-2" href=""><span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-telephone-x" viewBox="0 0 16 16">
                                                <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"/>
                                                <path fill-rule="evenodd" d="M11.146 1.646a.5.5 0 0 1 .708 0L13 2.793l1.146-1.147a.5.5 0 0 1 .708.708L13.707 3.5l1.147 1.146a.5.5 0 0 1-.708.708L13 4.207l-1.146 1.147a.5.5 0 0 1-.708-.708L12.293 3.5l-1.147-1.146a.5.5 0 0 1 0-.708"/>
                                                </svg></span> End Call</a>
                                            </li> -->
                                            <li>
                                                <a class="dropdown-item d-flex align-items-center gap-2" href="" data-bs-toggle="modal" data-bs-target="#customFuntionModal"> 
                                                <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4.33337 14.6667V10" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4.33337 3.33398V1.33398" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11.6666 14.666V12.666" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11.6666 6.00065V1.33398" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6.33337 4.66732V8.66732C6.33337 9.40065 6.00004 10.0007 5.00004 10.0007H3.66671C2.66671 10.0007 2.33337 9.40065 2.33337 8.66732V4.66732C2.33337 3.93398 2.66671 3.33398 3.66671 3.33398H5.00004C6.00004 3.33398 6.33337 3.93398 6.33337 4.66732Z" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M13.6666 7.33333V11.3333C13.6666 12.0667 13.3333 12.6667 12.3333 12.6667H11C9.99996 12.6667 9.66663 12.0667 9.66663 11.3333V7.33333C9.66663 6.6 9.99996 6 11 6H12.3333C13.3333 6 13.6666 6.6 13.6666 7.33333Z" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                                </span>
                                                Custom Function</a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="position-relative">
                            <button class="variable-btn" onclick="toggleVariableModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-braces" viewBox="0 0 16 16">
                                    <path d="M2.114 8.063V7.9c1.005-.102 1.497-.615 1.497-1.6V4.503c0-1.094.39-1.538 1.354-1.538h.273V2h-.376C3.25 2 2.49 2.759 2.49 4.352v1.524c0 1.094-.376 1.456-1.49 1.456v1.299c1.114 0 1.49.362 1.49 1.456v1.524c0 1.593.759 2.352 2.372 2.352h.376v-.964h-.273c-.964 0-1.354-.444-1.354-1.538V9.663c0-.984-.492-1.497-1.497-1.6M13.886 7.9v.163c-1.005.103-1.497.616-1.497 1.6v1.798c0 1.094-.39 1.538-1.354 1.538h-.273v.964h.376c1.613 0 2.372-.759 2.372-2.352v-1.524c0-1.094.376-1.456 1.49-1.456V7.332c-1.114 0-1.49-.362-1.49-1.456V4.352C13.51 2.759 12.75 2 11.138 2h-.376v.964h.273c.964 0 1.354.444 1.354 1.538V6.3c0 .984.492 1.497 1.497 1.6"/>
                                </svg>
                            </button>
                            <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer">
                                <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                            </div>
                            <div class="variable-modal" id="variable-modal" style="display: none;">
                                <div class="variable-modal-content">
                                    <h6 class="border-bottom pb-2">Dynamic Variables</h6>
                                    <div>
                                        <small class="text-muted">Set dynamic variables for dashboard audio and llm tests</small>
                                        <div class="mt-3 border-bottom pb-2 variable-modal-content-item-outer">
                                            <div class="variable-modal-content-item mb-2">
                                                <h5 class="mb-0">Variable Name</h5>
                                                <h5 class="mb-0">Test Value</h5>
                                            </div>
                                                <div id="dynamic-variables">
                                                    {% for key, value in dynamic_variables.items() %}
                                                        <div class="variable-modal-content-item mb-2">
                                                            <input type="text" class="form-control" value="{{ key }}">
                                                            <input type="text" class="form-control" value="{{ value }}">
                                                            <button class="dlt_btn bg-transparent border-0 p-0" onclick="removeVariable(this)">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                                            </button>   
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            <div>
                                                <button class="add-variable-btn"  onclick="addNewVariable()">+ Add</button>
                                            </div>
                                        </div>
                                        <div class="variable-modal-footer d-flex align-items-center gap-2 justify-content-end pt-2">
                                            <button class="cancel-btn"  onclick="toggleVariableModal()" >Cancel</button>
                                            <button class="save-btn" onclick="saveVariable()">Save</button>
                                        </div>
                                     </div>
                                </div>
                            </div>
                        </div>
                        <a href="{{ url_for('call_history') }}?agent_id={{ agent.id }}">
                            <div class="w-max-content view-call-history-btn d-flex align-items-center gap-2" id="create-agent-btn">
                                <img src="{{ host }}/static/Web/images/call-history.svg" class="img-fluid">
                            </div>
                        </a>
                        <div class="position-relative">
                            <div class="w-max-content view-call-history-btn d-flex align-items-center gap-2" id="token-settings-btn" onclick="toggleTokenModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-sliders" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1z"/>
                                </svg>
                            </div>
                            <div class="variable-modal" id="token-modal" style="display: none;">
                                <div class="variable-modal-content">
                                    <h6 class="border-bottom pb-2">Token Settings</h6>
                                    <div class="mt-3">
                                        <div class="mb-3">
                                            <label class="form-label">Overall Token Limit</label>
                                            <input type="number" class="form-control" id="overall-token-limit" value="{{ overall_token_limit }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Daily Token Limit</label>
                                            <input type="number" class="form-control" id="daily-token-limit" value="{{ daily_call_limit }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Per Call Token Limit</label>
                                            <input type="number" class="form-control" id="per-call-token-limit" value="{{ per_call_token_limit }}" required>
                                        </div>
                                        <div class="variable-modal-footer d-flex align-items-center gap-2 justify-content-end pt-2">
                                            <button class="cancel-btn" onclick="toggleTokenModal()">Cancel</button>
                                            <button class="save-btn" onclick="saveTokenSettings()">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="agent_type_box_inner">
                    <div class="agent_type_textarea">
                        <textarea class="form-control" id="agent-prompt" placeholder="Enter your prompt here....">{% if agent %}{{ agent.agent_prompt }}{% endif %}</textarea>
                        <div class="agent_type_textarea_footer pt-1">
                            <small style="font-size:12px;" class="text-muted">Use <span>&#123;&#123;_&#125;&#125;</span> to add variables. (Learn more)</small>
                        </div>
                    </div>
                    {% if agent %}
                    <div class="row align-items-end">
                        <div class="col-md-8 mt-4">
                            <label class="form-label">Your Agent Script</label>
                            <div class="copy_link_box d-flex align-items-center justify-content-between mx-auto">
                                <textarea class="copy_link_text" id="agent-script" disabled readonly></textarea>
                                <script>
                                    document.addEventListener("DOMContentLoaded", function() {
                                        const agentId = "{{ agent.dynamic_id }}";
                                        const origin = window.location.origin;
                                        const scriptTag = `<script src="${origin}/chatbot-script.js/${agentId}"><\/script>`;
                                        document.getElementById("agent-script").value = scriptTag;
                                    })
                                </script>
                                <button class="copy_link_btn border-0 bg-transparent position-relative" id="copy-link-btn" onclick="copyScript()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
                                </svg>
                                <div class="tooltip_text">Copy</div>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2 mt-4 position-relative">
                            <div class="d-flex align-items-center gap-2 justify-content-center">
                                <button class="customize-bot-btn position-relative" id="customize-bot-btn" onclick="toggleCustomizeModal()">
                                    <img src="{{ host }}/static/Web/images/icon-bot-img.png" class="img-fluid" width="30" height="30">
                                    <div class="customize-bot-btn-tooltip">Customize Your Bot</div>
                                </button>
                                <a href="/elevenlabs/preview/v1/preview_agent?agent_id={{ agent.dynamic_id }}" target="_blank">
                                    <button class="customize-bot-btn position-relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="#0c7fda" class="bi bi-eye-fill" viewBox="0 0 16 16">
                                        <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
                                        <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/>
                                        </svg>
                                        <div class="customize-bot-btn-tooltip">Preview Agent</div>
                                    </button>
                                </a>
                            </div>
                            <div class="customize-bot-modal" id="customize-bot-modal" style="display: none;">
                                <div class="recorder-controls show">
                                    <div class="settings">
                                        <div class="icon" onclick="toggleColorPalette()">
                                           <i class="fa-solid fa-gear"></i>
                                        </div>
                                        <div id="colorPalette" class="color-palette">
                                            <div class="color-box d-flex align-items-center gap-2 flex-wrap">
                                                <div class="color-option" style="background: linear-gradient(45deg, #00b4d8, #0077b6);" onclick="changeTheme('#00b4d8', '#0077b6', 'rgba(0, 180, 216, 0.3)')"></div>
                                                <div class="color-option" style="background: linear-gradient(45deg, #e63946, #9d0208);" onclick="changeTheme('#e63946', '#9d0208', 'rgba(230, 57, 70, 0.3)')"></div>
                                                <div class="color-option" style="background: linear-gradient(45deg, #8338ec, #5e60ce);" onclick="changeTheme('#8338ec', '#5e60ce', 'rgba(131, 56, 236, 0.3)')"></div>
                                                <div class="color-option" style="background: linear-gradient(45deg, #06d6a0, #118ab2);" onclick="changeTheme('#06d6a0', '#118ab2', 'rgba(6, 214, 160, 0.3)')"></div>
                                                <div class="color-option" style="background: linear-gradient(45deg, #fb8500, #ffb703);" onclick="changeTheme('#fb8500', '#ffb703', 'rgba(251, 133, 0, 0.3)')"></div>
                                                <div class="color-option" style="background: linear-gradient(45deg, #ff5a5f, #c1839f);" onclick="changeTheme('#ff5a5f', '#c1839f', 'rgba(255, 90, 95, 0.3)')"></div>
                                                <div class="color-option" style="background: linear-gradient(45deg, #2ec4b6, #20a4f3);" onclick="changeTheme('#2ec4b6', '#20a4f3', 'rgba(46, 196, 182, 0.3)')"></div>
                                                <div class="color-option" style="background: linear-gradient(45deg, #7209b7, #4361ee);" onclick="changeTheme('#7209b7', '#4361ee', 'rgba(114, 9, 183, 0.3)')"></div>
                                            </div>
                                            <div class="mt-3">
                                                <h6>Choose Icons</h6>
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <div class="icon-option active" onclick="changeIcon('{{ host }}/static/Web/images/gif-icon-1.gif', this)">
                                                    <img src="{{ host }}/static/Web/images/gif-icon-1.gif" class="img-fluid">
                                                    </div>
                                                    <div class="icon-option" onclick="changeIcon('{{ host }}/static/Web/images/gif-icon2.gif', this)">
                                                    <img src="{{ host }}/static/Web/images/gif-icon2.gif" class="img-fluid">
                                                    </div>
                                                    <div class="icon-option" onclick="changeIcon('{{ host }}/static/Web/images/gif-icon-3.gif', this)">
                                                    <img src="{{ host }}/static/Web/images/gif-icon-3.gif" class="img-fluid">
                                                    </div>
                                                    <div class="icon-option" onclick="changeIcon('{{ host }}/static/Web/images/gif-icon-4.gif', this)">
                                                    <img src="{{ host }}/static/Web/images/gif-icon-4.gif" class="img-fluid">
                                                    </div>
                                                    <div class="icon-option" onclick="changeIcon('{{ host }}/static/Web/images/gif-icon-5.gif', this)">
                                                        <img src="{{ host }}/static/Web/images/gif-icon-5.gif" class="img-fluid">
                                                    </div>
                                                </div>
                                                </div>
                                            </div>
                                        </div> 
                                     <h1>connect with me</h1>
                                    <div class="status-indicator">
                                       <img src="{{ host }}/static/Web/images/wave.gif" alt="voice_icon">
                                    </div>
                                    <button onclick="saveChanges()">Save Changes</button>
                                </div>
                            </div>
                            <script>
                                function toggleCustomizeModal() {
                                    const modal = document.getElementById('customize-bot-modal');
                                    if(modal.style.display === 'none') {
                                        modal.style.display = 'block';
                                    } else {
                                        modal.style.display = 'none';
                                    }
                                }
                            </script>
                        </div>
                        <!-- <div class="col-md-2">
                            <label class="form-label">Enable Design</label>
                            <div class="form-check form-switch d-flex align-items-center gap-2 ps-0">
                                <label class="form-label mb-0">Off</label>
                                <input class="form-check-input float-none ms-0" type="checkbox" role="switch" id="flexSwitchCheckChecked"  {% if agent.is_design_enabled %} checked {% endif %} onchange="toggleDesign(this.checked)">
                                <label class="form-label mb-0">On</label>
                            </div>
                        </div> -->
                        <script>
                            async function toggleDesign(isEnabled) {
                                try {
                                    const response = await fetch("{{ host }}/api/toggle-design", {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            agent_id: '{{ agent.id }}',
                                            is_enabled: isEnabled
                                        })
                                    });
                                    const data = await response.json();
                                    if (data.status === 'success') {
                                        toastr.success("Design toggle updated successfully");
                                    } else {
                                        toastr.error("Failed to update design toggle");
                                    }
                                } catch (error) {
                                    toastr.error("Error updating design toggle:", error);
                                }
                            }
                        </script>
                    </div>
                    {% endif %}
                    <div class="wlcm_msg_box pt-4">
                        <label class="form-label">Welcome Message</label>
                        <div class="custom-select">
                            <div class="select-box position-relative" id="welcome-msg">
                                {% if agent %}{{ agent.welcome_msg }}{% else %}Hi, how are you?{% endif %}
                            </div>
                            <input type="text" id="welcome-message" class="form-control mt-2" placeholder="Enter custom welcome message..." style="display: none;">
                            <div class="options">
                                <div class="option" data-value="custom">Add Custom Message</div>
                                <div class="option" data-value="1">Hi, I am SAGE, how can I help you?</div>
                                <div class="option" data-value="2">Hey there, Captain! How can I help you?</div>
                                <div class="option" data-value="3">Hi there, I am Jack Sparrow, how can I help you?</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dynamic Variables Section -->
                    <div class="dynamic_variables_box pt-4" id="dynamic-variables-section" style="display: none;">
                        <label class="form-label">Dynamic Variables</label>
                        <small class="text-muted d-block mb-2">Variables found in your prompt template. Set values to customize responses.</small>
                        <div id="dynamic-variables">
                            <!-- Variables will be populated dynamically -->
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewVariable()">
                                <i class="fas fa-plus"></i> Add Variable
                            </button>
                        </div>
                    </div>
                    
                    </div>
                    {% if not agent %}
                    <div class="save_btn_box mt-3 text-center">
                        <button type="button" class="save_btn" id="save-btn">
                            Save
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" tabindex="-1" aria-hidden="true" id="noise-settings-modal" style="display: none;">
        <div class="modal-dialog modal-dialog-centered" style="max-width:650px;">
            <div class="variable-modal-content modal-content">
                <h6 class="border-bottom p-3">Noise Settings</h6>
                <div class="px-3">
                    <small class="text-muted">Set noise settings variables for audio.</small>
                    <div class="mt-3 border-bottom pb-2 variable-modal-content-item-outer">
                        <div class="variable-modal-content-item mb-2">
                            <h5 class="mb-0">Variable Name</h5>
                            <h5 class="mb-0">Assigned Value</h5>
                            <h5 class="mb-0">Reset</h5>
                        </div>
                        <div id="noise-settings">
                        <!--Populated dynamically from API response-->
                        </div>
                    </div>
                    <div class="variable-modal-footer d-flex align-items-center gap-2 justify-content-end p-3">
                        <button class="cancel-btn" onclick="closeNoiseVariableModal()">Cancel</button>
                        <button class="save-btn" onclick="saveNoiseVariabless()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div> 
<!--Custom Function Modal - ElevenLabs Webhook Tool Config Format -->
<div class="modal fade custom_function_modal" id="customFuntionModal" tabindex="-1" aria-labelledby="customFuntionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="mb-0 d-flex align-items-center gap-2" id="customFuntionModalLabel">
        <span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4.33337 14.6667V10" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4.33337 3.33398V1.33398" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11.6666 14.666V12.666" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11.6666 6.00065V1.33398" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6.33337 4.66732V8.66732C6.33337 9.40065 6.00004 10.0007 5.00004 10.0007H3.66671C2.66671 10.0007 2.33337 9.40065 2.33337 8.66732V4.66732C2.33337 3.93398 2.66671 3.33398 3.66671 3.33398H5.00004C6.00004 3.33398 6.33337 3.93398 6.33337 4.66732Z" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M13.6666 7.33333V11.3333C13.6666 12.0667 13.3333 12.6667 12.3333 12.6667H11C9.99996 12.6667 9.66663 12.0667 9.66663 11.3333V7.33333C9.66663 6.6 9.99996 6 11 6H12.3333C13.3333 6 13.6666 6.6 13.6666 7.33333Z" stroke="#525866" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        </span>Webhook Tool</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
            <!-- Basic Tool Information -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Tool Configuration</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
            <div class="form_field mb-3">
                                <label for="tool_name" class="form-label">Tool Name *</label>
                                <input type="text" class="form-control" id="tool_name" placeholder="my_webhook_tool"  required>
                                <small class="text-muted">Only letters, numbers, underscores, and hyphens. Max 64 characters.</small>
            </div>
                        </div>
                        <div class="col-md-6">
            <div class="form_field mb-3">
                                <label for="response_timeout" class="form-label">Response Timeout (seconds)</label>
                                <input type="number" class="form-control" id="response_timeout" placeholder="20" value="20" min="5" max="120">
                                <small class="text-muted">Between 5-120 seconds</small>
            </div>
                        </div>
                    </div>
                    
            <div class="form_field mb-3">
                        <label for="tool_description" class="form-label">Description *</label>
                        <textarea class="form-control" id="tool_description" placeholder="Describe what this webhook tool does" rows="2" required></textarea>
            </div>
                </div>
            </div>

            <!-- API Schema Configuration -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">API Schema</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
            <div class="form_field mb-3">
                                <label for="api_url" class="form-label">Webhook URL *</label>
                                <input type="url" class="form-control" id="api_url" placeholder="https://api.example.com/agents/{agent_id}" required>
                                <small class="text-muted">May include path parameters like {agent_id}</small>
                </div>
            </div>
                        <div class="col-md-4">
                            <div class="form_field mb-3">
                                <label for="http_method" class="form-label">HTTP Method</label>
                                <select class="form-select" id="http_method">
                                    <option value="GET">GET</option>
                                    <option value="POST" selected>POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="PATCH">PATCH</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                </div>
            </div>
                    </div>
                </div>
            </div>

            <!-- Path Parameters -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Path Parameters</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPathParam()">+ Add Path Parameter</button>
                </div>
                <div class="card-body">
                    <small class="text-muted mb-3 d-block">Add path wrapped in curly braces to the URL to configure them here.</small>
                    <div id="path_params_help" class="alert alert-info mb-3" style="display: none;">
                        <small><strong>Example:</strong> Add <code>{agent_id}</code> to your URL like: <code>https://api.example.com/agents/{agent_id}</code></small>
                    </div>
                    <div id="path_params_container">
                        <!-- Path parameters will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Query Parameters -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Query Parameters</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addQueryParam()">+ Add Query Parameter</button>
                </div>
                <div class="card-body">
                    <small class="text-muted mb-3 d-block">Parameters that will be added to the URL as query params (?param=value)</small>
                    <div id="query_params_container">
                        <!-- Query parameters will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Request Body Schema -->
            <div class="card mb-3" id="request_body_schema_section" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Request Body Schema</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRequestBodyProperty()">+ Add Property</button>
                </div>
                <div class="card-body">
                    <small class="text-muted mb-3 d-block">Define the JSON structure for POST/PUT/PATCH requests</small>
                    <div class="form_field mb-3">
                        <label for="body_description" class="form-label">Body Description</label>
                        <input type="text" class="form-control" id="body_description" placeholder="Description of the request body">
                    </div>
                    <div id="request_body_properties_container">
                        <!-- Request body properties will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Request Headers -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Request Headers</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRequestHeader()">+ Add Header</button>
                </div>
                <div class="card-body">
                    <small class="text-muted mb-3 d-block">Headers to include in the webhook request</small>
                    <div id="request_headers_container">
                        <!-- Request headers will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Dynamic Variables -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Dynamic Variables</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addDynamicVariable()">+ Add Variable</button>
                </div>
                <div class="card-body">
                    <small class="text-muted mb-3 d-block">Variables that can be used in the webhook configuration</small>
                    <div id="dynamic_variables_container">
                        <!-- Dynamic variables will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Response Assignments -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Response Assignments</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addAssignment()">+ Add Assignment</button>
                </div>
                <div class="card-body">
                    <small class="text-muted mb-3 d-block">Extract values from webhook response and assign to dynamic variables</small>
                    <div id="assignments_container">
                        <!-- Assignments will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Advanced Options</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="disable_interruptions">
                                <label class="form-check-label" for="disable_interruptions">
                                    Disable Interruptions
                                </label>
                                <small class="text-muted d-block">User cannot interrupt while tool is running</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="force_pre_tool_speech">
                                <label class="form-check-label" for="force_pre_tool_speech">
                                    Force Pre-Tool Speech
                                </label>
                                <small class="text-muted d-block">Agent speaks before calling the tool</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form_field mb-3 parameters_field">
                <label for="parameters" class="form-label mb-0">Parameters (Optional)</label>
                <small class="text-muted">JSON schema that defines the format in which the LLM will return. Please refer to the docs.</small>
                <textarea class="form-control my-2" id="parameters" placeholder="Enter function parameters">{
  "tool_config": {
    "name": "",
    "type": "webhook",
    "api_schema": {
      "url": "",
      "method": "POST",
      "auth_connection": null,
      "request_headers": {},
      "path_params_schema": {},
      "query_params_schema": null,
      "request_body_schema": {
        "type": "object",
        "properties": {}
      }
    },
    "assignments": [],
    "description": "",
    "dynamic_variables": {
      "dynamic_variable_placeholders": {}
    },
    "disable_interruptions": false,
    "force_pre_tool_speech": false,
    "response_timeout_secs": 20
  }
}</textarea>

            </div>
            <div class="format_json_btn_box mb-3">
                <button type="button" onclick="formatJSON()" class="w-100">Format JSON</button>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
        <button type="button" id="save-custom-function" class="btn save_btn">Create Webhook Tool</button>
      </div>
    </div>
  </div>
</div>
    <!-- Modal -->
<div class="modal fade help-ai-modal" id="helpAiModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="helpAiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="d-flex align-items-center gap-3 mb-0"><span><img src="{{ url_for('static', path='/Web/images/eos-icons_ai.svg') }}" class="img-fluid"></span> Prompt Generator</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" id="close-help-ai-modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div class="help_ai_modal_slider">
            <div class="help_ai_modal_slider_item">
                <h4>What is the primary function of your AI agent?</h4>
                <div>
                    <select class="form-select" id="agent-function">
                        <option value="Answering questions" selected>Answering questions</option>
                        <option value="Providing information">Providing information</option>
                        <option value="Assisting with tasks">Assisting with tasks</option>
                        <option value="Engaging in conversations">Engaging in conversations</option>
                    </select>
                </div>
            </div>
            <div class="help_ai_modal_slider_item">
                <h4>What tone should the AI agent use?</h4>
                <div>
                    <select class="form-select" id="agent-tone">
                        <option value="Formal" selected>Formal</option>
                        <option value="Friendly">Friendly</option>
                        <option value="Professional">Professional</option>
                        <option value="Neutral">Neutral</option>
                        <option value="Humorous">Humorous</option>
                    </select>
                </div>
            </div>
            <div class="help_ai_modal_slider_item">
                <h4>What level of detail should the responses have?</h4>
                <div>
                    <select class="form-select" id='level-of-detail'>
                        <option value="Brief and concise"  selected>Brief and concise</option>
                        <option value="Moderate detail">Moderate detail</option>
                        <option value="In-depth and explanatory">In-depth and explanatory</option>
                        <option value="Step-by-step guidance">Step-by-step guidance</option>
                    </select>
                </div>
            </div>
            <div class="help_ai_modal_slider_item">
                <h4>Which industry does your AI agent serve?</h4>
                <div>
                    <select class="form-select" id='industry'>
                        <option value="Retail"  selected>Retail</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Finance">Finance</option>
                        <option value="Technology">Technology</option>
                        <option value="Education">Education</option>
                        <option value="Customer Support">Customer Support</option>
                        <option value="Marketing">Marketing</option>
                    </select>
                </div>
            </div>
            <div class="help_ai_modal_slider_item">
                <h4>What would you like to call your agent? (Optional)</h4>
                <div>
                   <input type="text" class="form-control" placeholder="(Optional)" id='agent-name-new'>
                </div>
            </div>
          </div>
          <!-- Navigation Buttons -->
            <div class="slider-nav d-flex align-items-center justify-content-between">
                <button class="prev-btn align-items-center justify-content-center prev_btn" disabled><img src="{{ url_for('static', path='/Web/images/slider-prev-icon.svg') }}" class="img-fluid">Previous</button>
                <button class="next-btn align-items-center justify-content-center"> Next <img src="{{ url_for('static', path='/Web/images/slider-next-icon.svg') }}" class="img-fluid"></button>
                <button class="submit-btn align-items-center justify-content-center" style="display: none;" id="generate-prompt-btn">Submit</button>
            </div>
        </div>
      </div>
    </div>
  </div>


  <div id="dialog" style="position: absolute; width: 300px; background: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 16px; left: 330px; top: 180px; border: 1px solid #ddd; z-index: 1000; display: none;">
        <div>
            <strong>LLM Temperature</strong>
            <p style="font-size: 12px; color: #666;">Lower value yields better function call results.</p>
            <small class="text-muted">Default: 1.0</small>
            <div style="position: relative; width: 100%;">
                <input id="temperatureSlider" type="range" min="0.0" max="2.0" step="0.1" value="{% if agent.temperature %}{{ agent.temperature }}{% else %}0.00{% endif %}" style="width: 100%;" >
                <div id="sliderValue" style="position: absolute; top: -25px; left: 0%; transform: translateX(-50%); background: #0C7FDA; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 12px;">0.00</div>
            </div>
        </div>
        <div>
            <strong>Max Output Tokens</strong>
            <p style="font-size: 12px; color: #666;">The maximum number of tokens to generate in the completion.</p>
            <small class="text-muted">Min: 100</small>
            <small class="text-muted">Default: 4096</small>
            <small class="text-muted">Max: 8000</small>
            <div style="position: relative; width: 100%;">
                <input id="maxOutputTokensSlider" type="text" class="form-control" placeholder="Enter max output tokens" value="{% if agent.max_output_tokens %}{{ agent.max_output_tokens }}{% else %}1000{% endif %}">
            </div>
        </div>
        <hr style="margin-top: 10px;">
        <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
            <button id="closeDialog" style="padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; background: #f0f0f0;" onclick="closeDialog()">Cancel</button>
            <button style="padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; background: #0C7FDA; color: white; margin-left: 8px;" onclick="saveSettings()">Save</button>
        </div>
    </div>
  <script>
    function toggleVariableModal() {
        const modal = document.getElementById('variable-modal');
        if(modal.style.display === 'none') {
            modal.style.display = 'block';
            // Populate the modal with current dynamic variables
            populateDynamicVariables();
        } else {
            modal.style.display = 'none';
        }
    }

    function populateDynamicVariables() {
        const dynamicVariablesDiv = document.getElementById("dynamic-variables");
        if (!dynamicVariablesDiv) return;
        
        // Clear existing content
        dynamicVariablesDiv.innerHTML = '';
        
        // Get dynamic variables from the template context
        const dynamicVariables = {{ dynamic_variables|tojson|safe }};
        
        if (dynamicVariables && Object.keys(dynamicVariables).length > 0) {
            // Add existing variables
            Object.entries(dynamicVariables).forEach(([key, value]) => {
                addVariableToModal(key, value);
            });
        } else {
            // Add a default empty row if no variables exist
            addVariableToModal('', '');
        }
    }

    function addVariableToModal(name, value) {
        const dynamicVariablesDiv = document.getElementById("dynamic-variables");
        if (!dynamicVariablesDiv) return;
        
        const variableDiv = document.createElement("div");
        variableDiv.className = "variable-modal-content-item mb-2";
        variableDiv.innerHTML = `
            <input type="text" class="form-control" placeholder="Variable Name" value="${name}">
            <input type="text" class="form-control" placeholder="Enter the value" value="${value}">
            <button class="dlt_btn bg-transparent border-0 p-0" onclick="removeVariable(this)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
            </button>
        `;
        
        dynamicVariablesDiv.appendChild(variableDiv);
    }
</script>
<script>
let host = "{{ host }}";
let selectedIconUrl = "{{ host }}/static/Web/images/gif-icon-1.gif"; // Default icon

    $(document).ready(function () {
        var $slider = $('.help_ai_modal_slider');
    
        function initSlider() {
            if (!$slider.hasClass('slick-initialized')) {
                $slider.slick({
                    infinite: false,
                    slidesToShow: 1,
                    slidesToScroll: 1,
                    arrows: false, // Hide default arrows
                    dots: false,
                    adaptiveHeight: true, // Adjust height dynamically
                });
    
                // Reveal the slider after initialization
                $slider.css("display", "block");
            }
        }
    
        $('.modal').on('shown.bs.modal', function () {
            initSlider();
            setTimeout(() => {
                $slider.slick('setPosition'); // Ensure correct rendering
            }, 100); // Small delay to prevent width glitch
        });
    
        $('.prev-btn').click(function () {
            if (!$(this).prop('disabled')) {
                $slider.slick('slickPrev');
            }
        });
    
        $('.next-btn').click(function () {
            $slider.slick('slickNext');
        });
    
        $slider.on('afterChange', function (event, slick, currentSlide) {
            $('.prev-btn').prop('disabled', currentSlide === 0);
            $('.next-btn').toggle(currentSlide !== slick.slideCount - 1);
            $('.submit-btn').toggle(currentSlide === slick.slideCount - 1);
        });
    
        function resetModal() {
            $("#agent-function").val("Answering questions");
            $("#agent-tone").val("Formal");
            $("#level-of-detail").val("Brief and concise");
            $("#industry").val("Retail");
            $("#agent-name-new").val("");
    
            // Reset slider to the first slide
            $slider.slick('slickGoTo', 0);
            $('.prev-btn').prop('disabled', true);
            $('.next-btn').show();
            $('.submit-btn').hide();
        }
    
        $('.modal').on('hidden.bs.modal', function () {
            resetModal();
    
            // Manually trigger a width update on close to prevent glitch
            setTimeout(() => {
                $slider.slick('setPosition');
            }, 100);
        });
    });
    
    
    
    
</script>
<script>
    let selectedTheme = {
        primaryColor: null,
        secondaryColor: null,
        pulseColor: null
    };


    document.addEventListener("DOMContentLoaded", function() {
        const selectBox = document.getElementById("welcome-msg");
        const optionsContainer = document.querySelector(".options");
        const options = document.querySelectorAll(".option");

        // Check if elements exist
        if (!selectBox || !optionsContainer) {
            console.error("Welcome message elements not found:", {
                selectBox: !!selectBox,
                optionsContainer: !!optionsContainer
            });
            return;
        }

        // Toggle dropdown
        selectBox.addEventListener("click", function() {
            optionsContainer.classList.toggle("active");
        });

        // Change the selected option
        options.forEach(option => {
            option.addEventListener("click", function() {
                selectBox.textContent = this.textContent;
                optionsContainer.classList.remove("active");
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", function(event) {
            if (!selectBox.parentElement.contains(event.target)) {
                optionsContainer.classList.remove("active");
            }
        });
    });
    
    function copyScript(){
        let script = $("#agent-script").val();
        navigator.clipboard.writeText(script);
        toastr.success("Script copied to clipboard", {positionClass: "toast-top-right"});
    }
</script>

<script>
    
    

    $(document).ready(function () {
        $(".select-box").click(function () {
            $(".options").toggleClass("visible");
        });

        $(".option").click(function () {
            let selectedText = $(this).text();
            $(".select-box").text(selectedText);
            $(".options").removeClass("visible");
        });

        // Close dropdown when clicking outside
        $(document).click(function (e) {
            if (!$(e.target).closest(".custom-select").length) {
                $(".options").removeClass("visible");
            }
        });
    });


    $("#save-btn").click(function(){
        let searchParams = new URLSearchParams(window.location.search);
        let agentId = searchParams.get('agent_id');

        let agentName = $("#agent-name").text().trim();
        let agentPrompt = $("#agent-prompt").val();
        let welcomeMsg = $("#welcome-msg").text();
        let selectedModel = $("#selected-model").val();
        let selectedVoice = $("#selected-voice").val();
        let selectedLanguage = $("#selected-language").val();
        let selectedKnowledgeBase = $("#selected-knowledge-base").val();
        if(agentName == "" || agentPrompt == "" || welcomeMsg == "" || selectedModel == "" || selectedVoice == "" || selectedLanguage == ""){
            toastr.error("Please fill all the fields", {positionClass: "toast-top-right"});
            return;
        }

        // Use absolute URL to avoid redirect
        let requestUrl = agentId ? `{{ host }}/api/edit_agent` : `{{ host }}/api/create_new_agent`;

        $.ajax({    
            url: requestUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                agent_id: agentId,
                agent_name: agentName,
                agent_prompt: agentPrompt,
                welcome_msg: welcomeMsg,
                selected_model: selectedModel,
                selected_voice: selectedVoice,
                selected_language: selectedLanguage,
                selected_knowledge_base: selectedKnowledgeBase
            }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response){
                if(response.status == "success"){
                    toastr.success(response.message, {positionClass: "toast-top-right"});
                    setTimeout(function(){
                        window.location.href = "/dashboard"; // Use absolute path
                    }, 2000);
                }
                else{
                    toastr.error("Something went wrong!", {positionClass: "toast-top-right"});
                }
            },
            error: function(xhr, status, error){
                console.log("Error:", xhr.responseText); // Log error details
                toastr.error("Something went wrong!", {positionClass: "toast-top-right"});
            }
        });
    });

    

function changeIcon(iconUrl, element) {
    // Remove 'active' class from previously selected icon
    let previousActive = document.querySelector('.icon-option.active');
    if (previousActive) {
        previousActive.classList.remove('active');
    }

    // Ensure element exists
    if (!element) {
        console.error('Element is undefined');
        return;
    }

    // Find the closest .icon-option parent
    let iconOption = element.closest('.icon-option');
    if (!iconOption) {
        console.error('Could not find parent .icon-option element');
        return;
    }

    // Add 'active' class to the selected icon
    iconOption.classList.add('active');

    // Update global variable for tracking the selected icon
    selectedIconUrl = iconUrl;
}


    document.addEventListener("DOMContentLoaded", function() {
        try {
            let agentId = "{{ agent.id if agent else '' }}";
            if(agentId){
                $.ajax({
                    url: `{{ host }}/api/get_agent_connection`,
                    type: 'GET',
                    data: {agent_id: agentId},
                    success: function(response){    
                        if(response.status == "success"){
                            let connection = response.data || {};
                            let iconUrl = connection.icon_url || "{{ host }}/static/Web/images/gif-icon-1.gif";
                            let primaryColor = connection.primary_color || "#00b4d8";
                            let secondaryColor = connection.secondary_color || "#0077b6"; 
                            let pulseColor = connection.pulse_color || "rgba(0, 180, 216, 0.3)";
                            
                            // First apply theme
                            changeTheme(primaryColor, secondaryColor, pulseColor);
                            
                            // Find icon option matching the saved icon URL
                            let iconOptions = document.querySelectorAll('.icon-option');
                            let matchingIcon = Array.from(iconOptions).find(option => {
                                let img = option.querySelector('img');
                                return img && img.src === iconUrl;
                            });

                            // If matching icon found, activate it, otherwise use first icon
                            if (matchingIcon) {
                                changeIcon(iconUrl, matchingIcon);
                            } else {
                                let firstIcon = document.querySelector('.icon-option');
                                if (firstIcon) {
                                    let firstIconUrl = firstIcon.querySelector('img').src;
                                    changeIcon(firstIconUrl, firstIcon);
                                }
                            }
                        }
                    },
                    error: function(xhr, status, error){
                        console.log("Error:", xhr.responseText);
                    }
                });
            }
        } catch (error) {
            console.error("Error in DOMContentLoaded:", error);
        }
    });


function saveChanges() {
    const customizeBotModal = document.getElementById('customize-bot-modal');
    const voiceIcon = document.querySelector('.voice_icon');

    if (customizeBotModal) {
        customizeBotModal.classList.remove('show');
        setTimeout(() => {
            customizeBotModal.style.display = 'none';
            if (voiceIcon) {
                voiceIcon.style.display = 'block';
            }
        }, 500);
    }

    let agentId = "{{ agent.id if agent else '' }}"; // Get agent ID safely
    let iconUrl = selectedIconUrl; // Use dynamically updated icon

    // Get colors from CSS variables
    let primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || "#00b4d8";
    let secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim() || "#0077b6";
    let pulseColor = getComputedStyle(document.documentElement).getPropertyValue('--pulse-shadow').trim() || "rgba(0, 180, 216, 0.3)";

    // Create the data payload
    let data = {
        agent_id: agentId,
        icon_url: iconUrl,
        primary_color: primaryColor,
        secondary_color: secondaryColor,
        pulse_color: pulseColor
    };

    // Send data to API
    fetch(`{{ host }}/api/save_changes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(response => {
        if (response.status === "success") {
            toastr.success("Changes saved successfully", { positionClass: "toast-top-right" });
        } else {
            throw new Error(response.message || "Something went wrong!");
        }
    })
    .catch(error => {
        toastr.error(error.message, { positionClass: "toast-top-right" });
    });
}



function toggleRecorder() {
    const customizeBotModal = document.getElementById('customize-bot-modal');
    const voiceIcon = document.querySelector('.voice_icon');

    if (customizeBotModal.classList.contains('show')) {
        customizeBotModal.classList.remove('show');
        setTimeout(() => {
            customizeBotModal.classList.add('hidden');
        }, 500);
    } else {
        customizeBotModal.classList.remove('hidden');
        setTimeout(() => customizeBotModal.classList.add('show'), 10);
        voiceIcon.style.display = 'none'; // Hide voice icon when opened
    }
}


function toggleColorPalette() {
    const colorPalette = document.getElementById('colorPalette');
    colorPalette.classList.toggle('show');
}
function toggleIconPalette() {
    const iconPalette = document.getElementById('iconPalette');
    iconPalette.classList.toggle('show');
}

function changeTheme(primaryColor, secondaryColor, pulseColor) {
        // Apply colors to CSS variables
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        document.documentElement.style.setProperty('--pulse-shadow', pulseColor);

        // Convert Hex to RGB and store as CSS variable
        const rgbMatch = primaryColor.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
        if (rgbMatch) {
            const r = parseInt(rgbMatch[1], 16);
            const g = parseInt(rgbMatch[2], 16);
            const b = parseInt(rgbMatch[3], 16);
            document.documentElement.style.setProperty('--primary-color-rgb', `${r}, ${g}, ${b}`);
        }

        // Store theme in a global variable
        selectedTheme = { primaryColor, secondaryColor, pulseColor };

        // Hide the color palette
        const colorPalette = document.getElementById('colorPalette');
        if (colorPalette) {
            colorPalette.classList.remove('show');
        }
    }


    $("#generate-prompt-btn").click(function () {
        let agentFunction = $("#agent-function").val();
        let agentTone = $("#agent-tone").val();
        let levelOfDetail = $("#level-of-detail").val();
        let industry = $("#industry").val();
        let agentName = $("#agent-name-new").val();
    
        if (agentFunction == "" || agentTone == "" || levelOfDetail == "" || industry == "") {
            toastr.error("Please select all the fields", { positionClass: "toast-top-right" });
            return;
        }
    
        $("#generate-prompt-btn").prop("disabled", true);
        $("#close-help-ai-modal").prop("disabled", true);
    
        $.ajax({
            url: `{{ host }}/api/agent_prompt_suggestion/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ agent_function: agentFunction, agent_tone: agentTone, level_of_detail: levelOfDetail, industry: industry, agent_name: agentName }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function (response) {
                if (response.status == "success") {
                    toastr.success("Prompt generated successfully", { positionClass: "toast-top-right" });
                    $("#agent-prompt").val(response.prompt);
                } else {
                    toastr.error(response.message, { positionClass: "toast-top-right" });
                }
    
                $("#generate-prompt-btn").prop("disabled", false);
                $("#close-help-ai-modal").prop("disabled", false);
                $("#agent-name-new").val("");

                $("#helpAiModal").modal("hide");
            },
            error: function (xhr, status, error) {
                console.log("Error:", xhr.responseText);
                toastr.error("Something went wrong!", { positionClass: "toast-top-right" });
    
                $("#generate-prompt-btn").prop("disabled", false);
                $("#close-help-ai-modal").prop("disabled", false);
                $("#helpAiModal").modal("hide");
                $("#agent-name-new").val("");
            }
        });
    });
    

document.addEventListener("DOMContentLoaded", function () {
    const textarea = document.getElementById("agent-prompt");

    // Check if the URL matches the ElevenLabs update-agent pattern
    const currentUrl = new URL(window.location.href);
    if (currentUrl.pathname === "/elevenlabs/web/v1/update_agent" && currentUrl.searchParams.has("agent_id")) {
        const agentId = currentUrl.searchParams.get("agent_id");
        let initialValue = textarea.value.trim(); // Store the initial value

        textarea.addEventListener("blur", function () {
            const text = textarea.value.trim();  // Get the text value

            if (text !== "" && text !== initialValue) {  
                saveAgentPrompt(agentId, text);
                updateAgentSetting('prompt',text)
                initialValue = text; 
            }
        });
    }
});

function getCSRFToken() {
    return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
}

document.addEventListener("DOMContentLoaded", function () {
    const welcomeMessageInput = document.getElementById("welcome-message");
    const selectBox = document.getElementById("welcome-msg");
    const optionsContainer = document.querySelector(".options");
    const options = document.querySelectorAll(".options .option");

    // Check if elements exist
    if (!selectBox || !optionsContainer || !welcomeMessageInput) {
        console.error("Required elements not found:", {
            selectBox: !!selectBox,
            optionsContainer: !!optionsContainer,
            welcomeMessageInput: !!welcomeMessageInput
        });
        return;
    }

    const currentUrl = new URL(window.location.href);
    const isUpdatePage = currentUrl.pathname === "/update_agent";
    const agentId = currentUrl.searchParams.get("agent_id");

    selectBox.addEventListener("click", function () {
        optionsContainer.style.display = "block";
    });

    options.forEach(option => {
        option.addEventListener("click", function () {
            const selectedValue = this.getAttribute("data-value");
            const selectedText = this.innerText;

            if (selectedValue === "custom") {
                selectBox.style.display = "none";
                welcomeMessageInput.style.display = "block";
                welcomeMessageInput.focus();
            } else {
                selectBox.innerText = selectedText;
                welcomeMessageInput.style.display = "none";
                selectBox.style.display = "block";
                optionsContainer.style.display = "none";

                // Immediately save the welcome message when option is selected
                saveWelcomeMessage(selectedText);
            }
        });
    });

    // Function to save welcome message immediately
    function saveWelcomeMessage(message) {
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");
        
        // Update both local database and ElevenLabs
        fetch(`${host}/elevenlabs/api/v1/edit_agent`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({
                agent_id: agentId,
                welcome_msg: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                toastr.success("Welcome message updated successfully", { positionClass: "toast-top-right" });
                
            } else {
                toastr.error(data.message || "Failed to update welcome message");
                
            }
        })
        .catch(error => {
            
            toastr.error("Error updating welcome message");
        });
    }

    let saveTimeout;

    welcomeMessageInput.addEventListener("blur", function () {
        clearTimeout(saveTimeout);
        handleCustomInput();
    });

    welcomeMessageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            clearTimeout(saveTimeout);
            handleCustomInput();
            welcomeMessageInput.blur();
        }
    });

    function handleCustomInput() {
        const value = welcomeMessageInput.value.trim();
        if (value !== "") {
            selectBox.innerText = value;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveWelcomeMessage(value);
            }, 300);
            welcomeMessageInput.style.display = "none";
            selectBox.style.display = "block";
            optionsContainer.style.display = "none";
        } else {
            toastr.error("Please enter a welcome message", { positionClass: "toast-top-right" });
            welcomeMessageInput.focus();
            return;
        }
    }
    function getCSRFToken() {
        return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }
});

// Add the missing saveAgentPrompt function for ElevenLabs integration
function saveAgentPrompt(agentId, promptText) {
    fetch("{{ host }}/elevenlabs/api/v1/edit_agent", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ 
            agent_id: agentId, 
            prompt: promptText 
        })
    })
    .then(response => response.json())
    .then(data => {
        if(data.status == "success"){
            toastr.success("Prompt saved successfully", { positionClass: "toast-top-right" });
        } else if (data.status == "error"){
            toastr.error(data.message || "Error saving prompt", { positionClass: "toast-top-right" });
        } else {
            toastr.error("Something went wrong!", { positionClass: "toast-top-right" });
        }
    })
    .catch(error => {
        console.error("Error saving prompt:", error);
        toastr.error("Error saving prompt", { positionClass: "toast-top-right" });
    });
}


function addNewVariable() {
    // Use our new helper function to add an empty variable row
    addVariableToModal('', '');
}


function removeVariable(button){
    var variableModalContentItemOuter = button.parentElement;
    variableModalContentItemOuter.remove();
    
    // Only make API call if there's a variable name (not for empty rows)
    const variableName = button.parentElement.querySelector('input[type="text"]').value;
    if (variableName && variableName.trim()) {
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");    
        console.log('Removing variable:', variableName, 'from agent:', agentId);
        
        $.ajax({
            url: "{{ host }}/api/remove-variable",
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ variable_id: variableName, agent_id: agentId }),
            success: function(response) {
                toastr.success('Variable removed successfully');
            },
            error: function(xhr, status, error) {
                toastr.error('Error removing variable: ' + error);
            }
        });
    }
}

function formatJSON(){
    var jsonTextarea = document.getElementById("parameters");
    var formattedJSON = jsonTextarea.value;
    jsonTextarea.value = formattedJSON;
}

function copyJSON(){
    var jsonTextarea = document.getElementById("parameters");
    var formattedJSON = jsonTextarea.value;
    jsonTextarea.value = formattedJSON;
}

// Wait for the modal to be shown before attaching the event listener
$('#customFuntionModal').on('shown.bs.modal', function () {
    // Initialize default messages for empty containers
    if (document.getElementById("path_params_container").innerHTML === '') {
        document.getElementById("path_params_container").innerHTML = '<p class="text-muted">No path parameters defined</p>';
    }
    if (document.getElementById("query_params_container").innerHTML === '') {
        document.getElementById("query_params_container").innerHTML = '<p class="text-muted">No query parameters defined</p>';
    }
    if (document.getElementById("request_body_properties_container").innerHTML === '') {
        document.getElementById("request_body_properties_container").innerHTML = '<p class="text-muted">No properties defined</p>';
    }
    if (document.getElementById("request_headers_container").innerHTML === '') {
        document.getElementById("request_headers_container").innerHTML = '<p class="text-muted">No headers defined</p>';
    }
    if (document.getElementById("dynamic_variables_container").innerHTML === '') {
        document.getElementById("dynamic_variables_container").innerHTML = '<p class="text-muted">No dynamic variables defined</p>';
    }
    if (document.getElementById("assignments_container").innerHTML === '') {
        document.getElementById("assignments_container").innerHTML = '<p class="text-muted">No assignments defined</p>';
    }
    
    const saveButton = document.getElementById("save-custom-function");
    if (saveButton && !saveButton.hasAttribute('data-listener-attached')) {
        saveButton.setAttribute('data-listener-attached', 'true'); // Prevent multiple listeners
        saveButton.addEventListener("click", function() {
            const currentUrl = new URL(window.location.href);
            const agentId = currentUrl.searchParams.get("agent_id");

            // Collect all form data including nested structures
            let formData = collectWebhookFormData();
            
            // Check if form data collection failed
            if (!formData) {
                toastr.error('Failed to collect form data. Please check the console for errors.');
                return;
            }

            // Frontend validation for ElevenLabs API compliance
            if (!validateElevenLabsCompliance(formData.http_method, formData.body_description)) {
                return; // Stop if validation fails
            }

            // Validate path parameters
            if (formData.path_params && formData.path_params.length > 0) {
                for (let i = 0; i < formData.path_params.length; i++) {
                    const param = formData.path_params[i];
                    if (!validatePathParameter(param.description, param.dynamic_variable, param.constant_value, i + 1)) {
                        return; // Stop if validation fails
                    }
                }
            }

            // Validate required fields
            if (!formData.tool_name || !formData.api_url) {
                toastr.error('Tool name and API URL are required');
                return;
            }
            
            console.log("Collected form data:", formData);

    $.ajax({
                url: "{{ host }}/elevenlabs/api/v1/custom-functions",
        type: 'POST',
        contentType: 'application/json',
                data: JSON.stringify({webhook_config: formData, agent_id: agentId}),
        success: function(response) {
            if(response.status == "success"){
                        toastr.success('ElevenLabs webhook tool created successfully');
                $('#customFuntionModal').modal('hide');
                        clearWebhookForm();
                var functionData = response.data
                $('#function-list').append(`
                    <li class="dropdown-item gap-3 d-flex align-items-center justify-content-between mb-2" id="function-${functionData.id}">
                                <div class="functionNameDivBlock">${functionData.tool_name || formData.tool_name}</div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="edit-function-btn bg-transparent border-0 p-0" onclick="editFunction(${functionData.id})"><img src="{{ url_for('static', path='/Web/images/edit-icon.svg') }}" class="img-fluid"></button>   
                            <button class="delete-function-btn bg-transparent border-0 p-0" onclick="deleteFunction(${functionData.id})"><img src="{{ url_for('static', path='/Web/images/black-dlt-icon.svg') }}" class="img-fluid"></button>
                        </div>
                    </li>
                `);
            }
            else{
                toastr.error(response.message || 'Something went wrong!');
            }
        },
        error: function(xhr, status, error) {
            let errorMessage = xhr?.responseJSON?.message;
                    toastr.error(errorMessage || 'Error creating webhook tool: ' + error);
        }
    });
});
    }
    
    // Add real-time event listeners for Parameters field updates
    setTimeout(() => {
        // Basic form fields
        const formFields = [
            'tool_name', 'tool_description', 'api_url', 'http_method', 
            'response_timeout', 'disable_interruptions', 'force_pre_tool_speech'
        ];
        
        formFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                if (field.type === 'checkbox') {
                    field.addEventListener('change', updateParametersField);
                } else {
                    field.addEventListener('input', updateParametersField);
                    field.addEventListener('change', updateParametersField);
                }
            }
        });
        
        // Add event listeners for dynamic form elements
        const addDynamicEventListeners = () => {
            // Path parameters
            document.querySelectorAll('#path_params_container input, #path_params_container select, #path_params_container textarea').forEach(element => {
                element.addEventListener('input', updateParametersField);
                element.addEventListener('change', updateParametersField);
            });
            
            // Query parameters
            document.querySelectorAll('#query_params_container input, #query_params_container select, #query_params_container textarea').forEach(element => {
                element.addEventListener('input', updateParametersField);
                element.addEventListener('change', updateParametersField);
            });
            
            // Request body properties
            document.querySelectorAll('#request_body_properties_container input, #request_body_properties_container select, #request_body_properties_container textarea').forEach(element => {
                element.addEventListener('input', updateParametersField);
                element.addEventListener('change', updateParametersField);
            });
        };
        
        // Initial update
        updateParametersField();
        
        // Add dynamic event listeners
        addDynamicEventListeners();
        
        // Re-add event listeners when new elements are added (using MutationObserver)
        const observer = new MutationObserver(() => {
            addDynamicEventListeners();
        });
        
        const pathContainer = document.getElementById('path_params_container');
        const queryContainer = document.getElementById('query_params_container');
        const bodyContainer = document.getElementById('request_body_properties_container');
        
        if (pathContainer) observer.observe(pathContainer, { childList: true, subtree: true });
        if (queryContainer) observer.observe(queryContainer, { childList: true, subtree: true });
        if (bodyContainer) observer.observe(bodyContainer, { childList: true, subtree: true });
    }, 100);
});

// Function to update Parameters field in real-time based on form changes
function updateParametersField() {
    try {
        // Helper function to safely get element value
        function getElementValue(id, defaultValue = "") {
            const element = document.getElementById(id);
            return element ? element.value : defaultValue;
        }

        // Helper function to safely get checkbox value
        function getCheckboxValue(id, defaultValue = false) {
            const element = document.getElementById(id);
            return element ? element.checked : defaultValue;
        }

        // Collect all form data
        const toolName = getElementValue("tool_name");
        const toolDescription = getElementValue("tool_description");
        const apiUrl = getElementValue("api_url");
        const httpMethod = getElementValue("http_method", "POST");
        const responseTimeout = getElementValue("response_timeout", "20");
        const disableInterruptions = getCheckboxValue("disable_interruptions", false);
        const forcePreToolSpeech = getCheckboxValue("force_pre_tool_speech", false);

        // Collect path parameters
        const pathParams = [];
        document.querySelectorAll('#path_params_container .path-param-row').forEach((row) => {
            const name = row.querySelector('input[name="path_param_name"]')?.value;
            const type = row.querySelector('select[name="path_param_type"]')?.value || 'string';
            const description = row.querySelector('input[name="path_param_description"]')?.value || '';
            const dynamicVariable = row.querySelector('input[name="path_param_dynamic_variable"]')?.value || '';
            const constantValue = row.querySelector('input[name="path_param_constant_value"]')?.value || '';
            const required = row.querySelector('input[name="path_param_required"]')?.checked || false;

            if (name) {
                const pathParam = { name, type, description, required };
                if (dynamicVariable) pathParam.dynamic_variable = dynamicVariable;
                if (constantValue) pathParam.constant_value = constantValue;
                pathParams.push(pathParam);
            }
        });

        // Collect query parameters
        const queryParams = [];
        document.querySelectorAll('#query_params_container .query-param-row').forEach((row) => {
            const name = row.querySelector('input[name="query_param_name"]')?.value;
            const type = row.querySelector('select[name="query_param_type"]')?.value || 'string';
            const description = row.querySelector('input[name="query_param_description"]')?.value || '';
            const dynamicVariable = row.querySelector('input[name="query_param_dynamic_variable"]')?.value || '';
            const constantValue = row.querySelector('input[name="query_param_constant_value"]')?.value || '';
            const required = row.querySelector('input[name="query_param_required"]')?.checked || false;

            if (name) {
                const queryParam = { name, type, description, required };
                if (dynamicVariable) queryParam.dynamic_variable = dynamicVariable;
                if (constantValue) queryParam.constant_value = constantValue;
                queryParams.push(queryParam);
            }
        });

        // Collect request body properties
        const requestBodyProperties = [];
        document.querySelectorAll('#request_body_properties_container .body-property-row').forEach((row) => {
            const name = row.querySelector('input[name="body_property_name"]')?.value;
            const type = row.querySelector('select[name="body_property_type"]')?.value || 'string';
            const description = row.querySelector('textarea[name="body_property_description"]')?.value || '';
            const dynamicVariable = row.querySelector('input[name="body_property_dynamic_variable"]')?.value || '';
            const constantValue = row.querySelector('input[name="body_property_constant_value"]')?.value || '';
            const required = row.querySelector('input[name="body_property_required"]')?.checked || false;

            if (name) {
                const bodyProperty = { name, type, description, required };
                if (dynamicVariable) bodyProperty.dynamic_variable = dynamicVariable;
                if (constantValue) bodyProperty.constant_value = constantValue;
                requestBodyProperties.push(bodyProperty);
            }
        });

        // Build the complete tool config
        const toolConfig = {
            name: toolName,
            type: "webhook",
            api_schema: {
                url: apiUrl,
                method: httpMethod,
                auth_connection: null,
                request_headers: {},
                path_params_schema: pathParams.length > 0 ? pathParams : {},
                query_params_schema: queryParams.length > 0 ? queryParams : null,
                request_body_schema: null
            },
            assignments: [],
            description: toolDescription,
            dynamic_variables: {
                dynamic_variable_placeholders: {}
            },
            disable_interruptions: disableInterruptions,
            force_pre_tool_speech: forcePreToolSpeech,
            response_timeout_secs: parseInt(responseTimeout) || 20
        };

        // Add request body schema for POST/PUT/PATCH methods
        if (["POST", "PUT", "PATCH"].includes(httpMethod) && requestBodyProperties.length > 0) {
            toolConfig.api_schema.request_body_schema = {
                type: "object",
                properties: requestBodyProperties
            };
        }

        // Update the parameters textarea
        const parametersTextarea = document.getElementById('parameters');
        if (parametersTextarea) {
            parametersTextarea.value = JSON.stringify({ tool_config: toolConfig }, null, 2);
        }

    } catch (error) {
        console.error('Error updating parameters field:', error);
    }
}

// Function to collect all webhook form data including nested structures
function collectWebhookFormData() {
    try {
        // Helper function to safely get element value
        function getElementValue(id, defaultValue = "") {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`Element with id '${id}' not found`);
                return defaultValue;
            }
            return element.value || defaultValue;
        }
        
        // Helper function to safely get element checked state
        function getElementChecked(id, defaultValue = false) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`Element with id '${id}' not found`);
                return defaultValue;
            }
            return element.checked || defaultValue;
        }
        
        return {
            // Basic tool configuration
            tool_name: getElementValue("tool_name"),
            tool_description: getElementValue("tool_description"),
            response_timeout: getElementValue("response_timeout", "20"),
            
            // API schema
            api_url: getElementValue("api_url"),
            http_method: getElementValue("http_method", "POST"),
            body_description: getElementValue("body_description"),
            
            // Advanced options
            disable_interruptions: getElementChecked("disable_interruptions"),
            force_pre_tool_speech: getElementChecked("force_pre_tool_speech"),
            
            // Nested arrays - these will be populated by dynamic form elements
            path_params: collectPathParams(),
            query_params: collectQueryParams(),
            request_body_properties: collectRequestBodyProperties(),
            request_headers: collectRequestHeaders(),
            dynamic_variables: collectDynamicVariables(),
            assignments: collectAssignments()
        };
    } catch (error) {
        console.error("Error collecting webhook form data:", error);
        toastr.error("Error collecting form data: " + error.message);
        return null;
    }
}

// Helper functions to collect nested form data
function collectPathParams() {
    const params = [];
    const container = document.getElementById("path_params_container");
    const paramElements = container.querySelectorAll('.param-item');
    
    paramElements.forEach(element => {
        const name = element.querySelector('.param-name').value;
        const type = element.querySelector('.param-type').value;
        const required = element.querySelector('.param-required').checked;
        const valueType = element.querySelector('.param-value-type').value;
        
        // Get the appropriate value based on value type
        let description = '';
        let dynamicVar = '';
        let constantValue = '';
        
        if (valueType === 'llm_prompt') {
            const descInput = element.querySelector('.param-description');
            description = descInput ? descInput.value : '';
        } else if (valueType === 'constant_value') {
            const constInput = element.querySelector('.param-constant-value');
            constantValue = constInput ? constInput.value : '';
        } else if (valueType === 'dynamic_variable') {
            const dynInput = element.querySelector('.param-dynamic-var');
            dynamicVar = dynInput ? dynInput.value : '';
        }
        
        if (name) {
            const param = {
                name, 
                type, 
                required
            };
            
            // Only add the relevant field based on value type
            if (valueType === 'llm_prompt' && description) {
                param.description = description;
            } else if (valueType === 'constant_value' && constantValue) {
                param.constant_value = constantValue;
            } else if (valueType === 'dynamic_variable' && dynamicVar) {
                param.dynamic_variable = dynamicVar;
            }
            
            params.push(param);
        }
    });
    
    // Validate path parameters against URL placeholders
    const apiUrl = document.getElementById("api_url").value;
    if (!validatePathParametersAgainstURL(apiUrl, params)) {
        throw new Error("Path parameter validation against URL failed");
    }
    
    return params;
}

function collectQueryParams() {
    const params = [];
    const container = document.getElementById("query_params_container");
    const paramElements = container.querySelectorAll('.param-item');
    
    paramElements.forEach(element => {
        const name = element.querySelector('.param-name').value;
        const type = element.querySelector('.param-type').value;
        const required = element.querySelector('.param-required').checked;
        const valueType = element.querySelector('.param-value-type').value;
        
        // Get the appropriate value based on value type
        let description = '';
        let dynamicVar = '';
        let constantValue = '';
        
        if (valueType === 'llm_prompt') {
            const descInput = element.querySelector('.param-description');
            description = descInput ? descInput.value : '';
        } else if (valueType === 'constant_value') {
            const constInput = element.querySelector('.param-constant-value');
            constantValue = constInput ? constInput.value : '';
        } else if (valueType === 'dynamic_variable') {
            const dynInput = element.querySelector('.param-dynamic-var');
            dynamicVar = dynInput ? dynInput.value : '';
        }
        
        if (name) {
            const param = {
                name, 
                type, 
                required
            };
            
            // Only add the relevant field based on value type
            if (valueType === 'llm_prompt' && description) {
                param.description = description;
            } else if (valueType === 'constant_value' && constantValue) {
                param.constant_value = constantValue;
            } else if (valueType === 'dynamic_variable' && dynamicVar) {
                param.dynamic_variable = dynamicVar;
            }
            
            params.push(param);
        }
    });
    return params;
}

function collectRequestBodyProperties() {
    const properties = [];
    const container = document.getElementById("request_body_properties_container");
    const propElements = container.querySelectorAll('.property-item');
    
    propElements.forEach(element => {
        const name = element.querySelector('.property-name').value;
        const type = element.querySelector('.property-type').value;
        const required = element.querySelector('.property-required').checked;
        const valueType = element.querySelector('.property-value-type').value;
        
        // Get the appropriate value based on value type
        let description = '';
        let dynamicVar = '';
        let constantValue = '';
        
        if (valueType === 'llm_prompt') {
            const descInput = element.querySelector('.property-description');
            description = descInput ? descInput.value : '';
        } else if (valueType === 'constant_value') {
            const constInput = element.querySelector('.property-constant-value');
            constantValue = constInput ? constInput.value : '';
        } else if (valueType === 'dynamic_variable') {
            const dynInput = element.querySelector('.property-dynamic-var');
            dynamicVar = dynInput ? dynInput.value : '';
        }
        
        if (name) {
            const property = {
                name, 
                type, 
                required
            };
            
            // Only add the relevant field based on value type
            if (valueType === 'llm_prompt' && description) {
                property.description = description;
            } else if (valueType === 'constant_value' && constantValue) {
                property.constant_value = constantValue;
            } else if (valueType === 'dynamic_variable' && dynamicVar) {
                property.dynamic_variable = dynamicVar;
            }
            
            properties.push(property);
        }
    });
    return properties;
}

function collectRequestHeaders() {
    const headers = [];
    const container = document.getElementById("request_headers_container");
    const headerElements = container.querySelectorAll('.header-item');
    
    headerElements.forEach(element => {
        const name = element.querySelector('.header-name').value;
        const value = element.querySelector('.header-value').value;
        const type = element.querySelector('.header-type').value;
        
        if (name && value) {
            headers.push({ name, value, type });
        }
    });
    return headers;
}

function collectDynamicVariables() {
    const variables = [];
    const container = document.getElementById("dynamic_variables_container");
    const varElements = container.querySelectorAll('.variable-item');
    
    varElements.forEach(element => {
        const name = element.querySelector('.variable-name').value;
        const value = element.querySelector('.variable-value').value;
        
        if (name) {
            variables.push({ name, value });
        }
    });
    return variables;
}

function collectAssignments() {
    const assignments = [];
    const container = document.getElementById("assignments_container");
    const assignmentElements = container.querySelectorAll('.assignment-item');
    
    assignmentElements.forEach(element => {
        const dynamicVar = element.querySelector('.assignment-dynamic-var').value;
        const valuePath = element.querySelector('.assignment-value-path').value;
        const source = element.querySelector('.assignment-source').value;
        
        if (dynamicVar && valuePath) {
            assignments.push({ dynamic_variable: dynamicVar, value_path: valuePath, source });
        }
    });
    return assignments;
}

// Function to clear the webhook form
function clearWebhookForm() {
    // Clear basic fields
    document.getElementById("tool_name").value = '';
    document.getElementById("tool_description").value = '';
    document.getElementById("api_url").value = '';
    document.getElementById("http_method").value = 'POST';
    document.getElementById("response_timeout").value = '20';
    document.getElementById("body_description").value = '';
    document.getElementById("disable_interruptions").checked = false;
    document.getElementById("force_pre_tool_speech").checked = false;
    
    // Clear dynamic containers and set default messages
    document.getElementById("path_params_container").innerHTML = '<p class="text-muted">No path parameters defined</p>';
    document.getElementById("query_params_container").innerHTML = '<p class="text-muted">No query parameters defined</p>';
    document.getElementById("request_body_properties_container").innerHTML = '<p class="text-muted">No properties defined</p>';
    document.getElementById("request_headers_container").innerHTML = '<p class="text-muted">No headers defined</p>';
    document.getElementById("dynamic_variables_container").innerHTML = '<p class="text-muted">No dynamic variables defined</p>';
    document.getElementById("assignments_container").innerHTML = '<p class="text-muted">No assignments defined</p>';
}

// Function to check if URL contains curly braces for path parameters
function checkUrlForPathParams() {
    const apiUrl = document.getElementById("api_url").value;
    const addPathParamBtn = document.getElementById("add-path-param-btn");
    const pathParamsHelp = document.getElementById("path_params_help");
    
    if (!addPathParamBtn) return; // Button doesn't exist yet
    
    // Check if URL contains curly braces pattern like {param_name}
    const hasCurlyBraces = /\{[^}]+\}/.test(apiUrl);
    
    if (hasCurlyBraces) {
        addPathParamBtn.disabled = false;
        addPathParamBtn.classList.remove('btn-outline-secondary');
        addPathParamBtn.classList.add('btn-outline-primary');
        if (pathParamsHelp) pathParamsHelp.style.display = 'none';
    } else {
        addPathParamBtn.disabled = true;
        addPathParamBtn.classList.remove('btn-outline-primary');
        addPathParamBtn.classList.add('btn-outline-secondary');
        if (pathParamsHelp) pathParamsHelp.style.display = 'block';
    }
}

// Function to toggle request body schema section based on HTTP method
function toggleRequestBodySchema() {
    const httpMethod = document.getElementById("http_method").value;
    const requestBodySection = document.getElementById("request_body_schema_section");
    
    if (!requestBodySection) return;
    
    // Show request body schema only for POST, PUT, PATCH methods
    if (["POST", "PUT", "PATCH"].includes(httpMethod)) {
        requestBodySection.style.display = 'block';
    } else {
        requestBodySection.style.display = 'none';
        // Clear any existing body properties when hiding
        document.getElementById("request_body_properties_container").innerHTML = '';
        document.getElementById("body_description").value = '';
    }
}

// Function to toggle edit modal request body schema section based on HTTP method
function toggleEditRequestBodySchema() {
    const httpMethod = document.getElementById("edit_http_method").value;
    const requestBodySection = document.getElementById("edit_request_body_schema_section");
    
    if (!requestBodySection) return;
    
    // Show request body schema only for POST, PUT, PATCH methods
    if (["POST", "PUT", "PATCH"].includes(httpMethod)) {
        requestBodySection.style.display = 'block';
    } else {
        requestBodySection.style.display = 'none';
        // Clear any existing body properties when hiding
        document.getElementById("edit_request_body_properties_container").innerHTML = '';
        document.getElementById("edit_body_description").value = '';
    }
}

// Function to check if edit modal URL contains curly braces for path parameters
function checkEditUrlForPathParams() {
    const apiUrl = document.getElementById("edit_api_url").value;
    const addPathParamBtn = document.getElementById("add-edit-path-param-btn");
    const pathParamsHelp = document.getElementById("edit_path_params_help");
    
    if (!addPathParamBtn) return; // Button doesn't exist yet
    
    // Check if URL contains curly braces pattern like {param_name}
    const hasCurlyBraces = /\{[^}]+\}/.test(apiUrl);
    
    if (hasCurlyBraces) {
        addPathParamBtn.disabled = false;
        addPathParamBtn.classList.remove('btn-outline-secondary');
        addPathParamBtn.classList.add('btn-outline-primary');
        if (pathParamsHelp) pathParamsHelp.style.display = 'none';
    } else {
        addPathParamBtn.disabled = true;
        addPathParamBtn.classList.remove('btn-outline-primary');
        addPathParamBtn.classList.add('btn-outline-secondary');
        if (pathParamsHelp) pathParamsHelp.style.display = 'block';
    }
}

// Dynamic form element creation functions
function addPathParam() {
    // Check if URL contains curly braces before allowing path parameter addition
    const apiUrl = document.getElementById("api_url").value;
    const hasCurlyBraces = /\{[^}]+\}/.test(apiUrl);
    
    if (!hasCurlyBraces) {
        toastr.error('Please add curly braces to the URL (e.g., {agent_id}) before adding path parameters');
        return;
    }
    
    const container = document.getElementById("path_params_container");
    const paramId = 'path_param_' + Date.now();
    
    const paramHtml = `
        <div class="param-item border rounded p-3 mb-3" id="${paramId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Path Parameter</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${paramId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" placeholder="agent_id" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input param-required" type="checkbox" checked>
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="togglePathParamValueType('${paramId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${paramId}_value_container">
                        <label class="form-label">Description</label>
                        <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', paramHtml);
    
    // Initialize field states for the new row
    const newRow = container.lastElementChild;
    initializeRowFieldStates(newRow);
    
    // Update Parameters field
    updateParametersField();
}

function togglePathParamValueType(paramId) {
    const container = document.getElementById(paramId + '_value_container');
    const valueTypeSelect = document.querySelector(`#${paramId} .param-value-type`);
    const valueType = valueTypeSelect.value;
    
    let html = '';
    if (valueType === 'llm_prompt') {
        html = `
            <label class="form-label">Description</label>
            <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
    } else if (valueType === 'constant_value') {
        html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="12345">
            <small class="text-muted">The constant value that will be used for this parameter.</small>
        `;
    } else if (valueType === 'dynamic_variable') {
        html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-var" placeholder="user_id">
            <small class="text-muted">The dynamic variable that will be replaced with actual values when the conversation starts.</small>
        `;
    }
    
    container.innerHTML = html;
}

function addQueryParam() {
    const container = document.getElementById("query_params_container");
    const paramId = 'query_param_' + Date.now();
    
    const paramHtml = `
        <div class="param-item border rounded p-3 mb-3" id="${paramId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Query Parameter</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${paramId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" placeholder="limit" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input param-required" type="checkbox" checked>
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleQueryParamValueType('${paramId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${paramId}_value_container">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control param-description" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', paramHtml);
    
    // Initialize field states for the new row
    const newRow = container.lastElementChild;
    initializeRowFieldStates(newRow);
}

function toggleQueryParamValueType(paramId) {
    const container = document.getElementById(paramId + '_value_container');
    const valueTypeSelect = document.querySelector(`#${paramId} .param-value-type`);
    const valueType = valueTypeSelect.value;
    
    let html = '';
    if (valueType === 'llm_prompt') {
        html = `
            <label class="form-label">Description</label>
            <input type="text" class="form-control param-description" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
    } else if (valueType === 'constant_value') {
        html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="10">
            <small class="text-muted">The constant value that will be used for this parameter.</small>
        `;
    } else if (valueType === 'dynamic_variable') {
        html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-var" placeholder="user_id">
            <small class="text-muted">The dynamic variable that will be replaced with actual values when the conversation starts.</small>
        `;
    }
    
    container.innerHTML = html;
}

function addRequestBodyProperty() {
    const container = document.getElementById("request_body_properties_container");
    const propId = 'property_' + Date.now();
    
    const propHtml = `
        <div class="property-item border rounded p-3 mb-3" id="${propId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Request Body Property</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${propId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select property-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="object">Object</option>
                        <option value="array">Array</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control property-name" placeholder="message" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input property-required" type="checkbox">
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select property-value-type" onchange="toggleBodyPropertyValueType('${propId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="property-value-container" id="${propId}_value_container">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control property-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript." required></textarea>
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript. <strong>Required for LLM Prompt type.</strong></small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', propHtml);
    
    // Initialize field states for the new row
    const newRow = container.lastElementChild;
    initializeRowFieldStates(newRow);
}

function toggleBodyPropertyValueType(propId) {
    const container = document.getElementById(propId + '_value_container');
    const valueTypeSelect = document.querySelector(`#${propId} .property-value-type`);
    const valueType = valueTypeSelect.value;
    
    let html = '';
    if (valueType === 'llm_prompt') {
        html = `
            <label class="form-label">Description</label>
            <textarea class="form-control property-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
    } else if (valueType === 'constant_value') {
        html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control property-constant-value" placeholder="Hello">
            <small class="text-muted">The constant value that will be used for this property.</small>
        `;
    } else if (valueType === 'dynamic_variable') {
        html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control property-dynamic-var" placeholder="user_message">
            <small class="text-muted">The dynamic variable that will be replaced with actual values when the conversation starts.</small>
        `;
    }
    
    container.innerHTML = html;
}

function addRequestHeader() {
    const container = document.getElementById("request_headers_container");
    const headerId = 'header_' + Date.now();
    
    const headerHtml = `
        <div class="header-item border rounded p-3 mb-3" id="${headerId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Request Header</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${headerId}')">Remove</button>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Header Name *</label>
                    <input type="text" class="form-control header-name" placeholder="Content-Type" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Type</label>
                    <select class="form-select header-type">
                        <option value="string" selected>String</option>
                        <option value="secret">Secret</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Value *</label>
                    <input type="text" class="form-control header-value" placeholder="application/json" required>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', headerHtml);
}

function addDynamicVariable() {
    const container = document.getElementById("dynamic_variables_container");
    const varId = 'variable_' + Date.now();
    
    const varHtml = `
        <div class="variable-item border rounded p-3 mb-3" id="${varId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Dynamic Variable</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${varId}')">Remove</button>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Variable Name *</label>
                    <input type="text" class="form-control variable-name" placeholder="user_id" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Value *</label>
                    <input type="text" class="form-control variable-value" placeholder="12345" required>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', varHtml);
}

function addAssignment() {
    const container = document.getElementById("assignments_container");
    const assignmentId = 'assignment_' + Date.now();
    
    const assignmentHtml = `
        <div class="assignment-item border rounded p-3 mb-3" id="${assignmentId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Response Assignment</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${assignmentId}')">Remove</button>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Dynamic Variable *</label>
                    <input type="text" class="form-control assignment-dynamic-var" placeholder="response_id" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Value Path *</label>
                    <input type="text" class="form-control assignment-value-path" placeholder="data.id" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Source</label>
                    <select class="form-select assignment-source">
                        <option value="response" selected>Response</option>
                        <option value="request">Request</option>
                    </select>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', assignmentHtml);
}

// Helper function to remove elements
function removeElement(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.remove();
    }
}


function updateFunctionElement(functionData) {
    const $li = $(`#function-${functionData.id}`);
    if ($li.length) {
        $li.find('div.functionNameDivBlock').text(functionData.function_name);
        $li.find('.edit-function-btn').attr('onclick', `editFunction(${functionData.id})`);
        $li.find('.delete-function-btn').attr('onclick', `deleteFunction(${functionData.id})`);
    }
}


function handleEditCustomFunction(functionId){
    
    
    // Basic tool information
    let toolName = document.getElementById("edit_tool_name").value;
    let toolDescription = document.getElementById("edit_tool_description").value;
    let responseTimeout = document.getElementById("edit_response_timeout").value;
    let apiUrl = document.getElementById("edit_api_url").value;
    let httpMethod = document.getElementById("edit_http_method").value;
    let bodyDescription = document.getElementById("edit_body_description").value;
    let functionParameters = document.getElementById("edit-parameters").value;
    
    // Advanced options
    let disableInterruptions = document.getElementById("edit_disable_interruptions").checked;
    let forcePreToolSpeech = document.getElementById("edit_force_pre_tool_speech").checked;
    
    // Frontend validation for ElevenLabs API compliance
    if (!validateElevenLabsCompliance(httpMethod, bodyDescription)) {
        return; // Stop if validation fails
    }
    
    const currentUrl = new URL(window.location.href);
    const agentId = currentUrl.searchParams.get("agent_id");

    // Collect path parameters with validation
    let pathParams = [];
    document.querySelectorAll('#edit_path_params_container .path-param-row').forEach((row, index) => {
        let name = row.querySelector('input[name="path_param_name"]').value;
        let type = row.querySelector('select[name="path_param_type"]').value;
        let description = row.querySelector('input[name="path_param_description"]').value;
        let dynamicVariable = row.querySelector('input[name="path_param_dynamic_variable"]').value;
        let constantValue = row.querySelector('input[name="path_param_constant_value"]').value;
        
        if (name) {
            // Validate path parameter (only one of description, dynamic_variable, or constant_value)
            if (!validatePathParameter(description, dynamicVariable, constantValue, index + 1)) {
                return; // Stop if validation fails
            }
            
            pathParams.push({ 
                name, 
                type, 
                description, 
                dynamic_variable: dynamicVariable,
                constant_value: constantValue
            });
        }
    });

    // Validate path parameters against URL placeholders
    if (!validatePathParametersAgainstURL(apiUrl, pathParams)) {
        return; // Stop if validation fails
    }

    // Collect query parameters
    let queryParams = [];
    document.querySelectorAll('#edit_query_params_container .query-param-row').forEach((row, index) => {
        let name = row.querySelector('input[name="query_param_name"]').value;
        let type = row.querySelector('select[name="query_param_type"]').value;
        let required = row.querySelector('input[name="query_param_required"]').checked;
        let description = row.querySelector('input[name="query_param_description"]').value;
        if (name) {
            queryParams.push({ name, type, required, description });
        }
    });

    // Collect request body properties
    let requestBodyProperties = [];
    document.querySelectorAll('#edit_request_body_properties_container .body-property-row').forEach((row, index) => {
        let name = row.querySelector('input[name="body_property_name"]').value;
        let type = row.querySelector('select[name="body_property_type"]').value;
        let required = row.querySelector('input[name="body_property_required"]').checked;
        let description = row.querySelector('input[name="body_property_description"]').value;
        if (name) {
            requestBodyProperties.push({ name, type, required, description });
        }
    });

    // Collect request headers
    let requestHeaders = [];
    document.querySelectorAll('#edit_request_headers_container .header-row').forEach((row, index) => {
        let name = row.querySelector('input[name="header_name"]').value;
        let value = row.querySelector('input[name="header_value"]').value;
        if (name && value) {
            requestHeaders.push({ name, value });
        }
    });

    // Collect dynamic variables
    let dynamicVariables = [];
    document.querySelectorAll('#edit_dynamic_variables_container .variable-row').forEach((row, index) => {
        let name = row.querySelector('input[name="variable_name"]').value;
        let value = row.querySelector('input[name="variable_value"]').value;
        if (name && value) {
            dynamicVariables.push({ name, value });
        }
    });

    // Collect assignments
    let assignments = [];
    document.querySelectorAll('#edit_assignments_container .assignment-row').forEach((row, index) => {
        let variable = row.querySelector('input[name="assignment_variable"]').value;
        let path = row.querySelector('input[name="assignment_path"]').value;
        if (variable && path) {
            assignments.push({ variable, path });
        }
    });

    // Parse JSON parameters if provided
    let parsedParameters = {};
    if (functionParameters) {
        try {
            parsedParameters = JSON.parse(functionParameters);
        } catch (e) {
            toastr.error('Invalid JSON format in parameters field');
            return;
        }
    }

    // Build comprehensive tool config
    let toolConfig = {
        api_url: apiUrl,
        response_timeout_secs: parseInt(responseTimeout) || 20,
        http_method: httpMethod,
        body_description: bodyDescription,
        path_params: pathParams,
        query_params: queryParams,
        request_body_properties: requestBodyProperties,
        request_headers: requestHeaders,
        dynamic_variables: dynamicVariables,
        assignments: assignments,
        disable_interruptions: disableInterruptions,
        force_pre_tool_speech: forcePreToolSpeech,
        ...parsedParameters
    };

    let data = {
        function_name: toolName,
        function_description: toolDescription,
        function_url: apiUrl,
        function_timeout: parseInt(responseTimeout) || 20,
        function_parameters: toolConfig,
        agent_id: agentId
    };



    $.ajax({
        url: `{{ host }}/elevenlabs/api/v1/edit-custom-functions/${functionId}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            
            if(response.status == "success"){
                toastr.success('Custom function saved successfully');
                $('#customFunctionEditModal').modal('hide');
                // Clear form fields
                document.getElementById("edit_tool_name").value = '';
                document.getElementById("edit_tool_description").value = '';
                document.getElementById("edit_api_url").value = '';
                document.getElementById("edit_response_timeout").value = '';
                document.getElementById("edit-parameters").value = '';
                var functionData = response.data
                updateFunctionElement(functionData);
            }
            else{
                toastr.error(response.message || 'Something went wrong!');
            }
        },
        error: function(xhr, status, error) {
            let errorMessage = xhr?.responseJSON?.message;
            toastr.error(errorMessage || 'Error saving custom function: ' + error);
        }
    });
}

// Helper functions for generating HTML for edit modal
function generatePathParamsHTML(pathParams) {
    if (!pathParams || pathParams.length === 0) {
        return '<p class="text-muted">No path parameters defined</p>';
    }
    return pathParams.map((param, index) => {
        const paramId = 'edit_path_param_' + index;
        return `
        <div class="param-item border rounded p-3 mb-3" id="${paramId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Path Parameter</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditPathParam(${index})">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" ${param.type === 'string' ? 'selected' : ''}>String</option>
                        <option value="integer" ${param.type === 'integer' ? 'selected' : ''}>Integer</option>
                        <option value="number" ${param.type === 'number' ? 'selected' : ''}>Number</option>
                        <option value="boolean" ${param.type === 'boolean' ? 'selected' : ''}>Boolean</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" value="${param.name || ''}" placeholder="agent_id" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input param-required" type="checkbox" ${param.required ? 'checked' : ''}>
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleEditPathParamValueType('${paramId}')">
                        <option value="llm_prompt" ${param.value_type === 'llm_prompt' ? 'selected' : ''}>LLM Prompt</option>
                        <option value="constant_value" ${param.value_type === 'constant_value' ? 'selected' : ''}>Constant Value</option>
                        <option value="dynamic_variable" ${param.value_type === 'dynamic_variable' ? 'selected' : ''}>Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${paramId}_value_container">
                        <label class="form-label">Description</label>
                        <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">${param.description || ''}</textarea>
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

function generateQueryParamsHTML(queryParams) {
    if (!queryParams || queryParams.length === 0) {
        return '<p class="text-muted">No query parameters defined</p>';
    }
    return queryParams.map((param, index) => {
        const paramId = 'edit_query_param_' + index;
        return `
        <div class="param-item border rounded p-3 mb-3" id="${paramId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Query Parameter</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditQueryParam(${index})">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" ${param.type === 'string' ? 'selected' : ''}>String</option>
                        <option value="integer" ${param.type === 'integer' ? 'selected' : ''}>Integer</option>
                        <option value="number" ${param.type === 'number' ? 'selected' : ''}>Number</option>
                        <option value="boolean" ${param.type === 'boolean' ? 'selected' : ''}>Boolean</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" value="${param.name || ''}" placeholder="limit" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input param-required" type="checkbox" ${param.required ? 'checked' : ''}>
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleEditQueryParamValueType('${paramId}')">
                        <option value="llm_prompt" ${param.value_type === 'llm_prompt' ? 'selected' : ''}>LLM Prompt</option>
                        <option value="constant_value" ${param.value_type === 'constant_value' ? 'selected' : ''}>Constant Value</option>
                        <option value="dynamic_variable" ${param.value_type === 'dynamic_variable' ? 'selected' : ''}>Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${paramId}_value_container">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control param-description" value="${param.description || ''}" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

function generateRequestBodyPropertiesHTML(properties) {
    if (!properties || properties.length === 0) {
        return '<p class="text-muted">No properties defined</p>';
    }
    return properties.map((prop, index) => {
        const propId = 'edit_property_' + index;
        return `
        <div class="property-item border rounded p-3 mb-3" id="${propId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Request Body Property</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditRequestBodyProperty(${index})">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select property-type">
                        <option value="string" ${prop.type === 'string' ? 'selected' : ''}>String</option>
                        <option value="integer" ${prop.type === 'integer' ? 'selected' : ''}>Integer</option>
                        <option value="number" ${prop.type === 'number' ? 'selected' : ''}>Number</option>
                        <option value="boolean" ${prop.type === 'boolean' ? 'selected' : ''}>Boolean</option>
                        <option value="object" ${prop.type === 'object' ? 'selected' : ''}>Object</option>
                        <option value="array" ${prop.type === 'array' ? 'selected' : ''}>Array</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control property-name" value="${prop.name || ''}" placeholder="message" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input property-required" type="checkbox" ${prop.required ? 'checked' : ''}>
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select property-value-type" onchange="toggleEditBodyPropertyValueType('${propId}')">
                        <option value="llm_prompt" ${prop.value_type === 'llm_prompt' ? 'selected' : ''}>LLM Prompt</option>
                        <option value="constant_value" ${prop.value_type === 'constant_value' ? 'selected' : ''}>Constant Value</option>
                        <option value="dynamic_variable" ${prop.value_type === 'dynamic_variable' ? 'selected' : ''}>Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="property-value-container" id="${propId}_value_container">
                        <label class="form-label">Description</label>
                        <textarea class="form-control property-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">${prop.description || ''}</textarea>
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

function generateRequestHeadersHTML(headers) {
    if (!headers || headers.length === 0) {
        return '<p class="text-muted">No headers defined</p>';
    }
    return headers.map((header, index) => `
        <div class="row mb-2 header-row" data-index="${index}">
            <div class="col-md-4">
                <input type="text" class="form-control" name="header_name" value="${header.name || ''}" placeholder="Header name">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="header_value" value="${header.value || ''}" placeholder="Header value">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditRequestHeader(${index})"></button>
            </div>
        </div>
    `).join('');
}

function generateDynamicVariablesHTML(variables) {
    if (!variables || variables.length === 0) {
        return '<p class="text-muted">No dynamic variables defined</p>';
    }
    return variables.map((variable, index) => `
        <div class="row mb-2 variable-row" data-index="${index}">
            <div class="col-md-4">
                <input type="text" class="form-control" name="variable_name" value="${variable.name || ''}" placeholder="Variable name">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="variable_description" value="${variable.description || ''}" placeholder="Variable description">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditDynamicVariable(${index})"></button>
            </div>
        </div>
    `).join('');
}

function generateAssignmentsHTML(assignments) {
    if (!assignments || assignments.length === 0) {
        return '<p class="text-muted">No assignments defined</p>';
    }
    return assignments.map((assignment, index) => `
        <div class="row mb-2 assignment-row" data-index="${index}">
            <div class="col-md-4">
                <input type="text" class="form-control" name="assignment_variable" value="${assignment.variable_name || ''}" placeholder="Variable name">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="assignment_path" value="${assignment.response_path || ''}" placeholder="JSON path (e.g., $.data.id)">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditAssignment(${index})"></button>
            </div>
        </div>
    `).join('');
}

// Helper function to extract and flatten tool configuration for edit modal
function extractToolConfigForEdit(rawToolConfig) {
    
    
    // Initialize the flattened structure
    var toolConfig = {
        http_method: 'POST',
        body_description: '',
        path_params: [],
        query_params: [],
        request_body_properties: [],
        request_headers: [],
        dynamic_variables: [],
        assignments: [],
        disable_interruptions: false,
        force_pre_tool_speech: false
    };
    
    // Check if we have the nested structure
    if (rawToolConfig && rawToolConfig.tool_config) {
        var innerConfig = rawToolConfig.tool_config;
        var apiSchema = innerConfig.api_schema || {};
        
        // Extract basic info
        toolConfig.http_method = apiSchema.method || 'POST';
        toolConfig.body_description = apiSchema.request_body_schema?.description || '';
        toolConfig.disable_interruptions = innerConfig.disable_interruptions || false;
        toolConfig.force_pre_tool_speech = innerConfig.force_pre_tool_speech || false;
        
        // Extract path parameters
        if (apiSchema.path_params_schema && apiSchema.path_params_schema.properties) {
            toolConfig.path_params = Object.entries(apiSchema.path_params_schema.properties).map(([name, config]) => ({
                name: name,
                type: config.type || 'string',
                required: apiSchema.path_params_schema.required?.includes(name) || false,
                description: config.description || '',
                value_type: config.value_type || 'llm_prompt',
                constant_value: config.constant_value || '',
                dynamic_variable: config.dynamic_variable || ''
            }));
        }
        
        // Extract query parameters
        if (apiSchema.query_params_schema && apiSchema.query_params_schema.properties) {
            toolConfig.query_params = Object.entries(apiSchema.query_params_schema.properties).map(([name, config]) => ({
                name: name,
                type: config.type || 'string',
                required: apiSchema.query_params_schema.required?.includes(name) || false,
                description: config.description || '',
                value_type: config.value_type || 'llm_prompt',
                constant_value: config.constant_value || '',
                dynamic_variable: config.dynamic_variable || ''
            }));
        }
        
        // Extract request body properties
        if (apiSchema.request_body_schema && apiSchema.request_body_schema.properties) {
            toolConfig.request_body_properties = Object.entries(apiSchema.request_body_schema.properties).map(([name, config]) => ({
                name: name,
                type: config.type || 'string',
                required: apiSchema.request_body_schema.required?.includes(name) || false,
                description: config.description || '',
                value_type: config.value_type || 'llm_prompt',
                constant_value: config.constant_value || '',
                dynamic_variable: config.dynamic_variable || ''
            }));
        }
        
        // Extract request headers
        if (apiSchema.request_headers) {
            toolConfig.request_headers = Object.entries(apiSchema.request_headers).map(([name, value]) => ({
                name: name,
                value: value,
                value_type: 'constant_value'
            }));
        }
        
        // Extract dynamic variables
        if (innerConfig.dynamic_variables && innerConfig.dynamic_variables.dynamic_variable_placeholders) {
            toolConfig.dynamic_variables = Object.entries(innerConfig.dynamic_variables.dynamic_variable_placeholders).map(([name, config]) => ({
                name: name,
                description: config.description || '',
                value_type: config.value_type || 'llm_prompt',
                constant_value: config.constant_value || '',
                dynamic_variable: config.dynamic_variable || ''
            }));
        }
        
        // Extract assignments
        if (innerConfig.assignments) {
            toolConfig.assignments = innerConfig.assignments.map(assignment => ({
                response_path: assignment.response_path || '',
                variable_name: assignment.variable_name || '',
                description: assignment.description || ''
            }));
        }
    }
    
    
    return toolConfig;
}

function editFunction(functionId) {
    
    
    $.ajax({
        url: "{{ host }}/elevenlabs/api/v1/get-custom-functions",
        type: 'GET',
        data: { function_id: functionId },
        success: function(response) {
            
            
            if (!response.data) {
                toastr.error('No function data found.');
                return;
            }

            var functionData = response.data;
            var rawToolConfig = functionData.function_parameters || {};
            
         
            
            // Extract and flatten the tool configuration for the edit modal
            var toolConfig = extractToolConfigForEdit(rawToolConfig);
            
            var modal = `
                <div class="modal fade custom_function_modal" id="customFunctionEditModal" tabindex="-1" aria-labelledby="customFunctionEditModalLabel">
                    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="mb-0 d-flex align-items-center gap-2" id="customFunctionEditModalLabel">
                                    <span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M4.33337 14.6667V10" stroke="#525866" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M4.33337 3.33398V1.33398" stroke="#525866" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M11.6666 14.666V12.666" stroke="#525866" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M11.6666 6.00065V1.33398" stroke="#525866" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M6.33337 4.66732V8.66732C6.33337 9.40065 6.00004 10.0007 5.00004 10.0007H3.66671C2.66671 10.0007 2.33337 9.40065 2.33337 8.66732V4.66732C2.33337 3.93398 2.66671 3.33398 3.66671 3.33398H5.00004C6.00004 3.33398 6.33337 3.93398 6.33337 4.66732Z" stroke="#525866" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M13.6666 7.33333V11.3333C13.6666 12.0667 13.3333 12.6667 12.3333 12.6667H11C9.99996 12.6667 9.66663 12.0667 9.66663 11.3333V7.33333C9.66663 6.6 9.99996 6 11 6H12.3333C13.3333 6 13.6666 6.6 13.6666 7.33333Z" stroke="#525866" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                    </span>
                                    Edit Webhook Tool
                                </h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editFunctionForm">
                                    <!-- Basic Tool Information -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">Tool Configuration</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                    <div class="form_field mb-3">
                                                        <label for="edit_tool_name" class="form-label">Tool Name *</label>
                                                        <input type="text" class="form-control" id="edit_tool_name" value="${functionData.function_name || ''}" placeholder="my_webhook_tool" required>
                                                        <small class="text-muted">Only letters, numbers, underscores, and hyphens. Max 64 characters.</small>
                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                    <div class="form_field mb-3">
                                                        <label for="edit_response_timeout" class="form-label">Response Timeout (seconds)</label>
                                                        <input type="number" class="form-control" id="edit_response_timeout" value="${functionData.function_timeout || 20}" placeholder="20" min="5" max="120">
                                                        <small class="text-muted">Between 5-120 seconds</small>
                                    </div>
                                                </div>
                                            </div>
                                            
                                    <div class="form_field mb-3">
                                                <label for="edit_tool_description" class="form-label">Description *</label>
                                                <textarea class="form-control" id="edit_tool_description" placeholder="Describe what this webhook tool does" rows="2" required>${functionData.function_description || ''}</textarea>
                                    </div>
                                        </div>
                                    </div>

                                    <!-- API Schema Configuration -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">API Schema</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                    <div class="form_field mb-3">
                                                        <label for="edit_api_url" class="form-label">Webhook URL *</label>
                                                        <input type="url" class="form-control" id="edit_api_url" value="${functionData.function_url || ''}" placeholder="https://api.example.com/agents/{agent_id}" required>
                                                        <small class="text-muted">May include path parameters like {agent_id}</small>
                                        </div>
                                    </div>
                                                <div class="col-md-4">
                                                    <div class="form_field mb-3">
                                                        <label for="edit_http_method" class="form-label">HTTP Method</label>
                                                        <select class="form-select" id="edit_http_method">
                                                            <option value="GET" ${toolConfig.http_method === 'GET' ? 'selected' : ''}>GET</option>
                                                            <option value="POST" ${toolConfig.http_method === 'POST' || !toolConfig.http_method ? 'selected' : ''}>POST</option>
                                                            <option value="PUT" ${toolConfig.http_method === 'PUT' ? 'selected' : ''}>PUT</option>
                                                            <option value="PATCH" ${toolConfig.http_method === 'PATCH' ? 'selected' : ''}>PATCH</option>
                                                            <option value="DELETE" ${toolConfig.http_method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Path Parameters -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Path Parameters</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="add-edit-path-param-btn" onclick="addEditPathParam()" disabled>+ Add Path Parameter</button>
                                        </div>
                                        <div class="card-body">
                                            <small class="text-muted mb-3 d-block">Add path wrapped in curly braces to the URL to configure them here.</small>
                                            <div id="edit_path_params_help" class="alert alert-info mb-3" style="display: none;">
                                                <small><strong>Example:</strong> Add <code>{agent_id}</code> to your URL like: <code>https://api.example.com/agents/{agent_id}</code></small>
                                            </div>
                                            <div id="edit_path_params_container">
                                                ${generatePathParamsHTML(toolConfig.path_params || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Query Parameters -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Query Parameters</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditQueryParam()">+ Add Query Parameter</button>
                                        </div>
                                        <div class="card-body">
                                            <small class="text-muted mb-3 d-block">Parameters that will be added to the URL as query params (?param=value)</small>
                                            <div id="edit_query_params_container">
                                                ${generateQueryParamsHTML(toolConfig.query_params || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Request Body Schema -->
                                    <div class="card mb-3" id="edit_request_body_schema_section" style="display: ${['POST', 'PUT', 'PATCH'].includes(toolConfig.http_method) ? 'block' : 'none'};">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Request Body Schema</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditRequestBodyProperty()">+ Add Property</button>
                                        </div>
                                        <div class="card-body">
                                            <small class="text-muted mb-3 d-block">Define the JSON structure for POST/PUT/PATCH requests</small>
                                            <div class="form_field mb-3">
                                                <label for="edit_body_description" class="form-label">Body Description</label>
                                                <input type="text" class="form-control" id="edit_body_description" value="${toolConfig.body_description || ''}" placeholder="Description of the request body">
                                            </div>
                                            <div id="edit_request_body_properties_container">
                                                ${generateRequestBodyPropertiesHTML(toolConfig.request_body_properties || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Request Headers -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Request Headers</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditRequestHeader()">+ Add Header</button>
                                        </div>
                                        <div class="card-body">
                                            <small class="text-muted mb-3 d-block">Headers to include in the webhook request</small>
                                            <div id="edit_request_headers_container">
                                                ${generateRequestHeadersHTML(toolConfig.request_headers || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Dynamic Variables -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Dynamic Variables</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditDynamicVariable()">+ Add Variable</button>
                                        </div>
                                        <div class="card-body">
                                            <small class="text-muted mb-3 d-block">Variables that can be used in the webhook configuration</small>
                                            <div id="edit_dynamic_variables_container">
                                                ${generateDynamicVariablesHTML(toolConfig.dynamic_variables || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Response Assignments -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Response Assignments</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditAssignment()">+ Add Assignment</button>
                                        </div>
                                        <div class="card-body">
                                            <small class="text-muted mb-3 d-block">Extract values from webhook response and assign to dynamic variables</small>
                                            <div id="edit_assignments_container">
                                                ${generateAssignmentsHTML(toolConfig.assignments || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form_field mb-3 parameters_field">
                                        <label for="parameters" class="form-label mb-0">Parameters (Optional)</label>
                                        <small class="text-muted">JSON schema that defines the format in which the LLM will return. Please refer to the docs.</small>
                                        <textarea class="form-control my-2" id="edit-parameters" placeholder="Enter function parameters">${JSON.stringify(functionData.function_parameters, null, 2) || `{
  "tool_config": {
    "name": "",
    "type": "webhook",
    "api_schema": {
      "url": "",
      "method": "POST",
      "auth_connection": null,
      "request_headers": {},
      "path_params_schema": {},
      "query_params_schema": null,
      "request_body_schema": {
        "type": "object",
        "properties": {}
      }
    },
    "assignments": [],
    "description": "",
    "dynamic_variables": {
      "dynamic_variable_placeholders": {}
    },
    "disable_interruptions": false,
    "force_pre_tool_speech": false,
    "response_timeout_secs": 20
  }
}`}</textarea>
                                    </div>
                                    <div class="format_json_btn_box mb-3">
                                        <button type="button" onclick="EditformatJSON()" class="w-100">Format JSON</button>
                                    </div>

                                    <!-- Advanced Options -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">Advanced Options</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-check mb-3">
                                                        <input class="form-check-input" type="checkbox" id="edit_disable_interruptions" ${toolConfig.disable_interruptions ? 'checked' : ''}>
                                                        <label class="form-check-label" for="edit_disable_interruptions">
                                                            Disable Interruptions
                                                        </label>
                                                        <small class="text-muted d-block">User cannot interrupt while tool is running</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check mb-3">
                                                        <input class="form-check-input" type="checkbox" id="edit_force_pre_tool_speech" ${toolConfig.force_pre_tool_speech ? 'checked' : ''}>
                                                        <label class="form-check-label" for="edit_force_pre_tool_speech">
                                                            Force Pre-Tool Speech
                                                        </label>
                                                        <small class="text-muted d-block">Agent speaks before calling the tool</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
                                <button type="button" id="save-edit-custom-function" class="btn save_btn" onclick="handleEditCustomFunction('${functionId}')">Update Webhook Tool</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // Remove any existing modal
            $('#customFunctionEditModal').remove();
            // Append the new modal to body
            $('body').append(modal);
            // Show the modal
            $('#customFunctionEditModal').modal('show');
            
            // Add event listeners for edit modal validation
            setTimeout(() => {
                const editHttpMethodSelect = document.getElementById('edit_http_method');
                if (editHttpMethodSelect) {
                    // Check initial state
                    toggleEditRequestBodySchema();
                    
                    // Add event listener for real-time validation
                    editHttpMethodSelect.addEventListener('change', toggleEditRequestBodySchema);
                }
                
                const editApiUrlInput = document.getElementById('edit_api_url');
                if (editApiUrlInput) {
                    // Check initial state
                    checkEditUrlForPathParams();
                    
                    // Add event listener for real-time validation
                    editApiUrlInput.addEventListener('input', checkEditUrlForPathParams);
                    editApiUrlInput.addEventListener('blur', checkEditUrlForPathParams);
                }
            }, 100);
        },
        error: function(xhr, status, error) {
            toastr.error('Error fetching custom function: ' + xhr.responseText || error);
        }
    });
}

// Edit modal helper functions
function addEditPathParam() {
    // Check if URL contains curly braces before allowing path parameter addition
    const apiUrl = document.getElementById("edit_api_url").value;
    const hasCurlyBraces = /\{[^}]+\}/.test(apiUrl);
    
    if (!hasCurlyBraces) {
        toastr.error('Please add curly braces to the URL (e.g., {agent_id}) before adding path parameters');
        return;
    }
    
    const container = document.getElementById('edit_path_params_container');
    const paramId = 'edit_path_param_' + Date.now();
    
    const paramHtml = `
        <div class="param-item border rounded p-3 mb-3" id="${paramId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Path Parameter</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${paramId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" placeholder="agent_id" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input param-required" type="checkbox" checked>
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleEditPathParamValueType('${paramId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${paramId}_value_container">
                        <label class="form-label">Description</label>
                        <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', paramHtml);
    
    // Initialize field states for the new row
    const newRow = container.lastElementChild;
    initializeRowFieldStates(newRow);
}

function removeEditPathParam(index) {
    const row = document.querySelector(`#edit_path_params_container .path-param-row[data-index="${index}"]`);
    if (row) row.remove();
}

function toggleEditPathParamValueType(paramId) {
    const container = document.getElementById(paramId + '_value_container');
    const valueTypeSelect = document.querySelector(`#${paramId} .param-value-type`);
    const valueType = valueTypeSelect.value;
    
    let html = '';
    if (valueType === 'llm_prompt') {
        html = `
            <label class="form-label">Description</label>
            <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
    } else if (valueType === 'constant_value') {
        html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="Enter constant value">
        `;
    } else if (valueType === 'dynamic_variable') {
        html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-variable" placeholder="Enter dynamic variable name">
        `;
    }
    
    container.innerHTML = html;
}

function addEditQueryParam() {
    const container = document.getElementById('edit_query_params_container');
    const paramId = 'edit_query_param_' + Date.now();
    
    const paramHtml = `
        <div class="param-item border rounded p-3 mb-3" id="${paramId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Query Parameter</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${paramId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" placeholder="limit" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input param-required" type="checkbox" checked>
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleEditQueryParamValueType('${paramId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${paramId}_value_container">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control param-description" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', paramHtml);
    
    // Initialize field states for the new row
    const newRow = container.lastElementChild;
    initializeRowFieldStates(newRow);
}

function removeEditQueryParam(index) {
    const row = document.querySelector(`#edit_query_params_container .query-param-row[data-index="${index}"]`);
    if (row) row.remove();
}

function toggleEditQueryParamValueType(paramId) {
    const container = document.getElementById(paramId + '_value_container');
    const valueTypeSelect = document.querySelector(`#${paramId} .param-value-type`);
    const valueType = valueTypeSelect.value;
    
    let html = '';
    if (valueType === 'llm_prompt') {
        html = `
            <label class="form-label">Description</label>
            <input type="text" class="form-control param-description" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
    } else if (valueType === 'constant_value') {
        html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="Enter constant value">
        `;
    } else if (valueType === 'dynamic_variable') {
        html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-variable" placeholder="Enter dynamic variable name">
        `;
    }
    
    container.innerHTML = html;
}

function addEditRequestBodyProperty() {
    const container = document.getElementById('edit_request_body_properties_container');
    const propId = 'edit_property_' + Date.now();
    
    const propHtml = `
        <div class="property-item border rounded p-3 mb-3" id="${propId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Request Body Property</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${propId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select property-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="object">Object</option>
                        <option value="array">Array</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control property-name" placeholder="message" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input property-required" type="checkbox">
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select property-value-type" onchange="toggleEditBodyPropertyValueType('${propId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="property-value-container" id="${propId}_value_container">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control property-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript." required></textarea>
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript. <strong>Required for LLM Prompt type.</strong></small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', propHtml);
    
    // Initialize field states for the new row
    const newRow = container.lastElementChild;
    initializeRowFieldStates(newRow);
}

function removeEditRequestBodyProperty(index) {
    const row = document.querySelector(`#edit_request_body_properties_container .body-prop-row[data-index="${index}"]`);
    if (row) row.remove();
}

function toggleEditBodyPropertyValueType(propId) {
    const container = document.getElementById(propId + '_value_container');
    const valueTypeSelect = document.querySelector(`#${propId} .property-value-type`);
    const valueType = valueTypeSelect.value;
    
    let html = '';
    if (valueType === 'llm_prompt') {
        html = `
            <label class="form-label">Description</label>
            <textarea class="form-control property-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
    } else if (valueType === 'constant_value') {
        html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control property-constant-value" placeholder="Enter constant value">
        `;
    } else if (valueType === 'dynamic_variable') {
        html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control property-dynamic-variable" placeholder="Enter dynamic variable name">
        `;
    }
    
    container.innerHTML = html;
}

function addEditRequestHeader() {
    const container = document.getElementById('edit_request_headers_container');
    const index = container.children.length;
    const html = `
        <div class="row mb-2 header-row" data-index="${index}">
            <div class="col-md-4">
                <input type="text" class="form-control" name="header_name" placeholder="Header name">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="header_value" placeholder="Header value">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditRequestHeader(${index})"></button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function removeEditRequestHeader(index) {
    const row = document.querySelector(`#edit_request_headers_container .header-row[data-index="${index}"]`);
    if (row) row.remove();
}

function addEditDynamicVariable() {
    const container = document.getElementById('edit_dynamic_variables_container');
    const index = container.children.length;
    const html = `
        <div class="row mb-2 variable-row" data-index="${index}">
            <div class="col-md-4">
                <input type="text" class="form-control" name="variable_name" placeholder="Variable name">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="variable_value" placeholder="Variable value">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditDynamicVariable(${index})"></button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function removeEditDynamicVariable(index) {
    const row = document.querySelector(`#edit_dynamic_variables_container .variable-row[data-index="${index}"]`);
    if (row) row.remove();
}

function addEditAssignment() {
    const container = document.getElementById('edit_assignments_container');
    const index = container.children.length;
    const html = `
        <div class="row mb-2 assignment-row" data-index="${index}">
            <div class="col-md-4">
                <input type="text" class="form-control" name="assignment_variable" placeholder="Variable name">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="assignment_path" placeholder="JSON path (e.g., $.data.id)">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditAssignment(${index})"></button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function removeEditAssignment(index) {
    const row = document.querySelector(`#edit_assignments_container .assignment-row[data-index="${index}"]`);
    if (row) row.remove();
}



function setExampleJSON(exampleId) {
    const examples = {
        "example1": {
            "type": "object",
            "properties": {
                "appointment_available_ts": {
                    "type": "string",
                    "description": "The timestamp of the appointment that is available for booking."
                }
            },
            "required": ["appointment_available_ts"]
        },
        "example2": {
            "type": "object",
            "properties": {
                "city": {
                    "type": "string",
                    "description": "The city for which the weather is to be fetched."
                }
            },
            "required": ["city"]
        },
        "example3": {
            "type": "object",
            "properties": {
                "appointment_available_ts": {
                    "type": "string",
                    "description": "The timestamp of the appointment that is available for booking."
                },
                "doctor_name": {
                    "type": "string",
                    "description": "An optional field to specify the name of the doctor."
                }
            },
            "required": ["appointment_available_ts"]
        }
    };

    if (examples[exampleId]) {
        const parametersTextarea = document.getElementById(`edit-parameters`);
        parametersTextarea.value = JSON.stringify(examples[exampleId], null, 2);
    }
}

function EditformatJSON(){
    var jsonTextarea = document.getElementById("edit-parameters");
    var formattedJSON = jsonTextarea.value;
    jsonTextarea.value = formattedJSON;
}


function deleteFunction(functionId){
    $.ajax({
        url:  "{{ host }}/elevenlabs/api/v1/delete-custom-functions",
        type: 'DELETE',
        contentType: 'application/json',
        data: JSON.stringify({ function_id: functionId }),
        success: function(response) {
            toastr.success('Custom function deleted successfully');
            $('#function-'+functionId).remove();
            $('#customFunctionEditModal').modal('hide');
        },
        error: function(xhr, status, error) {
            toastr.error('Error deleting custom function: ' + error);
        }
    });
}

function saveVariable() {
    // Get all variable input pairs
    var variables = {};
    var variableItems = document.querySelectorAll('#dynamic-variables .variable-modal-content-item');

    variableItems.forEach(function(item, index) {
        var inputs = item.querySelectorAll('input');
        
        console.log(`Row ${index + 1}: Found ${inputs.length} inputs`);
        
        if (inputs.length >= 2) {
            var variableName = inputs[0].value.trim();
            var variableValue = inputs[1].value.trim();
            
            console.log(`Row ${index + 1}: Name="${variableName}", Value="${variableValue}"`);
            
            if (variableName) {
                variables[variableName] = variableValue;
            }
        }
    });
    const currentUrl = new URL(window.location.href);
    const agentId = currentUrl.searchParams.get("agent_id");


    // Save variables via AJAX
    $.ajax({
        url: "{{ host }}/elevenlabs/api/v1/save-variables",
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            variables: variables,
            agent_id: agentId
        }),
        success: function(response) {
            toastr.success('Variables saved successfully');
            const modal = document.getElementById('variable-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        },
        error: function(xhr, status, error) {
            toastr.error('Error saving variables: ' + error);
        }
    });
}

        function openDialog() {
            const dialog = document.getElementById("dialog");
            if (dialog) {
                dialog.style.display = dialog.style.display === "none" ? "block" : "none";
            }
        }
        
        function closeDialog() {
            const dialog = document.getElementById("dialog");
            if (dialog) {
                dialog.style.display = "none";
            }
        }

        const slider = document.getElementById("temperatureSlider");
        const sliderValue = document.getElementById("sliderValue");

        // Set initial value and position based on existing value
        const initialValue = slider.value;
        const initialPercentage = ((initialValue - slider.min) / (slider.max - slider.min)) * 100;
        sliderValue.textContent = parseFloat(initialValue).toFixed(1);
        sliderValue.style.left = initialPercentage + "%";

        slider.addEventListener("input", function() {
            let percentage = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
            sliderValue.textContent = parseFloat(slider.value).toFixed(1);
            sliderValue.style.left = percentage + "%";
        });

        function saveSettings(){
            const temperature = document.getElementById("temperatureSlider").value;
            const maxOutputTokens = document.getElementById("maxOutputTokensSlider").value;
            const currentUrl = new URL(window.location.href);
            const agentId = currentUrl.searchParams.get("agent_id");
            $.ajax({
                url: host + '/api/update-agent-settings',
                type: 'POST',
                contentType: 'application/json',    
                data: JSON.stringify({ temperature: temperature, max_output_tokens: maxOutputTokens, agent_id: agentId }),
                success: function(response) {
                    if(response.status == "success"){
                        toastr.success('Settings saved successfully');
                        const dialog = document.getElementById("dialog");
                        if (dialog) {
                            dialog.style.display = "none";
                        }
                    }
                    else{
                        toastr.error(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    if(xhr.responseJSON.message){
                        toastr.error(xhr.responseJSON.message);
                    }
                    else{
                        toastr.error('Error saving settings: ' + error);
                    }
                }
            });
        }

        function toggleTokenModal() {
            const tokenModal = document.getElementById('token-modal');
            tokenModal.style.display = tokenModal.style.display === 'none' ? 'block' : 'none';
        }

        function saveTokenSettings() {
            const overallTokenLimit = document.getElementById('overall-token-limit').value;
            const dailyTokenLimit = document.getElementById('daily-token-limit').value;
            const perCallTokenLimit = document.getElementById('per-call-token-limit').value;
            if(overallTokenLimit == "" || dailyTokenLimit == "" || perCallTokenLimit == ""){
                toastr.error('Please fill all the fields');
                return;
            }
            const currentUrl = new URL(window.location.href);   
            const agentId = currentUrl.searchParams.get("agent_id");
            $.ajax({
                url: host + '/api/update-agent-token-settings',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ overall_token_limit: overallTokenLimit, daily_token_limit: dailyTokenLimit, per_call_token_limit: perCallTokenLimit, agent_id: agentId }),
                success: function(response) {
                    if(response.status == "success"){
                        toastr.success('Token settings saved successfully');
                        toggleTokenModal();
                    }
                    else{
                        toastr.error(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    if(xhr.responseJSON.message){
                        toastr.error(xhr.responseJSON.message);
                    }
                    else{
                        toastr.error('Error saving token settings: ' + error);
                    }
                }
            });
        }
    </script>

    <script>
        function updateAgentSetting(field, value) {
            const currentUrl = new URL(window.location.href);
            const agentId = currentUrl.searchParams.get("agent_id");
        
            fetch(`${host}/elevenlabs/api/v1/edit_agent`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({
                    agent_id: agentId,
                    [field]: value   // dynamic key
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    toastr.success("Agent updated successfully");
                } else {
                    toastr.error(data.message || "Failed to update agent");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                toastr.error("Something went wrong!");
            });
        }

        // Function to show dynamic variables when detected
        function showDynamicVariables(variables) {
            const dynamicVarsSection = document.getElementById("dynamic-variables-section");
            const dynamicVarsDiv = document.getElementById("dynamic-variables");
            
            if (!variables || Object.keys(variables).length === 0) {
                dynamicVarsSection.style.display = "none";
                return;
            }
            
            // Show the section
            dynamicVarsSection.style.display = "block";
            
            // Clear existing variables
            dynamicVarsDiv.innerHTML = "";
            
            // Add each variable
            Object.entries(variables).forEach(([varName, varValue]) => {
                const varDiv = document.createElement("div");
                varDiv.className = "variable-modal-content-item mb-2";
                varDiv.innerHTML = `
                    <input type="text" class="form-control" value="${varName}" readonly>
                    <input type="text" class="form-control" value="${varValue}" placeholder="Enter value" onchange="updateVariableValue('${varName}', this.value)">
                    <button class="dlt_btn bg-transparent border-0 p-0" onclick="removeVariable(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-1V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                    </button>
                `;
                dynamicVarsDiv.appendChild(varDiv);
            });
        }

        // Function to update variable value
        function updateVariableValue(varName, value) {
            const currentUrl = new URL(window.location.href);
            const agentId = currentUrl.searchParams.get("agent_id");
            
            
            
            // Update the variable in the backend
            fetch(`${host}/elevenlabs/api/v1/edit_agent`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({
                    agent_id: agentId,
                    dynamic_variable_update: {
                        [varName]: value
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    toastr.success(`Variable ${varName} updated successfully`, { positionClass: "toast-top-right" });
                } else {
                    toastr.error(data.message || "Failed to update variable");
                }
            })
            .catch(error => {
                console.error("Error updating variable:", error);
                toastr.error("Error updating variable");
            });
        }

        // ElevenLabs API Compliance Validation Functions
        function validateElevenLabsCompliance(httpMethod, bodyDescription) {
            // Rule 1: Request body schema only allowed for POST/PUT/PATCH methods
            if (httpMethod && !['POST', 'PUT', 'PATCH'].includes(httpMethod.toUpperCase())) {
                if (bodyDescription && bodyDescription.trim() !== '') {
                    toastr.error(`Request body description is not allowed for ${httpMethod} method. Only POST, PUT, and PATCH methods support request body schemas.`);
                    return false;
                }
            }
            return true;
        }

        // Function to validate path parameters against URL placeholders
        function validatePathParametersAgainstURL(apiUrl, pathParams) {
            const urlPlaceholders = apiUrl.match(/\{([^}]+)\}/g) || [];
            const urlParamNames = urlPlaceholders.map(placeholder => placeholder.slice(1, -1));
            
            for (const param of pathParams) {
                const paramName = param.name?.trim();
                if (paramName && !urlParamNames.includes(paramName)) {
                    toastr.error(`Path parameter "${paramName}" is defined but the URL doesn't contain the placeholder "{${paramName}}". Please either:\n1. Add {${paramName}} to the URL, or\n2. Remove this path parameter.`);
                    return false;
                }
            }
            return true;
        }

        function validatePathParameter(description, dynamicVariable, constantValue, paramIndex) {
            // Rule 2: Path parameters can only have one of: description, dynamic_variable, or constant_value
            let filledFields = 0;
            if (description && description.trim() !== '') filledFields++;
            if (dynamicVariable && dynamicVariable.trim() !== '') filledFields++;
            if (constantValue && constantValue.trim() !== '') filledFields++;

            if (filledFields > 1) {
                toastr.error(`Path Parameter ${paramIndex}: You can only set one of Description, Dynamic Variable, or Constant Value. Please clear the other fields.`);
                return false;
            }
            return true;
        }

        // Add real-time validation to form fields
        function addElevenLabsValidation() {
            // Add validation to HTTP method changes (both create and edit forms)
            const httpMethodSelects = ['http_method', 'edit_http_method'];
            httpMethodSelects.forEach(selectId => {
                const httpMethodSelect = document.getElementById(selectId);
                if (httpMethodSelect) {
                    httpMethodSelect.addEventListener('change', function() {
                        const method = this.value;
                        const bodyDescriptionFieldId = selectId === 'edit_http_method' ? 'edit_body_description' : 'body_description';
                        const bodyDescriptionField = document.getElementById(bodyDescriptionFieldId);
                        
                        if (bodyDescriptionField && !['POST', 'PUT', 'PATCH'].includes(method.toUpperCase())) {
                            // Clear body description for GET/DELETE methods
                            if (bodyDescriptionField.value.trim() !== '') {
                                bodyDescriptionField.value = '';
                                toastr.warning('Request body description cleared for ' + method + ' method');
                            }
                        }
                    });
                }
            });

            // Add validation to parameter fields with enable/disable functionality
            document.addEventListener('input', function(e) {
                if (e.target.matches('input[name="path_param_description"], input[name="path_param_dynamic_variable"], input[name="path_param_constant_value"], input[name="query_param_description"], input[name="query_param_dynamic_variable"], input[name="query_param_constant_value"], input[name="body_prop_description"], input[name="body_prop_dynamic_variable"], input[name="body_prop_constant_value"], .param-description, .param-dynamic-var, .param-constant-value, .property-description, .property-dynamic-var, .property-constant-value')) {
                    const row = e.target.closest('.path-param-row, .query-param-row, .body-prop-row, .param-item, .property-item');
                    if (row) {
                        // Determine parameter type and get appropriate field selectors
                        let descriptionField, dynamicVarField, constantValField;
                        
                        if (row.classList.contains('path-param-row')) {
                            descriptionField = row.querySelector('input[name="path_param_description"]');
                            dynamicVarField = row.querySelector('input[name="path_param_dynamic_variable"]');
                            constantValField = row.querySelector('input[name="path_param_constant_value"]');
                        } else if (row.classList.contains('query-param-row')) {
                            descriptionField = row.querySelector('input[name="query_param_description"]');
                            dynamicVarField = row.querySelector('input[name="query_param_dynamic_variable"]');
                            constantValField = row.querySelector('input[name="query_param_constant_value"]');
                        } else if (row.classList.contains('body-prop-row')) {
                            descriptionField = row.querySelector('input[name="body_prop_description"]');
                            dynamicVarField = row.querySelector('input[name="body_prop_dynamic_variable"]');
                            constantValField = row.querySelector('input[name="body_prop_constant_value"]');
                        } else if (row.classList.contains('param-item')) {
                            descriptionField = row.querySelector('.param-description');
                            dynamicVarField = row.querySelector('.param-dynamic-var');
                            constantValField = row.querySelector('.param-constant-value');
                        } else if (row.classList.contains('property-item')) {
                            descriptionField = row.querySelector('.property-description');
                            dynamicVarField = row.querySelector('.property-dynamic-var');
                            constantValField = row.querySelector('.property-constant-value');
                        }
                        
                        if (descriptionField && dynamicVarField && constantValField) {
                            const description = descriptionField.value.trim();
                            const dynamicVar = dynamicVarField.value.trim();
                            const constantVal = constantValField.value.trim();
                            
                            // Function to enable/disable fields
                            function updateFieldStates(activeField) {
                                const fields = [
                                    { field: descriptionField, name: 'description' },
                                    { field: dynamicVarField, name: 'dynamic_variable' },
                                    { field: constantValField, name: 'constant_value' }
                                ];
                                
                                fields.forEach(({ field, name }) => {
                                    if (name === activeField) {
                                        // Enable the active field
                                        field.disabled = false;
                                        field.style.backgroundColor = '#ffffff';
                                        field.style.opacity = '1';
                                    } else {
                                        // Disable other fields if any field has content
                                        const hasContent = description || dynamicVar || constantVal;
                                        field.disabled = hasContent;
                                        field.style.backgroundColor = hasContent ? '#f8f9fa' : '#ffffff';
                                        field.style.opacity = hasContent ? '0.6' : '1';
                                        
                                        // Clear disabled fields
                                        if (hasContent && field.value.trim() !== '') {
                                            field.value = '';
                                        }
                                    }
                                });
                            }
                            
                            // Determine which field is active and update states
                            if (description) {
                                updateFieldStates('description');
                            } else if (dynamicVar) {
                                updateFieldStates('dynamic_variable');
                            } else if (constantVal) {
                                updateFieldStates('constant_value');
                            } else {
                                // No fields have content, enable all
                                updateFieldStates(null);
                            }
                        }
                    }
                }
            });
        }

        // Function to initialize field states for existing data
        function initializeFieldStates() {
            // Initialize all parameter rows
            const allParamRows = document.querySelectorAll('.path-param-row, .query-param-row, .body-prop-row, .param-item, .property-item');
            allParamRows.forEach(row => {
                initializeRowFieldStates(row);
            });
        }

        // Function to initialize field states for a specific row
        function initializeRowFieldStates(row) {
            let descriptionField, dynamicVarField, constantValField;
            
            // Check for edit modal fields first
            if (row.classList.contains('path-param-row')) {
                descriptionField = row.querySelector('input[name="path_param_description"]');
                dynamicVarField = row.querySelector('input[name="path_param_dynamic_variable"]');
                constantValField = row.querySelector('input[name="path_param_constant_value"]');
            } else if (row.classList.contains('query-param-row')) {
                descriptionField = row.querySelector('input[name="query_param_description"]');
                dynamicVarField = row.querySelector('input[name="query_param_dynamic_variable"]');
                constantValField = row.querySelector('input[name="query_param_constant_value"]');
            } else if (row.classList.contains('body-prop-row')) {
                descriptionField = row.querySelector('input[name="body_prop_description"]');
                dynamicVarField = row.querySelector('input[name="body_prop_dynamic_variable"]');
                constantValField = row.querySelector('input[name="body_prop_constant_value"]');
            }
            // Check for create modal fields
            else if (row.classList.contains('param-item')) {
                descriptionField = row.querySelector('.param-description');
                dynamicVarField = row.querySelector('.param-dynamic-var');
                constantValField = row.querySelector('.param-constant-value');
            } else if (row.classList.contains('property-item')) {
                descriptionField = row.querySelector('.property-description');
                dynamicVarField = row.querySelector('.property-dynamic-var');
                constantValField = row.querySelector('.property-constant-value');
            }
            
            if (descriptionField && dynamicVarField && constantValField) {
                const description = descriptionField.value.trim();
                const dynamicVar = dynamicVarField.value.trim();
                const constantVal = constantValField.value.trim();
                
                // Apply initial field states
                const hasContent = description || dynamicVar || constantVal;
                const fields = [descriptionField, dynamicVarField, constantValField];
                
                fields.forEach(field => {
                    field.disabled = hasContent && field.value.trim() === '';
                    field.style.backgroundColor = field.disabled ? '#f8f9fa' : '#ffffff';
                    field.style.opacity = field.disabled ? '0.6' : '1';
                });
            }
        }

        // Initialize validation when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            addElevenLabsValidation();
            // Initialize field states after a short delay to ensure all content is loaded
            setTimeout(initializeFieldStates, 100);
            
            // Add URL validation for path parameters
            const apiUrlInput = document.getElementById('api_url');
            if (apiUrlInput) {
                // Check initial state
                checkUrlForPathParams();
                
                // Add event listener for real-time validation
                apiUrlInput.addEventListener('input', checkUrlForPathParams);
                apiUrlInput.addEventListener('blur', checkUrlForPathParams);
            }
            
            // Add HTTP method validation for request body schema
            const httpMethodSelect = document.getElementById('http_method');
            if (httpMethodSelect) {
                // Check initial state
                toggleRequestBodySchema();
                
                // Add event listener for real-time validation
                httpMethodSelect.addEventListener('change', toggleRequestBodySchema);
            }
        });
    </script>
{% endblock %}
