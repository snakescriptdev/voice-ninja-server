{% extends 'Web/base.html' %}

{% block content %}
<div class="wrapper">
    {% include 'Web/sidebar.html' %}

    <!-- Page Content  -->
    <div id="content" class="page_content position-relative">
        <button type="button"
            class="sidebarCollapse mobile_hamburger_btn hamburger_btn bg-transparent border-0 position-absolute ms-2">
            <img src="{{ host }}/static/Web/images/hamburger-icon.svg" class="img-fluid">
        </button>
        <div class="agent_data_outer d-flex align-items-center gap-3 justify-content-between">
            <div class="d-flex align-items-center gap-3 w-100">
                <a href="{{ host }}/dashboard"
                    class="page_back_arrow d-flex align-items-center justify-content-center"><img
                        src="{{ host }}/static/Web/images/left-arrow.svg" class="img-fluid"></a>
                <div class="">
                    <h3 id="agent-name" class="mb-0 d-flex gap-1">{% if agent %}{{ agent.agent_name }}{% else %}Agent{%
                        endif %}
                        <span onclick="editHeading()" class="edit-heading-icon">
                            <img src="{{ host }}/static/Web/images/pencil-icon.svg" style="cursor: pointer;">
                        </span>
                    </h3>
                </div>
            </div>
            {% if not agent %}
            <div>
                <button type="button" class="help-ai-btn" data-bs-toggle="modal" data-bs-target="#helpAiModal">
                    <span><img src="{{ host }}/static/Web/images/btn-star-icon.svg" class="img-fluid"> Help from
                        AI</span>
                </button>
            </div>
            {% endif %}
        </div>
        <div class="agent_type_box">
            <div class="agent_type_dropdown d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <div class="agent_select_box position-relative">
                        <select class="form-select" id="selected-model"
                            onchange="updateAgentSetting('selected_llm_model_id', this.value)">
                            {% for llm_model in llm_models %}
                            <option value="{{ llm_model.id }}" {% if agent and agent.selected_model==llm_model.id
                                %}selected{% endif %}>
                                {{ llm_model.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="agent_type_select_icon">
                            <img src="{{ host }}/static/Web/images/ai-icon.svg" class="img-fluid">
                        </div>
                        <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer"
                            onclick="openDialog()">
                            <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                        </div>
                    </div>
                    <div class="agent_select_box position-relative">
                        <select class="form-select" id="selected-voice"
                            onchange="updateAgentSetting('selected_voice_id', this.value)">
                            {% for voice in voices %}
                            <option value="{{ voice.id }}" {% if agent and agent.selected_voice==voice.id %}selected{%
                                endif %}>
                                {{ voice.voice_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="agent_type_select_icon">
                            <img src="{{ host }}/static/Web/images/jack-img.svg" class="img-fluid">
                        </div>
                        <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer">
                            <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                        </div>
                    </div>
                    <div class="agent_select_box position-relative">
                        <select class="form-select" id="selected-language"
                            onchange="updateAgentSetting('selected_language_code', this.value)">
                            <option value="en" {% if agent and agent.selected_language=='en' %}selected{% endif %}>
                                English</option>
                            <option value="zh" {% if agent and agent.selected_language=='zh' %}selected{% endif %}>
                                Chinese</option>
                            <option value="hi" {% if agent and agent.selected_language=='hi' %}selected{% endif %}>Hindi
                            </option>
                            <option value="es" {% if agent and agent.selected_language=='es' %}selected{% endif %}>
                                Spanish</option>
                            <option value="fr" {% if agent and agent.selected_language=='fr' %}selected{% endif %}>
                                French</option>
                            <option value="ar" {% if agent and agent.selected_language=='ar' %}selected{% endif %}>
                                Arabic</option>
                            <option value="ru" {% if agent and agent.selected_language=='ru' %}selected{% endif %}>
                                Russian</option>
                            <option value="pt" {% if agent and agent.selected_language=='pt' %}selected{% endif %}>
                                Portuguese</option>
                            <option value="id" {% if agent and agent.selected_language=='id' %}selected{% endif %}>
                                Indonesian</option>
                            <option value="de" {% if agent and agent.selected_language=='de' %}selected{% endif %}>
                                German</option>
                            <option value="ta" {% if agent and agent.selected_language=='ta' %}selected{% endif %}>Tamil
                            </option>
                        </select>
                        <div class="agent_type_select_icon">
                            <span id="language-icon" style="font-size: 20px;">
                                {% if agent and agent.selected_language %}
                                {% if agent.selected_language == 'en' %}ðŸ‡ºðŸ‡¸{% elif agent.selected_language == 'zh'
                                %}ðŸ‡¨ðŸ‡³{% elif agent.selected_language == 'hi' %}ðŸ‡®ðŸ‡³{% elif agent.selected_language ==
                                'es' %}ðŸ‡ªðŸ‡¸{% elif agent.selected_language == 'fr' %}ðŸ‡«ðŸ‡·{% elif agent.selected_language
                                == 'ar' %}ðŸ‡¸ðŸ‡¦{% elif agent.selected_language == 'ru' %}ï¿½ï¿½ðŸ‡º{% elif
                                agent.selected_language == 'pt' %}ðŸ‡µï¿½{% elif agent.selected_language == 'id' %}ðŸ‡®ðŸ‡©{%
                                elif agent.selected_language == 'de' %}ðŸ‡©ðŸ‡ª{% elif agent.selected_language == 'ta'
                                %}ðŸ‡®ðŸ‡³{% else %}ðŸ‡ºðŸ‡¸{% endif %}
                                {% else %}
                                ðŸ‡ºï¿½ðŸ‡¸
                                {% endif %}
                            </span>
                        </div>
                        <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer">
                            <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                        </div>
                    </div>
                    <div class="agent_select_box position-relative">
                        <select name="knowledge_base" id="selected-knowledge-base" class="form-select"
                            onchange="updateKnowledgeBase(this.value)">
                            <option value="" disabled {% if not selected_knowledge %}selected{% endif %}>
                                Select Knowledge Base
                            </option>
                            {% for knowledge_base in knowledge_bases %}
                            <option value="{{ knowledge_base.id }}" {% if selected_knowledge and
                                selected_knowledge.id==knowledge_base.id %}selected{% endif %}>
                                {{ knowledge_base.knowledge_base_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <script>
                            function updateKnowledgeBase(knowledgeBaseId) {
                                const currentUrl = new URL(window.location.href);
                                const agentId = currentUrl.searchParams.get("agent_id");

                                fetch(`${host}/elevenlabs/api/v1/attach-knowledge-base`, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "X-CSRFToken": getCSRFToken()
                                    },
                                    body: JSON.stringify({
                                        agent_id: agentId,
                                        knowledge_base_id: knowledgeBaseId
                                    })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.status === "success") {
                                            toastr.success("Knowledge base updated successfully");
                                        } else {
                                            toastr.error("Failed to update knowledge base");
                                        }
                                    })
                                    .catch(error => {
                                        console.error("Error:", error);
                                        toastr.error("Something went wrong!");
                                    });
                            }
                        </script>
                        <div class="agent_type_select_icon">
                            <img src="{{ host }}/static/Web/images/jack-img.svg" class="img-fluid">
                        </div>
                        <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer">
                            <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                        </div>
                    </div>
                </div>

                {% if request.url.path == '/elevenlabs/web/v1/update_agent' %}
                <div class="agent_select_box position-relative d-flex align-items-center gap-2">
                    <div class="functions_dropdown">
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"
                                data-bs-auto-close="outside">Functions</a>
                            <ul class="dropdown-menu dropdown-menu-end shadow mt-2 dropbottom">
                                <div id="function-list">
                                    {% for function in custom_functions %}
                                    <li class="dropdown-item gap-3 d-flex align-items-center justify-content-between mb-2"
                                        id="function-{{ function.id }}">
                                        <div class="functionNameDivBlock">{{ function.tool_name }}</div>
                                        <div class="d-flex align-items-center gap-2">
                                            <button class="edit-function-btn bg-transparent border-0 p-0"
                                                onclick="openEditToolsModal(`{{ function.id }}`)"><img
                                                    src="{{ host }}/static/Web/images/edit-icon.svg"
                                                    class="img-fluid"></button>
                                            <button class="delete-function-btn bg-transparent border-0 p-0"
                                                onclick="deleteFunction(`{{ function.id }}`)"><img
                                                    src="{{ host }}/static/Web/images/black-dlt-icon.svg"
                                                    class="img-fluid"></button>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </div>
                                <li class="">
                                    <a href="#" class="dropdown-item dropdown-toggle text-start"
                                        data-bs-toggle="dropdown">+ Add</a>
                                    <ul class="dropdown-menu shadow mt-2">
                                        <!-- <li class="mb-2">
                                                <a class="dropdown-item d-flex align-items-center gap-2" href=""><span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-telephone-x" viewBox="0 0 16 16">
                                                <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"/>
                                                <path fill-rule="evenodd" d="M11.146 1.646a.5.5 0 0 1 .708 0L13 2.793l1.146-1.147a.5.5 0 0 1 .708.708L13.707 3.5l1.147 1.146a.5.5 0 0 1-.708.708L13 4.207l-1.146 1.147a.5.5 0 0 1-.708-.708L12.293 3.5l-1.147-1.146a.5.5 0 0 1 0-.708"/>
                                                </svg></span> End Call</a>
                                            </li> -->
                                        <li>
                                            <a class="dropdown-item d-flex align-items-center gap-2"
                                                onclick="openCreateCustomToolModal()">
                                                <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                        viewBox="0 0 16 16" fill="none">
                                                        <path d="M4.33337 14.6667V10" stroke="#525866"
                                                            stroke-width="1.5" stroke-miterlimit="10"
                                                            stroke-linecap="round" stroke-linejoin="round"></path>
                                                        <path d="M4.33337 3.33398V1.33398" stroke="#525866"
                                                            stroke-width="1.5" stroke-miterlimit="10"
                                                            stroke-linecap="round" stroke-linejoin="round"></path>
                                                        <path d="M11.6666 14.666V12.666" stroke="#525866"
                                                            stroke-width="1.5" stroke-miterlimit="10"
                                                            stroke-linecap="round" stroke-linejoin="round"></path>
                                                        <path d="M11.6666 6.00065V1.33398" stroke="#525866"
                                                            stroke-width="1.5" stroke-miterlimit="10"
                                                            stroke-linecap="round" stroke-linejoin="round"></path>
                                                        <path
                                                            d="M6.33337 4.66732V8.66732C6.33337 9.40065 6.00004 10.0007 5.00004 10.0007H3.66671C2.66671 10.0007 2.33337 9.40065 2.33337 8.66732V4.66732C2.33337 3.93398 2.66671 3.33398 3.66671 3.33398H5.00004C6.00004 3.33398 6.33337 3.93398 6.33337 4.66732Z"
                                                            stroke="#525866" stroke-width="1.5" stroke-miterlimit="10"
                                                            stroke-linecap="round" stroke-linejoin="round"></path>
                                                        <path
                                                            d="M13.6666 7.33333V11.3333C13.6666 12.0667 13.3333 12.6667 12.3333 12.6667H11C9.99996 12.6667 9.66663 12.0667 9.66663 11.3333V7.33333C9.66663 6.6 9.99996 6 11 6H12.3333C13.3333 6 13.6666 6.6 13.6666 7.33333Z"
                                                            stroke="#525866" stroke-width="1.5" stroke-miterlimit="10"
                                                            stroke-linecap="round" stroke-linejoin="round"></path>
                                                    </svg>
                                                </span>
                                                Custom Function</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="position-relative">
                        <button class="variable-btn" onclick="toggleVariableModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-braces" viewBox="0 0 16 16">
                                <path
                                    d="M2.114 8.063V7.9c1.005-.102 1.497-.615 1.497-1.6V4.503c0-1.094.39-1.538 1.354-1.538h.273V2h-.376C3.25 2 2.49 2.759 2.49 4.352v1.524c0 1.094-.376 1.456-1.49 1.456v1.299c1.114 0 1.49.362 1.49 1.456v1.524c0 1.593.759 2.352 2.372 2.352h.376v-.964h-.273c-.964 0-1.354-.444-1.354-1.538V9.663c0-.984-.492-1.497-1.497-1.6M13.886 7.9v.163c-1.005.103-1.497.616-1.497 1.6v1.798c0 1.094-.39 1.538-1.354 1.538h-.273v.964h.376c1.613 0 2.372-.759 2.372-2.352v-1.524c0-1.094.376-1.456 1.49-1.456V7.332c-1.114 0-1.49-.362-1.49-1.456V4.352C13.51 2.759 12.75 2 11.138 2h-.376v.964h.273c.964 0 1.354.444 1.354 1.538V6.3c0 .984.492 1.497 1.497 1.6" />
                            </svg>
                        </button>
                        <div class="setting_icon d-flex align-items-center justify-content-center cursor-pointer">
                            <img src="{{ host }}/static/Web/images/setting-icon.svg" class="img-fluid">
                        </div>
                        <div class="variable-modal" id="variable-modal" style="display: none;">
                            <div class="variable-modal-content">
                                <h6 class="border-bottom pb-2">Dynamic Variables</h6>
                                <div>
                                    <small class="text-muted">Set dynamic variables for dashboard audio and llm
                                        tests</small>
                                    <div class="mt-3 border-bottom pb-2 variable-modal-content-item-outer">
                                        <div class="variable-modal-content-item mb-2">
                                            <h5 class="mb-0">Variable Name</h5>
                                            <h5 class="mb-0">Test Value</h5>
                                        </div>
                                        <div id="dynamic-variables">
                                            {% for key, value in dynamic_variables.items() %}
                                            <div class="variable-modal-content-item mb-2">
                                                <input type="text" class="form-control" value="{{ key }}">
                                                <input type="text" class="form-control" value="{{ value }}">
                                                <button class="dlt_btn bg-transparent border-0 p-0"
                                                    onclick="removeVariable(this)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                        class="h-12 w-12">
                                                        <path d="M3 6h18"></path>
                                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <div>
                                            <button type="button" class="add-variable-btn" onclick="addNewVariable()">+
                                                Add</button>
                                        </div>
                                    </div>
                                    <div
                                        class="variable-modal-footer d-flex align-items-center gap-2 justify-content-end pt-2">
                                        <button class="cancel-btn" onclick="toggleVariableModal()">Cancel</button>
                                        <button class="save-btn" onclick="saveVariable()">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="{{ url_for('call_history') }}?agent_id={{ agent.id }}">
                        <div class="w-max-content view-call-history-btn d-flex align-items-center gap-2"
                            id="create-agent-btn">
                            <img src="{{ host }}/static/Web/images/call-history.svg" class="img-fluid">
                        </div>
                    </a>
                    <div class="position-relative">
                        <div class="w-max-content view-call-history-btn d-flex align-items-center gap-2"
                            id="token-settings-btn" onclick="toggleTokenModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                                class="bi bi-sliders" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1z" />
                            </svg>
                        </div>
                        <div class="variable-modal" id="token-modal" style="display: none;">
                            <div class="variable-modal-content">
                                <h6 class="border-bottom pb-2">Token Settings</h6>
                                <div class="mt-3">
                                    <div class="mb-3">
                                        <label class="form-label">Overall Token Limit</label>
                                        <input type="number" class="form-control" id="overall-token-limit"
                                            value="{{ overall_token_limit }}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Daily Token Limit</label>
                                        <input type="number" class="form-control" id="daily-token-limit"
                                            value="{{ daily_call_limit }}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Per Call Token Limit</label>
                                        <input type="number" class="form-control" id="per-call-token-limit"
                                            value="{{ per_call_token_limit }}" required>
                                    </div>
                                    <div
                                        class="variable-modal-footer d-flex align-items-center gap-2 justify-content-end pt-2">
                                        <button class="cancel-btn" onclick="toggleTokenModal()">Cancel</button>
                                        <button class="save-btn" onclick="saveTokenSettings()">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div id="varPopup"
                style="display:none; position:absolute; z-index:9999; background:#fff; 
                            border:1px solid #ddd; border-radius:6px; padding:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
                {% for var in system_variables_data %}
                <div class="var-item" data-var="{{ var.name }}" title="{{ var.value }}">{{ var.name }}</div>
                {% endfor %}
            </div>


            <div class="agent_type_box_inner">
                <div class="agent_type_textarea">
                    <div id="editor" style="min-height:200px; border:1px solid #ddd; padding:8px;"></div>
                    <div style="margin-top:10px;">
                        <button id="save-editor-btn" class="btn btn-primary">Save</button>
                        <button id="cancel-editor-btn" class="btn btn-secondary">Cancel</button>
                    </div>
                    <textarea class="form-control" style="display:none;" id="agent-prompt" class="hidden-textarea"
                        placeholder="Enter your prompt here....">{% if agent %}{{ agent.agent_prompt }}{% endif %}</textarea>

                    <div class="agent_type_textarea_footer pt-1">
                        <small style="font-size:12px;" class="text-muted">Use <span>&#123;&#123;_&#125;&#125;</span> to
                            add variables.</small>
                    </div>
                </div>
                {% if agent %}
                <div class="row align-items-end">
                    <div class="col-md-8 mt-4">
                        <label class="form-label">Your Agent Script</label>
                        <div class="copy_link_box d-flex align-items-center justify-content-between mx-auto">
                            <textarea class="copy_link_text" id="agent-script" disabled readonly></textarea>
                            <script>
                                document.addEventListener("DOMContentLoaded", function () {
                                    const agentId = "{{ agent.dynamic_id }}";
                                    const origin = window.location.origin;
                                    const scriptTag = `<script src="${origin}/chatbot-script.js/${agentId}"><\/script>`;
                                    document.getElementById("agent-script").value = scriptTag;
                                })
                            </script>
                            <button class="copy_link_btn border-0 bg-transparent position-relative" id="copy-link-btn"
                                onclick="copyScript()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-copy" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z" />
                                </svg>
                                <div class="tooltip_text">Copy</div>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2 mt-4 position-relative">
                        <div class="d-flex align-items-center gap-2 justify-content-center">
                            <button class="customize-bot-btn position-relative" id="customize-bot-btn"
                                onclick="toggleCustomizeModal()">
                                <img src="{{ host }}/static/Web/images/icon-bot-img.png" class="img-fluid" width="30"
                                    height="30">
                                <div class="customize-bot-btn-tooltip">Customize Your Bot</div>
                            </button>
                            <a href="/elevenlabs/preview/v1/preview_agent?agent_id={{ agent.dynamic_id }}"
                                target="_blank">
                                <button class="customize-bot-btn position-relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="#0c7fda"
                                        class="bi bi-eye-fill" viewBox="0 0 16 16">
                                        <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0" />
                                        <path
                                            d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7" />
                                    </svg>
                                    <div class="customize-bot-btn-tooltip">Preview Agent</div>
                                </button>
                            </a>
                        </div>
                        <div class="customize-bot-modal" id="customize-bot-modal" style="display: none;">
                            <div class="customize-modal-content">
                                <!-- Modal Header -->
                                <div class="modal-header d-flex justify-content-between align-items-center mb-4">
                                    <h3 class="mb-0">Customize Your Agent Widget</h3>
                                    <button class="btn-close" onclick="toggleCustomizeModal()"
                                        style="border: none; background: none; font-size: 24px; cursor: pointer;">&times;</button>
                                </div>

                                <!-- Two Column Layout -->
                                <div class="row">
                                    <!-- Left Column - Customization Options -->
                                    <div class="col-md-6">
                                        <div class="customization-panel">
                                            <!-- Theme Colors Section -->
                                            <div class="customize-section mb-3">
                                                <h5 class="mb-2">
                                                    <i class="fa-solid fa-palette me-2"></i>
                                                    Theme Colors
                                                </h5>
                                                <div class="color-box d-flex align-items-center gap-2 flex-wrap">
                                                    <div class="color-option active"
                                                        style="background: linear-gradient(45deg, #00d4ff, #006eff);"
                                                        onclick="changeTheme('#00d4ff', '#006eff', 'rgba(0, 212, 255, 0.3)', this)"
                                                        title="Ocean Blue"></div>
                                                    <div class="color-option"
                                                        style="background: linear-gradient(45deg, #e63946, #9d0208);"
                                                        onclick="changeTheme('#e63946', '#9d0208', 'rgba(230, 57, 70, 0.3)', this)"
                                                        title="Vibrant Red"></div>
                                                    <div class="color-option"
                                                        style="background: linear-gradient(45deg, #8338ec, #5e60ce);"
                                                        onclick="changeTheme('#8338ec', '#5e60ce', 'rgba(131, 56, 236, 0.3)', this)"
                                                        title="Purple"></div>
                                                    <div class="color-option"
                                                        style="background: linear-gradient(45deg, #06d6a0, #118ab2);"
                                                        onclick="changeTheme('#06d6a0', '#118ab2', 'rgba(6, 214, 160, 0.3)', this)"
                                                        title="Mint Green"></div>
                                                    <div class="color-option"
                                                        style="background: linear-gradient(45deg, #fb8500, #ffb703);"
                                                        onclick="changeTheme('#fb8500', '#ffb703', 'rgba(251, 133, 0, 0.3)', this)"
                                                        title="Orange"></div>
                                                    <div class="color-option"
                                                        style="background: linear-gradient(45deg, #ff5a5f, #c1839f);"
                                                        onclick="changeTheme('#ff5a5f', '#c1839f', 'rgba(255, 90, 95, 0.3)', this)"
                                                        title="Pink"></div>
                                                    <div class="color-option"
                                                        style="background: linear-gradient(45deg, #2ec4b6, #20a4f3);"
                                                        onclick="changeTheme('#2ec4b6', '#20a4f3', 'rgba(46, 196, 182, 0.3)', this)"
                                                        title="Teal"></div>
                                                    <div class="color-option"
                                                        style="background: linear-gradient(45deg, #7209b7, #4361ee);"
                                                        onclick="changeTheme('#7209b7', '#4361ee', 'rgba(114, 9, 183, 0.3)', this)"
                                                        title="Deep Purple"></div>
                                                </div>
                                            </div>

                                            <!-- Widget Size Section -->
                                            <div class="customize-section mb-3">
                                                <h5 class="mb-2">
                                                    <i class="fa-solid fa-expand-arrows-alt me-2"></i>
                                                    Widget Size
                                                </h5>
                                                <div class="size-options d-flex gap-2">
                                                    <button class="size-btn"
                                                        onclick="changeSize('small', this)">Small</button>
                                                    <button class="size-btn active"
                                                        onclick="changeSize('medium', this)">Medium</button>
                                                    <button class="size-btn"
                                                        onclick="changeSize('large', this)">Large</button>
                                                </div>
                                            </div>

                                            <!-- Start Button Color Section -->
                                            <div class="customize-section mb-3">
                                                <h5 class="mb-2">
                                                    <i class="fa-solid fa-brush me-2"></i>
                                                    Start Button Color
                                                </h5>
                                                <div class="d-flex align-items-center gap-2">
                                                    <input type="color" id="start-btn-color-picker" value="#1a1a1a"
                                                        style="width: 40px; height: 40px; border: none; background: none; cursor: pointer;">
                                                    <span id="start-btn-color-value"
                                                        style="font-size: 13px; color: #333;">#1a1a1a</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column - Live Preview -->
                                    <div class="col-md-6">
                                        <div class="preview-panel">
                                            <h5 class="mb-2">
                                                <i class="fa-solid fa-eye me-2"></i>
                                                Live Preview
                                            </h5>
                                            <div class="preview-container"
                                                style="height: 320px; border: 2px dashed #ddd; border-radius: 10px; position: relative; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); overflow: hidden;">
                                                <!-- ElevenLabs Agent Widget Preview -->
                                                <div id="preview-elevenlabs-widget" style="
                                                        position: absolute;
                                                        bottom: 20px;
                                                        right: 20px;
                                                        z-index: 1000;
                                                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                                        transition: all 0.3s ease;
                                                    ">
                                                    <!-- Language Selection Panel (initially hidden) -->
                                                    <div id="preview-language-panel" style="
                                                            background: white;
                                                            border-radius: 20px;
                                                            padding: 20px;
                                                            margin-bottom: 10px;
                                                            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
                                                            display: none;
                                                            min-width: 280px;
                                                        ">
                                                        <div style="margin-bottom: 15px;">
                                                            <div
                                                                style="display: flex; align-items: center; padding: 10px; cursor: pointer; border-radius: 12px; transition: background 0.2s;">
                                                                <span
                                                                    style="font-size: 20px; margin-right: 12px;">ðŸ‡ºðŸ‡¸</span>
                                                                <span
                                                                    style="font-weight: 600; color: #1a1a1a;">ENGLISH</span>
                                                            </div>
                                                            <div
                                                                style="display: flex; align-items: center; padding: 10px; cursor: pointer; border-radius: 12px; transition: background 0.2s;">
                                                                <span
                                                                    style="font-size: 20px; margin-right: 12px;">ðŸ‡¨ðŸ‡³</span>
                                                                <span
                                                                    style="font-weight: 600; color: #1a1a1a;">CHINESE</span>
                                                            </div>
                                                            <div
                                                                style="display: flex; align-items: center; padding: 10px; cursor: pointer; border-radius: 12px; transition: background 0.2s;">
                                                                <span
                                                                    style="font-size: 20px; margin-right: 12px;">ðŸ‡­ðŸ‡·</span>
                                                                <span
                                                                    style="font-weight: 600; color: #1a1a1a;">CROATIAN</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Main Control Panel -->
                                                    <div id="preview-main-panel" style="
                                                            background: white;
                                                            border-radius: 20px;
                                                            padding: 18px;
                                                            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
                                                            display: flex;
                                                            align-items: center;
                                                            gap: 12px;
                                                            min-width: 320px;
                                                            border: 1px solid rgba(0, 0, 0, 0.05);
                                                        ">
                                                        <!-- Voice Indicator -->
                                                        <div id="preview-voice-indicator" style="
                                                                width: 45px;
                                                                height: 45px;
                                                                border-radius: 12px;
                                                                background: linear-gradient(45deg, #00d4ff, #006eff);
                                                                display: flex;
                                                                align-items: center;
                                                                justify-content: center;
                                                                flex-shrink: 0;
                                                                transition: all 0.3s ease;
                                                                position: relative;
                                                                overflow: hidden;
                                                            ">
                                                            <div style="
                                                                    width: 20px;
                                                                    height: 20px;
                                                                    border-radius: 4px;
                                                                    background: rgba(255,255,255,0.9);
                                                                    animation: pulse 2s infinite;
                                                                "></div>
                                                        </div>

                                                        <!-- Action Button -->
                                                        <button id="preview-voice-chat-btn"
                                                            onclick="toggleElevenLabsChat()" style="
                                                                background: linear-gradient(135deg, #1a1a1a, #333);
                                                                color: white;
                                                                border: none;
                                                                border-radius: 18px;
                                                                padding: 14px 24px;
                                                                font-weight: 700;
                                                                font-size: 13px;
                                                                letter-spacing: 0.5px;
                                                                cursor: pointer;
                                                                transition: all 0.3s ease;
                                                                display: flex;
                                                                align-items: center;
                                                                gap: 10px;
                                                                flex: 1;
                                                                text-transform: uppercase;
                                                                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                                            " data-default-bg="linear-gradient(135deg, #1a1a1a, #333)">
                                                            <i class="fas fa-microphone" style="font-size: 13px;"></i>
                                                            <span id="preview-btn-text">START CHAT</span>
                                                        </button>
                                                        <script>
                                                            // --- Start Button Color Customization ---
                                                            const startBtnColorPicker = document.getElementById('start-btn-color-picker');
                                                            const startBtnColorValue = document.getElementById('start-btn-color-value');
                                                            const previewVoiceChatBtn = document.getElementById('preview-voice-chat-btn');
                                                            let currentStartBtnColor = '#1a1a1a';

                                                            // --- Initialization: Apply saved theme and button color from backend on load ---
                                                            document.addEventListener('DOMContentLoaded', function () {
                                                                // Theme
                                                                let theme = JSON.parse(localStorage.getItem('selectedTheme')) || { primary: '#00d4ff', secondary: '#006eff', pulse: 'rgba(0, 212, 255, 0.3)' };
                                                                // Fetch agent connection for start_btn_color
                                                                let agentId = "{{ agent.id if agent else '' }}";
                                                                if (agentId) {
                                                                    fetch(`{{ host }}/api/get_agent_connection?agent_id=${agentId}`)
                                                                        .then(res => res.json())
                                                                        .then(response => {
                                                                            if (response.status === 'success' && response.data) {
                                                                                let startBtnColor = response.data.start_btn_color || '#1a1a1a';
                                                                                currentStartBtnColor = startBtnColor;
                                                                                if (previewVoiceChatBtn) previewVoiceChatBtn.style.background = startBtnColor;
                                                                                if (startBtnColorPicker) startBtnColorPicker.value = startBtnColor;
                                                                                if (startBtnColorValue) startBtnColorValue.textContent = startBtnColor;
                                                                            }
                                                                        });
                                                                } else {
                                                                    // fallback for new agent
                                                                    if (previewVoiceChatBtn) previewVoiceChatBtn.style.background = '#1a1a1a';
                                                                    if (startBtnColorPicker) startBtnColorPicker.value = '#1a1a1a';
                                                                    if (startBtnColorValue) startBtnColorValue.textContent = '#1a1a1a';
                                                                }
                                                                // Also apply theme to indicator if needed
                                                                const indicator = document.getElementById('preview-voice-indicator');
                                                                if (indicator) {
                                                                    indicator.style.background = `linear-gradient(45deg, ${theme.primary}, ${theme.secondary})`;
                                                                }
                                                            });

                                                            if (startBtnColorPicker && startBtnColorValue && previewVoiceChatBtn) {
                                                                startBtnColorPicker.addEventListener('input', function (e) {
                                                                    const color = e.target.value;
                                                                    startBtnColorValue.textContent = color;
                                                                    previewVoiceChatBtn.style.background = color;
                                                                    currentStartBtnColor = color;
                                                                    // Do NOT reset or change pulse color or theme here
                                                                    if (window.previewAgentWindow && typeof window.previewAgentWindow.postMessage === 'function') {
                                                                        window.previewAgentWindow.postMessage({ type: 'updateStartBtnColor', color }, '*');
                                                                    }
                                                                });
                                                            }

                                                            // Listen for postMessage in preview agent (if this is the preview agent window)
                                                            window.addEventListener('message', function (event) {
                                                                if (event.data && event.data.type === 'updateStartBtnColor') {
                                                                    const color = event.data.color;
                                                                    if (previewVoiceChatBtn) {
                                                                        previewVoiceChatBtn.style.background = color;
                                                                    }
                                                                }
                                                            });
                                                        </script>

                                                        <!-- Language Selector -->
                                                        <button id="preview-language-btn"
                                                            onclick="toggleLanguagePanel()" style="
                                                                background: #f8f9fa;
                                                                border: 1px solid #e1e5e9;
                                                                border-radius: 15px;
                                                                padding: 10px 14px;
                                                                cursor: pointer;
                                                                display: flex;
                                                                align-items: center;
                                                                gap: 8px;
                                                                transition: all 0.2s ease;
                                                                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                                                            ">
                                                            <span id="preview-selected-flag"
                                                                style="font-size: 16px;">ðŸ‡ºðŸ‡¸</span>
                                                            <i class="fas fa-chevron-down"
                                                                style="font-size: 8px; color: #6c757d;"></i>
                                                        </button>
                                                    </div>

                                                    <!-- Branding -->
                                                    <div style="
                                                            text-align: center;
                                                            margin-top: 12px;
                                                            font-size: 10px;
                                                            color: #adb5bd;
                                                            opacity: 0.8;
                                                            font-weight: 500;
                                                        ">
                                                        Powered by VoiceNinja
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal Footer -->
                                <div
                                    class="modal-footer d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                                    <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                                        <i class="fa-solid fa-refresh me-2"></i>Reset to Defaults
                                    </button>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary"
                                            onclick="toggleCustomizeModal()">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="saveChanges()">
                                            <i class="fa-solid fa-save me-2"></i>Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <script>
                            function toggleCustomizeModal() {
                                const modal = document.getElementById('customize-bot-modal');
                                if (modal.style.display === 'none') {
                                    modal.style.display = 'block';

                                    // Always fetch and apply backend start_btn_color and theme
                                    let agentId = "{{ agent.id if agent else '' }}";
                                    if (agentId) {
                                        fetch(`{{ host }}/api/get_agent_connection?agent_id=${agentId}`)
                                            .then(res => res.json())
                                            .then(response => {
                                                if (response.status === 'success' && response.data) {
                                                    // Set start button color
                                                    let startBtnColor = response.data.start_btn_color || '#1a1a1a';
                                                    currentStartBtnColor = startBtnColor;
                                                    if (startBtnColorPicker) startBtnColorPicker.value = startBtnColor;
                                                    if (startBtnColorValue) startBtnColorValue.textContent = startBtnColor;
                                                    if (previewVoiceChatBtn) previewVoiceChatBtn.style.background = startBtnColor;

                                                    // Set theme colors from backend
                                                    currentTheme = {
                                                        primary: response.data.primary_color || '#00d4ff',
                                                        secondary: response.data.secondary_color || '#006eff',
                                                        pulse: response.data.pulse_color || 'rgba(0, 212, 255, 0.3)'
                                                    };

                                                    // Update localStorage with current theme
                                                    localStorage.setItem('selectedTheme', JSON.stringify(currentTheme));

                                                    // Now reset preview widget with updated values
                                                    resetPreviewWidget();
                                                } else {
                                                    // Reset preview widget with default values if no data
                                                    resetPreviewWidget();
                                                }
                                            })
                                            .catch(error => {
                                                console.error('Error fetching agent connection:', error);
                                                // Reset preview widget with default values on error
                                                currentStartBtnColor = '#1a1a1a'; // Ensure default is set
                                                resetPreviewWidget();
                                            });
                                    } else {
                                        // Reset preview widget with default values if no agent ID
                                        currentStartBtnColor = '#1a1a1a'; // Ensure default is set
                                        resetPreviewWidget();
                                    }
                                } else {
                                    modal.style.display = 'none';
                                }
                            }

                            function resetPreviewWidget() {
                                // Reset button text and icon
                                const btn = document.getElementById('preview-voice-chat-btn');
                                const textSpan = document.getElementById('preview-btn-text');
                                const iconElement = btn?.querySelector('i');
                                const indicator = document.getElementById('preview-voice-indicator');

                                if (textSpan) textSpan.textContent = 'START CHAT';
                                if (iconElement) iconElement.className = 'fas fa-microphone';
                                if (btn) btn.style.background = currentStartBtnColor || '#1a1a1a';

                                // Apply current theme to indicator
                                const currentTheme = JSON.parse(localStorage.getItem('selectedTheme')) || {
                                    primary: '#00d4ff',
                                    secondary: '#006eff',
                                    pulse: 'rgba(0, 212, 255, 0.3)'
                                };

                                if (indicator) {
                                    // Always use gradient background (no more custom icons)
                                    indicator.style.background = `linear-gradient(45deg, ${currentTheme.primary}, ${currentTheme.secondary})`;
                                    indicator.innerHTML = '<div style="width: 20px; height: 20px; border-radius: 4px; background: rgba(255,255,255,0.9); animation: pulse 2s infinite;"></div>';
                                }

                                // Update the active color option based on stored theme
                                updateActiveColorOption(currentTheme);
                            }

                            function updateActiveColorOption(theme) {
                                // Remove active class from all color options
                                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));

                                // Find and activate the matching color option
                                const colorOptions = document.querySelectorAll('.color-option');
                                colorOptions.forEach(option => {
                                    const onclickAttr = option.getAttribute('onclick');
                                    if (onclickAttr && onclickAttr.includes(theme.primary) && onclickAttr.includes(theme.secondary)) {
                                        option.classList.add('active');
                                    }
                                });
                            }
                        </script>
                    </div>
                    <!-- <div class="col-md-2">
                            <label class="form-label">Enable Design</label>
                            <div class="form-check form-switch d-flex align-items-center gap-2 ps-0">
                                <label class="form-label mb-0">Off</label>
                                <input class="form-check-input float-none ms-0" type="checkbox" role="switch" id="flexSwitchCheckChecked"  {% if agent.is_design_enabled %} checked {% endif %} onchange="toggleDesign(this.checked)">
                                <label class="form-label mb-0">On</label>
                            </div>
                        </div> -->
                    <script>
                        async function toggleDesign(isEnabled) {
                            try {
                                const response = await fetch("{{ host }}/api/toggle-design", {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        agent_id: '{{ agent.id }}',
                                        is_enabled: isEnabled
                                    })
                                });
                                const data = await response.json();
                                if (data.status === 'success') {
                                    toastr.success("Design toggle updated successfully");
                                } else {
                                    toastr.error("Failed to update design toggle");
                                }
                            } catch (error) {
                                toastr.error("Error updating design toggle:", error);
                            }
                        }
                    </script>
                </div>
                {% endif %}
                <div class="wlcm_msg_box pt-4">
                    <label class="form-label">Welcome Message</label>
                    <div class="custom-select">
                        <div class="select-box position-relative" id="welcome-msg">
                            {% if agent %}{{ agent.welcome_msg }}{% else %}Hi, how are you?{% endif %}
                        </div>
                        <input type="text" id="welcome-message" class="form-control mt-2"
                            placeholder="Enter custom welcome message..." style="display: none;">
                        <div class="options">
                            <div class="option" data-value="custom"><i class="fas fa-plus-circle me-2"
                                    style="color: #007bff;"></i>Add Custom Message</div>

                            <div class="option" data-value="1">Hi, I am SAGE, how can I help you?</div>
                            <div class="option" data-value="2">Hey there, Captain! How can I help you?</div>
                            <div class="option" data-value="3">Hi there, I am Jack Sparrow, how can I help you?</div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Variables Section -->
                <div class="dynamic_variables_box pt-4" id="dynamic-variables-section" style="display: none;">
                    <label class="form-label">Dynamic Variables</label>
                    <small class="text-muted d-block mb-2">Variables found in your prompt template. Set values to
                        customize responses.</small>
                    <div id="dynamic-variables">
                        <!-- Variables will be populated dynamically -->
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewVariable()">
                            <i class="fas fa-plus"></i> Add Variable
                        </button>
                    </div>
                </div>

            </div>
            {% if not agent %}
            <div class="save_btn_box mt-3 text-center">
                <button type="button" class="save_btn" id="save-btn">
                    Save
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>
</div>

<div class="modal fade" tabindex="-1" aria-hidden="true" id="noise-settings-modal" style="display: none;">
    <div class="modal-dialog modal-dialog-centered" style="max-width:650px;">
        <div class="variable-modal-content modal-content">
            <h6 class="border-bottom p-3">Noise Settings</h6>
            <div class="px-3">
                <small class="text-muted">Set noise settings variables for audio.</small>
                <div class="mt-3 border-bottom pb-2 variable-modal-content-item-outer">
                    <div class="variable-modal-content-item mb-2">
                        <h5 class="mb-0">Variable Name</h5>
                        <h5 class="mb-0">Assigned Value</h5>
                        <h5 class="mb-0">Reset</h5>
                    </div>
                    <div id="noise-settings">
                        <!--Populated dynamically from API response-->
                    </div>
                </div>
                <div class="variable-modal-footer d-flex align-items-center gap-2 justify-content-end p-3">
                    <button class="cancel-btn" onclick="closeNoiseVariableModal()">Cancel</button>
                    <button class="save-btn" onclick="saveNoiseVariabless()">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade help-ai-modal" id="helpAiModal" data-bs-backdrop="static" tabindex="-1"
    aria-labelledby="helpAiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="d-flex align-items-center gap-3 mb-0"><span><img
                            src="{{ url_for('static', path='/Web/images/eos-icons_ai.svg') }}" class="img-fluid"></span>
                    Prompt Generator</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="close-help-ai-modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="help_ai_modal_slider">
                    <div class="help_ai_modal_slider_item">
                        <h4>What is the primary function of your AI agent?</h4>
                        <div>
                            <select class="form-select" id="agent-function">
                                <option value="Answering questions" selected>Answering questions</option>
                                <option value="Providing information">Providing information</option>
                                <option value="Assisting with tasks">Assisting with tasks</option>
                                <option value="Engaging in conversations">Engaging in conversations</option>
                            </select>
                        </div>
                    </div>
                    <div class="help_ai_modal_slider_item">
                        <h4>What tone should the AI agent use?</h4>
                        <div>
                            <select class="form-select" id="agent-tone">
                                <option value="Formal" selected>Formal</option>
                                <option value="Friendly">Friendly</option>
                                <option value="Professional">Professional</option>
                                <option value="Neutral">Neutral</option>
                                <option value="Humorous">Humorous</option>
                            </select>
                        </div>
                    </div>
                    <div class="help_ai_modal_slider_item">
                        <h4>What level of detail should the responses have?</h4>
                        <div>
                            <select class="form-select" id='level-of-detail'>
                                <option value="Brief and concise" selected>Brief and concise</option>
                                <option value="Moderate detail">Moderate detail</option>
                                <option value="In-depth and explanatory">In-depth and explanatory</option>
                                <option value="Step-by-step guidance">Step-by-step guidance</option>
                            </select>
                        </div>
                    </div>
                    <div class="help_ai_modal_slider_item">
                        <h4>Which industry does your AI agent serve?</h4>
                        <div>
                            <select class="form-select" id='industry'>
                                <option value="Retail" selected>Retail</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Finance">Finance</option>
                                <option value="Technology">Technology</option>
                                <option value="Education">Education</option>
                                <option value="Customer Support">Customer Support</option>
                                <option value="Marketing">Marketing</option>
                            </select>
                        </div>
                    </div>
                    <div class="help_ai_modal_slider_item">
                        <h4>What would you like to call your agent? (Optional)</h4>
                        <div>
                            <input type="text" class="form-control" placeholder="(Optional)" id='agent-name-new'>
                        </div>
                    </div>
                </div>
                <!-- Navigation Buttons -->
                <div class="slider-nav d-flex align-items-center justify-content-between">
                    <button class="prev-btn align-items-center justify-content-center prev_btn" disabled><img
                            src="{{ url_for('static', path='/Web/images/slider-prev-icon.svg') }}"
                            class="img-fluid">Previous</button>
                    <button class="next-btn align-items-center justify-content-center"> Next <img
                            src="{{ url_for('static', path='/Web/images/slider-next-icon.svg') }}"
                            class="img-fluid"></button>
                    <button class="submit-btn align-items-center justify-content-center" style="display: none;"
                        id="generate-prompt-btn">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="dialog"
    style="position: absolute; width: 300px; background: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 16px; left: 330px; top: 180px; border: 1px solid #ddd; z-index: 1000; display: none;">
    <div>
        <strong>LLM Temperature</strong>
        <p style="font-size: 12px; color: #666;">Lower value yields better function call results.</p>
        <small class="text-muted">Default: 1.0</small>
        <div style="position: relative; width: 100%;">
            <input id="temperatureSlider" type="range" min="0.0" max="2.0" step="0.1"
                value="{% if agent.temperature %}{{ agent.temperature }}{% else %}0.00{% endif %}" style="width: 100%;">
            <div id="sliderValue"
                style="position: absolute; top: -25px; left: 0%; transform: translateX(-50%); background: #0C7FDA; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                0.00</div>
        </div>
    </div>
    <div>
        <strong>Max Output Tokens</strong>
        <p style="font-size: 12px; color: #666;">The maximum number of tokens to generate in the completion.</p>
        <small class="text-muted">Min: 100</small>
        <small class="text-muted">Default: 4096</small>
        <small class="text-muted">Max: 8000</small>
        <div style="position: relative; width: 100%;">
            <input id="maxOutputTokensSlider" type="text" class="form-control" placeholder="Enter max output tokens"
                value="{% if agent.max_output_tokens %}{{ agent.max_output_tokens }}{% else %}1000{% endif %}">
        </div>
    </div>
    <hr style="margin-top: 10px;">
    <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
        <button id="closeDialog"
            style="padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; background: #f0f0f0;"
            onclick="closeDialog()">Cancel</button>
        <button
            style="padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; background: #0C7FDA; color: white; margin-left: 8px;"
            onclick="saveSettings()">Save</button>
    </div>
</div>
<script src="{{ host }}/elevenlabs/chatbot-script-preview.js/{{ agent_id }}"></script>
<script src="{{ host }}/static/js/elevenlabs_websocket.js"></script>
<script src="{{ host }}/static/js/elevenlabs/openEditWebhookModal.js"></script>

<input hidden id="username" placeholder="Username" value="admin">
<input hidden id="password" placeholder="Password" value="admin123">
<input hidden id="elevenlabs-agent-id" value="{{ agent_id }}">
<script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/balloon/ckeditor.js"></script>

{% raw %}
<script>

    /* ------------------------------------------------------------------
    GLOBAL POPUP HANDLERS
    ------------------------------------------------------------------ */

    document.addEventListener("click", e => {
        if (!e.target.closest("#varPopup")) {
            document.getElementById("varPopup").style.display = "none";
        }
    });

    function attachPopupItemEvents() {
        document.querySelectorAll("#varPopup .var-item").forEach(item => {
            item.onclick = function () {
                const variable = this.getAttribute("data-var");
                const insertText = `${variable}}}`;
                const popup = document.getElementById("varPopup");

                popup.style.display = "none";

                editorInstance.model.change(writer => {
                    const pos = editorInstance.model.document.selection.getFirstPosition();
                    writer.insertText(insertText, pos);
                });
            };
        });
    }


    /* ------------------------------------------------------------------
    POPUP DISPLAY LOGIC
    ------------------------------------------------------------------ */

    function showVariablePopup() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;

        const range = sel.getRangeAt(0);
        const rect = range.getBoundingClientRect();

        const popup = document.getElementById("varPopup");

        popup.style.position = "fixed";
        popup.style.left = rect.left + "px";
        popup.style.top = (rect.bottom + 4) + "px";
        popup.style.display = "block";
    }

    function enableVariablePopup(editor) {
        const viewDoc = editor.editing.view.document;

        viewDoc.on("insertText", (evt, data) => {
            if (data.text !== "{") return;

            setTimeout(() => {
                const sel = window.getSelection();
                const textBefore = sel.anchorNode.textContent.slice(0, sel.anchorOffset);

                if (textBefore.endsWith("{{")) {
                    showVariablePopup();
                }
            }, 0);
        });
    }


    /* ------------------------------------------------------------------
    VARIABLE PILL MODEL SCHEMA
    ------------------------------------------------------------------ */

    function registerVariablePillSchema(editor) {
        editor.model.schema.register("variablePill", {
            allowWhere: "$text",
            isInline: true,
            isObject: true,
            allowAttributes: ["data-var", "style"]
        });

        editor.conversion.for("upcast").elementToElement({
            view: { name: "span", attributes: { "data-var": true } },
            model: (viewEl, { writer }) => {
                return writer.createElement("variablePill", {
                    "data-var": viewEl.getAttribute("data-var"),
                    "style": viewEl.getAttribute("style")
                });
            }
        });

        editor.conversion.for("downcast").elementToElement({
            model: "variablePill",
            view: (modelEl, { writer }) => {
                return writer.createContainerElement("span", {
                    "data-var": modelEl.getAttribute("data-var"),
                    "style": modelEl.getAttribute("style")
                });
            }
        });
    }


    /* ------------------------------------------------------------------
    WRAPPING VARIABLES AS PILLS
    ------------------------------------------------------------------ */

    function enableRealtimeWrapping(editor) {
        const pillStyle = "background:#fff3b0;padding:3px 4px;border-radius:4px;font-weight:600;color:#000;";
        const viewDoc = editor.editing.view.document;

        viewDoc.on("insertText", (evt, data) => {
            if (data.text !== "}") return;
            setTimeout(() => wrapInView(editor, pillStyle), 0);
        });
    }

    function wrapInView(editor, pillStyle) {
        const view = editor.editing.view;
        const writer = view.document.writer;

        view.change(writer => {
            const range = view.createRangeIn(view.document.getRoot());

            for (const value of range) {
                const node = value.item;

                if (!node.is("text")) continue;

                const text = node.data;
                const regex = /{{\s*([a-zA-Z0-9_]+)\s*}}/g;
                const match = regex.exec(text);
                if (!match) continue;

                const full = match[0];
                const name = match[1];
                const start = match.index;
                const end = start + full.length;

                const startPos = writer.createPositionAt(node, start);
                const endPos = writer.createPositionAt(node, end);
                const wrapRange = writer.createRange(startPos, endPos);

                writer.remove(wrapRange);

                const span = writer.createAttributeElement("span", {
                    "data-var": name,
                    "style": pillStyle
                });

                writer.insert(span, startPos);
                writer.insert(viewWriter.createText(full), span);
                //writer.insertText(full, span);

                return;
            }
        });
    }

    function wrapVariables(text) {
        const pillStyle =
            'background:#fff3b0;padding:3px 4px;border-radius:4px;font-weight:600;color:#000;';

        return text.replace(/{{\s*([a-zA-Z0-9_]+)\s*}}/g,
            (_, name) => `<span data-var="${name}" style="${pillStyle}">{{${name}}}</span>`
        );
    }

    function htmlToPlainText(html) {
        const div = document.createElement("div");
        div.innerHTML = html;
        return div.innerText.trim();
    }

    /* ------------------------------------------------------------------
    INIT CKEDITOR
    ------------------------------------------------------------------ */

    let originalRawValue = document.getElementById("agent-prompt").value.trim();
    let editorInstance;

    BalloonEditor.create(document.querySelector("#editor"), {
        toolbar: [
            "bold", "italic", "underline", "|",
            "numberedList", "bulletedList", "|",
            "undo", "redo"
        ],
        htmlSupport: {
            allow: [
                {
                    name: "span",
                    attributes: true,
                    classes: true,
                    styles: true
                }
            ]
        }
    })
        .then(editor => {
            editorInstance = editor;

            //editor.setData(
            //   originalRawValue.replace(/\n/g, "<br>")
            //);
            editor.setData(wrapVariables(originalRawValue).replace(/\n/g, "<br>"));

            registerVariablePillSchema(editor);
            enableRealtimeWrapping(editor);
            enableVariablePopup(editor);
            attachPopupItemEvents();

        })
        .catch(err => console.error(err));


    /* ------------------------------------------------------------------
    SAVE BUTTON
    ------------------------------------------------------------------ */

    document.getElementById("save-editor-btn").addEventListener("click", function () {
        if (!editorInstance) return;

        let html = editorInstance.getData();
        const cleanedText = html
            .replace(/<br\s*\/?>/gi, "\n")
            .replace(/<\/(p|div|section|li)>/gi, "\n")
            .replace(/<[^>]+>/g, "")        // remove remaining tags
            .replace(/&nbsp;/g, " ")
            .replace(/\n{3,}/g, "\n\n")
            .trim();

        // 3) Put cleaned text into hidden input and call save functions
        document.getElementById("agent-prompt").value = cleanedText;

        const url = new URL(window.location.href);
        const agentId = url.searchParams.get("agent_id");

        // Your save APIs
        saveAgentPrompt(agentId, cleanedText);
        updateAgentSetting('prompt', cleanedText);

        console.log("save: success", { cleanedText, html });
    });

</script>
{% endraw %}

<script>
    var dynamicVariables = {{ dynamic_variables| tojson | safe }};

    function toggleVariableModal() {
        const modal = document.getElementById('variable-modal');
        if (modal.style.display === 'none') {
            modal.style.display = 'block';
            // Populate the modal with current dynamic variables
            populateDynamicVariables();
        } else {
            modal.style.display = 'none';
        }
    }

    function populateDynamicVariables() {
        const dynamicVariablesDiv = document.getElementById("dynamic-variables");
        if (!dynamicVariablesDiv) return;

        // Clear existing content
        dynamicVariablesDiv.innerHTML = '';

        // Get dynamic variables from the template context


        if (dynamicVariables && Object.keys(dynamicVariables).length > 0) {
            // Add existing variables
            Object.entries(dynamicVariables).forEach(([key, value]) => {
                addVariableToModal(key, value);
            });
        } else {
            // Add a default empty row if no variables exist
            addVariableToModal('', '');
        }
    }

    function addVariableToModal(name, value) {
        const dynamicVariablesDiv = document.getElementById("dynamic-variables");
        if (!dynamicVariablesDiv) return;

        const variableDiv = document.createElement("div");
        variableDiv.className = "variable-modal-content-item mb-2";
        variableDiv.innerHTML = `
            <input type="text" class="form-control" placeholder="Variable Name" value="${name}">
            <input type="text" class="form-control" placeholder="Enter the value" value="${value}">
            <button class="dlt_btn bg-transparent border-0 p-0" onclick="removeVariable(this)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
            </button>
        `;

        dynamicVariablesDiv.appendChild(variableDiv);
    }
</script>
<script>
    let host = "{{ host }}";
    let selectedIconUrl = "{{ host }}/static/Web/images/gif-icon-1.gif"; // Default icon

    function updateAgentSetting(field, value) {
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");

        fetch(`${host}/elevenlabs/api/v1/edit_agent`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({
                agent_id: agentId,
                [field]: value   // dynamic key
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    toastr.success("Agent updated successfully");
                } else {
                    toastr.error(data.message || "Failed to update agent");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                toastr.error("Something went wrong!");
            });
    }

    $(document).ready(function () {
        var $slider = $('.help_ai_modal_slider');

        function initSlider() {
            if (!$slider.hasClass('slick-initialized')) {
                $slider.slick({
                    infinite: false,
                    slidesToShow: 1,
                    slidesToScroll: 1,
                    arrows: false, // Hide default arrows
                    dots: false,
                    adaptiveHeight: true, // Adjust height dynamically
                });

                // Reveal the slider after initialization
                $slider.css("display", "block");
            }
        }

        $('.modal').on('shown.bs.modal', function () {
            initSlider();
            setTimeout(() => {
                $slider.slick('setPosition'); // Ensure correct rendering
            }, 100); // Small delay to prevent width glitch
        });

        $('.prev-btn').click(function () {
            if (!$(this).prop('disabled')) {
                $slider.slick('slickPrev');
            }
        });

        $('.next-btn').click(function () {
            $slider.slick('slickNext');
        });

        $slider.on('afterChange', function (event, slick, currentSlide) {
            $('.prev-btn').prop('disabled', currentSlide === 0);
            $('.next-btn').toggle(currentSlide !== slick.slideCount - 1);
            $('.submit-btn').toggle(currentSlide === slick.slideCount - 1);
        });

        function resetModal() {
            $("#agent-function").val("Answering questions");
            $("#agent-tone").val("Formal");
            $("#level-of-detail").val("Brief and concise");
            $("#industry").val("Retail");
            $("#agent-name-new").val("");

            // Reset slider to the first slide
            $slider.slick('slickGoTo', 0);
            $('.prev-btn').prop('disabled', true);
            $('.next-btn').show();
            $('.submit-btn').hide();
        }

        $('.modal').on('hidden.bs.modal', function () {
            resetModal();

            // Manually trigger a width update on close to prevent glitch
            setTimeout(() => {
                $slider.slick('setPosition');
            }, 100);
        });
    });




</script>
<script>
    let selectedTheme = {
        primaryColor: null,
        secondaryColor: null,
        pulseColor: null
    };


    document.addEventListener("DOMContentLoaded", function () {
        const selectBox = document.getElementById("welcome-msg");
        const optionsContainer = document.querySelector(".options");
        const options = document.querySelectorAll(".option");

        // Check if elements exist
        if (!selectBox || !optionsContainer) {
            console.error("Welcome message elements not found:", {
                selectBox: !!selectBox,
                optionsContainer: !!optionsContainer
            });
            return;
        }

        // Toggle dropdown
        selectBox.addEventListener("click", function () {
            optionsContainer.classList.toggle("active");
        });

        // Change the selected option
        options.forEach(option => {
            option.addEventListener("click", function () {
                selectBox.textContent = this.textContent;
                optionsContainer.classList.remove("active");
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", function (event) {
            if (!selectBox.parentElement.contains(event.target)) {
                optionsContainer.classList.remove("active");
            }
        });
    });

    function copyScript() {
        let script = $("#agent-script").val();
        navigator.clipboard.writeText(script);
        toastr.success("Script copied to clipboard", { positionClass: "toast-top-right" });
    }
</script>

<script>



    $(document).ready(function () {
        $(".select-box").click(function () {
            $(".options").toggleClass("visible");
        });

        $(".option").click(function () {
            let selectedText = $(this).text();
            $(".select-box").text(selectedText);
            $(".options").removeClass("visible");
        });

        // Close dropdown when clicking outside
        $(document).click(function (e) {
            if (!$(e.target).closest(".custom-select").length) {
                $(".options").removeClass("visible");
            }
        });
    });


    $("#save-btn").click(function () {
        let searchParams = new URLSearchParams(window.location.search);
        let agentId = searchParams.get('agent_id');

        let agentName = $("#agent-name").text().trim();
        let agentPrompt = $("#agent-prompt").val();
        let welcomeMsg = $("#welcome-msg").text();
        let selectedModel = $("#selected-model").val();
        let selectedVoice = $("#selected-voice").val();
        let selectedLanguage = $("#selected-language").val();
        let selectedKnowledgeBase = $("#selected-knowledge-base").val();
        if (agentName == "" || agentPrompt == "" || welcomeMsg == "" || selectedModel == "" || selectedVoice == "" || selectedLanguage == "") {
            toastr.error("Please fill all the fields", { positionClass: "toast-top-right" });
            return;
        }

        // Use absolute URL to avoid redirect
        let requestUrl = agentId ? `{{ host }}/api/edit_agent` : `{{ host }}/api/create_new_agent`;

        $.ajax({
            url: requestUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                agent_id: agentId,
                agent_name: agentName,
                agent_prompt: agentPrompt,
                welcome_msg: welcomeMsg,
                selected_model: selectedModel,
                selected_voice: selectedVoice,
                selected_language: selectedLanguage,
                selected_knowledge_base: selectedKnowledgeBase
            }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function (response) {
                if (response.status == "success") {
                    toastr.success(response.message, { positionClass: "toast-top-right" });
                    setTimeout(function () {
                        window.location.href = "/dashboard"; // Use absolute path
                    }, 2000);
                }
                else {
                    toastr.error("Something went wrong!", { positionClass: "toast-top-right" });
                }
            },
            error: function (xhr, status, error) {
                console.log("Error:", xhr.responseText); // Log error details
                toastr.error("Something went wrong!", { positionClass: "toast-top-right" });
            }
        });
    });



    function changeIcon(iconUrl, element) {
        // Remove 'active' class from previously selected icon
        let previousActive = document.querySelector('.icon-option.active');
        if (previousActive) {
            previousActive.classList.remove('active');
        }

        // Ensure element exists
        if (!element) {
            console.error('Element is undefined');
            return;
        }

        // Find the closest .icon-option parent
        let iconOption = element.closest('.icon-option');
        if (!iconOption) {
            console.error('Could not find parent .icon-option element');
            return;
        }

        // Add 'active' class to the selected icon
        iconOption.classList.add('active');

        // Update global variable for tracking the selected icon
        selectedIconUrl = iconUrl;
    }

    // Preview functions for the customization modal
    function toggleElevenLabsChat() {
        // This is just for preview demo purposes
        const btn = document.getElementById('preview-voice-chat-btn');
        const indicator = document.getElementById('preview-voice-indicator');

        if (btn && indicator) {
            // Get current theme colors from localStorage or use defaults
            const currentTheme = JSON.parse(localStorage.getItem('selectedTheme')) || {
                primary: '#00d4ff',
                secondary: '#006eff'
            };

            // Toggle button text and styling
            const textSpan = btn.querySelector('#preview-btn-text');
            const iconElement = btn.querySelector('i');

            if (textSpan.textContent === 'START CHAT') {
                // Connecting state
                textSpan.textContent = 'END CALL';
                btn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                indicator.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';

                // Change icon to end call
                if (iconElement) {
                    iconElement.className = 'fas fa-phone-slash';
                }
            } else {
                // Default state - use current theme colors and start button color
                textSpan.textContent = 'START CHAT';
                // Use the customized start button color instead of hardcoded gray
                btn.style.background = currentStartBtnColor;
                // Use the selected theme colors, not hardcoded blue
                indicator.style.background = `linear-gradient(45deg, ${currentTheme.primary}, ${currentTheme.secondary})`;

                // Change icon back to microphone
                if (iconElement) {
                    iconElement.className = 'fas fa-microphone';
                }
            }
        }
    }

    function toggleLanguagePanel() {
        // This is just for preview demo purposes
        const chevron = document.querySelector('#preview-language-btn .fa-chevron-down');
        if (chevron) {
            chevron.style.transform = chevron.style.transform === 'rotate(180deg)' ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    }


    document.addEventListener("DOMContentLoaded", function () {
        try {
            let agentId = "{{ agent.id if agent else '' }}";
            if (agentId) {
                $.ajax({
                    url: `{{ host }}/api/get_agent_connection`,
                    type: 'GET',
                    data: { agent_id: agentId },
                    success: function (response) {
                        if (response.status == "success") {
                            let connection = response.data || {};
                            let iconUrl = connection.icon_url || "{{ host }}/static/Web/images/gif-icon-1.gif";
                            let primaryColor = connection.primary_color || "#00b4d8";
                            let secondaryColor = connection.secondary_color || "#0077b6";
                            let pulseColor = connection.pulse_color || "rgba(0, 180, 216, 0.3)";

                            // First apply theme to main widget
                            applyThemeToMainWidget(primaryColor, secondaryColor, pulseColor);

                            // Find icon option matching the saved icon URL
                            let iconOptions = document.querySelectorAll('.icon-option');
                            let matchingIcon = Array.from(iconOptions).find(option => {
                                let img = option.querySelector('img');
                                return img && img.src === iconUrl;
                            });

                            // If matching icon found, activate it, otherwise use first icon
                            if (matchingIcon) {
                                changeIcon(iconUrl, matchingIcon);
                            } else {
                                let firstIcon = document.querySelector('.icon-option');
                                if (firstIcon) {
                                    let firstIconUrl = firstIcon.querySelector('img').src;
                                    changeIcon(firstIconUrl, firstIcon);
                                }
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("Error:", xhr.responseText);
                    }
                });
            }
        } catch (error) {
            console.error("Error in DOMContentLoaded:", error);
        }
    });


    function saveChanges() {
        const customizeBotModal = document.getElementById('customize-bot-modal');
        const voiceIcon = document.querySelector('.voice_icon');

        if (customizeBotModal) {
            customizeBotModal.classList.remove('show');
            setTimeout(() => {
                customizeBotModal.style.display = 'none';
                if (voiceIcon) {
                    voiceIcon.style.display = 'block';
                }
            }, 500);
        }

        let agentId = "{{ agent.id if agent else '' }}"; // Get agent ID safely
        let iconUrl = selectedIconUrl; // Use dynamically updated icon

        // Get colors from CSS variables
        let primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || "#00b4d8";
        let secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim() || "#0077b6";
        let pulseColor = getComputedStyle(document.documentElement).getPropertyValue('--pulse-shadow').trim() || "rgba(0, 180, 216, 0.3)";
        let startBtnColor = currentStartBtnColor || '#1a1a1a';

        // Create the data payload
        let data = {
            agent_id: agentId,
            icon_url: iconUrl,
            primary_color: primaryColor,
            secondary_color: secondaryColor,
            pulse_color: pulseColor,
            start_btn_color: startBtnColor
        };

        // Send data to API
        fetch(`{{ host }}/api/save_changes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(response => {
                if (response.status === "success") {
                    toastr.success("Changes saved successfully", { positionClass: "toast-top-right" });
                } else {
                    throw new Error(response.message || "Something went wrong!");
                }
            })
            .catch(error => {
                toastr.error(error.message, { positionClass: "toast-top-right" });
            });
    }



    function toggleRecorder() {
        const customizeBotModal = document.getElementById('customize-bot-modal');
        const voiceIcon = document.querySelector('.voice_icon');

        if (customizeBotModal.classList.contains('show')) {
            customizeBotModal.classList.remove('show');
            setTimeout(() => {
                customizeBotModal.classList.add('hidden');
            }, 500);
        } else {
            customizeBotModal.classList.remove('hidden');
            setTimeout(() => customizeBotModal.classList.add('show'), 10);
            voiceIcon.style.display = 'none'; // Hide voice icon when opened
        }
    }


    function toggleColorPalette() {
        const colorPalette = document.getElementById('colorPalette');
        colorPalette.classList.toggle('show');
    }
    function toggleIconPalette() {
        const iconPalette = document.getElementById('iconPalette');
        iconPalette.classList.toggle('show');
    }

    function applyThemeToMainWidget(primaryColor, secondaryColor, pulseColor) {
        // Apply colors to CSS variables
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        document.documentElement.style.setProperty('--pulse-shadow', pulseColor);

        // Convert Hex to RGB and store as CSS variable
        const rgbMatch = primaryColor.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
        if (rgbMatch) {
            const r = parseInt(rgbMatch[1], 16);
            const g = parseInt(rgbMatch[2], 16);
            const b = parseInt(rgbMatch[3], 16);
            document.documentElement.style.setProperty('--primary-color-rgb', `${r}, ${g}, ${b}`);
        }

        // Store theme in a global variable
        selectedTheme = { primaryColor, secondaryColor, pulseColor };

        // Hide the color palette
        const colorPalette = document.getElementById('colorPalette');
        if (colorPalette) {
            colorPalette.classList.remove('show');
        }
    }


    $("#generate-prompt-btn").click(function () {
        let agentFunction = $("#agent-function").val();
        let agentTone = $("#agent-tone").val();
        let levelOfDetail = $("#level-of-detail").val();
        let industry = $("#industry").val();
        let agentName = $("#agent-name-new").val();

        if (agentFunction == "" || agentTone == "" || levelOfDetail == "" || industry == "") {
            toastr.error("Please select all the fields", { positionClass: "toast-top-right" });
            return;
        }

        $("#generate-prompt-btn").prop("disabled", true);
        $("#close-help-ai-modal").prop("disabled", true);

        $.ajax({
            url: `{{ host }}/api/agent_prompt_suggestion/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ agent_function: agentFunction, agent_tone: agentTone, level_of_detail: levelOfDetail, industry: industry, agent_name: agentName }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function (response) {
                if (response.status == "success") {
                    toastr.success("Prompt generated successfully", { positionClass: "toast-top-right" });
                    $("#agent-prompt").val(response.prompt);
                } else {
                    toastr.error(response.message, { positionClass: "toast-top-right" });
                }

                $("#generate-prompt-btn").prop("disabled", false);
                $("#close-help-ai-modal").prop("disabled", false);
                $("#agent-name-new").val("");

                $("#helpAiModal").modal("hide");
            },
            error: function (xhr, status, error) {
                console.log("Error:", xhr.responseText);
                toastr.error("Something went wrong!", { positionClass: "toast-top-right" });

                $("#generate-prompt-btn").prop("disabled", false);
                $("#close-help-ai-modal").prop("disabled", false);
                $("#helpAiModal").modal("hide");
                $("#agent-name-new").val("");
            }
        });
    });

    function getCSRFToken() {
        return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }

    document.addEventListener("DOMContentLoaded", function () {
        const welcomeMessageInput = document.getElementById("welcome-message");
        const selectBox = document.getElementById("welcome-msg");
        const optionsContainer = document.querySelector(".options");
        const options = document.querySelectorAll(".options .option");

        // Check if elements exist
        if (!selectBox || !optionsContainer || !welcomeMessageInput) {
            console.error("Required elements not found:", {
                selectBox: !!selectBox,
                optionsContainer: !!optionsContainer,
                welcomeMessageInput: !!welcomeMessageInput
            });
            return;
        }

        const currentUrl = new URL(window.location.href);
        const isUpdatePage = currentUrl.pathname === "/update_agent";
        const agentId = currentUrl.searchParams.get("agent_id");

        selectBox.addEventListener("click", function (e) {
            e.stopPropagation(); // Prevent event bubbling
            optionsContainer.style.display = "block";
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", function (e) {
            if (!selectBox.contains(e.target) && !optionsContainer.contains(e.target)) {
                optionsContainer.style.display = "none";
            }
        });

        options.forEach(option => {
            option.addEventListener("click", function (e) {
                e.stopPropagation(); // Prevent event bubbling
                const selectedValue = this.getAttribute("data-value");
                const selectedText = this.innerText;

                if (selectedValue === "custom") {
                    selectBox.style.display = "none";
                    welcomeMessageInput.style.display = "block";
                    welcomeMessageInput.focus();
                } else {
                    selectBox.innerText = selectedText;
                    welcomeMessageInput.style.display = "none";
                    selectBox.style.display = "block";
                    optionsContainer.style.display = "none";

                    // Immediately save the welcome message when option is selected
                    saveWelcomeMessage(selectedText);
                }
            });
        });

        // Function to save welcome message immediately
        function saveWelcomeMessage(message) {
            const currentUrl = new URL(window.location.href);
            const agentId = currentUrl.searchParams.get("agent_id");

            // Update both local database and ElevenLabs
            fetch(`${host}/elevenlabs/api/v1/edit_agent`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify({
                    agent_id: agentId,
                    welcome_msg: message
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        toastr.success("Welcome message updated successfully", { positionClass: "toast-top-right" });

                    } else {
                        toastr.error(data.message || "Failed to update welcome message");

                    }
                })
                .catch(error => {

                    toastr.error("Error updating welcome message");
                });
        }

        let saveTimeout;

        welcomeMessageInput.addEventListener("blur", function () {
            clearTimeout(saveTimeout);
            handleCustomInput();
        });

        welcomeMessageInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                clearTimeout(saveTimeout);
                handleCustomInput();
                welcomeMessageInput.blur();
            }
        });

        function handleCustomInput() {
            const value = welcomeMessageInput.value.trim();
            if (value !== "") {
                selectBox.innerText = value;
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveWelcomeMessage(value);
                }, 300);
                welcomeMessageInput.style.display = "none";
                selectBox.style.display = "block";
                optionsContainer.style.display = "none";
            } else {
                toastr.error("Please enter a welcome message", { positionClass: "toast-top-right" });
                welcomeMessageInput.focus();
                return;
            }
        }
        function getCSRFToken() {
            return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        }
    });

    // Add the missing saveAgentPrompt function for ElevenLabs integration
    function saveAgentPrompt(agentId, promptText) {
        fetch("{{ host }}/elevenlabs/api/v1/edit_agent", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({
                agent_id: agentId,
                prompt: promptText
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status == "success") {
                    if (data.updated_dynamic_variables) {
                        try {
                            renderDynamicVariables(data.updated_dynamic_variables);

                        }

                        catch (err) {
                            console.error({ err }, "while updating dynamic variables")
                        }
                    }
                    toastr.success("Prompt saved successfully", { positionClass: "toast-top-right" });
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000)

                } else if (data.status == "error") {
                    toastr.error(data.message || "Error saving prompt", { positionClass: "toast-top-right" });
                } else {
                    toastr.error("Something went wrong!", { positionClass: "toast-top-right" });
                }
            })
            .catch(error => {
                console.error("Error saving prompt:", error);
                toastr.error("Error saving prompt", { positionClass: "toast-top-right" });
            });
    }


    function addNewVariable() {
        // Use our new helper function to add an empty variable row
        addVariableToModal('', '');
    }


    function removeVariable(button) {
        var variableModalContentItemOuter = button.parentElement;
        variableModalContentItemOuter.remove();

        // Only make API call if there's a variable name (not for empty rows)
        const variableName = button.parentElement.querySelector('input[type="text"]').value;
        if (variableName && variableName.trim()) {
            const currentUrl = new URL(window.location.href);
            const agentId = currentUrl.searchParams.get("agent_id");
            console.log('Removing variable:', variableName, 'from agent:', agentId);

            $.ajax({
                url: "{{ host }}/api/remove-variable",
                type: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ variable_id: variableName, agent_id: agentId }),
                success: function (response) {
                    toastr.success('Variable removed successfully');
                },
                error: function (xhr, status, error) {
                    toastr.error('Error removing variable: ' + error);
                }
            });
        }
    }

    function formatJSON() {
        var jsonTextarea = document.getElementById("parameters");
        var formattedJSON = jsonTextarea.value;
        jsonTextarea.value = formattedJSON;
    }

    function copyJSON() {
        var jsonTextarea = document.getElementById("parameters");
        var formattedJSON = jsonTextarea.value;
        jsonTextarea.value = formattedJSON;
    }

    // Function to update Parameters field in real-time based on form changes
    function updateParametersField() {
        try {
            // Helper function to safely get element value
            function getElementValue(id, defaultValue = "") {
                const element = document.getElementById(id);
                return element ? element.value : defaultValue;
            }

            // Helper function to safely get checkbox value
            function getCheckboxValue(id, defaultValue = false) {
                const element = document.getElementById(id);
                return element ? element.checked : defaultValue;
            }

            // Collect all form data
            const toolName = getElementValue("tool_name");
            const toolDescription = getElementValue("tool_description");
            const apiUrl = getElementValue("api_url");
            const httpMethod = getElementValue("http_method", "POST");
            const responseTimeout = getElementValue("response_timeout", "20");
            const disableInterruptions = getCheckboxValue("disable_interruptions", false);
            const forcePreToolSpeech = getCheckboxValue("force_pre_tool_speech", false);

            // Collect path parameters
            const pathParams = [];
            document.querySelectorAll('#path_params_container .path-param-row').forEach((row) => {
                const name = row.querySelector('input[name="path_param_name"]')?.value;
                const type = row.querySelector('select[name="path_param_type"]')?.value || 'string';
                const description = row.querySelector('input[name="path_param_description"]')?.value || '';
                const dynamicVariable = row.querySelector('input[name="path_param_dynamic_variable"]')?.value || '';
                const constantValue = row.querySelector('input[name="path_param_constant_value"]')?.value || '';
                const required = row.querySelector('input[name="path_param_required"]')?.checked || false;

                if (name) {
                    const pathParam = { name, type, description, required };
                    if (dynamicVariable) pathParam.dynamic_variable = dynamicVariable;
                    if (constantValue) pathParam.constant_value = constantValue;
                    pathParams.push(pathParam);
                }
            });

            // Collect query parameters
            const queryParams = [];
            document.querySelectorAll('#query_params_container .query-param-row').forEach((row) => {
                const name = row.querySelector('input[name="query_param_name"]')?.value;
                const type = row.querySelector('select[name="query_param_type"]')?.value || 'string';
                const description = row.querySelector('input[name="query_param_description"]')?.value || '';
                const dynamicVariable = row.querySelector('input[name="query_param_dynamic_variable"]')?.value || '';
                const constantValue = row.querySelector('input[name="query_param_constant_value"]')?.value || '';
                const required = row.querySelector('input[name="query_param_required"]')?.checked || false;

                if (name) {
                    const queryParam = { name, type, description, required };
                    if (dynamicVariable) queryParam.dynamic_variable = dynamicVariable;
                    if (constantValue) queryParam.constant_value = constantValue;
                    queryParams.push(queryParam);
                }
            });

            // Collect request body properties
            const requestBodyProperties = [];
            document.querySelectorAll('#request_body_properties_container .body-param-row').forEach((row) => {
                const name = row.querySelector('input[name="body_property_name"]')?.value;
                const type = row.querySelector('select[name="body_property_type"]')?.value || 'string';
                const description = row.querySelector('textarea[name="body_property_description"]')?.value || '';
                const dynamicVariable = row.querySelector('input[name="body_property_dynamic_variable"]')?.value || '';
                const constantValue = row.querySelector('input[name="body_property_constant_value"]')?.value || '';
                const required = row.querySelector('input[name="body_property_required"]')?.checked || false;

                if (name) {
                    const bodyProperty = { name, type, description, required };
                    if (dynamicVariable) bodyProperty.dynamic_variable = dynamicVariable;
                    if (constantValue) bodyProperty.constant_value = constantValue;
                    requestBodyProperties.push(bodyProperty);
                }
            });

            // Build the complete tool config
            const toolConfig = {
                name: toolName,
                type: "webhook",
                api_schema: {
                    url: apiUrl,
                    method: httpMethod,
                    auth_connection: null,
                    request_headers: {},
                    path_params_schema: pathParams.length > 0 ? pathParams : {},
                    query_params_schema: queryParams.length > 0 ? queryParams : null,
                    request_body_schema: null
                },
                assignments: [],
                description: toolDescription,
                dynamic_variables: {
                    dynamic_variable_placeholders: {}
                },
                disable_interruptions: disableInterruptions,
                force_pre_tool_speech: forcePreToolSpeech,
                response_timeout_secs: parseInt(responseTimeout) || 20
            };

            // Add request body schema for POST/PUT/PATCH methods
            if (["POST", "PUT", "PATCH"].includes(httpMethod) && requestBodyProperties.length > 0) {
                toolConfig.api_schema.request_body_schema = {
                    type: "object",
                    properties: requestBodyProperties
                };
            }

            // Update the parameters textarea
            const parametersTextarea = document.getElementById('parameters');
            if (parametersTextarea) {
                parametersTextarea.value = JSON.stringify({ tool_config: toolConfig }, null, 2);
            }

        } catch (error) {
            console.error('Error updating parameters field:', error);
        }
    }

    // Function to collect all webhook form data including nested structures
    function collectWebhookFormData() {
        try {
            // Helper function to safely get element value
            function getElementValue(id, defaultValue = "") {
                const element = document.getElementById(id);
                if (!element) {
                    console.error(`Element with id '${id}' not found`);
                    return defaultValue;
                }
                return element.value || defaultValue;
            }

            // Helper function to safely get element checked state
            function getElementChecked(id, defaultValue = false) {
                const element = document.getElementById(id);
                if (!element) {
                    console.error(`Element with id '${id}' not found`);
                    return defaultValue;
                }
                return element.checked || defaultValue;
            }

            return {
                // Basic tool configuration
                tool_name: getElementValue("tool_name"),
                tool_description: getElementValue("tool_description"),
                response_timeout: getElementValue("response_timeout", "20"),

                // API schema
                api_url: getElementValue("api_url"),
                http_method: getElementValue("http_method", "POST"),
                body_description: getElementValue("body_description"),

                // Advanced options
                disable_interruptions: getElementChecked("disable_interruptions"),
                force_pre_tool_speech: getElementChecked("force_pre_tool_speech"),

                // Nested arrays - these will be populated by dynamic form elements
                path_params: collectPathParams(),
                query_params: collectQueryParams(),
                request_body_properties: collectRequestBodyProperties(),
                request_headers: collectRequestHeaders(),
                dynamic_variables: collectDynamicVariables(),
                assignments: collectAssignments()
            };
        } catch (error) {
            console.error("Error collecting webhook form data:", error);
            toastr.error("Error collecting form data: " + error.message);
            return null;
        }
    }

    // Helper functions to collect nested form data
    function collectPathParams() {
        const params = [];
        const container = document.getElementById("path_params_container");
        const paramElements = container.querySelectorAll('.param-item');

        paramElements.forEach(element => {
            const name = element.querySelector('.param-name').value;
            const type = element.querySelector('.param-type').value;
            const required = element.querySelector('.param-required').checked;
            const valueType = element.querySelector('.param-value-type').value;

            // Get the appropriate value based on value type
            let description = '';
            let dynamicVar = '';
            let constantValue = '';

            if (valueType === 'llm_prompt') {
                const descInput = element.querySelector('.param-description');
                description = descInput ? descInput.value : '';
            } else if (valueType === 'constant_value') {
                const constInput = element.querySelector('.param-constant-value');
                constantValue = constInput ? constInput.value : '';
            } else if (valueType === 'dynamic_variable') {
                const dynInput = element.querySelector('.param-dynamic-var');
                dynamicVar = dynInput ? dynInput.value : '';
            }

            if (name) {
                const param = {
                    name,
                    type,
                    required
                };

                // Only add the relevant field based on value type
                if (valueType === 'llm_prompt' && description) {
                    param.description = description;
                } else if (valueType === 'constant_value' && constantValue) {
                    param.constant_value = constantValue;
                } else if (valueType === 'dynamic_variable' && dynamicVar) {
                    param.dynamic_variable = dynamicVar;
                }

                params.push(param);
            }
        });

        // Validate path parameters against URL placeholders
        const apiUrl = document.getElementById("api_url").value;
        if (!validatePathParametersAgainstURL(apiUrl, params)) {
            throw new Error("Path parameter validation against URL failed");
        }

        return params;
    }

    function collectQueryParams() {
        const params = [];
        const container = document.getElementById("query_params_container");
        const paramElements = container.querySelectorAll('.param-item');

        paramElements.forEach(element => {
            const name = element.querySelector('.param-name').value;
            const type = element.querySelector('.param-type').value;
            const required = element.querySelector('.param-required').checked;
            const valueType = element.querySelector('.param-value-type').value;

            // Get the appropriate value based on value type
            let description = '';
            let dynamicVar = '';
            let constantValue = '';

            if (valueType === 'llm_prompt') {
                const descInput = element.querySelector('.param-description');
                description = descInput ? descInput.value : '';
            } else if (valueType === 'constant_value') {
                const constInput = element.querySelector('.param-constant-value');
                constantValue = constInput ? constInput.value : '';
            } else if (valueType === 'dynamic_variable') {
                const dynInput = element.querySelector('.param-dynamic-var');
                dynamicVar = dynInput ? dynInput.value : '';
            }

            if (name) {
                const param = {
                    name,
                    type,
                    required
                };

                // Only add the relevant field based on value type
                if (valueType === 'llm_prompt' && description) {
                    param.description = description;
                } else if (valueType === 'constant_value' && constantValue) {
                    param.constant_value = constantValue;
                } else if (valueType === 'dynamic_variable' && dynamicVar) {
                    param.dynamic_variable = dynamicVar;
                }

                params.push(param);
            }
        });
        return params;
    }

    function collectRequestBodyProperties() {
        const properties = [];
        const container = document.getElementById("request_body_properties_container");
        const propElements = container.querySelectorAll('.param-item');

        propElements.forEach(element => {
            const name = element.querySelector('.param-name').value;
            const type = element.querySelector('.param-type').value;
            const required = element.querySelector('.param-required').checked;
            const valueType = element.querySelector('.param-value-type').value;

            // Get the appropriate value based on value type
            let description = '';
            let dynamicVar = '';
            let constantValue = '';

            if (valueType === 'llm_prompt') {
                const descInput = element.querySelector('.param-description');
                description = descInput ? descInput.value : '';
            } else if (valueType === 'constant_value') {
                const constInput = element.querySelector('.param-constant-value');
                constantValue = constInput ? constInput.value : '';
            } else if (valueType === 'dynamic_variable') {
                const dynInput = element.querySelector('.param-dynamic-var');
                dynamicVar = dynInput ? dynInput.value : '';
            }

            if (name) {
                const property = {
                    name,
                    type,
                    required
                };

                // Only add the relevant field based on value type
                if (valueType === 'llm_prompt' && description) {
                    property.description = description;
                } else if (valueType === 'constant_value' && constantValue) {
                    property.constant_value = constantValue;
                } else if (valueType === 'dynamic_variable' && dynamicVar) {
                    property.dynamic_variable = dynamicVar;
                }

                properties.push(property);
            }
        });
        return properties;
    }

    function collectRequestHeaders() {
        const headers = [];
        const container = document.getElementById("request_headers_container");
        const headerElements = container.querySelectorAll('.header-item');

        headerElements.forEach(element => {
            const name = element.querySelector('.header-name').value;
            const value = element.querySelector('.header-value').value;
            const type = element.querySelector('.header-type').value;

            if (name && value) {
                headers.push({ name, value, type });
            }
        });
        return headers;
    }

    function collectDynamicVariables() {
        const variables = [];
        const container = document.getElementById("dynamic_variables_container");
        const varElements = container.querySelectorAll('.variable-item');

        varElements.forEach(element => {
            const name = element.querySelector('.variable-name').value;
            const value = element.querySelector('.variable-value').value;

            if (name) {
                variables.push({ name, value });
            }
        });
        return variables;
    }

    function collectAssignments() {
        const assignments = [];
        const container = document.getElementById("assignments_container");
        const assignmentElements = container.querySelectorAll('.assignment-item');

        assignmentElements.forEach(element => {
            const dynamicVar = element.querySelector('.assignment-dynamic-var').value;
            const valuePath = element.querySelector('.assignment-value-path').value;
            const source = element.querySelector('.assignment-source').value;

            if (dynamicVar && valuePath) {
                assignments.push({ dynamic_variable: dynamicVar, value_path: valuePath, source });
            }
        });
        return assignments;
    }

    // Function to clear the webhook form
    function clearWebhookForm() {
        // Clear basic fields
        document.getElementById("tool_name").value = '';
        document.getElementById("tool_description").value = '';
        document.getElementById("api_url").value = '';
        document.getElementById("http_method").value = 'POST';
        document.getElementById("response_timeout").value = '20';
        document.getElementById("body_description").value = '';
        document.getElementById("disable_interruptions").checked = false;
        document.getElementById("force_pre_tool_speech").checked = false;

        // Clear dynamic containers and set default messages
        document.getElementById("path_params_container").innerHTML = '<p class="text-muted">No path parameters defined</p>';
        document.getElementById("query_params_container").innerHTML = '<p class="text-muted">No query parameters defined</p>';
        document.getElementById("request_body_properties_container").innerHTML = '<p class="text-muted">No properties defined</p>';
        document.getElementById("request_headers_container").innerHTML = '<p class="text-muted">No headers defined</p>';
        document.getElementById("dynamic_variables_container").innerHTML = '<p class="text-muted">No dynamic variables defined</p>';
        document.getElementById("assignments_container").innerHTML = '<p class="text-muted">No assignments defined</p>';
    }

    // Function to check if URL contains curly braces for path parameters
    function checkUrlForPathParams() {
        const apiUrl = document.getElementById("api_url").value;
        const addPathParamBtn = document.getElementById("add-path-param-btn");
        const pathParamsHelp = document.getElementById("path_params_help");

        if (!addPathParamBtn) return; // Button doesn't exist yet

        // Check if URL contains curly braces pattern like {param_name}
        const hasCurlyBraces = /\{[^}]+\}/.test(apiUrl);

        if (hasCurlyBraces) {
            addPathParamBtn.disabled = false;
            addPathParamBtn.classList.remove('btn-outline-secondary');
            addPathParamBtn.classList.add('btn-outline-primary');
            if (pathParamsHelp) pathParamsHelp.style.display = 'none';
        } else {
            addPathParamBtn.disabled = true;
            addPathParamBtn.classList.remove('btn-outline-primary');
            addPathParamBtn.classList.add('btn-outline-secondary');
            if (pathParamsHelp) pathParamsHelp.style.display = 'block';
        }
    }

    // Function to toggle request body schema section based on HTTP method
    function toggleRequestBodySchema() {
        const httpMethod = document.getElementById("http_method").value;
        const requestBodySection = document.getElementById("request_body_schema_section");

        if (!requestBodySection) return;

        // Show request body schema only for POST, PUT, PATCH methods
        if (["POST", "PUT", "PATCH"].includes(httpMethod)) {
            requestBodySection.style.display = 'block';
        } else {
            requestBodySection.style.display = 'none';
            // Clear any existing body properties when hiding
            document.getElementById("request_body_properties_container").innerHTML = '';
            document.getElementById("body_description").value = '';
        }
    }

    // Function to toggle edit modal request body schema section based on HTTP method
    function toggleEditRequestBodySchema() {
        const httpMethod = document.getElementById("edit_http_method").value;
        const requestBodySection = document.getElementById("edit_request_body_schema_section");

        if (!requestBodySection) return;

        // Show request body schema only for POST, PUT, PATCH methods
        if (["POST", "PUT", "PATCH"].includes(httpMethod)) {
            requestBodySection.style.display = 'block';
        } else {
            requestBodySection.style.display = 'none';
            // Clear any existing body properties when hiding
            document.getElementById("edit_request_body_properties_container").innerHTML = '';
            document.getElementById("edit_body_description").value = '';
        }
    }

    // Function to check if edit modal URL contains curly braces for path parameters
    function checkEditUrlForPathParams() {
        const apiUrl = document.getElementById("edit_api_url").value;
        const addPathParamBtn = document.getElementById("add-edit-path-param-btn");
        const pathParamsHelp = document.getElementById("edit_path_params_help");

        if (!addPathParamBtn) return; // Button doesn't exist yet

        // Check if URL contains curly braces pattern like {param_name}
        const hasCurlyBraces = /\{[^}]+\}/.test(apiUrl);

        if (hasCurlyBraces) {
            addPathParamBtn.disabled = false;
            addPathParamBtn.classList.remove('btn-outline-secondary');
            addPathParamBtn.classList.add('btn-outline-primary');
            if (pathParamsHelp) pathParamsHelp.style.display = 'none';
        } else {
            addPathParamBtn.disabled = true;
            addPathParamBtn.classList.remove('btn-outline-primary');
            addPathParamBtn.classList.add('btn-outline-secondary');
            if (pathParamsHelp) pathParamsHelp.style.display = 'block';
        }
    }

    // Dynamic form element creation functions
    function addPathParam() {
        // Check if URL contains curly braces before allowing path parameter addition
        const apiUrl = document.getElementById("api_url").value;
        const hasCurlyBraces = /\{[^}]+\}/.test(apiUrl);

        if (!hasCurlyBraces) {
            toastr.error('Please add curly braces to the URL (e.g., {agent_id}) before adding path parameters');
            return;
        }

        const container = document.getElementById("path_params_container");
        const paramId = 'path_param_' + Date.now();

        const paramHtml = `
        <div class="param-item border rounded p-3 mb-3" id="${paramId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Path Parameter</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${paramId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" placeholder="agent_id" required>
                </div>
               
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="togglePathParamValueType('${paramId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${paramId}_value_container">
                        <label class="form-label">Description</label>
                        <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', paramHtml);

        // Initialize field states for the new row
        const newRow = container.lastElementChild;
        initializeRowFieldStates(newRow);

        // Update Parameters field
        updateParametersField();
    }

    function togglePathParamValueType(paramId) {
        const container = document.getElementById(paramId + '_value_container');
        const valueTypeSelect = document.querySelector(`#${paramId} .param-value-type`);
        const valueType = valueTypeSelect.value;

        let html = '';
        if (valueType === 'llm_prompt') {
            html = `
            <label class="form-label">Description</label>
            <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
        } else if (valueType === 'constant_value') {
            html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="12345">
            <small class="text-muted">The constant value that will be used for this parameter.</small>
        `;
        } else if (valueType === 'dynamic_variable') {
            html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-var" placeholder="user_id">
            <small class="text-muted">The dynamic variable that will be replaced with actual values when the conversation starts.</small>
        `;
        }

        container.innerHTML = html;
    }

    function addQueryParam() {
        const container = document.getElementById("query_params_container");
        const paramId = 'query_param_' + Date.now();

        const paramHtml = `
        <div class="param-item border rounded p-3 mb-3" id="${paramId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Query Parameter</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${paramId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" placeholder="limit" required>
                </div>
                
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleQueryParamValueType('${paramId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${paramId}_value_container">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control param-description" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
                    </div>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', paramHtml);

        // Initialize field states for the new row
        const newRow = container.lastElementChild;
        initializeRowFieldStates(newRow);
    }

    function toggleQueryParamValueType(paramId) {
        const container = document.getElementById(paramId + '_value_container');
        const valueTypeSelect = document.querySelector(`#${paramId} .param-value-type`);
        const valueType = valueTypeSelect.value;

        let html = '';
        if (valueType === 'llm_prompt') {
            html = `
            <label class="form-label">Description</label>
            <input type="text" class="form-control param-description" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
        } else if (valueType === 'constant_value') {
            html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="10">
            <small class="text-muted">The constant value that will be used for this parameter.</small>
        `;
        } else if (valueType === 'dynamic_variable') {
            html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-var" placeholder="user_id">
            <small class="text-muted">The dynamic variable that will be replaced with actual values when the conversation starts.</small>
        `;
        }

        container.innerHTML = html;
    }

    function addRequestBodyProperty() {
        const container = document.getElementById("request_body_properties_container");
        const propId = 'property_' + Date.now();

        const propHtml = `
        <div class="param-item border rounded p-3 mb-3" id="${propId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Request Body Property</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${propId}')">Delete</button>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Data type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="object">Object</option>
                        <option value="array">Array</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Identifier *</label>
                    <input type="text" class="form-control param-name" placeholder="message" required>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input param-required" type="checkbox">
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleBodyPropertyValueType('${propId}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <div class="param-value-container" id="${propId}_value_container">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript." required></textarea>
                        <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript. <strong>Required for LLM Prompt type.</strong></small>
                    </div>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', propHtml);

        // Initialize field states for the new row
        const newRow = container.lastElementChild;
        initializeRowFieldStates(newRow);
    }

    function toggleBodyPropertyValueType(propId) {
        const container = document.getElementById(propId + '_value_container');
        const valueTypeSelect = document.querySelector(`#${propId} .param-value-type`);
        const valueType = valueTypeSelect.value;

        let html = '';
        if (valueType === 'llm_prompt') {
            html = `
            <label class="form-label">Description</label>
            <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
        } else if (valueType === 'constant_value') {
            html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="Hello">
            <small class="text-muted">The constant value that will be used for this property.</small>
        `;
        } else if (valueType === 'dynamic_variable') {
            html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-var" placeholder="user_message">
            <small class="text-muted">The dynamic variable that will be replaced with actual values when the conversation starts.</small>
        `;
        }

        container.innerHTML = html;
    }

    function addRequestHeader() {
        const container = document.getElementById("request_headers_container");
        const headerId = 'header_' + Date.now();

        const headerHtml = `
        <div class="header-item border rounded p-3 mb-3" id="${headerId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Request Header</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${headerId}')">Remove</button>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Header Name *</label>
                    <input type="text" class="form-control header-name" placeholder="Content-Type" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Type</label>
                    <select class="form-select header-type">
                        <option value="string" selected>String</option>
                        <option value="secret">Secret</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Value *</label>
                    <input type="text" class="form-control header-value" placeholder="application/json" required>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', headerHtml);
    }

    function addDynamicVariable() {
        const container = document.getElementById("dynamic_variables_container");
        const varId = 'variable_' + Date.now();

        const varHtml = `
        <div class="variable-item border rounded p-3 mb-3" id="${varId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Dynamic Variable</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${varId}')">Remove</button>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Variable Name *</label>
                    <input type="text" class="form-control variable-name" placeholder="user_id" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Value *</label>
                    <input type="text" class="form-control variable-value" placeholder="12345" required>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', varHtml);
    }

    function addAssignment() {
        const container = document.getElementById("assignments_container");
        const assignmentId = 'assignment_' + Date.now();

        const assignmentHtml = `
        <div class="assignment-item border rounded p-3 mb-3" id="${assignmentId}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Response Assignment</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${assignmentId}')">Remove</button>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Dynamic Variable *</label>
                    <input type="text" class="form-control assignment-dynamic-var" placeholder="response_id" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Value Path *</label>
                    <input type="text" class="form-control assignment-value-path" placeholder="data.id" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Source</label>
                    <select class="form-select assignment-source">
                        <option value="response" selected>Response</option>
                        <option value="request">Request</option>
                    </select>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', assignmentHtml);
    }

    // Helper function to remove elements
    function removeElement(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.remove();
        }
    }


    function updateFunctionElement(functionData) {
        const $li = $(`#function-${functionData.id}`);
        if ($li.length) {
            $li.find('div.functionNameDivBlock').text(functionData.function_name);
            $li.find('.edit-function-btn').attr('onclick', `openEditToolsModal(${functionData.id})`);
            $li.find('.delete-function-btn').attr('onclick', `deleteFunction(${functionData.id})`);
        }
    }
    function handleEditCustomFunction(functionId) {

        const activeTabId = document.querySelector('#FunctionToolTab .nav-link.active')?.id;

        const getVal = (row, selector) => {
            const el = row.querySelector(selector);
            return el ? (el.value ?? "").trim() : "";
        };
        const getChecked = (row, selector) => {
            const el = row.querySelector(selector);
            return !!(el && el.checked);
        };

        let toolConfig = {};
        let data = {};

        /* ============================================================
           CONFIG TAB SAVE
        ============================================================ */
        if (activeTabId === "configure-tab") {
            const errors = [];

            const toolName = (document.getElementById("edit_tool_name")?.value || "").trim();
            const toolDescription = (document.getElementById("edit_tool_description")?.value || "").trim();
            const apiUrl = (document.getElementById("edit_api_url")?.value || "").trim();
            const httpMethod = (document.getElementById("edit_http_method")?.value || "POST").toUpperCase();
            const bodyDescription = (document.getElementById("edit_body_description")?.value || "").trim();

            const disableInterruptions = !!document.getElementById("edit_disable_interruptions")?.checked;
            const forcePreToolSpeech = !!document.getElementById("edit_force_pre_tool_speech")?.checked;

            let responseTimeout = parseInt(document.getElementById("edit_response_timeout")?.value, 10);
            if (Number.isNaN(responseTimeout)) responseTimeout = 20;

            if (!toolName) errors.push("Tool name is required.");
            if (!apiUrl) errors.push("Webhook URL is required.");
            if (responseTimeout < 5 || responseTimeout > 120)
                errors.push("Response timeout must be between 5â€“120 seconds.");

            /* ============================================================
               PATH PARAMETERS
            ============================================================ */
            const pathParams = [];
            document.querySelectorAll('#edit_path_params_container .param-item')
                .forEach((row) => {

                    const name = getVal(row, '.param-name');
                    if (!name) return;

                    const type = getVal(row, '.param-type') || "string";
                    const valueType = getVal(row, '.param-value-type') || "llm_prompt";

                    let constantValue = null;
                    let dynamicVariable = null;
                    let description = null;

                    if (valueType === "constant_value") {
                        constantValue = getVal(row, '.param-constant-value');
                    }
                    else if (valueType === "dynamic_variable") {
                        dynamicVariable = getVal(row, '.param-dynamic-variable');
                    }
                    else {
                        description = getVal(row, '.param-description');
                    }

                    pathParams.push({
                        name,
                        type,
                        value_type: valueType,
                        constant_value: constantValue,
                        dynamic_variable: dynamicVariable,
                        description
                    });
                });

            // Validate URL placeholders
            const urlPlaceholders = [...apiUrl.matchAll(/\{([^}]+)\}/g)].map(m => m[1]);

            const missingInUrl = pathParams.filter(p => !urlPlaceholders.includes(p.name));
            if (missingInUrl.length)
                errors.push(`Path parameters not in URL: ${missingInUrl.map(p => p.name).join(", ")}`);

            const undefinedPlaceholders = urlPlaceholders.filter(ph => !pathParams.some(p => p.name === ph));
            if (undefinedPlaceholders.length)
                errors.push(`URL placeholders missing in Path Params: ${undefinedPlaceholders.join(", ")}`);

            if (errors.length) {
                toastr.error(errors[0]);
                return;
            }

            /* ============================================================
               QUERY PARAMETERS
            ============================================================ */
            const queryParams = [];
            document.querySelectorAll('#edit_query_params_container .param-item')
                .forEach((row) => {
                    const name = getVal(row, '.param-name');
                    if (!name) return;

                    const type = getVal(row, '.param-type') || "string";
                    const valueType = getVal(row, '.param-value-type') || "llm_prompt";

                    let constantValue = null;
                    let dynamicVariable = null;
                    let description = null;

                    if (valueType === "constant_value") {
                        constantValue = getVal(row, '.param-constant-value');
                    } else if (valueType === "dynamic_variable") {
                        dynamicVariable = getVal(row, '.param-dynamic-variable');
                    } else {
                        description = getVal(row, '.param-description');
                    }

                    queryParams.push({
                        name,
                        type,
                        value_type: valueType,
                        constant_value: constantValue,
                        dynamic_variable: dynamicVariable,
                        description
                    });
                });

            /* ============================================================
               REQUEST BODY PROPERTIES
            ============================================================ */
            const requestBodyProperties = [];
            document.querySelectorAll('#edit_request_body_properties_container .param-item')
                .forEach((row) => {

                    const name = getVal(row, '.param-name');
                    if (!name) return;

                    const type = getVal(row, '.param-type') || "string";
                    const required = getChecked(row, '.param-required');
                    const valueType = getVal(row, '.param-value-type') || "llm_prompt";

                    let constantValue = null;
                    let dynamicVariable = null;
                    let description = null;

                    if (valueType === "constant_value") {
                        constantValue = getVal(row, '.param-constant-value');
                    } else if (valueType === "dynamic_variable") {
                        dynamicVariable = getVal(row, '.param-dynamic-variable');
                    } else {
                        description = getVal(row, '.param-description');
                    }

                    requestBodyProperties.push({
                        name,
                        type,
                        required,
                        value_type: valueType,
                        constant_value: constantValue,
                        dynamic_variable: dynamicVariable,
                        description
                    });
                });

            /* ============================================================
               HEADERS
            ============================================================ */
            const requestHeaders = [];
            document.querySelectorAll('#edit_request_headers_container .header-row')
                .forEach((row) => {
                    const inputs = row.querySelectorAll('input');
                    const name = inputs[0]?.value.trim() || "";
                    const value = inputs[1]?.value.trim() || "";
                    if (!name && !value) return;

                    requestHeaders.push({ name, value });
                });

            /* ============================================================
               DYNAMIC VARIABLES
            ============================================================ */
            const dynamicVariables = [];
            document.querySelectorAll('#edit_dynamic_variables_container .variable-row')
                .forEach((row) => {
                    const inputs = row.querySelectorAll('input');
                    const name = inputs[0]?.value.trim() || "";
                    const value = inputs[1]?.value.trim() || "";
                    if (!name) return;

                    dynamicVariables.push({ name, value });
                });

            /* ============================================================
               ASSIGNMENTS
            ============================================================ */
            const assignments = [];
            document.querySelectorAll('#edit_assignments_container .assignment-row')
                .forEach((row) => {
                    const inputs = row.querySelectorAll('input');
                    const variable = inputs[0]?.value.trim() || "";
                    const path = inputs[1]?.value.trim() || "";
                    if (!variable || !path) return;

                    assignments.push({ variable, path });
                });

            /* ============================================================
               FINAL PAYLOAD
            ============================================================ */
            const currentUrl = new URL(window.location.href);
            const agentId = currentUrl.searchParams.get("agent_id") || null;

            toolConfig = {
                api_url: apiUrl,
                http_method: httpMethod,
                response_timeout_secs: responseTimeout,
                body_description: bodyDescription,
                path_params: pathParams,
                query_params: queryParams,
                request_body_properties: requestBodyProperties,
                request_headers: requestHeaders,
                dynamic_variables: dynamicVariables,
                assignments,
                disable_interruptions: disableInterruptions,
                force_pre_tool_speech: forcePreToolSpeech
            };

            data = {
                function_name: toolName,
                function_description: toolDescription,
                function_url: apiUrl,
                function_timeout: responseTimeout,
                function_parameters: toolConfig,
                agent_id: agentId
            };
            data['activeTabId'] = activeTabId;
        }

        /* ============================================================
           RAW JSON TAB SAVE
        ============================================================ */
        else if (activeTabId === "format_json_tab") {
            let txt = document.getElementById("edit-parameters").value;

            try {
                data = JSON.parse(txt);
                data['activeTabId'] = activeTabId;
            } catch (e) {
                toastr.error("Invalid JSON.");
                return;
            }
        }
        else {
            toastr.error("Some Error in updating custom functions. Please contact support team.");
            return;
        }

        /* ============================================================
           SUBMIT
        ============================================================ */
        $.ajax({
            url: `${host}/elevenlabs/api/v1/edit-custom-functions/${functionId}`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                if (response.status === "success") {
                    toastr.success("Custom function updated.");
                    $('#customFunctionEditModal').modal('hide');
                    updateFunctionElement(response.data);
                } else {
                    toastr.error(response.message || "Update failed.");
                }
            },
            error: function (xhr) {
                toastr.error(xhr?.responseJSON?.message || "Error updating function.");
            }
        });
    }

    function openEditToolsModal(functionId) {
        $.ajax({
            url: `${host}/elevenlabs/api/v1/get-custom-functions`,
            type: 'GET',
            data: { function_id: functionId },
            success: function (response) {

                if (!response.data) {
                    toastr.error("No function data found.");
                    return;
                }

                const functionData = response.data;
                const rawToolConfig = functionData.function_parameters || {};

                /** -------------------------------
                 * Flatten & extract using the class
                 * --------------------------------*/
                const tool = new WebhookToolEditor(rawToolConfig, functionData);
                const config = tool.extract();

                /** -------------------------------------------------------------
                 *  Build modal HTML (your structure kept 100% unchanged)
                 * -------------------------------------------------------------*/
                const modal = `
                    <div class="modal fade custom_function_modal" id="customFunctionEditModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="mb-0">Edit Webhook Tool</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body">

                                    <ul class="nav nav-tabs" id="FunctionToolTab" role="tablist">
                                        <li class="nav-item" role="presentation" >
                                            <button class="nav-link active" id="configure-tab"
                                                data-bs-target="#configure-tab-pane" data-bs-toggle="tab">
                                                Configure
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="format_json_tab"
                                                data-bs-target="#format_json_tab-pane" data-bs-toggle="tab">
                                                Format JSON
                                            </button>
                                        </li>
                                    </ul>

                                    <div class="tab-content">

                                        <!-- CONFIG TAB -->
                                        <div class="tab-pane fade show active p-2" id="configure-tab-pane">

                                            <form id="editFunctionForm">

                                                <!-- BASIC TOOL CONFIG -->
                                                <div class="card mb-3">
                                                    <div class="card-header"><h6>Tool Configuration</h6></div>
                                                    <div class="card-body">

                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label class="form-label">Tool Name *</label>
                                                                <input type="text" class="form-control"
                                                                    id="edit_tool_name"
                                                                    value="${functionData.function_name}">
                                                            </div>

                                                            <div class="col-md-6">
                                                                <label class="form-label">Response Timeout</label>
                                                                <input type="number" class="form-control"
                                                                    id="edit_response_timeout"
                                                                    value="${functionData.function_timeout || 20}">
                                                            </div>
                                                        </div>

                                                        <label class="form-label mt-3">Description *</label>
                                                        <textarea class="form-control" id="edit_tool_description"
                                                            rows="2">${functionData.function_description || ""}</textarea>

                                                    </div>
                                                </div>

                                                <!-- API SCHEMA -->
                                                <div class="card mb-3">
                                                    <div class="card-header"><h6>API Schema</h6></div>
                                                    <div class="card-body">

                                                        <div class="row">

                                                            <div class="col-md-8">
                                                                <label class="form-label">Webhook URL *</label>
                                                                <input type="url"
                                                                    class="form-control"
                                                                    id="edit_api_url"
                                                                    value="${functionData.function_url}">
                                                            </div>

                                                            <div class="col-md-4">
                                                                <label class="form-label">HTTP Method *</label>
                                                                <select class="form-select" id="edit_http_method">
                                                                    <option value="GET" ${config.http_method === "GET" ? "selected" : ""}>GET</option>
                                                                    <option value="POST" ${config.http_method === "POST" ? "selected" : ""}>POST</option>
                                                                    <option value="PUT" ${config.http_method === "PUT" ? "selected" : ""}>PUT</option>
                                                                    <option value="PATCH" ${config.http_method === "PATCH" ? "selected" : ""}>PATCH</option>
                                                                    <option value="DELETE" ${config.http_method === "DELETE" ? "selected" : ""}>DELETE</option>
                                                                </select>
                                                            </div>

                                                        </div>

                                                    </div>
                                                </div>

                                                <!-- PATH PARAMS -->
                                                <div class="card mb-3">
                                                    <div class="card-header d-flex justify-content-between">
                                                        <h6>Path Parameters</h6>
                                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                                            onclick="addEditPathParam()">+ Add Path Parameter</button>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="edit_path_params_container">
                                                            ${generatePathParamsHTML(config.path_params)}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- QUERY PARAMS -->
                                                <div class="card mb-3">
                                                    <div class="card-header d-flex justify-content-between">
                                                        <h6>Query Parameters</h6>
                                                        <button  type="button"  class="btn btn-sm btn-outline-primary"
                                                            onclick="addEditQueryParam()">+ Add Query Parameter</button>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="edit_query_params_container">
                                                            ${generateQueryParamsHTML(config.query_params)}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- REQUEST BODY -->
                                                <div class="card mb-3" id="edit_request_body_schema_section"
                                                    style="display: ${["POST", "PUT", "PATCH"].includes(config.http_method) ? "block" : "none"}">

                                                    <div class="card-header d-flex justify-content-between">
                                                        <h6>Request Body Schema</h6>
                                                        <button type="button"  class="btn btn-sm btn-outline-primary"
                                                            onclick="addEditRequestBodyProperty()">+ Add Property</button>
                                                    </div>

                                                    <div class="card-body">
                                                        <label class="form-label">Body Description</label>
                                                        <input class="form-control"
                                                            id="edit_body_description"
                                                            value="${config.body_description || ""}">
                                                        <div id="edit_request_body_properties_container" class="mt-3">
                                                            ${generateRequestBodyPropertiesHTML(config.request_body_properties)}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- HEADERS -->
                                                <div class="card mb-3">
                                                    <div class="card-header d-flex justify-content-between">
                                                        <h6>Request Headers</h6>
                                                        <button  type="button" class="btn btn-sm btn-outline-primary"
                                                            onclick="addEditRequestHeader()">+ Add Header</button>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="edit_request_headers_container">
                                                            ${generateRequestHeadersHTML(config.request_headers)}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- DYNAMIC VARIABLES -->
                                                <div class="card mb-3">
                                                    <div class="card-header d-flex justify-content-between">
                                                        <h6>Dynamic Variables</h6>
                                                        <button type="button"  class="btn btn-sm btn-outline-primary"
                                                            onclick="addEditDynamicVariable()">+ Add Variable</button>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="edit_dynamic_variables_container">
                                                            ${generateDynamicVariablesHTML(config.dynamic_variables)}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- ASSIGNMENTS -->
                                                <div class="card mb-3">
                                                    <div class="card-header d-flex justify-content-between">
                                                        <h6>Response Assignments</h6>
                                                        <button type="button"  class="btn btn-sm btn-outline-primary"
                                                            onclick="addEditAssignment()">+ Add Assignment</button>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="edit_assignments_container">
                                                            ${generateAssignmentsHTML(config.assignments)}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- ADVANCED -->
                                                <div class="card mb-3">
                                                    <div class="card-header"><h6>Advanced Options</h6></div>
                                                    <div class="card-body">

                                                        <div class="row">

                                                            <div class="col-md-6">
                                                                <label class="form-check-label">
                                                                    <input type="checkbox"
                                                                        id="edit_disable_interruptions"
                                                                        class="form-check-input"
                                                                        ${config.disable_interruptions ? "checked" : ""}>
                                                                    Disable Interruptions
                                                                </label>
                                                            </div>

                                                            <div class="col-md-6">
                                                                <label class="form-check-label">
                                                                    <input type="checkbox"
                                                                        id="edit_force_pre_tool_speech"
                                                                        class="form-check-input"
                                                                        ${config.force_pre_tool_speech ? "checked" : ""}>
                                                                    Force Pre-Tool Speech
                                                                </label>
                                                            </div>

                                                        </div>

                                                    </div>
                                                </div>

                                            </form>

                                        </div>

                                        <!-- RAW JSON TAB -->
                                        <div class="tab-pane fade" id="format_json_tab-pane">
                                            <textarea id="edit-parameters" class="form-control" rows="20">
                                                ${JSON.stringify(rawToolConfig?.tool_config, null, 4)}
                                            </textarea>
                                        </div>

                                    </div>

                                </div>

                                <div class="modal-footer">
                                    <button class="btn" data-bs-dismiss="modal">Close</button>
                                    <button class="btn save_btn" id="edit_custom_function_save_btn"
                                        onclick="handleEditCustomFunction('${functionId}')">
                                        Update Webhook Tool
                                    </button>
                                    <button class="btn save_btn" id="create_custom_function_save_btn"
                                        onclick="handleCreateCustomFunction('${functionId}')">
                                        Create Webhook Tool
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                `;



                /** Remove old modal & append */
                $('#customFunctionEditModal').remove();
                $("body").append(modal);
                document.getElementById("edit_api_url").addEventListener("input", function () {
                    const url = this.value.trim();

                    // 1) Get placeholders from URL: {something}
                    const placeholders = [...url.matchAll(/\{([^}]+)\}/g)].map(match => match[1]);

                    // 2) Get existing path param names from UI
                    const existing = Array.from(
                        document.querySelectorAll("#edit_path_params_container .param-item .param-name")
                    ).map(input => input.value.trim());

                    // 3) Find new placeholders not yet added
                    const toAdd = placeholders.filter(p => !existing.includes(p));

                    // 4) Find params that exist in UI but removed from URL
                    const toRemove = existing.filter(x => !placeholders.includes(x));

                    // 5) Add missing path params
                    toAdd.forEach(name => autoAddPathParam(name));

                    // 6) Remove path params that no longer appear in URL
                    toRemove.forEach(name => autoRemovePathParam(name));
                });
                $("#edit_custom_function_save_btn").show();
                $("#create_custom_function_save_btn").hide();
                $("#customFunctionEditModal").modal("show");

                /** Auto-bind triggers */
                setTimeout(() => {
                    toggleEditRequestBodySchema();
                    document.getElementById("edit_http_method")
                        ?.addEventListener("change", toggleEditRequestBodySchema);

                    const url = document.getElementById("edit_api_url");
                    url?.addEventListener("input", checkEditUrlForPathParams);
                    url?.addEventListener("blur", checkEditUrlForPathParams);
                }, 50);
            },

            error: function (xhr) {
                toastr.error("Error fetching custom function");
            }
        });
    }

    // Edit modal helper functions
    function addEditPathParam() {
        const container = document.getElementById("edit_path_params_container");
        const index = container.querySelectorAll(".param-item").length;
        const id = `edit_path_param_${index}`;

        const html = `
        <div class="param-item border rounded p-3 mb-3" id="${id}">
            <div class="d-flex justify-content-between mb-2">
                <h6 class="mb-0">Path Parameter</h6>
                <button class="btn btn-sm btn-outline-danger" onclick="removeEditPathParam(${index})">Delete</button>
            </div>

            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Identifier</label>
                    <input class="form-control param-name" placeholder="user_id">
                </div>

                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleEditPathParamValueType('${id}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-12" id="${id}_value_container">
                    <label class="form-label">LLM Prompt Description</label>
                    <textarea class="form-control param-description" rows="2"></textarea>
                </div>
            </div>
        </div>`;

        container.insertAdjacentHTML("beforeend", html);
    }

    function removeEditPathParam(index) {
        const element = document.getElementById(`edit_path_param_${index}`);
        if (element) {
            element.remove();
        }
    }

    function toggleEditPathParamValueType(paramId) {
        const container = document.getElementById(paramId + '_value_container');
        const valueTypeSelect = document.querySelector(`#${paramId} .param-value-type`);
        const valueType = valueTypeSelect.value;

        let html = '';
        if (valueType === 'llm_prompt') {
            html = `
            <label class="form-label">Description</label>
            <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
        } else if (valueType === 'constant_value') {
            html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="Enter constant value">
        `;
        } else if (valueType === 'dynamic_variable') {
            html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-variable" placeholder="Enter dynamic variable name">
        `;
        }

        container.innerHTML = html;
    }

    function addEditQueryParam() {
        const container = document.getElementById("edit_query_params_container");
        const index = container.querySelectorAll(".param-item").length;
        const id = `edit_query_param_${index}`;

        const html = `
        <div class="param-item border rounded p-3 mb-3" id="${id}">
            <div class="d-flex justify-content-between mb-2">
                <h6 class="mb-0">Query Parameter</h6>
                <button class="btn btn-sm btn-outline-danger" onclick="removeEditQueryParam(${index})">Delete</button>
            </div>

            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Identifier</label>
                    <input class="form-control param-name" placeholder="limit">
                </div>

                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type" onchange="toggleEditQueryParamValueType('${id}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-12" id="${id}_value_container">
                    <label class="form-label">LLM Prompt Description</label>
                    <textarea class="form-control param-description" rows="2"></textarea>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML("beforeend", html);
    }

    function removeEditQueryParam(index) {
        const el = document.getElementById(`edit_query_param_${index}`);
        if (el) el.remove();
    }

    function toggleEditQueryParamValueType(paramId) {
        const container = document.getElementById(paramId + '_value_container');
        const valueTypeSelect = document.querySelector(`#${paramId} .param-value-type`);
        const valueType = valueTypeSelect.value;

        let html = '';
        if (valueType === 'llm_prompt') {
            html = `
            <label class="form-label">Description</label>
            <input type="text" class="form-control param-description" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.">
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
        } else if (valueType === 'constant_value') {
            html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="Enter constant value">
        `;
        } else if (valueType === 'dynamic_variable') {
            html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-variable" placeholder="Enter dynamic variable name">
        `;
        }

        container.innerHTML = html;
    }

    function addEditRequestBodyProperty() {
        const container = document.getElementById("edit_request_body_properties_container");
        const index = container.querySelectorAll(".param-item").length;
        const id = `edit_property_${index}`;

        const html = `
        <div class="param-item border rounded p-3 mb-3" id="${id}">
            <div class="d-flex justify-content-between mb-2">
                <h6 class="mb-0">Request Body Property</h6>
                <button class="btn btn-sm btn-outline-danger" onclick="removeEditRequestBodyProperty(${index})">Delete</button>
            </div>

            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <select class="form-select param-type">
                        <option value="string" selected>String</option>
                        <option value="integer">Integer</option>
                        <option value="number">Number</option>
                        <option value="boolean">Boolean</option>
                        <option value="object">Object</option>
                        <option value="array">Array</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Identifier</label>
                    <input class="form-control param-name" placeholder="email">
                </div>

                <div class="col-md-2">
                    <label class="form-check-label mt-4">
                        <input type="checkbox" class="form-check-input param-required">
                        Required
                    </label>
                </div>

                <div class="col-md-5">
                    <label class="form-label">Value Type</label>
                    <select class="form-select param-value-type"
                        onchange="toggleEditBodyPropertyValueType('${id}')">
                        <option value="llm_prompt" selected>LLM Prompt</option>
                        <option value="constant_value">Constant Value</option>
                        <option value="dynamic_variable">Dynamic Variable</option>
                    </select>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-12" id="${id}_value_container">
                    <label class="form-label">LLM Prompt Description</label>
                    <textarea class="form-control param-description" rows="2"></textarea>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML("beforeend", html);
    }

    function removeEditRequestBodyProperty(index) {
        const el = document.getElementById(`edit_property_${index}`);
        if (el) el.remove();
    }

    function toggleEditBodyPropertyValueType(propId) {
        const container = document.getElementById(propId + '_value_container');
        const valueTypeSelect = document.querySelector(`#${propId} .param-value-type`);
        const valueType = valueTypeSelect.value;

        let html = '';
        if (valueType === 'llm_prompt') {
            html = `
            <label class="form-label">Description</label>
            <textarea class="form-control param-description" rows="3" placeholder="This field will be passed to the LLM and should describe in detail how to extract the data from the transcript."></textarea>
            <small class="text-muted">This field will be passed to the LLM and should describe in detail how to extract the data from the transcript.</small>
        `;
        } else if (valueType === 'constant_value') {
            html = `
            <label class="form-label">Constant Value</label>
            <input type="text" class="form-control param-constant-value" placeholder="Enter constant value">
        `;
        } else if (valueType === 'dynamic_variable') {
            html = `
            <label class="form-label">Dynamic Variable</label>
            <input type="text" class="form-control param-dynamic-variable" placeholder="Enter dynamic variable name">
        `;
        }

        container.innerHTML = html;
    }

    function addEditRequestHeader() {
        const container = document.getElementById("edit_request_headers_container");
        const index = container.querySelectorAll(".header-row").length;

        const html = `
        <div class="row mb-2 header-row" data-index="${index}">
            <div class="col-md-4">
                <input class="form-control" placeholder="Header name">
            </div>
            <div class="col-md-6">
                <input class="form-control" placeholder="Header value">
            </div>
            <div class="col-md-2">
                <button class="btn btn-sm btn-outline-danger"
                    onclick="removeEditRequestHeader(${index})">Ã—</button>
            </div>
        </div>
    `;

        container.insertAdjacentHTML("beforeend", html);
    }


    function removeEditRequestHeader(index) {
        const container = document.getElementById("edit_request_headers_container");
        const row = container.querySelector(`.header-row[data-index="${index}"]`);
        if (row) row.remove();
    }

    function addEditDynamicVariable() {
        const container = document.getElementById("edit_dynamic_variables_container");
        const index = container.querySelectorAll(".variable-row").length;

        const html = `
        <div class="row mb-2 variable-row" data-index="${index}">
            <div class="col-md-4">
                <input class="form-control" placeholder="variable_name">
            </div>
            <div class="col-md-6">
                <input class="form-control" placeholder="description or value">
            </div>
            <div class="col-md-2">
                <button class="btn btn-sm btn-outline-danger"
                    onclick="removeEditDynamicVariable(${index})">Ã—</button>
            </div>
        </div>
    `;

        container.insertAdjacentHTML("beforeend", html);
    }

    function removeEditDynamicVariable(index) {
        const container = document.getElementById("edit_dynamic_variables_container");
        const row = container.querySelector(`.variable-row[data-index="${index}"]`);
        if (row) row.remove();
    }

    function addEditAssignment() {
        const container = document.getElementById("edit_assignments_container");
        const index = container.querySelectorAll(".assignment-row").length;

        const html = `
        <div class="row mb-2 assignment-row" data-index="${index}">
            <div class="col-md-4">
                <input class="form-control" placeholder="dynamic_variable">
            </div>
            <div class="col-md-6">
                <input class="form-control" placeholder="response_path (e.g. id)">
            </div>
            <div class="col-md-2">
                <button class="btn btn-sm btn-outline-danger"
                    onclick="removeEditAssignment(${index})">Ã—</button>
            </div>
        </div>
    `;

        container.insertAdjacentHTML("beforeend", html);
    }

    function removeEditAssignment(index) {
        const container = document.getElementById("edit_assignments_container");
        const row = container.querySelector(`.assignment-row[data-index="${index}"]`);
        if (row) row.remove();
    }

    function setExampleJSON(exampleId) {
        const examples = {
            "example1": {
                "type": "object",
                "properties": {
                    "appointment_available_ts": {
                        "type": "string",
                        "description": "The timestamp of the appointment that is available for booking."
                    }
                },
                "required": ["appointment_available_ts"]
            },
            "example2": {
                "type": "object",
                "properties": {
                    "city": {
                        "type": "string",
                        "description": "The city for which the weather is to be fetched."
                    }
                },
                "required": ["city"]
            },
            "example3": {
                "type": "object",
                "properties": {
                    "appointment_available_ts": {
                        "type": "string",
                        "description": "The timestamp of the appointment that is available for booking."
                    },
                    "doctor_name": {
                        "type": "string",
                        "description": "An optional field to specify the name of the doctor."
                    }
                },
                "required": ["appointment_available_ts"]
            }
        };

        if (examples[exampleId]) {
            const parametersTextarea = document.getElementById(`edit-parameters`);
            parametersTextarea.value = JSON.stringify(examples[exampleId], null, 2);
        }
    }

    function EditformatJSON() {
        var jsonTextarea = document.getElementById("edit-parameters");
        var formattedJSON = jsonTextarea.value;
        jsonTextarea.value = formattedJSON;
    }


    function deleteFunction(functionId) {
        $.ajax({
            url: "{{ host }}/elevenlabs/api/v1/delete-custom-functions",
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ function_id: functionId }),
            success: function (response) {
                toastr.success('Custom function deleted successfully');
                $('#function-' + functionId).remove();
                $('#customFunctionEditModal').modal('hide');
            },
            error: function (xhr, status, error) {
                toastr.error('Error deleting custom function: ' + error);
            }
        });
    }

    function saveVariable() {
        // Get all variable input pairs
        var variables = {};
        var variableItems = document.querySelectorAll('#dynamic-variables .variable-modal-content-item');

        variableItems.forEach(function (item, index) {
            var inputs = item.querySelectorAll('input');

            console.log(`Row ${index + 1}: Found ${inputs.length} inputs`);

            if (inputs.length >= 2) {
                var variableName = inputs[0].value.trim();
                var variableValue = inputs[1].value.trim();

                console.log(`Row ${index + 1}: Name="${variableName}", Value="${variableValue}"`);

                if (variableName) {
                    variables[variableName] = variableValue;
                }
            }
        });
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");


        // Save variables via AJAX
        $.ajax({
            url: "{{ host }}/elevenlabs/api/v1/save-variables",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                variables: variables,
                agent_id: agentId
            }),
            success: function (response) {
                toastr.success('Variables saved successfully');
                const modal = document.getElementById('variable-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            },
            error: function (xhr, status, error) {
                toastr.error('Error saving variables: ' + error);
            }
        });
    }

    function openDialog() {
        const dialog = document.getElementById("dialog");
        if (dialog) {
            dialog.style.display = dialog.style.display === "none" ? "block" : "none";
        }
    }

    function closeDialog() {
        const dialog = document.getElementById("dialog");
        if (dialog) {
            dialog.style.display = "none";
        }
    }

    const slider = document.getElementById("temperatureSlider");
    const sliderValue = document.getElementById("sliderValue");

    // Set initial value and position based on existing value
    const initialValue = slider.value;
    const initialPercentage = ((initialValue - slider.min) / (slider.max - slider.min)) * 100;
    sliderValue.textContent = parseFloat(initialValue).toFixed(1);
    sliderValue.style.left = initialPercentage + "%";

    slider.addEventListener("input", function () {
        let percentage = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        sliderValue.textContent = parseFloat(slider.value).toFixed(1);
        sliderValue.style.left = percentage + "%";
    });

    function saveSettings() {
        const temperature = document.getElementById("temperatureSlider").value;
        const maxOutputTokens = document.getElementById("maxOutputTokensSlider").value;
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");
        $.ajax({
            url: host + '/api/update-agent-settings',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ temperature: temperature, max_output_tokens: maxOutputTokens, agent_id: agentId }),
            success: function (response) {
                if (response.status == "success") {
                    toastr.success('Settings saved successfully');
                    const dialog = document.getElementById("dialog");
                    if (dialog) {
                        dialog.style.display = "none";
                    }
                }
                else {
                    toastr.error(response.message);
                }
            },
            error: function (xhr, status, error) {
                if (xhr.responseJSON.message) {
                    toastr.error(xhr.responseJSON.message);
                }
                else {
                    toastr.error('Error saving settings: ' + error);
                }
            }
        });
    }

    function toggleTokenModal() {
        const tokenModal = document.getElementById('token-modal');
        tokenModal.style.display = tokenModal.style.display === 'none' ? 'block' : 'none';
    }

    function saveTokenSettings() {
        const overallTokenLimit = document.getElementById('overall-token-limit').value;
        const dailyTokenLimit = document.getElementById('daily-token-limit').value;
        const perCallTokenLimit = document.getElementById('per-call-token-limit').value;
        if (overallTokenLimit == "" || dailyTokenLimit == "" || perCallTokenLimit == "") {
            toastr.error('Please fill all the fields');
            return;
        }
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");
        $.ajax({
            url: host + '/api/update-agent-token-settings',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ overall_token_limit: overallTokenLimit, daily_token_limit: dailyTokenLimit, per_call_token_limit: perCallTokenLimit, agent_id: agentId }),
            success: function (response) {
                if (response.status == "success") {
                    toastr.success('Token settings saved successfully');
                    toggleTokenModal();
                }
                else {
                    toastr.error(response.message);
                }
            },
            error: function (xhr, status, error) {
                if (xhr.responseJSON.message) {
                    toastr.error(xhr.responseJSON.message);
                }
                else {
                    toastr.error('Error saving token settings: ' + error);
                }
            }
        });
    }
</script>

<script>
    // Function to show dynamic variables when detected
    function showDynamicVariables(variables) {
        const dynamicVarsSection = document.getElementById("dynamic-variables-section");
        const dynamicVarsDiv = document.getElementById("dynamic-variables");

        if (!variables || Object.keys(variables).length === 0) {
            dynamicVarsSection.style.display = "none";
            return;
        }

        // Show the section
        dynamicVarsSection.style.display = "block";

        // Clear existing variables
        dynamicVarsDiv.innerHTML = "";

        // Add each variable
        Object.entries(variables).forEach(([varName, varValue]) => {
            const varDiv = document.createElement("div");
            varDiv.className = "variable-modal-content-item mb-2";
            varDiv.innerHTML = `
                    <input type="text" class="form-control" value="${varName}" readonly>
                    <input type="text" class="form-control" value="${varValue}" placeholder="Enter value" onchange="updateVariableValue('${varName}', this.value)">
                    <button class="dlt_btn bg-transparent border-0 p-0" onclick="removeVariable(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-1V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                    </button>
                `;
            dynamicVarsDiv.appendChild(varDiv);
        });
    }

    // Function to update variable value
    function updateVariableValue(varName, value) {
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");



        // Update the variable in the backend
        fetch(`${host}/elevenlabs/api/v1/edit_agent`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({
                agent_id: agentId,
                dynamic_variable_update: {
                    [varName]: value
                }
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    toastr.success(`Variable ${varName} updated successfully`, { positionClass: "toast-top-right" });
                } else {
                    toastr.error(data.message || "Failed to update variable");
                }
            })
            .catch(error => {
                console.error("Error updating variable:", error);
                toastr.error("Error updating variable");
            });
    }

    function renderDynamicVariables(updated_dynamic_variables) {
        const container = document.getElementById("dynamic-variables");

        // Clear old variables
        container.innerHTML = "";
        dynamicVariables = updated_dynamic_variables;

        // Loop through updated variables
        Object.entries(updated_dynamic_variables).forEach(([varName, varValue]) => {

            const item = document.createElement("div");
            item.className = "variable-modal-content-item mb-2";

            item.innerHTML = `
                    <input type="text" class="form-control" placeholder="Variable Name" value="${varName}">
                    <input type="text" class="form-control" placeholder="Enter the value" value="${varValue || ''}">
                    <button class="dlt_btn bg-transparent border-0 p-0" onclick="removeVariable(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor"
                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                             class="h-12 w-12">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                    </button>
                `;

            container.appendChild(item);
        });
    }


    // ElevenLabs API Compliance Validation Functions
    function validateElevenLabsCompliance(httpMethod, bodyDescription) {
        // Rule 1: Request body schema only allowed for POST/PUT/PATCH methods
        if (httpMethod && !['POST', 'PUT', 'PATCH'].includes(httpMethod.toUpperCase())) {
            if (bodyDescription && bodyDescription.trim() !== '') {
                toastr.error(`Request body description is not allowed for ${httpMethod} method. Only POST, PUT, and PATCH methods support request body schemas.`);
                return false;
            }
        }
        return true;
    }

    // Function to validate path parameters against URL placeholders
    function validatePathParametersAgainstURL(apiUrl, pathParams) {
        const urlPlaceholders = apiUrl.match(/\{([^}]+)\}/g) || [];
        const urlParamNames = urlPlaceholders.map(placeholder => placeholder.slice(1, -1));

        for (const param of pathParams) {
            const paramName = param.name?.trim();
            if (paramName && !urlParamNames.includes(paramName)) {
                toastr.error(`Path parameter "${paramName}" is defined but the URL doesn't contain the placeholder "{${paramName}}". Please either:\n1. Add {${paramName}} to the URL, or\n2. Remove this path parameter.`);
                return false;
            }
        }
        return true;
    }

    function validatePathParameter(description, dynamicVariable, constantValue, paramIndex) {
        // Rule 2: Path parameters can only have one of: description, dynamic_variable, or constant_value
        let filledFields = 0;
        if (description && description.trim() !== '') filledFields++;
        if (dynamicVariable && dynamicVariable.trim() !== '') filledFields++;
        if (constantValue && constantValue.trim() !== '') filledFields++;

        if (filledFields > 1) {
            toastr.error(`Path Parameter ${paramIndex}: You can only set one of Description, Dynamic Variable, or Constant Value. Please clear the other fields.`);
            return false;
        }
        return true;
    }

    // Add real-time validation to form fields
    function addElevenLabsValidation() {
        // Add validation to HTTP method changes (both create and edit forms)
        const httpMethodSelects = ['http_method', 'edit_http_method'];
        httpMethodSelects.forEach(selectId => {
            const httpMethodSelect = document.getElementById(selectId);
            if (httpMethodSelect) {
                httpMethodSelect.addEventListener('change', function () {
                    const method = this.value;
                    const bodyDescriptionFieldId = selectId === 'edit_http_method' ? 'edit_body_description' : 'body_description';
                    const bodyDescriptionField = document.getElementById(bodyDescriptionFieldId);

                    if (bodyDescriptionField && !['POST', 'PUT', 'PATCH'].includes(method.toUpperCase())) {
                        // Clear body description for GET/DELETE methods
                        if (bodyDescriptionField.value.trim() !== '') {
                            bodyDescriptionField.value = '';
                            toastr.warning('Request body description cleared for ' + method + ' method');
                        }
                    }
                });
            }
        });

        // Add validation to parameter fields with enable/disable functionality
        document.addEventListener('input', function (e) {
            if (e.target.matches('input[name="path_param_description"], input[name="path_param_dynamic_variable"], input[name="path_param_constant_value"], input[name="query_param_description"], input[name="query_param_dynamic_variable"], input[name="query_param_constant_value"], input[name="body_prop_description"], input[name="body_prop_dynamic_variable"], input[name="body_prop_constant_value"], .param-description, .param-dynamic-var, .param-constant-value, .param-description, .param-dynamic-var, .param-constant-value')) {
                const row = e.target.closest('.path-param-row, .query-param-row, .body-prop-row, .param-item, .param-item');
                if (row) {
                    // Determine parameter type and get appropriate field selectors
                    let descriptionField, dynamicVarField, constantValField;

                    if (row.classList.contains('path-param-row')) {
                        descriptionField = row.querySelector('input[name="path_param_description"]');
                        dynamicVarField = row.querySelector('input[name="path_param_dynamic_variable"]');
                        constantValField = row.querySelector('input[name="path_param_constant_value"]');
                    } else if (row.classList.contains('query-param-row')) {
                        descriptionField = row.querySelector('input[name="query_param_description"]');
                        dynamicVarField = row.querySelector('input[name="query_param_dynamic_variable"]');
                        constantValField = row.querySelector('input[name="query_param_constant_value"]');
                    } else if (row.classList.contains('body-prop-row')) {
                        descriptionField = row.querySelector('input[name="body_prop_description"]');
                        dynamicVarField = row.querySelector('input[name="body_prop_dynamic_variable"]');
                        constantValField = row.querySelector('input[name="body_prop_constant_value"]');
                    } else if (row.classList.contains('param-item')) {
                        descriptionField = row.querySelector('.param-description');
                        dynamicVarField = row.querySelector('.param-dynamic-var');
                        constantValField = row.querySelector('.param-constant-value');
                    } else if (row.classList.contains('param-item')) {
                        descriptionField = row.querySelector('.param-description');
                        dynamicVarField = row.querySelector('.param-dynamic-var');
                        constantValField = row.querySelector('.param-constant-value');
                    }

                    if (descriptionField && dynamicVarField && constantValField) {
                        const description = descriptionField.value.trim();
                        const dynamicVar = dynamicVarField.value.trim();
                        const constantVal = constantValField.value.trim();

                        // Function to enable/disable fields
                        function updateFieldStates(activeField) {
                            const fields = [
                                { field: descriptionField, name: 'description' },
                                { field: dynamicVarField, name: 'dynamic_variable' },
                                { field: constantValField, name: 'constant_value' }
                            ];

                            fields.forEach(({ field, name }) => {
                                if (name === activeField) {
                                    // Enable the active field
                                    field.disabled = false;
                                    field.style.backgroundColor = '#ffffff';
                                    field.style.opacity = '1';
                                } else {
                                    // Disable other fields if any field has content
                                    const hasContent = description || dynamicVar || constantVal;
                                    field.disabled = hasContent;
                                    field.style.backgroundColor = hasContent ? '#f8f9fa' : '#ffffff';
                                    field.style.opacity = hasContent ? '0.6' : '1';

                                    // Clear disabled fields
                                    if (hasContent && field.value.trim() !== '') {
                                        field.value = '';
                                    }
                                }
                            });
                        }

                        // Determine which field is active and update states
                        if (description) {
                            updateFieldStates('description');
                        } else if (dynamicVar) {
                            updateFieldStates('dynamic_variable');
                        } else if (constantVal) {
                            updateFieldStates('constant_value');
                        } else {
                            // No fields have content, enable all
                            updateFieldStates(null);
                        }
                    }
                }
            }
        });
    }

    // Function to initialize field states for existing data
    function initializeFieldStates() {
        // Initialize all parameter rows
        const allParamRows = document.querySelectorAll('.path-param-row, .query-param-row, .body-prop-row, .param-item, .param-item');
        allParamRows.forEach(row => {
            initializeRowFieldStates(row);
        });
    }

    // Function to initialize field states for a specific row
    function initializeRowFieldStates(row) {
        let descriptionField, dynamicVarField, constantValField;

        // Check for edit modal fields first
        if (row.classList.contains('path-param-row')) {
            descriptionField = row.querySelector('input[name="path_param_description"]');
            dynamicVarField = row.querySelector('input[name="path_param_dynamic_variable"]');
            constantValField = row.querySelector('input[name="path_param_constant_value"]');
        } else if (row.classList.contains('query-param-row')) {
            descriptionField = row.querySelector('input[name="query_param_description"]');
            dynamicVarField = row.querySelector('input[name="query_param_dynamic_variable"]');
            constantValField = row.querySelector('input[name="query_param_constant_value"]');
        } else if (row.classList.contains('body-prop-row')) {
            descriptionField = row.querySelector('input[name="body_prop_description"]');
            dynamicVarField = row.querySelector('input[name="body_prop_dynamic_variable"]');
            constantValField = row.querySelector('input[name="body_prop_constant_value"]');
        }
        // Check for create modal fields
        else if (row.classList.contains('param-item')) {
            descriptionField = row.querySelector('.param-description');
            dynamicVarField = row.querySelector('.param-dynamic-var');
            constantValField = row.querySelector('.param-constant-value');
        } else if (row.classList.contains('param-item')) {
            descriptionField = row.querySelector('.param-description');
            dynamicVarField = row.querySelector('.param-dynamic-var');
            constantValField = row.querySelector('.param-constant-value');
        }

        if (descriptionField && dynamicVarField && constantValField) {
            const description = descriptionField.value.trim();
            const dynamicVar = dynamicVarField.value.trim();
            const constantVal = constantValField.value.trim();

            // Apply initial field states
            const hasContent = description || dynamicVar || constantVal;
            const fields = [descriptionField, dynamicVarField, constantValField];

            fields.forEach(field => {
                field.disabled = hasContent && field.value.trim() === '';
                field.style.backgroundColor = field.disabled ? '#f8f9fa' : '#ffffff';
                field.style.opacity = field.disabled ? '0.6' : '1';
            });
        }
    }

    // Initialize validation when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        addElevenLabsValidation();
        // Initialize field states after a short delay to ensure all content is loaded
        setTimeout(initializeFieldStates, 100);

        // Add URL validation for path parameters
        const apiUrlInput = document.getElementById('api_url');
        if (apiUrlInput) {
            // Check initial state
            checkUrlForPathParams();

            // Add event listener for real-time validation
            apiUrlInput.addEventListener('input', checkUrlForPathParams);
            apiUrlInput.addEventListener('blur', checkUrlForPathParams);
        }

        // Add HTTP method validation for request body schema
        const httpMethodSelect = document.getElementById('http_method');
        if (httpMethodSelect) {
            // Check initial state
            toggleRequestBodySchema();

            // Add event listener for real-time validation
            httpMethodSelect.addEventListener('change', toggleRequestBodySchema);
        }
    });

    // Enhanced Customize Modal Functions
    let currentTheme = {
        primary: '#00d4ff',
        secondary: '#006eff',
        pulse: 'rgba(0, 212, 255, 0.3)'
    };
    let currentSize = 'medium';

    function changeTheme(primary, secondary, pulse, element) {
        // Update current theme
        currentTheme = { primary, secondary, pulse };

        // Store theme in localStorage for preview functions
        localStorage.setItem('selectedTheme', JSON.stringify({ primary, secondary, pulse }));

        // Update active color option (only if element is provided)
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
        if (element && element.classList) {
            element.classList.add('active');
        }

        // Update preview widget
        const indicator = document.getElementById('preview-voice-indicator');
        if (indicator) {
            indicator.style.background = `linear-gradient(45deg, ${primary}, ${secondary})`;
        }

        // Store the theme for later application to the actual agent widget
        const agentId = new URL(window.location.href).searchParams.get("agent_id");
        if (agentId) {
            // Store in localStorage for server-side storage later
            localStorage.setItem(`agent_${agentId}_theme`, JSON.stringify(currentTheme));
        }
    }

    function changeSize(size, element) {
        currentSize = size;

        // Update active size button
        document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
        element.classList.add('active');

        // Update preview widget size
        const widget = document.getElementById('preview-elevenlabs-widget');
        const panel = document.getElementById('preview-main-panel');
        const indicator = document.getElementById('preview-voice-indicator');
        const button = document.getElementById('preview-voice-chat-btn');
        const languagePanel = document.getElementById('preview-language-panel');
        const languageBtn = document.getElementById('preview-language-btn');

        if (panel && indicator && button) {
            const sizes = {
                'small': {
                    panel: { minWidth: '220px', padding: '15px', gap: '10px' },
                    indicator: { width: '40px', height: '40px' },
                    button: { padding: '8px 15px', fontSize: '12px' },
                    languagePanel: { minWidth: '220px' },
                    languageBtn: { padding: '8px 12px' }
                },
                'medium': {
                    panel: { minWidth: '280px', padding: '20px', gap: '15px' },
                    indicator: { width: '50px', height: '50px' },
                    button: { padding: '12px 20px', fontSize: '14px' },
                    languagePanel: { minWidth: '280px' },
                    languageBtn: { padding: '10px 14px' }
                },
                'large': {
                    panel: { minWidth: '320px', padding: '25px', gap: '20px' },
                    indicator: { width: '60px', height: '60px' },
                    button: { padding: '15px 25px', fontSize: '16px' },
                    languagePanel: { minWidth: '320px' },
                    languageBtn: { padding: '12px 16px' }
                }
            };

            Object.assign(panel.style, sizes[size].panel);
            Object.assign(indicator.style, sizes[size].indicator);
            Object.assign(button.style, sizes[size].button);

            if (languagePanel) {
                Object.assign(languagePanel.style, sizes[size].languagePanel);
            }

            if (languageBtn) {
                Object.assign(languageBtn.style, sizes[size].languageBtn);
            }

            // Update microphone icon size to match button font size
            const micIcon = button.querySelector('i');
            if (micIcon) {
                micIcon.style.fontSize = sizes[size].button.fontSize;
            }
        }

        // Save size immediately to database
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");

        if (agentId) {
            // Store in localStorage for immediate application
            localStorage.setItem(`agent_${agentId}_size`, currentSize);

            // Also save to database immediately
            const saveData = {
                agent_id: agentId,
                primary_color: currentTheme.primary,
                secondary_color: currentTheme.secondary,
                pulse_color: currentTheme.pulse,
                widget_size: currentSize
            };

            fetch(`${host}/elevenlabs/api/v1/save_widget_customization`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify(saveData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        console.log("Widget size saved successfully");
                    } else {
                        console.error("Failed to save widget size:", data.message);
                    }
                })
                .catch(error => {
                    console.error("Error saving widget size:", error);
                });
        }
    }

    function resetToDefaults() {
        // Reset all settings to defaults
        currentTheme = { primary: '#00d4ff', secondary: '#006eff', pulse: 'rgba(0, 212, 255, 0.3)' };
        currentSize = 'medium';

        // Reset UI controls
        document.querySelectorAll('.color-option').forEach((opt, index) => {
            opt.classList.toggle('active', index === 0);
        });
        document.querySelectorAll('.size-btn').forEach((btn, index) => {
            btn.classList.toggle('active', index === 1);
        });

        // Update preview
        updatePreview();
    }

    function updatePreview() {
        // Apply all current settings to preview
        const indicator = document.getElementById('preview-voice-indicator');
        const widget = document.getElementById('preview-elevenlabs-widget');
        const panel = document.getElementById('preview-main-panel');
        const button = document.getElementById('preview-voice-chat-btn');

        if (!indicator || !widget || !panel || !button) return;

        // Theme
        indicator.style.background = `linear-gradient(45deg, ${currentTheme.primary}, ${currentTheme.secondary})`;

        // Size
        const sizes = {
            'small': {
                panel: { minWidth: '220px', padding: '15px', gap: '10px' },
                indicator: { width: '40px', height: '40px' },
                button: { padding: '8px 15px', fontSize: '12px' }
            },
            'medium': {
                panel: { minWidth: '280px', padding: '20px', gap: '15px' },
                indicator: { width: '50px', height: '50px' },
                button: { padding: '12px 20px', fontSize: '14px' }
            },
            'large': {
                panel: { minWidth: '320px', padding: '25px', gap: '20px' },
                indicator: { width: '60px', height: '60px' },
                button: { padding: '15px 25px', fontSize: '16px' }
            }
        };
        Object.assign(panel.style, sizes[currentSize].panel);
        Object.assign(indicator.style, sizes[currentSize].indicator);
        Object.assign(button.style, sizes[currentSize].button);
    }

    function saveChanges() {
        // Get agent ID from URL
        const currentUrl = new URL(window.location.href);
        const agentId = currentUrl.searchParams.get("agent_id");

        if (!agentId) {
            toastr.error("Agent ID not found", { positionClass: "toast-top-right" });
            return;
        }

        // Prepare the data to save
        const saveData = {
            agent_id: agentId,
            primary_color: currentTheme.primary,
            secondary_color: currentTheme.secondary,
            pulse_color: currentTheme.pulse,
            widget_size: currentSize,
            start_btn_color: currentStartBtnColor || '#1a1a1a'
        };

        // Save to database via API
        fetch(`${host}/elevenlabs/api/v1/save_widget_customization`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify(saveData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    toastr.success("Widget customization saved successfully!", { positionClass: "toast-top-right" });

                    // Also store in localStorage for immediate preview updates
                    const settings = {
                        theme: currentTheme,
                        size: currentSize
                    };
                    localStorage.setItem(`agent_${agentId}_customization`, JSON.stringify(settings));

                    toggleCustomizeModal();
                } else {
                    toastr.error(data.message || "Failed to save customization", { positionClass: "toast-top-right" });
                }
            })
            .catch(error => {
                console.error("Error saving customization:", error);
                toastr.error("Error saving customization", { positionClass: "toast-top-right" });
            });
    }

    // Function to apply customization to the preview agent
    function applyCustomizationToPreviewAgent(agentId, settings) {
        // This function will be called to update the actual preview agent with the customizations
        // You can implement this to update the AgentConnectionModel in the database
        fetch(`${host}/elevenlabs/api/v1/save_widget_customization`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({
                agent_id: agentId,
                primary_color: settings.theme.primary,
                secondary_color: settings.theme.secondary,
                pulse_color: settings.theme.pulse,
                widget_size: settings.size
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    console.log("Widget customization applied to preview agent");
                } else {
                    console.warn("Failed to apply customization to preview agent:", data.message);
                }
            })
            .catch(error => {
                console.error('Error applying customization:', error);
            });
    }
</script>

<style>
    /* Enhanced Customize Modal Styles */
    .customize-bot-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        padding: 20px;
        overflow-y: auto;
    }

    .customize-modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 900px;
        margin: 40px auto;
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25);
        max-height: calc(100vh - 80px);
        overflow-y: auto;
    }

    .customization-panel {
        height: 380px;
        overflow-y: auto;
        padding-right: 12px;
    }

    .customization-panel::-webkit-scrollbar {
        width: 6px;
    }

    .customization-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .customization-panel::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .customization-panel::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .customize-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border-left: 4px solid #0C7FDA;
    }

    .color-option {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
        position: relative;
    }

    .color-option:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .color-option.active {
        border-color: #fff;
        box-shadow: 0 0 0 4px #0C7FDA, 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: scale(1.1);
    }

    .color-option.active::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
        z-index: 10;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.7;
            transform: scale(0.95);
        }

        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .size-btn {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .size-btn:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .size-btn.active {
        background: #0C7FDA;
        color: white;
        border-color: #0C7FDA;
    }

    .preview-panel {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        height: 500px;
    }

    .preview-container {
        position: relative;
        border: 2px dashed #ddd !important;
        border-radius: 12px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        overflow: hidden;
    }

    /* Custom pulse animation */
    @keyframes customPulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(0, 212, 255, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(0, 212, 255, 0);
        }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .customize-modal-content {
            padding: 20px;
            margin: 10px;
        }

        .customization-panel,
        .preview-panel {
            height: auto;
            max-height: 400px;
        }

        .preview-container {
            height: 300px !important;
        }
    }

    /* Compact Modal Styling */
    #customizeBotModal h5 {
        font-size: 1rem;
        font-weight: 600;
    }

    #customizeBotModal .customize-section {
        margin-bottom: 1rem;
    }
</style>
<script>
    // Language flag mapping
    const flagMap = {
        'en': 'ðŸ‡ºðŸ‡¸',
        'zh': 'ðŸ‡¨ðŸ‡³',
        'hi': 'ðŸ‡®ðŸ‡³',
        'es': 'ðŸ‡ªðŸ‡¸',
        'fr': 'ðŸ‡«ðŸ‡·',
        'ar': 'ðŸ‡¸ðŸ‡¦',
        'ru': 'ðŸ‡·ðŸ‡º',
        'pt': 'ðŸ‡µðŸ‡¹',
        'id': 'ðŸ‡®ðŸ‡©',
        'de': 'ðŸ‡©ðŸ‡ª',
        'ta': 'ðŸ‡®ðŸ‡³'
    };

    // Function to update language icon
    function updateLanguageIcon() {
        console.log('updateLanguageIcon called');
        const selectElement = document.getElementById('selected-language');
        const iconElement = document.getElementById('language-icon');

        if (!selectElement || !iconElement) {
            console.error('Language select or icon element not found');
            return;
        }

        const selectedValue = selectElement.value;
        console.log('Selected language:', selectedValue);

        const flag = flagMap[selectedValue] || 'ðŸ‡ºðŸ‡¸';
        console.log('Flag to display:', flag);

        iconElement.textContent = flag;
        console.log('Icon updated successfully');
    }

    // Add event listener when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        const selectElement = document.getElementById('selected-language');
        if (selectElement) {
            selectElement.addEventListener('change', updateLanguageIcon);
            console.log('Event listener added to language select');

            // Set initial flag
            updateLanguageIcon();
        } else {
            console.error('Language select element not found on page load');
        }
    });

    function openCreateCustomToolModal() {
        openCreateToolsModal();

        $("#edit_custom_function_save_btn").hide();
        $("#create_custom_function_save_btn").show();
    }

    function buildAndShowCustomToolModal(config, rawToolConfig, isEdit, functionId = null) {

        const defaultConfig = {
            name: "",
            type: "webhook",

            api_schema: {
                url: "",
                method: "POST",
                auth_connection: null,

                request_headers: {},

                path_params_schema: {},

                query_params_schema: {
                    properties: {}
                },

                request_body_schema: {
                    type: "object",
                    required: [],
                    properties: {},
                    description: ""
                }
            },

            assignments: [],

            description: "",

            dynamic_variables: {
                dynamic_variable_placeholders: {}
            },

            disable_interruptions: false,
            force_pre_tool_speech: false,
            response_timeout_secs: 20
        };

        const currConfig = isEdit ? rawToolConfig?.tool_config : defaultConfig;

        const modal = `
        <div class="modal fade custom_function_modal" id="customFunctionEditModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="mb-0">${isEdit ? "Edit Webhook Tool" : "Create Webhook Tool"}</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                        <ul class="nav nav-tabs" id="FunctionToolTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="configure-tab"
                                    data-bs-target="#configure-tab-pane" data-bs-toggle="tab">
                                    Configure
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="format_json_tab"
                                    data-bs-target="#format_json_tab-pane" data-bs-toggle="tab">
                                    Format JSON
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">

                            <div class="tab-pane fade show active p-2" id="configure-tab-pane">

                                <form id="editFunctionForm">

                                    <!-- BASIC TOOL CONFIG -->
                                    <div class="card mb-3">
                                        <div class="card-header"><h6>Tool Configuration</h6></div>
                                        <div class="card-body">

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">Tool Name *</label>
                                                    <input type="text" class="form-control"
                                                        id="edit_tool_name"
                                                        value="${config.function_name || ""}">
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label">Response Timeout</label>
                                                    <input type="number" class="form-control"
                                                        id="edit_response_timeout"
                                                        value="${config.function_timeout || 20}">
                                                </div>
                                            </div>

                                            <label class="form-label mt-3">Description *</label>
                                            <textarea class="form-control" id="edit_tool_description"
                                                rows="2">${config.function_description || ""}</textarea>

                                        </div>
                                    </div>

                                    <!-- API SCHEMA -->
                                    <div class="card mb-3">
                                        <div class="card-header"><h6>API Schema</h6></div>
                                        <div class="card-body">

                                            <div class="row">

                                                <div class="col-md-8">
                                                    <label class="form-label">Webhook URL *</label>
                                                    <input type="url"
                                                        class="form-control"
                                                        id="edit_api_url"
                                                        value="${config.function_url || ""}">
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="form-label">HTTP Method *</label>
                                                    <select class="form-select" id="edit_http_method">
                                                        <option value="GET" ${config.http_method === "GET" ? "selected" : ""}>GET</option>
                                                        <option value="POST" ${config.http_method === "POST" ? "selected" : ""}>POST</option>
                                                        <option value="PUT" ${config.http_method === "PUT" ? "selected" : ""}>PUT</option>
                                                        <option value="PATCH" ${config.http_method === "PATCH" ? "selected" : ""}>PATCH</option>
                                                        <option value="DELETE" ${config.http_method === "DELETE" ? "selected" : ""}>DELETE</option>
                                                    </select>
                                                </div>

                                            </div>

                                        </div>
                                    </div>

                                    <!-- PATH PARAMS -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between">
                                            <h6>Path Parameters</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="addEditPathParam()">+ Add Path Parameter</button>
                                        </div>
                                        <div class="card-body">
                                            <div id="edit_path_params_container">
                                                ${generatePathParamsHTML(config.path_params || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- QUERY PARAMS -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between">
                                            <h6>Query Parameters</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="addEditQueryParam()">+ Add Query Parameter</button>
                                        </div>
                                        <div class="card-body">
                                            <div id="edit_query_params_container">
                                                ${generateQueryParamsHTML(config.query_params || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- REQUEST BODY -->
                                    <div class="card mb-3" id="edit_request_body_schema_section"
                                        style="display: ${["POST", "PUT", "PATCH"].includes(config.http_method) ? "block" : "none"}">

                                        <div class="card-header d-flex justify-content-between">
                                            <h6>Request Body Schema</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="addEditRequestBodyProperty()">+ Add Property</button>
                                        </div>

                                        <div class="card-body">
                                            <label class="form-label">Body Description</label>
                                            <input class="form-control"
                                                id="edit_body_description"
                                                value="${config.body_description || ""}">

                                            <div id="edit_request_body_properties_container" class="mt-3">
                                                ${generateRequestBodyPropertiesHTML(config.request_body_properties || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- HEADERS -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between">
                                            <h6>Request Headers</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="addEditRequestHeader()">+ Add Header</button>
                                        </div>
                                        <div class="card-body">
                                            <div id="edit_request_headers_container">
                                                ${generateRequestHeadersHTML(config.request_headers || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- DYNAMIC VARIABLES -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between">
                                            <h6>Dynamic Variables</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="addEditDynamicVariable()">+ Add Variable</button>
                                        </div>
                                        <div class="card-body">
                                            <div id="edit_dynamic_variables_container">
                                                ${generateDynamicVariablesHTML(config.dynamic_variables || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ASSIGNMENTS -->
                                    <div class="card mb-3">
                                        <div class="card-header d-flex justify-content-between">
                                            <h6>Response Assignments</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="addEditAssignment()">+ Add Assignment</button>
                                        </div>
                                        <div class="card-body">
                                            <div id="edit_assignments_container">
                                                ${generateAssignmentsHTML(config.assignments || [])}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ADVANCED OPTIONS -->
                                    <div class="card mb-3">
                                        <div class="card-header"><h6>Advanced Options</h6></div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" id="edit_disable_interruptions"
                                                            class="form-check-input"
                                                            ${config.disable_interruptions ? "checked" : ""}>
                                                        Disable Interruptions
                                                    </label>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-check-label">
                                                        <input type="checkbox" id="edit_force_pre_tool_speech"
                                                            class="form-check-input"
                                                            ${config.force_pre_tool_speech ? "checked" : ""}>
                                                        Force Pre-Tool Speech
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </form>

                            </div>

                            <!-- RAW JSON TAB -->
                            <div class="tab-pane fade" id="format_json_tab-pane">
                                <textarea id="edit-parameters" class="form-control" rows="20">
                                    ${JSON.stringify(currConfig || {}, null, 4)}
                                </textarea>
                            </div>

                        </div>

                    </div>

                    <div class="modal-footer">
                        <button class="btn" data-bs-dismiss="modal">Close</button>

                        <button class="btn save_btn"
                            id="edit_custom_function_save_btn"
                            style="display: ${isEdit ? 'inline-block' : 'none'}"
                            onclick="handleEditCustomFunction('${functionId || ''}')">
                            Update Webhook Tool
                        </button>

                        <button class="btn save_btn"
                            id="create_custom_function_save_btn"
                            style="display: ${isEdit ? 'none' : 'inline-block'}"
                            onclick="handleCreateCustomFunction()">
                            Create Webhook Tool
                        </button>
                    </div>

                </div>
                </div>
            </div>
        `;

        $('#customFunctionEditModal').remove();
        $("body").append(modal);
        document.getElementById("edit_api_url").addEventListener("input", function () {
            const url = this.value.trim();

            // 1) Extract placeholders: {something}
            const placeholders = [...url.matchAll(/\{([^}]+)\}/g)].map(match => match[1]);

            // 2) Get existing path param identifiers
            const existing = Array.from(
                document.querySelectorAll("#edit_path_params_container .param-item .param-name")
            ).map(input => input.value.trim());

            // 3) Add missing params
            const toAdd = placeholders.filter(p => !existing.includes(p));

            // 4) Remove params not in URL anymore
            const toRemove = existing.filter(x => !placeholders.includes(x));

            // Add new placeholders
            toAdd.forEach(name => autoAddPathParam(name));

            // Remove deleted placeholders
            toRemove.forEach(name => autoRemovePathParam(name));
        });
        $("#customFunctionEditModal").modal("show");
    }

    function openCreateToolsModal() {

        const emptyConfig = {
            function_name: "",
            function_timeout: 20,
            function_description: "",
            function_url: "",
            http_method: "POST",

            path_params: [],
            query_params: [],
            request_body_properties: [],
            body_description: "",
            request_headers: [],
            dynamic_variables: [],
            assignments: [],
            disable_interruptions: false,
            force_pre_tool_speech: false,
        };

        const rawToolConfig = {
            tool_config: {}
        };

        // Build modal using same builder as edit mode
        buildAndShowCustomToolModal(emptyConfig, rawToolConfig, false);
    }

    function closeCreateCustomToolModal() {
        $("#customFunctionEditModal").modal("hide");

        $("#edit_custom_function_save_btn").show();
        $("#create_custom_function_save_btn").hide();
    }

    function handleCreateCustomFunction() {
        const activeTabId = document.querySelector('#FunctionToolTab .nav-link.active')?.id;

        const getVal = (row, selector) => {
            const el = row.querySelector(selector);
            return el ? (el.value ?? "").trim() : "";
        };
        const getChecked = (row, selector) => {
            const el = row.querySelector(selector);
            return !!(el && el.checked);
        };

        let toolConfig = {};
        let data = {};

        /* ============================================================
           CONFIG TAB SAVE
        ============================================================ */
        if (activeTabId === "configure-tab") {
            const errors = [];

            const toolName = (document.getElementById("edit_tool_name")?.value || "").trim();
            const toolDescription = (document.getElementById("edit_tool_description")?.value || "").trim();
            const apiUrl = (document.getElementById("edit_api_url")?.value || "").trim();
            const httpMethod = (document.getElementById("edit_http_method")?.value || "POST").toUpperCase();
            const bodyDescription = (document.getElementById("edit_body_description")?.value || "").trim();

            const disableInterruptions = !!document.getElementById("edit_disable_interruptions")?.checked;
            const forcePreToolSpeech = !!document.getElementById("edit_force_pre_tool_speech")?.checked;

            let responseTimeout = parseInt(document.getElementById("edit_response_timeout")?.value, 10);
            if (Number.isNaN(responseTimeout)) responseTimeout = 20;

            if (!toolName) errors.push("Tool name is required.");
            if (!apiUrl) errors.push("Webhook URL is required.");
            if (responseTimeout < 5 || responseTimeout > 120)
                errors.push("Response timeout must be between 5â€“120 seconds.");

            /* ============================================================
               PATH PARAMETERS
            ============================================================ */
            const pathParams = [];
            document.querySelectorAll('#edit_path_params_container .param-item')
                .forEach((row) => {

                    const name = getVal(row, '.param-name');
                    if (!name) return;

                    const type = getVal(row, '.param-type') || "string";
                    const valueType = getVal(row, '.param-value-type') || "llm_prompt";

                    let constantValue = null;
                    let dynamicVariable = null;
                    let description = null;

                    if (valueType === "constant_value") {
                        constantValue = getVal(row, '.param-constant-value');
                    }
                    else if (valueType === "dynamic_variable") {
                        dynamicVariable = getVal(row, '.param-dynamic-variable');
                    }
                    else {
                        description = getVal(row, '.param-description');
                    }

                    pathParams.push({
                        name,
                        type,
                        value_type: valueType,
                        constant_value: constantValue,
                        dynamic_variable: dynamicVariable,
                        description
                    });
                });

            // Validate URL placeholders
            const urlPlaceholders = [...apiUrl.matchAll(/\{([^}]+)\}/g)].map(m => m[1]);

            const missingInUrl = pathParams.filter(p => !urlPlaceholders.includes(p.name));
            if (missingInUrl.length)
                errors.push(`Path parameters not in URL: ${missingInUrl.map(p => p.name).join(", ")}`);

            const undefinedPlaceholders = urlPlaceholders.filter(ph => !pathParams.some(p => p.name === ph));
            if (undefinedPlaceholders.length)
                errors.push(`URL placeholders missing in Path Params: ${undefinedPlaceholders.join(", ")}`);

            if (errors.length) {
                toastr.error(errors[0]);
                return;
            }

            /* ============================================================
               QUERY PARAMETERS
            ============================================================ */
            const queryParams = [];
            document.querySelectorAll('#edit_query_params_container .param-item')
                .forEach((row) => {
                    const name = getVal(row, '.param-name');
                    if (!name) return;

                    const type = getVal(row, '.param-type') || "string";
                    const valueType = getVal(row, '.param-value-type') || "llm_prompt";

                    let constantValue = null;
                    let dynamicVariable = null;
                    let description = null;

                    if (valueType === "constant_value") {
                        constantValue = getVal(row, '.param-constant-value');
                    } else if (valueType === "dynamic_variable") {
                        dynamicVariable = getVal(row, '.param-dynamic-variable');
                    } else {
                        description = getVal(row, '.param-description');
                    }

                    queryParams.push({
                        name,
                        type,
                        value_type: valueType,
                        constant_value: constantValue,
                        dynamic_variable: dynamicVariable,
                        description
                    });
                });

            /* ============================================================
               REQUEST BODY PROPERTIES
            ============================================================ */
            const requestBodyProperties = [];
            document.querySelectorAll('#edit_request_body_properties_container .param-item')
                .forEach((row) => {

                    const name = getVal(row, '.param-name');
                    if (!name) return;

                    const type = getVal(row, '.param-type') || "string";
                    const required = getChecked(row, '.param-required');
                    const valueType = getVal(row, '.param-value-type') || "llm_prompt";

                    let constantValue = null;
                    let dynamicVariable = null;
                    let description = null;

                    if (valueType === "constant_value") {
                        constantValue = getVal(row, '.param-constant-value');
                    } else if (valueType === "dynamic_variable") {
                        dynamicVariable = getVal(row, '.param-dynamic-variable');
                    } else {
                        description = getVal(row, '.param-description');
                    }

                    requestBodyProperties.push({
                        name,
                        type,
                        required,
                        value_type: valueType,
                        constant_value: constantValue,
                        dynamic_variable: dynamicVariable,
                        description
                    });
                });

            /* ============================================================
               HEADERS
            ============================================================ */
            const requestHeaders = [];
            document.querySelectorAll('#edit_request_headers_container .header-row')
                .forEach((row) => {
                    const inputs = row.querySelectorAll('input');
                    const name = inputs[0]?.value.trim() || "";
                    const value = inputs[1]?.value.trim() || "";
                    if (!name && !value) return;

                    requestHeaders.push({ name, value });
                });

            /* ============================================================
               DYNAMIC VARIABLES
            ============================================================ */
            const dynamicVariables = [];
            document.querySelectorAll('#edit_dynamic_variables_container .variable-row')
                .forEach((row) => {
                    const inputs = row.querySelectorAll('input');
                    const name = inputs[0]?.value.trim() || "";
                    const value = inputs[1]?.value.trim() || "";
                    if (!name) return;

                    dynamicVariables.push({ name, value });
                });

            /* ============================================================
               ASSIGNMENTS
            ============================================================ */
            const assignments = [];
            document.querySelectorAll('#edit_assignments_container .assignment-row')
                .forEach((row) => {
                    const inputs = row.querySelectorAll('input');
                    const variable = inputs[0]?.value.trim() || "";
                    const path = inputs[1]?.value.trim() || "";
                    if (!variable || !path) return;

                    assignments.push({ variable, path });
                });

            /* ============================================================
               FINAL PAYLOAD
            ============================================================ */
            const currentUrl = new URL(window.location.href);
            const agentId = currentUrl.searchParams.get("agent_id") || null;

            toolConfig = {
                api_url: apiUrl,
                http_method: httpMethod,
                response_timeout_secs: responseTimeout,
                body_description: bodyDescription,
                path_params: pathParams,
                query_params: queryParams,
                request_body_properties: requestBodyProperties,
                request_headers: requestHeaders,
                dynamic_variables: dynamicVariables,
                assignments,
                disable_interruptions: disableInterruptions,
                force_pre_tool_speech: forcePreToolSpeech
            };

            data = {
                function_name: toolName,
                function_description: toolDescription,
                function_url: apiUrl,
                function_timeout: responseTimeout,
                function_parameters: toolConfig,
                agent_id: agentId
            };
            data['activeTabId'] = activeTabId;
        }

        /* ============================================================
           RAW JSON TAB SAVE
        ============================================================ */
        else if (activeTabId === "format_json_tab") {
            let txt = document.getElementById("edit-parameters").value;

            try {
                data = JSON.parse(txt);
                data['activeTabId'] = activeTabId;
            } catch (e) {
                toastr.error("Invalid JSON.");
                return;
            }
        }
        else {
            toastr.error("Some Error in updating custom functions. Please contact support team.");
            return;
        }


        /* ============================================================
           SUBMIT
        ============================================================ */
        $.ajax({
            url: `${host}/elevenlabs/api/v1/custom-functions/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                if (response.status === "success") {
                    toastr.success("Custom function updated.");
                    closeCreateCustomToolModal();
                    //updateFunctionElement(response.data);
                } else {
                    toastr.error(response.message || "Update failed.");
                }
            },
            error: function (xhr) {
                toastr.error(xhr?.responseJSON?.message || "Error updating function.");
            }
        });

    }

    function autoAddPathParam(identifierName) {
        const container = document.getElementById("edit_path_params_container");
        const newIndex = container.querySelectorAll(".param-item").length;

        const html = `
            <div class="param-item border rounded p-3 mb-3" id="edit_path_param_${newIndex}">
                <div class="d-flex justify-content-between mb-2">
                    <h6 class="mb-0">Path Parameter</h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeEditPathParam(${newIndex})">Delete</button>
                </div>

                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">Type</label>
                        <select class="form-select param-type">
                            <option value="string" selected>string</option>
                            <option value="integer">integer</option>
                            <option value="number">number</option>
                            <option value="boolean">boolean</option>
                            <option value="object">object</option>
                            <option value="array">array</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Identifier</label>
                        <input class="form-control param-name" value="${identifierName}" disabled>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label">Value Type</label>
                        <select class="form-select param-value-type" onchange="toggleEditPathParamValueType('edit_path_param_${newIndex}')">
                            <option value="llm_prompt" selected>LLM Prompt</option>
                            <option value="constant_value">Constant Value</option>
                            <option value="dynamic_variable">Dynamic Variable</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="col-12" id="edit_path_param_${newIndex}_value_container">
                        <label class="form-label">LLM Prompt Description</label>
                        <textarea class="form-control param-description" rows="2"></textarea>
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML("beforeend", html);
        toastr.info(`Added Path Param: ${identifierName}`);
    }

    // Remove path params not present in URL
    function autoRemovePathParam(identifierName) {
        const rows = document.querySelectorAll("#edit_path_params_container .param-item");

        rows.forEach(row => {
            const nameInput = row.querySelector(".param-name");
            if (nameInput && nameInput.value.trim() === identifierName) {
                row.remove();
                toastr.info(`Removed Path Param: ${identifierName}`);
            }
        });
    }


</script>
{% endblock %}