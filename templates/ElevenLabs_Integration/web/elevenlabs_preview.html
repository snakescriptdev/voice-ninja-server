<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ host }}/static/Web/css/bot_style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenLabs Agent Preview</title>
</head>
<body>
    <script src="{{ host }}/elevenlabs/web/chatbot-script.js/{{ agent_id }}"></script>
    <script src="{{ host }}/static/js/elevenlabs_websocket.js"></script>
    <input hidden id="username" placeholder="Username" value="admin">
    <input hidden id="password" placeholder="Password" value="admin123">
    <input hidden id="elevenlabs-agent-id" value="{{ agent_id }}">

    <style>
        #visual-panel {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .visual-indicator {
            font-size: 14px;
            margin: 5px 0;
        }
        
        .status-connected { color: #00ff00; }
        .status-disconnected { color: #ff0000; }
        .status-listening { color: #00bfff; }
        .status-speaking { color: #ffa500; }
        .status-waiting { color: #ffff00; }
        
        #audio-queue-info {
            font-size: 11px;
            color: #cccccc;
            margin-top: 8px;
        }
        
        .queue-pending { color: #ffa500; }
        .queue-playing { color: #00ff00; }
    </style>    <script>
        // Wait for ElevenLabs client to be initialized before setting up toggle
        function waitForElevenLabsClient() {
            return new Promise((resolve) => {
                const checkClient = () => {
                    if (window.elevenLabsClient && window.elevenLabsClient.setInterruptionSensitivity) {
                        console.log('ElevenLabs client is ready');
                        resolve(window.elevenLabsClient);
                    } else {
                        console.log('Waiting for ElevenLabs client...');
                        setTimeout(checkClient, 500);
                    }
                };
                checkClient();
            });
        }

        async function toggleVoiceInterruption(isEnabled) {
            try {
                // Wait for ElevenLabs client to be available
                const client = await waitForElevenLabsClient();
                
                if (isEnabled) {
                    // Enable voice interruption with default sensitivity
                    client.setInterruptionSensitivity(0.01, 5);
                    console.log('‚úÖ Voice interruption enabled (threshold: 0.01, frames: 5)');
                    
                    // Load chatbot script when toggle is enabled
                    await loadChatbotScript();
                } else {
                    // Disable voice interruption by setting very high threshold
                    client.setInterruptionSensitivity(1.0, 100);
                    console.log('‚ùå Voice interruption disabled (threshold: 1.0, frames: 100)');
                    
                    // Remove chatbot elements when disabled
                    removeChatbotElements();
                }
                
            } catch (error) {
                console.error("‚ùå Error toggling voice interruption:", error);
            }
        }
        
        async function loadChatbotScript() {
            try {
                // Get agent ID from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const agentId = urlParams.get('agent_id');
                
                if (!agentId) {
                    console.error('Agent ID not found in URL parameters');
                    return;
                }
                
                // Fetch and execute the chatbot script
                const scriptUrl = `/chatbot-script.js/${agentId}`;
                const response = await fetch(scriptUrl);
                
                if (response.ok) {
                    const scriptContent = await response.text();
                    
                    // Create script element and execute
                    const scriptElement = document.createElement('script');
                    scriptElement.textContent = scriptContent;
                    scriptElement.id = 'chatbot-script'; // Add ID for later removal
                    document.head.appendChild(scriptElement);
                    
                    console.log('‚úÖ Chatbot script loaded successfully');
                } else {
                    console.error('Failed to load chatbot script:', response.statusText);
                }
            } catch (error) {
                console.error('Error loading chatbot script:', error);
            }
        }
        
        function removeChatbotElements() {
            // Remove chatbot-related elements when toggle is disabled
            const elementsToRemove = [
                '.voice_icon',
                '.recorder-controls', 
                '.popup',
                '.phone_numder_outer',
                '.micro'
            ];
            
            elementsToRemove.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => element.remove());
            });
            
            // Remove the chatbot script itself
            const chatbotScript = document.getElementById('chatbot-script');
            if (chatbotScript) {
                chatbotScript.remove();
            }
            
            console.log('üóëÔ∏è Chatbot elements removed');
        }

        // Initialize ElevenLabs preview when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üéôÔ∏è ElevenLabs preview page loaded');
            
            // Wait for client and enable features automatically
            try {
                await waitForElevenLabsClient();
                // Automatically load chatbot script on page load
                await loadChatbotScript();
                console.log('‚úÖ ElevenLabs preview initialized successfully');
            } catch (error) {
                console.error('Error initializing ElevenLabs preview:', error);
            }
        });
    </script>
</body>
</html>
