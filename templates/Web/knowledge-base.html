{% extends 'Web/base.html' %}


{% block content %}
    <div class="wrapper">
        <!-- Sidebar  -->
        {% include 'Web/sidebar.html' %}

        <!-- Page Content  -->
        <div id="content" class="page_content">
            
            <div class="agent_page_header knowledge_base_header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <button type="button"
                        class="sidebarCollapse mobile_hamburger_btn hamburger_btn bg-transparent border-0">
                        <img src="{{ url_for('static', path='/Web/images/hamburger-icon.svg') }}" class="img-fluid">
                    </button>
                    <div class="d-flex align-items-center gap-2">
                        <img src="{{ url_for('static', path='/Web/images/book-icon.svg') }}" class="img-fluid">
                        <h6 class="mb-0">Knowledge Base</h6>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="bg-transparent border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <img src="{{ url_for('static', path='/Web/images/person-img.svg') }}" class="img-fluid">
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="#">
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                        class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                                        <path fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                                    </svg>
                                </span>Log Out
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="knowledge_base_outer">
                <div class="container-fluid">
                    <div class="row gx-3">

                        <div class="col-md-6 col-lg-4 mb-md-0 mb-2 px-0 px-md-2">
                            <div class="add_knowledge_base">
                                <div
                                    class="add_knowledge_base_heading d-flex justify-content-between align-items-center">
                                    <h6 class="d-flex align-items-center gap-2 mb-0"><span><img
                                                src="{{ url_for('static', path='/Web/images/book-icon.svg') }}" class="img-fluid"></span> Knowledge Base
                                    </h6>
                                    <button type="button" class="d-flex gap-3 border-0" data-bs-toggle="modal" data-bs-target="#addKnowledgeBaseModal"><img
                                            src="{{ url_for('static', path='/Web/images/white-plus-icon.svg') }}" class="img-fluid">
                                        <span>Add</span></button>
                                </div>
                                <div class="knowledge_base_list" id="knowledge-base-list">
                                    {% for knowledge_base in page_obj.items %}
                                    <div class="list_data">
                                        <a href="#" 
                                           class="d-flex align-items-center gap-2 active_knowldege_base" 
                                           data-id="{{ knowledge_base.id }}" 
                                           data-name="{{ knowledge_base.knowledge_base_name }}" 
                                           data-files='{{ knowledge_base.files | tojson | safe }}'>
                                
                                            <img src="{{ url_for('static', path='Web/images/lines-icon.svg') }}" class="img-fluid"> 
                                            {{ knowledge_base.knowledge_base_name }}
                                        </a>
                                
                                        <!-- File list container (hidden by default) -->
                                        <ul class="file-list" style="display: none;">
                                            {% for file in knowledge_base.files %}
                                                <li>
                                                    <a href="{{ file.url }}" target="_blank">{{ file.name }}</a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endfor %}
                                

                                

                                    <div class="loader" id="loader" style="display: none;">
                                        <div class="bar1"></div>
                                        <div class="bar2"></div>
                                        <div class="bar3"></div>
                                        <div class="bar4"></div>
                                        <div class="bar5"></div>
                                        <div class="bar6"></div>
                                        <div class="bar7"></div>
                                        <div class="bar8"></div>
                                        <div class="bar9"></div>
                                        <div class="bar10"></div>
                                        <div class="bar11"></div>
                                        <div class="bar12"></div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-8 mb-md-0 mb-2 px-0 px-md-2">
                            <div class="add_knowledge_base" id="knowledge-base-box">
                                <div class="add_knowledge_base_heading add_knowledge_base_right_heading d-flex align-items-center justify-content-between">
                                    <div>
                                        <h6 class="mb-0">Select a Knowledge Base</h6>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-end gap-2">
                                        <!-- Delete button (Initially hidden) -->
                                        <button type="button" class="gap-2 dlt_btn align-items-center justify-content-center" 
                                                style="display: none;" id="delete-btn" data-id="" data-bs-toggle="modal" 
                                                data-bs-target="#deleteModal" >
                                            <img src="{{ url_for('static', path='/Web/images/dlt-icon.svg') }}" class="img-fluid">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="knowledge_base_files">
                                    <div class="empty-state text-center py-5">
                                        <p class="mb-0">Please select a knowledge base from the left panel to view details</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade delete_modal" id="deleteModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="text-center">
                        <h3>Are you sure?</h3>
                        <p>You want to delete this knowledge base?</p>
                        <input type="hidden" id="knowledge-base-id">
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <button type="button" class="btn btn-danger" id="confirm-delete">
                                Delete
                            </button>                      
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

<!--Make an inbound call Modal -->
<div class="modal fade inbound_call_modal" id="addKnowledgeBaseModal" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h3>Add Knowledge Base</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form_input">
                <label class="form-label mb-3">Knowledge Base Name</label>
                <input type="text" class="form-control" placeholder="Knowledge Base Name" id="knowledgeBaseName">
            </div>
            <div class="form_input">
                <label class="form-label mb-0">Upload Files</label>
                <div class="upload_area">
                    <label for="uploadFile" class="" id="uploadLabel">
                        <span class="label-text d-flex justify-content-center flex-column align-items-center gap-1"><span><img src="{{ url_for('static', path='/Web/images/upload-file-icon.svg') }}" class="img-fluid"></span>
                        Choose a docx, txt or pdf file or drag & drop it here.<span class="file_size_text">Up to 5 MB</span></span>
                        <p id="fileName" class="d-none mb-0 text-center"></p>
                    </label>
                    <input type="file" class="form-control d-none" id="uploadFile" name="attachment" accept=".docx, .txt, .pdf" multiple>
                </div>
            </div>
            <div class="form_btns d-flex justify-content-end align-items-center gap-3">
                <button type="button" class="" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" id="save_btn" class="bg_black_btn">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

<script>
document.getElementById("uploadFile").addEventListener("change", function () {
    if (this.files.length > 5) {
        toastr.error("You can only select up to 5 files.", "Error", {
                        positionClass: "toast-top-right"
                    });
        this.value = ""; // Clear the selection
    }
});
</script>

<script>

  document.getElementById('uploadFile').addEventListener('change', function(e) {
    var fileName = e.target.files[0].name; // Get the uploaded file name
    var fileNameElement = document.getElementById('fileName'); // File name display element
    var uploadLabel = document.getElementById('uploadLabel'); // Upload label (icon)
    var labelText = uploadLabel.querySelector('.label-text'); // Label text span
  
    // Update the file name element's content and show it
    fileNameElement.textContent = fileName;
    fileNameElement.classList.remove('d-none');
    // Hide the label text span
    if (labelText) {
      labelText.classList.add('d-none');
    }
  });
    

  document.addEventListener("DOMContentLoaded", function () {
    let page = 2;
    let loading = false;
    let hasNext = true;
    
    const knowledgeBaseList = document.getElementById("knowledge-base-list");
    const knowledgeBaseBox = document.getElementById("knowledge-base-box");

    const deleteButton = document.querySelector('.dlt_btn');

    deleteButton.style.display = "none";
    
    // Handle knowledge base click using event delegation
    knowledgeBaseList.addEventListener("click", function (event) {
        let target = event.target.closest(".active_knowldege_base");
        if (!target) return;

        event.preventDefault();

        // Get data attributes
        const name = target.getAttribute("data-name");
        const fileData = JSON.parse(target.getAttribute("data-files"));
        const knowledgeBaseId = target.getAttribute("data-id");

        // Update the knowledge base display container
        updateKnowledgeBaseDisplay(name, fileData);

        // Show the delete button only for the clicked knowledge base
        deleteButton.style.display = "flex";
        deleteButton.setAttribute("data-id", knowledgeBaseId);

        // Highlight the selected item
        document.querySelectorAll(".active_knowldege_base").forEach(kb => kb.classList.remove("selected"));
        target.classList.add("selected");
    });

    function updateKnowledgeBaseDisplay(name, fileData) {
        const knowledgeBaseBox = document.getElementById("knowledge-base-box");
        
        if (!knowledgeBaseBox) {
            console.error("Error: knowledgeBaseBox not found in the DOM.");
            return;
        }

        knowledgeBaseBox.classList.remove("d-none");

        const heading = knowledgeBaseBox.querySelector('.add_knowledge_base_right_heading h6');
        if (heading) {
            heading.textContent = name;
        }

        const filesContainer = knowledgeBaseBox.querySelector('.knowledge_base_files');
        if (!filesContainer) {
            console.error("Error: filesContainer not found in the DOM.");
            return;
        }

        // Clear existing files
        filesContainer.innerHTML = '';

        if (fileData.length > 0) {
            fileData.forEach(file => {
                let iconPath = "/static/Web/images/upload-file-icon.svg";  // Direct static URL
                const formattedSize = file.size ? formatFileSize(file.size) : "Unknown Size";

                const fileElement = document.createElement("div");
                fileElement.className = 'file_inner d-flex justify-content-between align-items-center';
                fileElement.innerHTML = `
                    <div class="d-flex align-items-center gap-lg-4 gap-2">
                        <div class="file_icon">
                            <img src="${iconPath}" class="img-fluid">
                        </div>
                        <div>
                            <h6 class="mb-0">${file.name}</h6>
                            <p class="mb-0">${formattedSize}</p>
                        </div>
                    </div>
                    <a href="${file.url}" class="d-flex" download>
                        <img src="/static/Web/images/download-icon.svg" class="img-fluid">
                    </a>
                `;

                filesContainer.appendChild(fileElement);
            });
        } else {
            filesContainer.innerHTML = '<div class="py-3 text-center">No files attached to this knowledge base.</div>';
        }
    }

    function formatFileSize(size) {
        if (!size || isNaN(size)) return "Unknown Size";
        const i = Math.floor(Math.log(size) / Math.log(1024));
        return (size / Math.pow(1024, i)).toFixed(2) * 1 + " " + ["B", "KB", "MB", "GB", "TB"][i];
    }
});


    function formatFileSize(size) {
        if (!size) return "Unknown Size";
        size = parseInt(size, 10);
        if (size < 1024) return size + ' B';
        else if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
        else return (size / (1024 * 1024)).toFixed(1) + ' MB';
    }

    window.addEventListener("scroll", function () {
        if (!loading && hasNext && window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
            loadMoreKnowledgeBases();
        }
    });

    function loadMoreKnowledgeBases() {
        loading = true;
        document.getElementById("loader").style.display = "block";

        fetch(`/knowledge_base/?page=${page}`, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(response => response.json())
        .then(data => {
            if (data.knowledge_bases.length > 0) {
                data.knowledge_bases.forEach(kb => {
                    if (!document.querySelector(`.active_knowldege_base[data-id="${kb.id}"]`)) {
                        const div = document.createElement("div");
                        div.classList.add("list_data"); 
                        div.innerHTML = `
                        <a href="#" class="d-flex align-items-center gap-2 active_knowldege_base" 
                           data-id="${kb.id}" 
                           data-name="${kb.name}" 
                           data-files='${JSON.stringify(kb.files)}'>
                            <img src="{{ url_for('static', path='/Web/images/lines-icon.svg') }}" class="img-fluid"> 
                            ${kb.name}
                        </a>
                        `;
                        knowledgeBaseList.appendChild(div);
                    }
                });

                if (data.has_next) {
                    page = data.next_page;  // Set the next page from the response
                } else {
                    hasNext = false;  // Stop loading if there's no next page
                }
            }

            document.getElementById("loader").style.display = "none";
            loading = false;
        })
        .catch(error => {
            console.error("Error loading more knowledge bases:", error);
            document.getElementById("loader").style.display = "none";
            loading = false;
        });
    }


document.addEventListener("DOMContentLoaded", function () {
    const deleteButton = document.querySelector('.dlt_btn');
    const deleteModal = document.getElementById("deleteModal");
    const confirmDeleteBtn = document.getElementById("confirm-delete");

    // Ensure the delete button is hidden initially
    deleteButton.style.display = "none";

    // Listen for clicks on the delete button
    deleteButton.addEventListener("click", function () {
        const knowledgeBaseId = deleteButton.getAttribute("data-id");

        if (knowledgeBaseId) {
            // Store the ID in the modal for reference when confirming deletion
            deleteModal.setAttribute("data-id", knowledgeBaseId);
        }
    });

    // Handle confirm delete button click
    confirmDeleteBtn.addEventListener("click", function () {
        const knowledgeBaseId = deleteModal.getAttribute("data-id");

        if (knowledgeBaseId) {
            fetch(`/api/delete_knowledge_base`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    knowledge_base_id: knowledgeBaseId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status == "success") {
                    toastr.success(data.message, "Success", {
                        positionClass: "toast-top-right"
                    });
                    deleteModal.style.display = "none";
                    document.querySelector(".modal-backdrop")?.remove();

                    setTimeout(() => {
                        location.reload();  
                    }, 1000);
                } else {
                    toastr.error("Error deleting knowledge base!", "Error", {
                        positionClass: "toast-top-right"
                    });
                    deleteModal.style.display = "none";
                    document.querySelector(".modal-backdrop")?.remove();

                }
            })
            .catch(error => console.error("Error:", error));
        }
    });


});





</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("save_btn").addEventListener("click", function (e) {
        e.preventDefault(); // Prevent form submission

        let save_btn = document.getElementById("save_btn");
        save_btn.textContent = "Please wait...";
        save_btn.disabled = true;

        let knowledgeBaseName = document.getElementById("knowledgeBaseName").value;
        let attachments = document.getElementById("uploadFile").files;

        if (!knowledgeBaseName || attachments.length === 0) {
            toastr.error("Please enter a Knowledge Base Name and upload at least one file.", "Error", {
                positionClass: "toast-top-right"
            });
            save_btn.textContent = "Save";
            save_btn.disabled = false;
            return;
        }

        if (attachments.length > 5) {
            toastr.error("You can upload a maximum of 5 files.", "Error", {
                positionClass: "toast-top-right"
            });
            save_btn.textContent = "Save";
            save_btn.disabled = false;
            return;
        }

        let formData = new FormData();
        formData.append("name", knowledgeBaseName);
        
        // Append multiple files
        for (let i = 0; i < attachments.length; i++) {
            formData.append("attachments[]", attachments[i]); 
        }

        // Send AJAX request to backend
        fetch("/api/upload_knowledge_base", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                toastr.success("Knowledge Base added successfully!", "Success", {
                    positionClass: "toast-top-right"
                });
                save_btn.textContent = "Save";
                save_btn.disabled = false;
                document.querySelector(".modal-backdrop")?.remove();
                setTimeout(() => {
                    location.reload(); 
                }, 1000);
            } else {
                toastr.error("Error: " + data.message, "Error", {
                    positionClass: "toast-top-right"
                });
                save_btn.textContent = "Save";
                save_btn.disabled = false;
                $('#addKnowledgeBaseModal').hide();
                document.querySelector(".modal-backdrop")?.remove();
            }
        })
        .catch(error => {
            console.error("Error:", error);
            toastr.error("An unexpected error occurred.", "Error", {
                positionClass: "toast-top-right"
            });
            save_btn.textContent = "Save";
            save_btn.disabled = false;
        });
    });
});

</script>


{% endblock %}