{% extends 'Web/base.html' %}


{% block content %}
    <div class="wrapper">
        <!-- Sidebar  -->
        {% include 'Web/sidebar.html' %}

        <!-- Page Content  -->
        <div id="content" class="page_content">
            
            <div class="agent_page_header knowledge_base_header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <button type="button"
                        class="sidebarCollapse mobile_hamburger_btn hamburger_btn bg-transparent border-0">
                        <img src="{{ host }}/static/Web/images/hamburger-icon.svg" class="img-fluid">
                    </button>
                    <div class="d-flex align-items-center gap-2">
                        <img src="{{ host }}/static/Web/images/book-icon.svg" class="img-fluid">
                        <h6 class="mb-0">Knowledge Base</h6>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="bg-transparent border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <div class="user-avatar">
                            {{ request.session.get("user").get('name')[0].upper() }}
                        </div>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="#">
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                        class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                                        <path fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                                    </svg>
                                </span>Log Out
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="knowledge_base_outer">
                <div class="container-fluid">
                    <div class="row gx-3">

                        <div class="col-md-6 col-lg-4 mb-md-0 mb-2 px-0 px-md-2">
                            <div class="add_knowledge_base">
                                <div
                                    class="add_knowledge_base_heading d-flex justify-content-between align-items-center">
                                    <h6 class="d-flex align-items-center gap-2 mb-0"><span><img
                                                src="{{ host }}/static/Web/images/book-icon.svg" class="img-fluid"></span> Knowledge Base
                                    </h6>
                                    <div class="dropdown">
                                        <button type="button" class="d-flex gap-3 border-0 dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            <img src="{{ host }}/static/Web/images/white-plus-icon.svg" class="img-fluid">
                                            <span>Add</span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="openAddUrlModal(event, 'create')">Add URL</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="openAddFilesModal(event, 'create')">Add Files</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="openCreateTextModal(event, 'create')">Create Text</a></li>
                                        </ul>

                                        <!-- Add URL Modal -->
                                        <div class="modal fade" id="addUrlModal" tabindex="-1" aria-labelledby="addUrlModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="addUrlModalLabel">Add URL</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form id="addUrlForm" onsubmit="addUrl(event)">
                                                            <div class="mb-3">
                                                                <label for="urlName" class="form-label" id="urlNameLabel">Knowledge Base Name</label>
                                                                <input type="text" class="form-control" id="urlName" required>
                                                                <small class="text-muted d-block" id="urlNameHelper">Enter a new knowledge base name or pick an existing one.</small>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="urlInput" class="form-label">Enter URL</label>
                                                                <input type="url" class="form-control" id="urlInput" required>
                                                            </div>
                                                            <input type="hidden" id="add-url-knowledge-base-id">
                                                        </form>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" form="addUrlForm" class="btn btn-primary">Add URL</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Add Files Modal -->
                                        <div class="modal fade inbound_call_modal" id="addKnowledgeBaseModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                              <div class="modal-content" >
                                                <div class="modal-header border-0">
                                                  <h3>Add Knowledge Base</h3>
                                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                  <form>
                                                    <div class="form_input">
                                                        <label class="form-label mb-3">Knowledge Base Name</label>
                                                        <input type="text" class="form-control" placeholder="Knowledge Base Name" id="knowledgeBaseName">
                                                    </div>
                                                    <div class="form_input">
                                                        <label class="form-label mb-0">Upload Files</label>
                                                        <div class="upload_area">
                                                            <label for="uploadFile" class="" id="uploadLabel">
                                                                <span class="label-text d-flex justify-content-center flex-column align-items-center gap-1"><span><img src="{{ host }}/static/Web/images/upload-file-icon.svg" class="img-fluid"></span>
                                                                Choose multiple docx, txt or pdf file or drag & drop it here.<span class="file_size_text">Up to 5 MB</span></span>
                                                                <p id="fileName" class="d-none mb-0 text-center"></p>
                                                            </label>
                                                            <input type="file" class="form-control d-none" id="uploadFile" name="attachment" accept=".docx, .txt, .pdf" multiple>
                                                        </div>
                                                    </div>
                                                    <div class="form_btns d-flex justify-content-end align-items-center gap-3">
                                                        <button type="button" class="" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" id="save_btn" class="bg_black_btn">Save</button>
                                                    </div>
                                                  </form>
                                                </div>
                                              </div>
                                            </div>
                                        </div>

                                        <!-- Create Text Modal -->
                                        <div class="modal fade" id="createTextModal" tabindex="-1" aria-labelledby="createTextModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="createTextModalLabel">Create Text</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form id="createTextForm" onsubmit="createText(event)">
                                                            <div class="mb-3">
                                                                <label for="textTitle" class="form-label" id="textTitleLabel">Knowledge Base Name</label>
                                                                <input type="text" class="form-control" id="textTitle" required>
                                                                <small class="text-muted d-block" id="textTitleHelper">Provide the name for this knowledge base.</small>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label for="textContent" class="form-label">Content</label>
                                                                <textarea class="form-control" id="textContent" rows="5" required></textarea>
                                                            </div>
                                                            <input type="hidden" id="add-text-knowledge-base-id">
                                                        </form>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" form="createTextForm" class="btn btn-primary">Save Text</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="knowledge_base_list" id="knowledge-base-list">
                                    {% for knowledge_base in page_obj.items %}
                                        <div class="list_data" id="knowledge-base-list-item_{{ knowledge_base.id }}">
                                            <input type="hidden" id="set-knowledge-base-id" value="{{ knowledge_base.id }}">
                                            <a href="#" 
                                            class="d-flex align-items-center gap-2 active_knowldege_base" 
                                            data-id="{{ knowledge_base.id }}" 
                                            data-name="{{ knowledge_base.knowledge_base_name }}" 
                                            data-files='{{ knowledge_base.files | tojson | safe }}'>
                                                <img src="{{ host }}/static/Web/images/lines-icon.svg" class="img-fluid"> 
                                                <span class="kb-name-text">{{ knowledge_base.knowledge_base_name }}</span>
                                            </a>
                                    
                                            <!-- File list container (hidden by default) -->
                                            <ul class="file-list" style="display: none;">
                                                {% for file in knowledge_base.files %}
                                                    <li>
                                                        <a href="{{ file.url }}" target="_blank">{{ file.name }}</a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endfor %}
                                    <div class="loader" id="loader" style="display: none;">
                                        <div class="bar1"></div>
                                        <div class="bar2"></div>
                                        <div class="bar3"></div>
                                        <div class="bar4"></div>
                                        <div class="bar5"></div>
                                        <div class="bar6"></div>
                                        <div class="bar7"></div>
                                        <div class="bar8"></div>
                                        <div class="bar9"></div>
                                        <div class="bar10"></div>
                                        <div class="bar11"></div>
                                        <div class="bar12"></div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-8 mb-md-0 mb-2 px-0 px-md-2">
                            <div class="add_knowledge_base" id="knowledge-base-box">
                                <div class="add_knowledge_base_heading add_knowledge_base_right_heading d-flex align-items-center justify-content-between">
                                    <div>
                                        <h6 class="mb-0">Select a Knowledge Base</h6>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-end gap-2">
                                        <div class="dropdown selected_kb_actions" id="selected-kb-action-dropdown" style="display: none;">
                                            <button type="button" class="d-flex gap-2 border-0 dropdown-toggle align-items-center" data-bs-toggle="dropdown" aria-expanded="false">
                                                <img src="{{ host }}/static/Web/images/white-plus-icon.svg" class="img-fluid">
                                                <span>Add to KB</span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><a class="dropdown-item" href="#" onclick="openAddFilesModal(event, 'existing')">Add Files</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="openAddUrlModal(event, 'existing')">Add URL</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="openCreateTextModal(event, 'existing')">Add Text</a></li>
                                            </ul>
                                        </div>
                                        <!-- Delete button (Initially hidden) -->
                                        <button type="button" class="gap-2 dlt_btn align-items-center justify-content-center" 
                                                style="display: none;" id="delete-btn" data-id="" data-bs-toggle="modal" 
                                                data-bs-target="#deleteModal" >
                                            <img src="{{ host }}/static/Web/images/dlt-icon.svg" class="img-fluid delete-icon">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="knowledge_base_files">
                                    <div class="empty-state text-center py-5">
                                        <p class="mb-0">Please select a knowledge base from the left panel to view details</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade delete_modal" id="deleteModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="text-center">
                        <h3 id="delete-title">Are you sure?</h3>
                        <p id="delete-description">You want to delete this knowledge base?</p>
                        <input type="hidden" id="knowledge-base-id">
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <button type="button" class="btn btn-danger" id="confirm-delete">
                                Delete
                            </button>                      
                            <button type="button" class="btn btn-secondary" id="cancel-delete" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<!-- Modal -->
    <div class="modal fade delete_modal" id="deleteFileModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleFileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="text-center">
                        <h3 id="delete-file-question">Are you sure?</h3>
                        <p id="delete-file-description">You want to delete this file?</p>
                        <input type="hidden" id="file-id">
                        <input type="hidden" id="knowledge-base-id">
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <button type="button" class="btn btn-danger" id="confirm-delete-file" onclick="confirmDeleteFile()">
                                Delete
                            </button>                      
                            <button type="button" class="btn btn-secondary" id="cancel-delete-file" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
  
<!--Add more files to Knowledge Base Modal -->
<div class="modal fade inbound_call_modal" id="AddFilesModel" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" >
        <div class="modal-header border-0">
          <h3>Add more files to Knowledge Base</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <input type="hidden" id="selected-knowledge-base-id" name="selected_knowledge_base_id">
            <input type="hidden" id="selected-knowledge-base-name" name="selected_knowledge_base_name">
            <div class="form_input">
                <label class="form-label mb-0">Upload Files</label>
                <div class="upload_area">
                    <label for="uploadMoreFiles" class="" id="uploadMoreLabel">
                        <span class="label-text d-flex justify-content-center flex-column align-items-center gap-1"><span><img src="{{ host }}/static/Web/images/upload-file-icon.svg" class="img-fluid"></span>
                        Choose a docx, txt or pdf file or drag & drop it here.<span class="file_size_text">Up to 5 MB</span></span>
                        <p id="moreFileName" class="d-none mb-0 text-center"></p>
                    </label>
                    <input type="file" class="form-control d-none" id="uploadMoreFiles" name="attachment" accept=".docx, .txt, .pdf">
                </div>
            </div>
            <div class="form_btns d-flex justify-content-end align-items-center gap-3">
                <button type="button" class="" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="bg_black_btn" id="saveMoreFilesBtn" onclick="saveMoreFiles(event)">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

<script>
document.getElementById("uploadFile").addEventListener("change", function () {
    if (this.files.length > 5) {
        toastr.error("You can only select up to 5 files.", "Error", {
                        positionClass: "toast-top-right"
                    });
        this.value = ""; // Clear the selection
    }
});
</script>

<script>
  document.getElementById('uploadFile').addEventListener('change', function(e) {
    var fileName = e.target.files[0].name; // Get the uploaded file name
    var fileNameElement = document.getElementById('fileName'); // File name display element
    var uploadLabel = document.getElementById('uploadLabel'); // Upload label (icon)
    var labelText = uploadLabel.querySelector('.label-text'); // Label text span
  
    // Update the file name element's content and show it
    fileNameElement.textContent = fileName;
    fileNameElement.classList.remove('d-none');
    // Hide the label text span
    if (labelText) {
      labelText.classList.add('d-none');
    }
  });

    let page = 2;
    let loading = false;
    let hasNext = true;
    const knowledgeBaseList = document.getElementById("knowledge-base-list");
    const knowledgeBaseBox = document.getElementById("knowledge-base-box");
    const selectedKnowledgeBaseInput = document.getElementById("selected-knowledge-base-id");
    const selectedKnowledgeBaseNameInput = document.getElementById("selected-knowledge-base-name");

    const deleteButton = document.querySelector('.dlt_btn');
    const actionDropdown = document.getElementById("selected-kb-action-dropdown");
    
  document.addEventListener("DOMContentLoaded", function () {
    deleteButton.style.display = "none";
    if (actionDropdown) {
        actionDropdown.style.display = "none";
    }
    // Handle knowledge base click using event delegation
    knowledgeBaseList.addEventListener("click", function (event) {
        let target = event.target.closest(".active_knowldege_base");
        if (!target) return;

        event.preventDefault();

        // Get data attributes
        const name = target.getAttribute("data-name");
        const fileData = JSON.parse(target.getAttribute("data-files"));
        const knowledgeBaseId = target.getAttribute("data-id");

        // Update the knowledge base display container
        updateKnowledgeBaseDisplay(name, fileData, knowledgeBaseId);

        // Persist the currently selected knowledge base id for later actions
        if (selectedKnowledgeBaseInput) {
            selectedKnowledgeBaseInput.value = knowledgeBaseId;
        }
        if (selectedKnowledgeBaseNameInput) {
            selectedKnowledgeBaseNameInput.value = name;
        }

        // Show the delete button only for the clicked knowledge base
        deleteButton.style.display = "flex";
        deleteButton.setAttribute("data-id", knowledgeBaseId);
        if (actionDropdown) {
            actionDropdown.style.display = "flex";
            actionDropdown.setAttribute("data-id", knowledgeBaseId);
        }

        // Highlight the selected item
        document.querySelectorAll(".active_knowldege_base").forEach(kb => kb.classList.remove("selected"));
        target.classList.add("selected");
    });


    function formatFileSize(size) {
        if (!size || isNaN(size)) return "Unknown Size";
        const i = Math.floor(Math.log(size) / Math.log(1024));
        return (size / Math.pow(1024, i)).toFixed(2) * 1 + " " + ["B", "KB", "MB", "GB", "TB"][i];
    }
});


function updateKnowledgeBaseDisplay(name, fileData, knowledgeBaseId) {
    var knowledgeBaseBox = document.getElementById("knowledge-base-box");
    
    if (!knowledgeBaseBox) {
        console.error("Error: knowledgeBaseBox not found in the DOM.");
        return;
    }

    knowledgeBaseBox.classList.remove("d-none");

    const heading = knowledgeBaseBox.querySelector('.add_knowledge_base_right_heading h6');
    if (heading) {
        // Remove any existing containers first
        const existingContainer = heading.parentElement;
        if (existingContainer && existingContainer.classList.contains('d-flex')) {
            existingContainer.parentNode.replaceChild(heading, existingContainer);
        }

        // Create new container div for heading and edit icon
        const container = document.createElement('div');
        container.className = 'd-flex align-items-center gap-2';
        
        heading.textContent = name;
        heading.id = "knowledge-base-name";
        
        // Only add edit functionality if heading has correct ID
        if (heading.id === "knowledge-base-name") {
            // Create edit icon only if it doesn't exist
            if (!container.querySelector('.edit-icon')) {
                const editIcon = document.createElement('img');
                editIcon.src = "{{ host }}/static/Web/images/edit-icon.svg";
                editIcon.className = "edit-icon";
                editIcon.style.width = "16px";
                editIcon.style.cursor = "pointer";
                
                // Move heading to container and add edit icon
                heading.parentNode.replaceChild(container, heading);
                container.appendChild(heading);
                container.appendChild(editIcon);

                // Add click handler to edit icon
                editIcon.addEventListener('click', function() {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = heading.textContent;
                    input.className = heading.className;
                    input.style.width = '100%';
                    
                    // Replace heading with input but keep edit icon
                    container.replaceChild(input, heading);
                    input.focus();

                    let isEditing = true;

                    function saveChanges() {
                        if (!isEditing) return;
                        isEditing = false;
                        heading.textContent = input.value;
                        container.replaceChild(heading, input);
                        editIcon.style.display = "flex";

                        if (input.value.trim() === '') {
                            toastr.error('Knowledge base name cannot be empty.', 'Error', {
                                positionClass: 'toast-top-right'
                            });
                            return;
                        }


                        if (input.value.trim() === name.trim()) {
                            editIcon.style.display = "flex";
                            return;
                        }
                        
                        
                        fetch("{{ host }}/api/update_knowledge_base", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                knowledge_base_id: knowledgeBaseId,
                                new_name: input.value
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                toastr.success('Knowledge base name updated successfully!', 'Success', {
                                    positionClass: 'toast-top-right'
                                });
                                updateKnowledgeBaseName(knowledgeBaseId, input.value)
                            } else {
                                toastr.error('Error updating knowledge base name: ' + data.message, 'Error', {
                                    positionClass: 'toast-top-right'
                                });
                                heading.textContent = name;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            toastr.error('An unexpected error occurred while updating the name.', 'Error', {
                                positionClass: 'toast-top-right'
                            });
                            heading.textContent = name;
                        });
                    }

                    input.addEventListener('blur', saveChanges);
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            saveChanges();
                        }
                    });

                    editIcon.style.display = "none";
                });
            }
        } else {
            heading.parentNode.replaceChild(container, heading);
            container.appendChild(heading);
        }
    }

    const filesContainer = knowledgeBaseBox.querySelector('.knowledge_base_files');
    if (!filesContainer) {
        console.error("Error: filesContainer not found in the DOM.");
        return;
    }

    // Clear existing files
    filesContainer.innerHTML = '';

    if (fileData.length > 0) {
        
        fileData.forEach(file => {
            
            let iconPath = "{{ host }}/static/Web/images/upload-file-icon.svg";
            const formattedSize = file.size ? formatFileSize(file.size) : "Unknown Size";

            const fileElement = document.createElement("div");
            fileElement.className = 'file_inner d-flex justify-content-between align-items-center flex-sm-nowrap flex-wrap';
            fileElement.innerHTML = `
                <div class="d-flex align-items-center gap-lg-3 gap-2 flex-sm-nowrap flex-wrap">
                    <div class="file_icon">
                        <img src="${iconPath}" class="img-fluid">
                    </div>
                    <div>
                        <h6 class="mb-0">${file.name}</h6>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2 delete_download_btns">
                    <a class="d-flex" onclick="downloadFile('${file.url}')"  download>
                        <img src="{{ host }}/static/Web/images/download-icon.svg" class="img-fluid">
                    </a>
                    <a class="d-flex" onclick="deleteFile(${file.id}, ${file.knowledge_base_id}, ${file.elevenlabs_doc_id ? `'${file.elevenlabs_doc_id}'` : 'null'})">
                        <img src="{{ host }}/static/Web/images/dlt-icon.svg" class="img-fluid">
                    </a>
                </div>
            `;

            filesContainer.appendChild(fileElement);
        });
    } else {
        filesContainer.innerHTML = '<div class="py-3 text-center">No files attached to this knowledge base.</div>';
    }
}

function updateKnowledgeBaseName(knowledgeBaseId, newName) {
    const listItem = document.querySelector(`#knowledge-base-list-item_${knowledgeBaseId} a`);
    if (listItem) {
        listItem.setAttribute("data-name", newName);
        const textNode = listItem.querySelector(".kb-name-text");
        if (textNode) {
            textNode.textContent = newName;
        }
    }
    const selectedKnowledgeBaseInput = document.getElementById("selected-knowledge-base-id");
    const selectedKnowledgeBaseNameInput = document.getElementById("selected-knowledge-base-name");
    if (selectedKnowledgeBaseInput && selectedKnowledgeBaseInput.value === String(knowledgeBaseId) && selectedKnowledgeBaseNameInput) {
        selectedKnowledgeBaseNameInput.value = newName;
        const titleInput = document.getElementById("textTitle");
        const urlNameInput = document.getElementById("urlName");
        if (titleInput && titleInput.hasAttribute("readonly")) {
            titleInput.value = newName;
        }
        if (urlNameInput && urlNameInput.hasAttribute("readonly")) {
            urlNameInput.value = newName;
        }
    }
}

function formatFileSize(size) {
    if (!size) return "Unknown Size";
    size = parseInt(size, 10);
    if (size < 1024) return size + ' B';
    else if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
    else return (size / (1024 * 1024)).toFixed(1) + ' MB';
}

window.addEventListener("scroll", function () {
    if (!loading && hasNext && window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        loadMoreKnowledgeBases();
    }
});

function loadMoreKnowledgeBases() {
    loading = true;
    document.getElementById("loader").style.display = "block";

    fetch(`/elevenlabs/api/v1/knowledge-base-json?page=${page}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
        if (data.knowledge_bases.length > 0) {
            data.knowledge_bases.forEach(kb => {
                if (!document.querySelector(`.active_knowldege_base[data-id="${kb.id}"]`)) {
                    const div = document.createElement("div");
                            div.classList.add("list_data"); 
                            div.id = `knowledge-base-list-item_${kb.id}`;
                    div.innerHTML = `
                    <a href="#" class="d-flex align-items-center gap-2 active_knowldege_base" 
                       data-id="${kb.id}" 
                       data-name="${kb.knowledge_base_name}" 
                       data-files='${JSON.stringify(kb.files)}'>
                        <img src="{{ host }}/static/Web/images/lines-icon.svg" class="img-fluid"> 
                        <span class="kb-name-text">${kb.knowledge_base_name}</span>
                    </a>
                    `;
                   
                    knowledgeBaseList.appendChild(div);
                }
            });

            if (data.has_next) {
                page = data.next_page;  // Set the next page from the response
            } else {
                hasNext = false;  // Stop loading if there's no next page
            }
        }

        document.getElementById("loader").style.display = "none";
        loading = false;
    })
    .catch(error => {
        console.error("Error loading more knowledge bases:", error);
        document.getElementById("loader").style.display = "none";
        loading = false;
    });
}


function getSelectedKnowledgeBaseId() {
    const knowledgeBaseInput = document.getElementById("selected-knowledge-base-id");
    return knowledgeBaseInput ? knowledgeBaseInput.value : "";
}

function ensureKnowledgeBaseSelection(actionLabel) {
    const knowledgeBaseId = getSelectedKnowledgeBaseId();
    if (!knowledgeBaseId) {
        toastr.error(`Please select a knowledge base to ${actionLabel}.`, "Error", {
            positionClass: "toast-top-right"
        });
        return null;
    }
    return knowledgeBaseId;
}

function resetCreateKnowledgeBaseForm() {
    const nameInput = document.getElementById("knowledgeBaseName");
    const uploadInput = document.getElementById("uploadFile");
    const fileNameElement = document.getElementById('fileName');
    const labelText = document.querySelector('#uploadLabel .label-text');

    if (nameInput) {
        nameInput.value = "";
    }
    if (uploadInput) {
        uploadInput.value = "";
    }
    if (fileNameElement) {
        fileNameElement.textContent = "";
        fileNameElement.classList.add('d-none');
    }
    if (labelText) {
        labelText.classList.remove('d-none');
    }
}

function openAddFilesModal(event, mode = "existing") {
    event.preventDefault();

    if (mode === "create") {
        const createModalEl = document.getElementById("addKnowledgeBaseModal");
        if (createModalEl) {
            const modal = bootstrap.Modal.getOrCreateInstance(createModalEl);
            resetCreateKnowledgeBaseForm();
            modal.show();
        }
        return;
    }

    const knowledgeBaseId = ensureKnowledgeBaseSelection("add files");
    if (!knowledgeBaseId) return;

    const modalEl = document.getElementById("AddFilesModel");
    if (modalEl) {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }
}

function openAddUrlModal(event, mode = "existing") {
    event.preventDefault();
    const modalEl = document.getElementById("addUrlModal");
    const hiddenInput = document.getElementById("add-url-knowledge-base-id");
    const kbNameInput = document.getElementById("urlName");
    const helper = document.getElementById("urlNameHelper");
    const label = document.getElementById("urlNameLabel");
    const selectedKnowledgeBaseNameInput = document.getElementById("selected-knowledge-base-name");

    if (!modalEl || !kbNameInput) {
        console.error("Required elements for Add URL modal are missing.");
        return;
    }

    modalEl.setAttribute("data-mode", mode);

    if (mode === "existing") {
        const knowledgeBaseId = ensureKnowledgeBaseSelection("add a URL");
        if (!knowledgeBaseId) return;

        if (hiddenInput) {
            hiddenInput.value = knowledgeBaseId;
        }

        const selectedName = selectedKnowledgeBaseNameInput ? selectedKnowledgeBaseNameInput.value : "";
        kbNameInput.value = selectedName;
        kbNameInput.setAttribute("readonly", "readonly");
        if (label) {
            label.textContent = "Knowledge Base Name";
        }
        if (helper) {
            helper.textContent = "Using the currently selected knowledge base.";
        }
    } else {
        if (hiddenInput) {
            hiddenInput.value = "";
        }
        kbNameInput.value = "";
        kbNameInput.removeAttribute("readonly");
        const urlInput = document.getElementById("urlInput");
        if (urlInput) {
            urlInput.value = "";
        }
        if (label) {
            label.textContent = "Knowledge Base Name";
        }
        if (helper) {
            helper.textContent = "Enter a name to create a new knowledge base for this URL.";
        }
    }

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

function openCreateTextModal(event, mode = "existing") {
    event.preventDefault();
    const modalEl = document.getElementById("createTextModal");
    const hiddenInput = document.getElementById("add-text-knowledge-base-id");
    const titleInput = document.getElementById("textTitle");
    const helper = document.getElementById("textTitleHelper");
    const label = document.getElementById("textTitleLabel");
    const selectedKnowledgeBaseNameInput = document.getElementById("selected-knowledge-base-name");

    if (!modalEl || !titleInput) {
        console.error("Required elements for Create Text modal are missing.");
        return;
    }

    modalEl.setAttribute("data-mode", mode);

    if (mode === "existing") {
        const knowledgeBaseId = ensureKnowledgeBaseSelection("add text");
        if (!knowledgeBaseId) return;

        if (hiddenInput) {
            hiddenInput.value = knowledgeBaseId;
        }

        const selectedName = selectedKnowledgeBaseNameInput ? selectedKnowledgeBaseNameInput.value : "";
        titleInput.value = selectedName;
        titleInput.setAttribute("readonly", "readonly");
        if (label) {
            label.textContent = "Knowledge Base Name";
        }
        if (helper) {
            helper.textContent = "Using the currently selected knowledge base.";
        }
    } else {
        if (hiddenInput) {
            hiddenInput.value = "";
        }
        titleInput.value = "";
        titleInput.removeAttribute("readonly");
        const contentInput = document.getElementById("textContent");
        if (contentInput) {
            contentInput.value = "";
        }
        if (label) {
            label.textContent = "Knowledge Base Name";
        }
        if (helper) {
            helper.textContent = "Enter a name to create a new knowledge base for this text.";
        }
    }

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}


document.addEventListener("DOMContentLoaded", function () {
    const deleteButton = document.querySelector('.dlt_btn');
    const deleteModal = document.getElementById("deleteModal");
    const confirmDeleteBtn = document.getElementById("confirm-delete");
    const cancelDeleteBtn = document.getElementById("cancel-delete");
    const deleteTitle = document.getElementById("delete-title");
    const deleteDescription = document.getElementById("delete-description");
    // Ensure the delete button is hidden initially
    deleteButton.style.display = "none";

    // Listen for clicks on the delete button
    deleteButton.addEventListener("click", function () {
        const knowledgeBaseId = deleteButton.getAttribute("data-id");

        if (knowledgeBaseId) {
            // Store the ID in the modal for reference when confirming deletion
            deleteModal.setAttribute("data-id", knowledgeBaseId);
        }
    });

    // Handle confirm delete button click
    confirmDeleteBtn.addEventListener("click", function () {
        const knowledgeBaseId = deleteModal.getAttribute("data-id");
        confirmDeleteBtn.disabled = true;
        cancelDeleteBtn.style.display = "none";
        confirmDeleteBtn.textContent = "Please wait...";
        deleteTitle.style.display = "none";
        deleteDescription.style.display = "none";

        if (knowledgeBaseId) {
            fetch("{{ host }}/elevenlabs/api/v1/delete_knowledge_base", {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    knowledge_base_id: knowledgeBaseId
                })
            })
            .then(response => response.json())
            .then(data => {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = "Delete";
                cancelDeleteBtn.style.display = "block";
                deleteTitle.style.display = "block";
                deleteDescription.style.display = "block";
                 if (data.status == "success") {
                    toastr.success(data.message, "Success", {
                        positionClass: "toast-top-right"
                    });
                    deleteModal.style.display = "none";
                    document.querySelector(".modal-backdrop")?.remove();

                    setTimeout(() => {
                        location.reload();  
                    }, 1000);
                } else {
                    toastr.error("Error deleting knowledge base!", "Error", {
                        positionClass: "toast-top-right"
                    });
                    deleteModal.style.display = "none";
                    document.querySelector(".modal-backdrop")?.remove();

                }
            })
            .catch(error => {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = "Delete";
                cancelDeleteBtn.style.display = "block";
                deleteTitle.style.display = "block";
                deleteDescription.style.display = "block";
                console.error("Error:", error);
            });
        }
    });


});





</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("save_btn").addEventListener("click", function (e) {
        e.preventDefault(); // Prevent form submission

        let save_btn = document.getElementById("save_btn");
        save_btn.textContent = "Please wait...";
        save_btn.disabled = true;

        let knowledgeBaseName = document.getElementById("knowledgeBaseName").value;
        let attachments = document.getElementById("uploadFile").files;

        if (!knowledgeBaseName || attachments.length === 0) {
            toastr.error("Please enter a Knowledge Base Name and upload at least one file.", "Error", {
                positionClass: "toast-top-right"
            });
            save_btn.textContent = "Save";
            save_btn.disabled = false;
            return;
        }

        if (attachments.length > 5) {
            toastr.error("You can upload a maximum of 5 files.", "Error", {
                positionClass: "toast-top-right"
            });
            save_btn.textContent = "Save";
            save_btn.disabled = false;
            return;
        }

        let formData = new FormData();
        formData.append("name", knowledgeBaseName);
        
        // Append multiple files
        for (let i = 0; i < attachments.length; i++) {
            formData.append("attachments[]", attachments[i]); 
        }

        // Send AJAX request to backend
        fetch("{{ host }}/elevenlabs/api/v1/upload_knowledge_base", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                toastr.success("Knowledge Base added successfully!", "Success", {
                    positionClass: "toast-top-right"
                });
                save_btn.textContent = "Save";
                save_btn.disabled = false;
                document.querySelector(".modal-backdrop")?.remove();
                setTimeout(() => {
                    location.reload(); 
                }, 1000);
            } else {
                toastr.error("Error: " + data.message, "Error", {
                    positionClass: "toast-top-right"
                });
                save_btn.textContent = "Save";
                save_btn.disabled = false;
                $('#addKnowledgeBaseModal').hide();
                document.querySelector(".modal-backdrop")?.remove();
            }
        })
        .catch(error => {
            console.error("Error:", error);
            toastr.error("An unexpected error occurred.", "Error", {
                positionClass: "toast-top-right"
            });
            save_btn.textContent = "Save";
            save_btn.disabled = false;
        });
    });
});

function deleteFile(fileId, knowledgeBaseId, elevenlabsDocId) {
    if (!fileId || !knowledgeBaseId) {
        toastr.error("Missing required parameters for file deletion.", "Error", {
            positionClass: "toast-top-right"
        });
        return;
    }
 
    var confirm_model = document.getElementById("deleteFileModal"); 
    if (confirm_model) {
        confirm_model.setAttribute("data-id", fileId);
        confirm_model.setAttribute("data-knowledge_base_id", knowledgeBaseId);
        confirm_model.setAttribute("data-elevenlabs_doc_id", elevenlabsDocId);
        $('#deleteFileModal').modal('show');
    } else {
        console.error("Confirm modal element not found");
        toastr.error("Error deleting file. Please try again.", "Error", {
            positionClass: "toast-top-right"
        });
    }
}
function confirmDeleteFile() {
    const fileId = document.getElementById("deleteFileModal").getAttribute("data-id");
    const knowledgeBaseId = document.getElementById("deleteFileModal").getAttribute("data-knowledge_base_id");
    const elevenlabs_doc_id = document.getElementById("deleteFileModal").getAttribute("data-elevenlabs_doc_id");
    
    
    fetch("{{ host }}/elevenlabs/api/v1/delete_file", {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            knowledge_base_id: knowledgeBaseId,
            file_id: fileId,
            elevenlabs_doc_id: elevenlabs_doc_id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            $('#deleteFileModal').modal('hide');
            toastr.success("File deleted successfully!", "Success", {
                positionClass: "toast-top-right"
            });
            // Refresh the file list
            const knowledgeBase = document.querySelector(`.active_knowldege_base[data-id="${knowledgeBaseId}"]`);
            if (knowledgeBase) {
                const name = knowledgeBase.getAttribute('data-name');
                const files = JSON.parse(knowledgeBase.getAttribute('data-files')).filter(f => f.id != fileId);
                updateKnowledgeBaseDisplay(name, files, knowledgeBaseId);
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            toastr.error("Error deleting file: " + data.message, "Error", {
                positionClass: "toast-top-right" 
            });
        }
    })
    .catch(error => {
        console.error("Error:", error);
        toastr.error("An unexpected error occurred while deleting the file.", "Error", {
            positionClass: "toast-top-right"
        });
    });
}
document.getElementById('uploadMoreFiles').addEventListener('change', function(e) {
    var fileName = e.target.files[0].name; // Get the uploaded file name
    var fileNameElement = document.getElementById('moreFileName'); // File name display element
    var uploadMoreLabel = document.getElementById('uploadMoreLabel'); // Upload label (icon)
    var labelText = uploadMoreLabel.querySelector('.label-text'); // Label text span
  
    // Update the file name element's content and show it
    fileNameElement.textContent = fileName;
    fileNameElement.classList.remove('d-none');
    
    // Hide the label text span
    if (labelText) {
        labelText.classList.add('d-none');
    }

    // Ensure modal stays focusable
    const modal = document.getElementById('AddFilesModel');
    if (modal) {
        modal.removeAttribute('aria-hidden');
    }

    // Enable save button once file is selected
    const saveBtn = document.getElementById('saveMoreFilesBtn');
    if (saveBtn) {
        saveBtn.disabled = false;
    }
});


function saveMoreFiles(e) {
    e.preventDefault();
    const knowledgeBaseInput = document.getElementById("selected-knowledge-base-id");
    const knowledgeBaseId = knowledgeBaseInput ? knowledgeBaseInput.value : "";
    const file = document.getElementById("uploadMoreFiles").files[0];
    const saveBtn = document.getElementById('saveMoreFilesBtn');    
    
    if (!knowledgeBaseId) {
        toastr.error("Please select a knowledge base first.", "Error", {
            positionClass: "toast-top-right"
        });
        return;
    }

    if (!file) {
        toastr.error("Please upload a file.", "Error", {
            positionClass: "toast-top-right"
        });
        return;
    }

    saveBtn.textContent = "Please wait...";
    saveBtn.disabled = true;

    const formData = new FormData();
    formData.append("file", file);
    formData.append("knowledge_base_id", knowledgeBaseId);
    
    fetch("{{ host }}/elevenlabs/api/v1/upload_file", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(JSON.stringify(errorData));
            });
        }
        return response.json();
    })
    .then(data => {
        saveBtn.textContent = "Save";
        saveBtn.disabled = false;
        
        if (data.status === "success") {
            toastr.success("File uploaded successfully!", "Success", {
                positionClass: "toast-top-right"
            });
            
            // Clear form
            document.getElementById('uploadMoreFiles').value = '';
            document.getElementById('moreFileName').textContent = '';
            document.getElementById('moreFileName').classList.add('d-none');
            document.getElementById('uploadMoreLabel').querySelector('.label-text').classList.remove('d-none');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('AddFilesModel'));
            if (modal) {
                modal.hide();
            }
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            toastr.error(data.message || "Error uploading file", "Error", {
                positionClass: "toast-top-right"
            });
        }
    })
    .catch(error => {
        saveBtn.textContent = "Save";
        saveBtn.disabled = false;
        console.error("Error:", error);
        
        try {
            const errorData = JSON.parse(error.message);
            if (errorData.detail && errorData.detail.message) {
                toastr.error(errorData.detail.message, "Error", {
                    positionClass: "toast-top-right"
                });
            } else if (errorData.message) {
                toastr.error(errorData.message, "Error", {
                    positionClass: "toast-top-right"
                });
            } else {
                toastr.error("An unexpected error occurred while uploading the file.", "Error", {
                    positionClass: "toast-top-right"
                });
            }
        } catch (parseError) {
            toastr.error("An unexpected error occurred while uploading the file.", "Error", {
                positionClass: "toast-top-right"
            });
        }
    });
}

function addUrl(e) {
        e.preventDefault();
        const modalEl = document.getElementById("addUrlModal");
        const mode = modalEl ? modalEl.getAttribute("data-mode") || "existing" : "existing";
        const url = document.getElementById("urlInput").value.trim();
        const knowledgeBaseIdInput = document.getElementById("add-url-knowledge-base-id");
        const selectedKnowledgeBaseNameInput = document.getElementById("selected-knowledge-base-name");
        let name = document.getElementById("urlName").value.trim();
        const knowledgeBaseId = knowledgeBaseIdInput ? knowledgeBaseIdInput.value : "";

        if (!url) {
            toastr.error("Please enter a URL.", "Error", {
                positionClass: "toast-top-right"
            });
            return;
        }

        if (mode === "existing") {
            if (!knowledgeBaseId) {
                toastr.error("Please select a knowledge base before adding a URL.", "Error", {
                    positionClass: "toast-top-right"
                });
                return;
            }
            if (selectedKnowledgeBaseNameInput && selectedKnowledgeBaseNameInput.value) {
                name = selectedKnowledgeBaseNameInput.value.trim();
            }
        } else if (!name) {
            toastr.error("Please provide a knowledge base name.", "Error", {
                positionClass: "toast-top-right"
            });
            return;
        }

        // Create and show full screen loader
        const fullScreenLoader = document.createElement('div');
        fullScreenLoader.id = 'fullScreenLoader';
        fullScreenLoader.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;

        const spinnerHTML = `
            <div class="spinner-border" style="
                width: 50px;
                height: 50px;
                border: 5px solid #f3f3f3;
                border-top: 5px solid #3498db;
                border-radius: 50%;
            "></div>
        `;

        fullScreenLoader.innerHTML = spinnerHTML;
        document.body.appendChild(fullScreenLoader);

        fetch("{{ host }}/elevenlabs/api/v1/add_url", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                url: url,
                name: name,
                knowledge_base_id: knowledgeBaseId
            })
        })
        .then(response => response.json())
        .then(data => {
            // Remove loader
            document.getElementById('fullScreenLoader').remove();

            if (data.status === "success") {
                const addUrlModal = document.getElementById("addUrlModal");
                const modalInstance = addUrlModal ? bootstrap.Modal.getInstance(addUrlModal) : null;
                modalInstance?.hide();

                toastr.success(data.message, "Success", {
                    positionClass: "toast-top-right"
                });
                document.getElementById("urlInput").value = "";
                if (mode === "create") {
                    document.getElementById("urlName").value = "";
                }
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(data.message, "Error", {
                    positionClass: "toast-top-right"
                });
            }
        })
        .catch(error => {
            // Remove loader
            document.getElementById('fullScreenLoader').remove();
            
            toastr.error("An unexpected error occurred while adding the URL.", "Error", {
                positionClass: "toast-top-right"
            });
            console.error("Error:", error);
        });
}

function downloadFile(url) {
    if (url.includes('/media/media/')) {
        url = url.replace('/media/media/', '/media/');
    }
    window.open(url, '_blank');
}

function createText(e) {
    e.preventDefault();
    const modalEl = document.getElementById("createTextModal");
    const mode = modalEl ? modalEl.getAttribute("data-mode") || "existing" : "existing";
    const titleInput = document.getElementById("textTitle");
    const contentInput = document.getElementById("textContent");
    const knowledgeBaseIdInput = document.getElementById("add-text-knowledge-base-id");
    const selectedKnowledgeBaseNameInput = document.getElementById("selected-knowledge-base-name");

    const content = contentInput.value;
    let title = titleInput.value.trim();
    const knowledgeBaseId = knowledgeBaseIdInput ? knowledgeBaseIdInput.value : "";

    if (!content) {
        toastr.error("Please enter content.", "Error", {
            positionClass: "toast-top-right"
        });
        return;
    }

    if (mode === "existing") {
        if (!knowledgeBaseId) {
            toastr.error("Please select a knowledge base before adding text.", "Error", {
                positionClass: "toast-top-right"
            });
            return;
        }
        if (selectedKnowledgeBaseNameInput && selectedKnowledgeBaseNameInput.value) {
            title = selectedKnowledgeBaseNameInput.value.trim();
        }
    } else if (!title) {
        toastr.error("Please provide a knowledge base name.", "Error", {
            positionClass: "toast-top-right"
        });
        return;
    }

    // Create and show full screen loader
    const fullScreenLoader = document.createElement('div');
    fullScreenLoader.id = 'fullScreenLoader';
    fullScreenLoader.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;

    const spinnerHTML = `
        <div class="spinner-border" style="
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
        "></div>
    `;

    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(styleSheet);

    fullScreenLoader.innerHTML = spinnerHTML;
    document.body.appendChild(fullScreenLoader);

    fetch("{{ host }}/elevenlabs/api/v1/create_text", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            title: title,
            content: content,
            knowledge_base_id: knowledgeBaseId
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loader
        fullScreenLoader.remove();

        if (data.status === "success") {
            const createTextModal = document.getElementById("createTextModal");
            const modalInstance = createTextModal ? bootstrap.Modal.getInstance(createTextModal) : null;
            modalInstance?.hide();

            toastr.success(data.message, "Success", {
                positionClass: "toast-top-right"
            });

            if (mode === "create" && titleInput) {
                titleInput.value = "";
            }
            if (contentInput) {
                contentInput.value = "";
            }

            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            toastr.error(data.message, "Error", {
                positionClass: "toast-top-right"
            });
        }
    })
    .catch(error => {
        // Remove loader on error
        fullScreenLoader.remove();
        
        toastr.error("An unexpected error occurred while creating the text.", "Error", {
            positionClass: "toast-top-right"    
        });
        console.error("Error:", error);
    });
}

</script>


{% endblock %}