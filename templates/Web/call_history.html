{% extends 'Web/base.html' %}

{% block content %}

<body>

    <div class="wrapper">
        <!-- Sidebar  -->
       {% include 'Web/sidebar.html' %}

        <!-- Page Content  -->
        <div id="content" class="page_content position-relative">
            <div class="agent_page_header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <button type="button"
                        class="sidebarCollapse mobile_hamburger_btn hamburger_btn bg-transparent border-0">
                        <img src="{{ url_for('static', path='Web/images/hamburger-icon.svg') }}" class="img-fluid">
                    </button>
                    <div class="d-flex align-items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 13 13" fill="none">
                            <path d="M6.5 12.875C4.87083 12.875 3.45133 12.335 2.2415 11.255C1.03167 10.1751 0.337972 8.82617 0.160417 7.20833H1.6125C1.77778 8.43611 2.3239 9.45139 3.25087 10.2542C4.17785 11.0569 5.26089 11.4583 6.5 11.4583C7.88125 11.4583 9.05307 10.9774 10.0155 10.0155C10.9778 9.05354 11.4588 7.88172 11.4583 6.5C11.4579 5.11828 10.9769 3.94669 10.0155 2.98525C9.05401 2.02381 7.88219 1.54261 6.5 1.54167C5.68542 1.54167 4.92396 1.73056 4.21562 2.10833C3.50729 2.48611 2.91111 3.00556 2.42708 3.66667H4.375V5.08333H0.125V0.833333H1.54167V2.49792C2.14375 1.74236 2.87876 1.15799 3.74671 0.744792C4.61465 0.331597 5.53242 0.125 6.5 0.125C7.38542 0.125 8.21487 0.293347 8.98837 0.630042C9.76187 0.966736 10.4348 1.42101 11.0071 1.99287C11.5795 2.56474 12.034 3.23765 12.3707 4.01163C12.7074 4.7856 12.8755 5.61506 12.875 6.5C12.8745 7.38494 12.7064 8.2144 12.3707 8.98837C12.0349 9.76235 11.5804 10.4353 11.0071 11.0071C10.4338 11.579 9.76093 12.0335 8.98837 12.3707C8.21582 12.7078 7.38636 12.8759 6.5 12.875ZM8.48333 9.475L5.79167 6.78333V2.95833H7.20833V6.21667L9.475 8.48333L8.48333 9.475Z" fill="#000000"></path>
                        </svg>
                        <h6 class="mb-0">Call History</h6>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="bg-transparent border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <img src="{{ url_for('static', path='Web/images/person-img.svg') }}" class="img-fluid">
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('logout') }}">
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                        class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                                        <path fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                                    </svg>
                                </span>Log Out
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('change_password') }}">
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                        class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                                        <path fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                                    </svg>
                                </span>
                                Change Password
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="agent_table_outer">
                <div class="agent_table">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Voice</th>
                                    <th>Date</th>
                                    <th>Audio</th>
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for audio_recording in audio_recordings %}
                                    <tr data-id="{{ audio_recording.id }}">
                                        <td>{{ audio_recording.agent_name }}</td>
                                        <td>{{ audio_recording.selected_voice }}</td>
                                        <td>{{ audio_recording.created_at }}</td> {# No need to format datetime here #}
                                        <td>
                                            <div class="max-content audio_player">
                                                <audio controls>
                                                    <source src="{{ audio_recording.audio_file }}" type="audio/ogg">
                                                    Your browser does not support the audio element.
                                                </audio>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="max-content">
                                                <button class="delete-btn btn btn-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteModal" 
                                                        data-audio-recording-id="{{ audio_recording.id }}" 
                                                        onclick="event.stopPropagation();">
                                                    <img src="{{ url_for('static', path='Web/images/delete-icon.svg') }}" alt="Delete" class="img-fluid">
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}


                            </tbody>
                            
                        </table>
                    </div>
                    <div class="table_pagination">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-end gap-2 mb-0">
                                {%- if page_obj.has_previous -%}
                                <li class="page-item">
                                    <a class="page-link pagination_arrow" href="{{ url_for('call_history') }}?page={{ page_obj.previous_page_number }}" tabindex="-1" aria-disabled="false">&lt;</a>
                                </li>
                                {%- endif -%}
                                
                                {%- for page in page_obj.page_range -%}
                                <li class="page-item {{ 'active' if page == page_obj.page else '' }}">
                                    <a class="page-link" href="{{ url_for('call_history') }}?page={{ page }}" {% if page == page_obj.page %}aria-current="page"{% endif %}>{{ page }}</a>
                                </li>
                                {%- endfor -%}
                                
                                {%- if page_obj.has_next -%}
                                <li class="page-item">
                                    <a class="page-link pagination_arrow" href="{{ url_for('call_history') }}?page={{ page_obj.next_page_number }}">&gt;</a>
                                </li>
                                {%- endif -%}
                            </ul>
                        </nav>
                    </div>
                    
                </div>
                
            </div>
        </div>
    </div>
</body>



<!-- Modal -->
<div class="modal fade delete_modal" id="deleteModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <h3>Are you sure?</h3>
                    <p>You want to delete this audio recording?</p>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <button type="button" class="btn btn-danger" id="confirm-delete">
                            Delete
                        </button>                      
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
// Add this JavaScript code to your file
document.addEventListener('DOMContentLoaded', function() {
    // Select all delete buttons
    const deleteButtons = document.querySelectorAll('.delete-btn');
    
    // Add click event listener to each delete button
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Get agent ID and name from data attributes
            const audioRecordingId = this.getAttribute('data-audio-recording-id');
            
            // Store the agent ID in the confirm delete button
            document.getElementById('confirm-delete').setAttribute('data-audio-recording-id', audioRecordingId);
        });
    });
});



document.getElementById('confirm-delete').addEventListener('click', function() {
    const audioRecordingId = this.getAttribute('data-audio-recording-id');
    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
    fetch(`/api/delete_audio_recording/?audio_recording_id=${audioRecordingId}`, {
        method: 'DELETE',
        headers: { "X-CSRFToken": '{{ csrf_token }}' }, 
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {

            const rowToRemove = document.querySelector(`tr[data-id="${audioRecordingId}"]`);
            if (rowToRemove) {
                rowToRemove.remove();
            }
            
            
            deleteModal.hide();
            document.querySelector(".modal-backdrop")?.remove();

            toastr.success(data.message, { positionClass: "toast-top-right" });
        } else {
            toastr.error(data.message || "Failed to delete audio recording", { positionClass: "toast-top-right" });
            document.querySelector(".modal-backdrop")?.remove();
            deleteModal.hide();
        }
    })
    .catch(error => {
        toastr.error("An error occurred while deleting the audio recording", { positionClass: "toast-top-right" });
        document.querySelector(".modal-backdrop")?.remove();
        deleteModal.hide();
    });
});
</script>



{% endblock %}  

