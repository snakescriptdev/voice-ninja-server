{% extends 'Web/base.html' %}

{% block content %}

<body>

    <div class="wrapper">
        <!-- Sidebar  -->
       {% include 'Web/sidebar.html' %}

        <!-- Page Content  -->
        <div id="content" class="page_content position-relative">
            <div class="agent_page_header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2" style="flex:1;">
                    <button type="button"
                        class="sidebarCollapse mobile_hamburger_btn hamburger_btn bg-transparent border-0">
                        <img src="{{ host }}/static/Web/images/hamburger-icon.svg" class="img-fluid">
                    </button>
                    <div class="d-flex align-items-center gap-2 w-100">
                        <div class="page_back_arrow d-flex align-items-center justify-content-center">
                            <a href="#" onclick="window.history.back()" class=""><img src="{{ host }}/static/Web/images/left-arrow.svg" class="img-fluid"></a>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 13 13" fill="none">
                            <path d="M6.5 12.875C4.87083 12.875 3.45133 12.335 2.2415 11.255C1.03167 10.1751 0.337972 8.82617 0.160417 7.20833H1.6125C1.77778 8.43611 2.3239 9.45139 3.25087 10.2542C4.17785 11.0569 5.26089 11.4583 6.5 11.4583C7.88125 11.4583 9.05307 10.9774 10.0155 10.0155C10.9778 9.05354 11.4588 7.88172 11.4583 6.5C11.4579 5.11828 10.9769 3.94669 10.0155 2.98525C9.05401 2.02381 7.88219 1.54261 6.5 1.54167C5.68542 1.54167 4.92396 1.73056 4.21562 2.10833C3.50729 2.48611 2.91111 3.00556 2.42708 3.66667H4.375V5.08333H0.125V0.833333H1.54167V2.49792C2.14375 1.74236 2.87876 1.15799 3.74671 0.744792C4.61465 0.331597 5.53242 0.125 6.5 0.125C7.38542 0.125 8.21487 0.293347 8.98837 0.630042C9.76187 0.966736 10.4348 1.42101 11.0071 1.99287C11.5795 2.56474 12.034 3.23765 12.3707 4.01163C12.7074 4.7856 12.8755 5.61506 12.875 6.5C12.8745 7.38494 12.7064 8.2144 12.3707 8.98837C12.0349 9.76235 11.5804 10.4353 11.0071 11.0071C10.4338 11.579 9.76093 12.0335 8.98837 12.3707C8.21582 12.7078 7.38636 12.8759 6.5 12.875ZM8.48333 9.475L5.79167 6.78333V2.95833H7.20833V6.21667L9.475 8.48333L8.48333 9.475Z" fill="#000000"></path>
                        </svg>
                        <h6 class="mb-0">Call History</h6>
                    </div>  
                </div>
                <div class="dropdown">
                    <button class="bg-transparent border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <div class="user-avatar">
                            {{ request.session.get("user").get('name')[0].upper() }}
                        </div>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('logout') }}">
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                        class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                                        <path fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                                    </svg>
                                </span>Log Out
                            </a>
                        </li>
                        <li>
                           <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('change_password') }}">
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" version="1.1">

                                    <g id="layer1">

                                    <path d="M 10 0 C 4.4830748 0 0 4.4830748 0 10 C 0 15.516925 4.4830748 20 10 20 C 10.686108 20 11.353096 19.923761 12 19.791016 L 12 18.767578 C 11.357372 18.916361 10.689085 19 10 19 C 7.7805094 19 5.7554759 18.195439 4.1875 16.867188 L 4.2871094 16.835938 L 5.0878906 16.615234 L 5.9003906 16.427734 L 6.7167969 16.273438 L 6.9472656 16.216797 L 7.1699219 16.123047 L 7.3710938 15.996094 L 7.5507812 15.835938 L 7.7011719 15.652344 L 7.8222656 15.443359 L 7.9101562 15.220703 L 7.9570312 14.986328 L 7.9707031 14.748047 L 7.9433594 14.509766 L 7.8789062 14.279297 L 7.7792969 14.0625 L 7.6484375 13.865234 L 7.4902344 13.644531 L 7.3535156 13.416016 L 7.0742188 12.855469 L 6.8261719 12.279297 L 6.609375 11.693359 L 6.4238281 11.09375 L 6.2734375 10.486328 L 6.1542969 9.8710938 L 6.0683594 9.2519531 L 6.015625 8.6289062 L 6 8.0019531 L 6.0195312 7.609375 L 6.078125 7.2207031 L 6.171875 6.8398438 L 6.3046875 6.4707031 L 6.4726562 6.1152344 L 6.6738281 5.7792969 L 6.9082031 5.4628906 L 7.1699219 5.171875 L 7.4628906 4.9082031 L 7.7773438 4.6738281 L 8.1152344 4.4746094 L 8.4707031 4.3046875 L 8.8398438 4.1738281 L 9.21875 4.078125 L 9.6074219 4.0195312 L 10 4 L 10.392578 4.0195312 L 10.78125 4.078125 L 11.160156 4.1738281 L 11.529297 4.3046875 L 11.886719 4.4746094 L 12.222656 4.6738281 L 12.537109 4.9082031 L 12.830078 5.171875 L 13.091797 5.4628906 L 13.326172 5.7792969 L 13.527344 6.1152344 L 13.695312 6.4707031 L 13.828125 6.8398438 L 13.923828 7.2207031 L 13.982422 7.609375 L 14 8.0019531 L 13.984375 8.6289062 L 13.931641 9.2519531 L 13.845703 9.8710938 L 13.728516 10.486328 L 13.576172 11.09375 L 13.390625 11.693359 L 13.234375 12.117188 C 13.541423 11.400474 14.085761 10.814969 14.757812 10.429688 L 14.833984 10.035156 L 14.925781 9.359375 L 14.982422 8.6816406 L 15 8.0019531 L 14.982422 7.5664062 L 14.923828 7.1328125 L 14.830078 6.7070312 L 14.697266 6.2910156 L 14.53125 5.8886719 L 14.330078 5.5 L 14.097656 5.1328125 L 13.830078 4.7871094 L 13.537109 4.4648438 L 13.212891 4.171875 L 12.869141 3.90625 L 12.5 3.6699219 L 12.113281 3.46875 L 11.710938 3.3027344 L 11.294922 3.1699219 L 10.867188 3.0761719 L 10.435547 3.0195312 L 10 3 L 9.5644531 3.0195312 L 9.1328125 3.0761719 L 8.7050781 3.1699219 L 8.2890625 3.3027344 L 7.8867188 3.46875 L 7.5 3.6699219 L 7.1328125 3.90625 L 6.7871094 4.171875 L 6.4628906 4.4648438 L 6.1699219 4.7871094 L 5.9042969 5.1328125 L 5.6699219 5.5 L 5.46875 5.8886719 L 5.3027344 6.2910156 L 5.1699219 6.7070312 L 5.0761719 7.1328125 L 5.0195312 7.5664062 L 5 8.0019531 L 5.0175781 8.6816406 L 5.0742188 9.359375 L 5.1660156 10.035156 L 5.2949219 10.703125 L 5.4589844 11.361328 L 5.6601562 12.013672 L 5.8984375 12.652344 L 6.1660156 13.275391 L 6.4707031 13.884766 L 6.6523438 14.193359 L 6.8632812 14.484375 L 6.9296875 14.595703 L 6.9648438 14.720703 L 6.96875 14.847656 L 6.9375 14.974609 L 6.875 15.087891 L 6.7871094 15.181641 L 6.6777344 15.25 L 6.5527344 15.287109 L 5.6953125 15.449219 L 4.84375 15.646484 L 4.0019531 15.878906 L 3.375 16.080078 C 1.9045777 14.478558 1 12.349397 1 10 C 1 5.0235149 5.0235149 1 10 1 C 14.976485 1 19 5.0235149 19 10 C 19 10.320097 18.979986 10.634169 18.947266 10.945312 C 19.294443 11.278158 19.578734 11.675211 19.769531 12.123047 C 19.918106 11.438148 20 10.728954 20 10 C 20 4.4830748 15.516925 0 10 0 z M 16.5 11 C 15.12521 11 14 12.12521 14 13.5 L 14 15 L 13 15 L 13 20 L 20 20 L 20 15 L 19 15 L 19 13.5 C 19 12.12521 17.87479 11 16.5 11 z M 16.5 12 C 17.334349 12 18 12.665651 18 13.5 L 18 15 L 15 15 L 15 13.5 C 15 12.665651 15.665651 12 16.5 12 z M 14 16 L 19 16 L 19 19 L 14 19 L 14 16 z " style="fill:#222222; fill-opacity:1; stroke:none; stroke-width:0px;"/>

                                    </g>

                                </svg>
                            </span>
                                Change Password
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="agent_table_outer">
                <div class="agent_table">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Voice</th>
                                    <th>Date</th>
                                    <th>Audio</th>
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody style="overflow-y: hidden;">
                                {% for audio_recording in page_obj.items %}
                                    <tr data-id="{{ audio_recording.id }}" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                                        <td class="clickable-cell">{{ agent_name }}</td>
                                        <td class="clickable-cell">{{ selected_voice }}</td>
                                        <td class="clickable-cell">{{ audio_recording.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td> 
                                        <td class="clickable-cell">
                                            <div class="max-content audio_player">
                                                {% if audio_recording.audio_file %}
                                                    <audio controls onclick="event.stopPropagation();">
                                                        <source src="{{ audio_recording.audio_file }}" type="audio/ogg">
                                                        Your browser does not support the audio element.
                                                    </audio>
                                                {% else %}
                                                    <span class="text-muted">No audio available</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="max-content">
                                                <button class="delete-btn btn btn-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteModal" 
                                                        data-audio-recording-id="{{ audio_recording.id }}" 
                                                        onclick="event.stopPropagation();"
                                                        aria-label="Delete audio recording {{ audio_recording.id }}">
                                                    <img src="{{ host }}/static/Web/images/delete-icon.svg" 
                                                        alt="Delete" 
                                                        class="img-fluid">
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No audio recordings found.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>

                            
                        </table>
                    </div>
                    <div class="table_pagination">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-end gap-2 mb-0">
                                {%- if page_obj.has_previous -%}
                                <li class="page-item">
                                    <a class="page-link pagination_arrow" href="{{ host }}/call_history?agent_id={{ agent_id }}&page={{ page_obj.previous_page_number }}" tabindex="-1" aria-disabled="false">&lt;</a>
                                </li>
                                {%- endif -%}
                                
                                {%- for page in page_obj.page_range -%}
                                <li class="page-item {{ 'active' if page == page_obj.page else '' }}">
                                    <a class="page-link" href="{{ host }}/call_history?agent_id={{ agent_id }}&page={{ page }}" {% if page == page_obj.page %}aria-current="page"{% endif %}>{{ page }}</a>
                                </li>
                                {%- endfor -%}
                                
                                {%- if page_obj.has_next -%}
                                <li class="page-item">
                                    <a class="page-link pagination_arrow" href="{{ host }}/call_history?agent_id={{ agent_id }}&page={{ page_obj.next_page_number }}">&gt;</a>
                                </li>
                                {%- endif -%}
                            </ul>
                        </nav>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</body>


<!-- Modal -->
<div class="modal fade delete_modal" id="deleteModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <h3>Are you sure?</h3>
                    <p>You want to delete this audio recording?</p>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <button type="button" class="btn btn-danger" id="confirm-delete">
                            Delete
                        </button>                      
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- offcanvas for call history detail -->
<div class="offcanvas offcanvas-end call_history_offcanvas" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title" id="offcanvasRightLabel">Call Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="call_details mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Overview</h6>
          <audio controls class="w-100 mb-3" id="audioPlayer">
            <source id="audioSource" src="" type="audio/wav">
            Your browser does not support the audio element.
          </audio>
          <h6 class="text-muted">Call Summary</h6>
          <p id="callSummary"></p>
          
          <div class="row mt-3">
            <div class="col-6">
              <p class="text-muted mb-1">Call Duration</p>
              <p class="fw-medium" id="callDuration"></p>
            </div>
            <div class="col-6">
              <p class="text-muted mb-1">Call Date</p>
              <p class="fw-medium" id="callDate"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="collected_variables mb-4">
      <h6 class="mb-3">Client Data</h6>
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Language</h6>
          <p class="fw-medium">ðŸ‡ºðŸ‡¸ English</p>
        </div>
      </div>
      
      <h6 class="mt-3">Dynamic Variables</h6>
      <div id="dynamicVariables">
        <!-- Dynamic variables will be inserted here -->
      </div>
    </div>

    <div class="conversation_history">
      <h6 class="mb-3">Conversation Transcript</h6>
      <div id="transcriptContainer">
        <!-- Transcript messages will be inserted here -->
      </div>
    </div>
  </div>
</div>


<script>
const host = "{{ host }}";  
// Add this JavaScript code to your file
document.addEventListener('DOMContentLoaded', function() {
    // Handle clickable cells for opening offcanvas (excluding delete button area)
    const clickableCells = document.querySelectorAll('.clickable-cell');
    clickableCells.forEach(cell => {
        cell.addEventListener('click', function(event) {
            // Don't trigger if clicking on audio controls
            if (event.target.tagName === 'AUDIO') {
                return;
            }
            const row = this.parentElement;
            openOffcanvas(row);
        });
        
        // Add cursor pointer style to indicate clickable
        cell.style.cursor = 'pointer';
    });
    
    // Select all delete buttons
    const deleteButtons = document.querySelectorAll('.delete-btn');
    
    // Add click event listener to each delete button
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            // Get audio recording ID from data attributes
            const audioRecordingId = this.getAttribute('data-audio-recording-id');
            
            // Store the audio recording ID in the confirm delete button
            document.getElementById('confirm-delete').setAttribute('data-audio-recording-id', audioRecordingId);
        });
    });
});



document.getElementById('confirm-delete').addEventListener('click', function() {
    const audioRecordingId = this.getAttribute('data-audio-recording-id');
    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
    fetch(`${host}/elevenlabs/api/v1/delete_audio_recording/?audio_recording_id=${audioRecordingId}`, {
        method: 'DELETE',
        headers: { "X-CSRFToken": '{{ csrf_token }}' }, 
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {

            const rowToRemove = document.querySelector(`tr[data-id="${audioRecordingId}"]`);
            if (rowToRemove) {
                rowToRemove.remove();
            }
            
            
            deleteModal.hide();
            document.querySelector(".modal-backdrop")?.remove();

            toastr.success(data.message, { positionClass: "toast-top-right" });
        } else {
            toastr.error(data.message || "Failed to delete audio recording", { positionClass: "toast-top-right" });
            document.querySelector(".modal-backdrop")?.remove();
            deleteModal.hide();
        }
    })
    .catch(error => {
        toastr.error("An error occurred while deleting the audio recording", { positionClass: "toast-top-right" });
        document.querySelector(".modal-backdrop")?.remove();
        deleteModal.hide();
    });
});


// Define openOffcanvas function in global scope
window.openOffcanvas = function(element) {
    const call_id = element.getAttribute('data-id');
    
    // Create and show full screen loader
    const fullScreenLoader = document.createElement('div');
    fullScreenLoader.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    fullScreenLoader.innerHTML = `
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    `;
    document.body.appendChild(fullScreenLoader);

    fetch(`${host}/elevenlabs/api/v1/call_details`, {
        method: 'POST',
        headers: { 
            "X-CSRFToken": '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            call_id: call_id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            try {
                console.log("Call details received:", data); // Debug log
                console.log("Dynamic variables:", data.dynamic_variable); // Debug log
                console.log("Transcript:", data.transcript); // Debug log
                
                // Format timestamp
                const createdAt = new Date(data.call.created_at);
                const formattedDate = createdAt.toLocaleString();

                // Prepare content before showing offcanvas
                const callDetailsSection = document.querySelector('.call_details');
                const conversationSection = document.querySelector('.conversation_history');
                const dynamicVariablesContainer = document.getElementById('dynamicVariables');

                // Update call details section
                callDetailsSection.innerHTML = `
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Overview</h6>
                            <audio controls class="w-100 mb-3" id="audioPlayer">
                                <source src="${data.call.audio_file}" type="audio/wav">
                                Your browser does not support the audio element.
                            </audio>
                            <div id="durationScript"></div>
                            <h6 class="text-muted">Call Summary</h6>
                            <p>${data.summary || 'No summary available'}</p>
                            
                            <div class="row mt-3">
                                <div class="col-6">
                                    <p class="text-muted mb-1">Duration:</p>
                                    <p class="fw-medium"><span id="audioDuration">0:00</span></p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted mb-1">Call Date</p>
                                    <p class="fw-medium">${formattedDate}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add duration script after HTML is set
                const durationScript = document.createElement('script');
                durationScript.textContent = `
                    document.getElementById('audioPlayer').addEventListener('loadedmetadata', function() {
                        const duration = this.duration;
                        const minutes = Math.floor(duration / 60);
                        const seconds = Math.floor(duration % 60);
                        document.getElementById('audioDuration').textContent = 
                            minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                    });
                `;
                document.getElementById('durationScript').appendChild(durationScript);

                const dynamic_variable = data.dynamic_variable || {};
                dynamicVariablesContainer.innerHTML = '';

                console.log("Processing dynamic variables:", dynamic_variable); // Debug log

                // Only show essential call information: start time, end time, conversation ID
                const visibleVariables = Object.entries(dynamic_variable).filter(([key, value]) => {
                    const keyLower = key.toLowerCase();
                    return keyLower.includes('conversation id') || 
                           keyLower.includes('start time') || 
                           keyLower.includes('end time') ||
                           (keyLower.includes('start') && keyLower.includes('time')) ||
                           (keyLower.includes('end') && keyLower.includes('time'));
                });

                if (visibleVariables.length === 0) {
                    dynamicVariablesContainer.innerHTML = `
                        <div class="card shadow-sm">
                            <div class="card-body text-center text-muted">
                                <p class="mb-0">No additional data collected during this call</p>
                            </div>
                        </div>
                    `;
                } else {
                    for (const [key, value] of visibleVariables) {
                        console.log(`Processing variable: ${key} = ${value}`); // Debug log
                        
                        const variableItem = document.createElement('div');
                        variableItem.classList.add('card', 'mb-2', 'shadow-sm');
                        
                        // Handle different value types
                        let displayValue = value;
                        if (typeof value === 'object' && value !== null) {
                            displayValue = JSON.stringify(value);
                        } else if (typeof value !== 'string') {
                            displayValue = String(value);
                        }
                        
                        variableItem.innerHTML = `
                            <div class="card-body">
                                <p class="text-muted mb-1">${key}</p>
                                <p class="fw-medium">${displayValue}</p>
                            </div>
                        `;
                        dynamicVariablesContainer.appendChild(variableItem);
                    }
                }

                // Update conversation history section
                conversationSection.innerHTML = `
                    <h6 class="mb-3">Conversation Transcript</h6>
                    <div class="conversation_history_item mb-3 p-3 rounded">
                        ${data.transcript && Array.isArray(data.transcript) ? data.transcript.map(msg => `
                            <div class="d-flex mb-3 ${msg.role === 'assistant' ? 'justify-content-start' : 'justify-content-end'}">
                                <div class="p-3 rounded ${msg.role === 'assistant' ? 'bg-light' : 'bg-primary text-white'}" style="max-width: 75%;">
                                    <p class="mb-1 small ${msg.role === 'assistant' ? 'text-muted' : 'text-white'}">${msg.role === 'assistant' ? 'Assistant' : 'User'}</p>
                                    <p class="mb-0">${typeof msg.content === 'string' ? msg.content : (typeof msg.content === 'object' ? JSON.stringify(msg.content) : String(msg.content))}</p>
                                </div>
                            </div>
                        `).join('') : 'No transcript available'}
                    </div>
                `;

                // Remove loader and show offcanvas
                fullScreenLoader.remove();
                const offcanvas = new bootstrap.Offcanvas(document.getElementById('offcanvasRight'));
                
                // Add event listener for when offcanvas is hidden
                document.getElementById('offcanvasRight').addEventListener('hidden.bs.offcanvas', function () {
                    // Remove backdrop
                    document.querySelector('.offcanvas-backdrop')?.remove();
                });

                offcanvas.show();

            } catch (error) {
                console.error('Error updating content:', error);
                fullScreenLoader.remove();
                toastr.error("Error displaying call details", { positionClass: "toast-top-right" });
            }
        } else {
            fullScreenLoader.remove();
            toastr.error("Failed to fetch call details", { positionClass: "toast-top-right" });
        }
    })
    .catch(error => {
        console.error('Error fetching call details:', error);
        fullScreenLoader.remove();
        toastr.error("Error fetching call details", { positionClass: "toast-top-right" });
    });
};
</script>



{% endblock %}  

