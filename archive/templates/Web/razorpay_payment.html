{% extends 'Web/base.html' %}

{% block title %}
    <title>Payment</title>
{% endblock %}

{% block content %}

<div class="wrapper">
    {% include 'Web/sidebar.html' %}

     <div id="content" class="page_content">
        <div class="agent_page_header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <button type="button"
                    class="sidebarCollapse mobile_hamburger_btn hamburger_btn bg-transparent border-0">
                    <img src="{{ host }}/static/Web/images/hamburger-icon.svg" class="img-fluid">
                </button>
            </div>
            <div class="dropdown">
                <button class="bg-transparent border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <div class="user-avatar">
                        {{ request.session.get("user").get('name')[0].upper() }}
                    </div>
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" href="{{ host }}/logout">
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                    class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                                    <path fill-rule="evenodd"
                                        d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                                </svg>
                            </span>Log Out
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" href="{{ host }}/change-password">
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" version="1.1">

                                    <g id="layer1">

                                    <path d="M 10 0 C 4.4830748 0 0 4.4830748 0 10 C 0 15.516925 4.4830748 20 10 20 C 10.686108 20 11.353096 19.923761 12 19.791016 L 12 18.767578 C 11.357372 18.916361 10.689085 19 10 19 C 7.7805094 19 5.7554759 18.195439 4.1875 16.867188 L 4.2871094 16.835938 L 5.0878906 16.615234 L 5.9003906 16.427734 L 6.7167969 16.273438 L 6.9472656 16.216797 L 7.1699219 16.123047 L 7.3710938 15.996094 L 7.5507812 15.835938 L 7.7011719 15.652344 L 7.8222656 15.443359 L 7.9101562 15.220703 L 7.9570312 14.986328 L 7.9707031 14.748047 L 7.9433594 14.509766 L 7.8789062 14.279297 L 7.7792969 14.0625 L 7.6484375 13.865234 L 7.4902344 13.644531 L 7.3535156 13.416016 L 7.0742188 12.855469 L 6.8261719 12.279297 L 6.609375 11.693359 L 6.4238281 11.09375 L 6.2734375 10.486328 L 6.1542969 9.8710938 L 6.0683594 9.2519531 L 6.015625 8.6289062 L 6 8.0019531 L 6.0195312 7.609375 L 6.078125 7.2207031 L 6.171875 6.8398438 L 6.3046875 6.4707031 L 6.4726562 6.1152344 L 6.6738281 5.7792969 L 6.9082031 5.4628906 L 7.1699219 5.171875 L 7.4628906 4.9082031 L 7.7773438 4.6738281 L 8.1152344 4.4746094 L 8.4707031 4.3046875 L 8.8398438 4.1738281 L 9.21875 4.078125 L 9.6074219 4.0195312 L 10 4 L 10.392578 4.0195312 L 10.78125 4.078125 L 11.160156 4.1738281 L 11.529297 4.3046875 L 11.886719 4.4746094 L 12.222656 4.6738281 L 12.537109 4.9082031 L 12.830078 5.171875 L 13.091797 5.4628906 L 13.326172 5.7792969 L 13.527344 6.1152344 L 13.695312 6.4707031 L 13.828125 6.8398438 L 13.923828 7.2207031 L 13.982422 7.609375 L 14 8.0019531 L 13.984375 8.6289062 L 13.931641 9.2519531 L 13.845703 9.8710938 L 13.728516 10.486328 L 13.576172 11.09375 L 13.390625 11.693359 L 13.234375 12.117188 C 13.541423 11.400474 14.085761 10.814969 14.757812 10.429688 L 14.833984 10.035156 L 14.925781 9.359375 L 14.982422 8.6816406 L 15 8.0019531 L 14.982422 7.5664062 L 14.923828 7.1328125 L 14.830078 6.7070312 L 14.697266 6.2910156 L 14.53125 5.8886719 L 14.330078 5.5 L 14.097656 5.1328125 L 13.830078 4.7871094 L 13.537109 4.4648438 L 13.212891 4.171875 L 12.869141 3.90625 L 12.5 3.6699219 L 12.113281 3.46875 L 11.710938 3.3027344 L 11.294922 3.1699219 L 10.867188 3.0761719 L 10.435547 3.0195312 L 10 3 L 9.5644531 3.0195312 L 9.1328125 3.0761719 L 8.7050781 3.1699219 L 8.2890625 3.3027344 L 7.8867188 3.46875 L 7.5 3.6699219 L 7.1328125 3.90625 L 6.7871094 4.171875 L 6.4628906 4.4648438 L 6.1699219 4.7871094 L 5.9042969 5.1328125 L 5.6699219 5.5 L 5.46875 5.8886719 L 5.3027344 6.2910156 L 5.1699219 6.7070312 L 5.0761719 7.1328125 L 5.0195312 7.5664062 L 5 8.0019531 L 5.0175781 8.6816406 L 5.0742188 9.359375 L 5.1660156 10.035156 L 5.2949219 10.703125 L 5.4589844 11.361328 L 5.6601562 12.013672 L 5.8984375 12.652344 L 6.1660156 13.275391 L 6.4707031 13.884766 L 6.6523438 14.193359 L 6.8632812 14.484375 L 6.9296875 14.595703 L 6.9648438 14.720703 L 6.96875 14.847656 L 6.9375 14.974609 L 6.875 15.087891 L 6.7871094 15.181641 L 6.6777344 15.25 L 6.5527344 15.287109 L 5.6953125 15.449219 L 4.84375 15.646484 L 4.0019531 15.878906 L 3.375 16.080078 C 1.9045777 14.478558 1 12.349397 1 10 C 1 5.0235149 5.0235149 1 10 1 C 14.976485 1 19 5.0235149 19 10 C 19 10.320097 18.979986 10.634169 18.947266 10.945312 C 19.294443 11.278158 19.578734 11.675211 19.769531 12.123047 C 19.918106 11.438148 20 10.728954 20 10 C 20 4.4830748 15.516925 0 10 0 z M 16.5 11 C 15.12521 11 14 12.12521 14 13.5 L 14 15 L 13 15 L 13 20 L 20 20 L 20 15 L 19 15 L 19 13.5 C 19 12.12521 17.87479 11 16.5 11 z M 16.5 12 C 17.334349 12 18 12.665651 18 13.5 L 18 15 L 15 15 L 15 13.5 C 15 12.665651 15.665651 12 16.5 12 z M 14 16 L 19 16 L 19 19 L 14 19 L 14 16 z " style="fill:#222222; fill-opacity:1; stroke:none; stroke-width:0px;"/>

                                    </g>

                                </svg>
                            </span>
                            Change Password
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-md-6 mx-auto">
            <form id="payment-form" class="payment_enter_box mb-4">
                <div class="mb-2">
                <label class="form-label">Amount (INR)</label>
                <input 
                    type="number" 
                    class="form-control" 
                    id="amount-input" 
                    name="amount" 
                    placeholder="Amount (Minimum INR 1)"
                    min="1" 
                    step="1"
                    onkeydown="return event.key !== 'e' && event.key !== '.'" 
                    required>                    
            </div>
            
            <div class="mb-3 received_coins">
                <p>You will receive <span id="coins-received">0</span> coins</p>
            </div>
            <div class="pay_now_btn text-center">
                <button type="submit" id="rzp-button">Pay with Razorpay</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    let host = "{{ host }}";
    const amountInput = document.getElementById('amount-input');
    const coinsReceived = document.getElementById('coins-received');
    
    amountInput.addEventListener('input', function() {

        let amount = parseInt(amountInput.value, 10);
    
        if (!isNaN(amount) && amount >= 1) {
            coinsReceived.textContent = amount;
        } else {

            coinsReceived.textContent = '0';
        }
    });
    
    amountInput.addEventListener('keypress', function(event) {
        const invalidChars = ['e', 'E', '+', '-', '.'];
        if (invalidChars.includes(event.key)) {
            event.preventDefault();
        }
    });
    
    // Razorpay integration
    document.getElementById('payment-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const amount = document.getElementById('amount-input').value;
        
        if (!amount || parseInt(amount) < 1) {
            toastr.error('Please enter a valid amount (minimum INR 1)', "Error", {
                "positionClass": "toast-top-right"
            });
            return;
        }
        
        try {
            const response = await fetch("{{ host }}/api/razorpay_payment", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ amount: amount })
            });
            
            const data = await response.json();
            
            if (data.status !== 'success') {
                throw new Error(data.message || 'Failed to create order');
                toastr.error(data.message || 'Failed to create order', "Error", {
                    "positionClass": "toast-top-right"
                });
                return;
            }
            
            const orderData = data.data;
            
            const options = {
                key: orderData.razorpay_key_id,
                amount: orderData.amount,
                currency: orderData.currency,
                name: orderData.name,
                description: orderData.description,
                order_id: orderData.razorpay_order_id,
                handler: function (response) {
                    document.location.href = host + `/api/razorpay_callback?razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}&razorpay_signature=${response.razorpay_signature}`;
                },
                prefill: {
                    email: orderData.email,
                },
                theme: {
                    color: "#3399cc"
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
            
        } catch (error) {
            console.error('Payment error:', error);
            toastr.error('Payment initialization failed: ' + error.message, "Error", {
                "positionClass": "toast-top-right"
            });
        }
    });
</script>

<script type="text/javascript">
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == "error" %}
                toastr.error("{{ message }}", "Error", {
                    "positionClass": "toast-top-right"
                });
            {% elif message.tags == "success" %}
                toastr.success("{{ message }}", "Success", {
                    "positionClass": "toast-top-right"
                });
            {% else %}
                toastr.info("{{ message }}", "Info", {
                    "positionClass": "toast-top-right"
                });
            {% endif %}
        {% endfor %}
    {% endif %}
</script>

{% endblock %}