
{% extends 'Web/base.html' %}

{% block title %}
    <title>Dashboard</title>
{% endblock %}

{% block content %}

<body>

    <div class="wrapper">
        <!-- Sidebar  -->
       {% include 'Web/sidebar.html' %}

        <!-- Page Content  -->
        <div id="content" class="page_content position-relative">
            <div class="agent_page_header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <button type="button"
                        class="sidebarCollapse mobile_hamburger_btn hamburger_btn bg-transparent border-0">
                        <img src="{{ host }}/static/Web/images/hamburger-icon.svg" class="img-fluid">
                    </button>
                    <div class="d-flex align-items-center gap-2">
                        <img src="{{ host }}/static/Web/images/agent-icon.svg" class="img-fluid">
                        <h6 class="mb-0">Agents</h6>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="bg-transparent border-0 dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <div class="user-avatar">
                            {{ request.session.get("user").get('name')[0].upper() }}
                        </div>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('logout') }}">
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black"
                                        class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                                        <path fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                                    </svg>
                                </span>Log Out
                            </a>
                        </li>
                        <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('change_password') }}">
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20" version="1.1">

                                    <g id="layer1">

                                    <path d="M 10 0 C 4.4830748 0 0 4.4830748 0 10 C 0 15.516925 4.4830748 20 10 20 C 10.686108 20 11.353096 19.923761 12 19.791016 L 12 18.767578 C 11.357372 18.916361 10.689085 19 10 19 C 7.7805094 19 5.7554759 18.195439 4.1875 16.867188 L 4.2871094 16.835938 L 5.0878906 16.615234 L 5.9003906 16.427734 L 6.7167969 16.273438 L 6.9472656 16.216797 L 7.1699219 16.123047 L 7.3710938 15.996094 L 7.5507812 15.835938 L 7.7011719 15.652344 L 7.8222656 15.443359 L 7.9101562 15.220703 L 7.9570312 14.986328 L 7.9707031 14.748047 L 7.9433594 14.509766 L 7.8789062 14.279297 L 7.7792969 14.0625 L 7.6484375 13.865234 L 7.4902344 13.644531 L 7.3535156 13.416016 L 7.0742188 12.855469 L 6.8261719 12.279297 L 6.609375 11.693359 L 6.4238281 11.09375 L 6.2734375 10.486328 L 6.1542969 9.8710938 L 6.0683594 9.2519531 L 6.015625 8.6289062 L 6 8.0019531 L 6.0195312 7.609375 L 6.078125 7.2207031 L 6.171875 6.8398438 L 6.3046875 6.4707031 L 6.4726562 6.1152344 L 6.6738281 5.7792969 L 6.9082031 5.4628906 L 7.1699219 5.171875 L 7.4628906 4.9082031 L 7.7773438 4.6738281 L 8.1152344 4.4746094 L 8.4707031 4.3046875 L 8.8398438 4.1738281 L 9.21875 4.078125 L 9.6074219 4.0195312 L 10 4 L 10.392578 4.0195312 L 10.78125 4.078125 L 11.160156 4.1738281 L 11.529297 4.3046875 L 11.886719 4.4746094 L 12.222656 4.6738281 L 12.537109 4.9082031 L 12.830078 5.171875 L 13.091797 5.4628906 L 13.326172 5.7792969 L 13.527344 6.1152344 L 13.695312 6.4707031 L 13.828125 6.8398438 L 13.923828 7.2207031 L 13.982422 7.609375 L 14 8.0019531 L 13.984375 8.6289062 L 13.931641 9.2519531 L 13.845703 9.8710938 L 13.728516 10.486328 L 13.576172 11.09375 L 13.390625 11.693359 L 13.234375 12.117188 C 13.541423 11.400474 14.085761 10.814969 14.757812 10.429688 L 14.833984 10.035156 L 14.925781 9.359375 L 14.982422 8.6816406 L 15 8.0019531 L 14.982422 7.5664062 L 14.923828 7.1328125 L 14.830078 6.7070312 L 14.697266 6.2910156 L 14.53125 5.8886719 L 14.330078 5.5 L 14.097656 5.1328125 L 13.830078 4.7871094 L 13.537109 4.4648438 L 13.212891 4.171875 L 12.869141 3.90625 L 12.5 3.6699219 L 12.113281 3.46875 L 11.710938 3.3027344 L 11.294922 3.1699219 L 10.867188 3.0761719 L 10.435547 3.0195312 L 10 3 L 9.5644531 3.0195312 L 9.1328125 3.0761719 L 8.7050781 3.1699219 L 8.2890625 3.3027344 L 7.8867188 3.46875 L 7.5 3.6699219 L 7.1328125 3.90625 L 6.7871094 4.171875 L 6.4628906 4.4648438 L 6.1699219 4.7871094 L 5.9042969 5.1328125 L 5.6699219 5.5 L 5.46875 5.8886719 L 5.3027344 6.2910156 L 5.1699219 6.7070312 L 5.0761719 7.1328125 L 5.0195312 7.5664062 L 5 8.0019531 L 5.0175781 8.6816406 L 5.0742188 9.359375 L 5.1660156 10.035156 L 5.2949219 10.703125 L 5.4589844 11.361328 L 5.6601562 12.013672 L 5.8984375 12.652344 L 6.1660156 13.275391 L 6.4707031 13.884766 L 6.6523438 14.193359 L 6.8632812 14.484375 L 6.9296875 14.595703 L 6.9648438 14.720703 L 6.96875 14.847656 L 6.9375 14.974609 L 6.875 15.087891 L 6.7871094 15.181641 L 6.6777344 15.25 L 6.5527344 15.287109 L 5.6953125 15.449219 L 4.84375 15.646484 L 4.0019531 15.878906 L 3.375 16.080078 C 1.9045777 14.478558 1 12.349397 1 10 C 1 5.0235149 5.0235149 1 10 1 C 14.976485 1 19 5.0235149 19 10 C 19 10.320097 18.979986 10.634169 18.947266 10.945312 C 19.294443 11.278158 19.578734 11.675211 19.769531 12.123047 C 19.918106 11.438148 20 10.728954 20 10 C 20 4.4830748 15.516925 0 10 0 z M 16.5 11 C 15.12521 11 14 12.12521 14 13.5 L 14 15 L 13 15 L 13 20 L 20 20 L 20 15 L 19 15 L 19 13.5 C 19 12.12521 17.87479 11 16.5 11 z M 16.5 12 C 17.334349 12 18 12.665651 18 13.5 L 18 15 L 15 15 L 15 13.5 C 15 12.665651 15.665651 12 16.5 12 z M 14 16 L 19 16 L 19 19 L 14 19 L 14 16 z " style="fill:#222222; fill-opacity:1; stroke:none; stroke-width:0px;"/>

                                    </g>

                                </svg>
                            </span>
                                Change Password
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="table_filters pt-0 d-flex justify-content-between align-items-center gap-2">
                <form class="table_search_box position-relative" method="get" action="{{ host }}/dashboard" id="searchForm">
                    <input type="text"
                           class="form-control"
                           id="searchInput"
                           placeholder="Search agents, models, voices or numbers"
                           name="search"
                           value="">
                    <button type="button" class="clear_search_icon bg-transparent border-0 p-0 d-none" id="clearSearchBtn" aria-label="Clear search" style="position: absolute; right: 40px; top: 50%; transform: translateY(-50%); cursor: pointer; z-index: 10;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                        </svg>
                    </button>
                    <button type="submit" class="search_icon bg-transparent border-0 p-0" aria-label="Search">
                        <img src="{{ host }}/static/Web/images/search-icon.svg" class="img-fluid">
                    </button>
                </form>
                <div class="dropdown filter_dropdown">
                    <a href="{{ host }}/elevenlabs/web/v1/create_agent" class="create_agent_btn"> 
                        Create an Agent
                    </a>
                </div>
            </div>
            <div class="agent_table_outer">
                <div class="agent_table">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Agent Name</th>
                                    <th>Model</th>
                                    <th>Voice</th>
                                    <th>Phone</th>
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody id="agentsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading agents...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table_pagination">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-end gap-2 mb-0" id="paginationContainer">
                                <!-- Pagination will be dynamically generated -->
                            </ul>
                        </nav>
                    </div>
                    
                </div>
                
            </div>
        </div>
    </div>
</body>



<!-- Modal -->
<div class="modal fade delete_modal" id="deleteModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <h3>Are you sure?</h3>
                    <p>You want to delete <strong id="modal-agent-name"></strong>?</p>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <button type="button" class="btn btn-danger" id="confirm-delete">
                            Delete
                        </button>                      
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Function to fetch LLM model names by IDs
async function fetchLLMNames(ids) {
    if (!ids || ids.length === 0) return {};
    
    try {
        const res = await fetch(`/elevenlabs/api/v1/llm_models?ids=${ids.join(',')}`);
        if (res.ok) {
            const data = await res.json();
            return (data && data.models) || {};
        }
    } catch (e) {
        console.error("Error fetching LLM names:", e);
    }
    return {};
}





    let host = "{{ host }}";

// Debounce function implementation with cancel support
function debounce(func, wait) {
    let timeout;
    const debounced = function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
    
    // Add cancel method to clear pending timeout
    debounced.cancel = function() {
        clearTimeout(timeout);
    };
    
    return debounced;
}

// Function to render agent row
function renderAgentRow(agent, llmNameMap) {
    const llmId = agent.selected_llm_model || '';
    const modelName = agent.llm_name || agent.model_name || agent.selected_model || '-';
    const displayModel = llmId && llmNameMap[llmId] ? llmNameMap[llmId] : modelName;
    
    return `
        <tr onclick="window.location.href='/elevenlabs/web/v1/update_agent?agent_id=${agent.id}'" style="cursor: pointer;">
            <td>
                <div class="d-flex align-items-center justify-content-center gap-2 agent_name_data">
                    <span>
                        ${agent.agent_name ? `<img src="${host}/static/Web/images/lucide_bot.svg" class="img-fluid">` : ''}
                    </span>
                    ${agent.agent_name || ''}
                </div>
            </td>
            <td>
                <div class="max-content" data-llm-id="${llmId}" data-selected-model="${agent.selected_model || ''}">
                    ${displayModel}
                </div>
            </td>
            <td>
                <div class="d-flex align-items-center justify-content-center gap-1 max-content">
                    <span>
                        ${agent.has_voice ? `<img src="${host}/static/Web/images/voice-icon.svg" class="img-fluid">` : ''}
                    </span>
                    ${agent.voice_name || ''}
                </div>
            </td>
            <td>
                <div class="max-content">
                    ${agent.phone_number || '-'}
                </div>
            </td>
            <td>
                <div class="max-content">
                    ${agent.id ? `
                        <button class="delete-btn btn btn-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteModal" 
                                data-agent-id="${agent.id}" 
                                data-agent-name="${agent.agent_name || ''}"
                                onclick="event.stopPropagation();">
                            <img src="${host}/static/Web/images/delete-icon.svg" alt="Delete" class="img-fluid">
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `;
}

// Function to render pagination
function renderPagination(paginationData, searchQuery) {
    const container = document.querySelector('#paginationContainer');
    if (!container) return;
    
    let html = '';
    
    // Previous button
    if (paginationData.has_previous) {
        html += `
            <li class="page-item">
                <a class="page-link pagination_arrow" href="#" data-page="${paginationData.previous_page}" tabindex="-1">&lt;</a>
            </li>
        `;
    }
    
    // Page numbers
    paginationData.page_range.forEach(pageNum => {
        const isActive = pageNum === paginationData.page;
        html += `
            <li class="page-item ${isActive ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${pageNum}" ${isActive ? 'aria-current="page"' : ''}>${pageNum}</a>
            </li>
        `;
    });
    
    // Next button
    if (paginationData.has_next) {
        html += `
            <li class="page-item">
                <a class="page-link pagination_arrow" href="#" data-page="${paginationData.next_page}">&gt;</a>
            </li>
        `;
    }
    
    container.innerHTML = html;
}

// Function to fetch dashboard data from API
async function fetchDashboardData(searchQuery = "", page = 1) {
    try {
        const tableBody = document.querySelector('#agentsTableBody');
        if (!tableBody) return;
        
        // Show loading state
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Loading agents...
                </td>
            </tr>
        `;
        
        // Build API URL
        const url = new URL(`${host}/api/dashboard/search`, window.location.origin);
        url.searchParams.set("page", page.toString());
        if (searchQuery && searchQuery.trim()) {
            url.searchParams.set("search", searchQuery.trim());
        }

        const response = await fetch(url.toString());
        if (!response.ok) {
            throw new Error('Failed to fetch dashboard data');
        }

        const data = await response.json();
        
        // Collect all LLM IDs for batch fetching
        const llmIds = [...new Set(data.results.map(agent => agent.selected_llm_model).filter(Boolean))];
        const llmNameMap = await fetchLLMNames(llmIds);
        
        // Render agent rows
        if (data.results && data.results.length > 0) {
            tableBody.innerHTML = data.results.map(agent => renderAgentRow(agent, llmNameMap)).join('');
        } else {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">No agents found</td>
                </tr>
            `;
        }
        
        // Update LLM model names in rendered rows
        const cells = Array.from(document.querySelectorAll('[data-llm-id]'));
        cells.forEach(cell => {
            const llmId = cell.getAttribute('data-llm-id');
            const fallback = cell.getAttribute('data-selected-model');
            if (llmId && llmNameMap[llmId]) {
                cell.textContent = llmNameMap[llmId];
            } else if (fallback) {
                cell.textContent = fallback;
            } else if (llmId) {
                cell.textContent = `ID ${llmId}`;
            } else {
                cell.textContent = '-';
            }
        });
        
        // Render pagination
        renderPagination({
            page: data.page,
            total_pages: data.total_pages,
            has_previous: data.has_previous,
            has_next: data.has_next,
            previous_page: data.previous_page,
            next_page: data.next_page,
            page_range: data.page_range
        }, searchQuery);
        
        // Re-initialize delete button handlers
        initializeDeleteButtons();
        
        // Update URL without page reload
        const newUrl = new URL(`${host}/dashboard`, window.location.origin);
        if (searchQuery && searchQuery.trim()) {
            newUrl.searchParams.set("search", searchQuery.trim());
        }
        if (page > 1) {
            newUrl.searchParams.set("page", page.toString());
        }
        window.history.pushState({ path: newUrl.toString() }, '', newUrl.toString());

    } catch (error) {
        console.error("Error fetching dashboard data:", error);
        const tableBody = document.querySelector('#agentsTableBody');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">Error loading agents. Please try again.</td>
                </tr>
            `;
        }
        if (typeof toastr !== 'undefined') {
            toastr.error("Failed to load dashboard data", { positionClass: "toast-top-right" });
        }
    }
}

// Debounced search function - resets to page 1 when searching
const debouncedSearch = debounce((searchQuery) => {
    fetchDashboardData(searchQuery.trim(), 1);
}, 500);

// Add this JavaScript code to your file
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchForm = document.getElementById('searchForm');

    // Show/hide clear button based on input value
    function toggleClearButton() {
        if (searchInput.value.trim()) {
            clearSearchBtn.classList.remove('d-none');
        } else {
            clearSearchBtn.classList.add('d-none');
        }
    }

    // Initialize clear button visibility
    toggleClearButton();

    // Handle search input with debounce
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value;
        toggleClearButton();
        // Debounce will handle trimming and resetting to page 1
        debouncedSearch(query);
    });

    // Handle clear button click - resets search and goes to page 1
    clearSearchBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        searchInput.value = '';
        toggleClearButton();
        // Reset to page 1 with no search query
        fetchDashboardData('', 1);
    });

    // Prevent form submission on Enter - use immediate search (no debounce)
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const query = searchInput.value.trim();
        // Cancel any pending debounced search
        debouncedSearch.cancel && debouncedSearch.cancel();
        // Immediate search, reset to page 1
        fetchDashboardData(query, 1);
    });

    // Handle pagination clicks (delegated event listener)
    document.addEventListener('click', function(e) {
        const paginationLink = e.target.closest('#paginationContainer a.page-link');
        if (paginationLink) {
            e.preventDefault();
            const page = parseInt(paginationLink.getAttribute('data-page') || '1');
            const currentSearchQuery = searchInput.value.trim();
            
            // Fetch dashboard data with the correct page and search query
            fetchDashboardData(currentSearchQuery, page);
        }
    });
    
    // Load initial data on page load
    const urlParams = new URLSearchParams(window.location.search);
    const initialSearch = urlParams.get('search') || '';
    const initialPage = parseInt(urlParams.get('page') || '1');
    searchInput.value = initialSearch;
    toggleClearButton();
    fetchDashboardData(initialSearch, initialPage);
    // Initialize delete buttons
    initializeDeleteButtons();
});

// Function to initialize delete button handlers
function initializeDeleteButtons() {
    // Select all delete buttons
    const deleteButtons = document.querySelectorAll('.delete-btn');
    
    // Remove existing event listeners by cloning and replacing
    deleteButtons.forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
    });
    
    // Add click event listener to each delete button
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Get agent ID and name from data attributes
            const agentId = this.getAttribute('data-agent-id');
            const agentName = this.getAttribute('data-agent-name');
            
            // Set the agent name in the modal
            document.getElementById('modal-agent-name').textContent = agentName;
            
            // Store the agent ID in the confirm delete button
            document.getElementById('confirm-delete').setAttribute('data-agent-id', agentId);
        });
    });
}
    
    

    document.getElementById('confirm-delete').addEventListener('click', function() {
        const agentId = this.getAttribute('data-agent-id');
        
        fetch(`${host}/elevenlabs/api/v1/delete_agent/?agent_id=${agentId}`, {
            method: "DELETE",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                // Close the modal
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                deleteModal.hide();
                
                // Reload dashboard data to refresh the table
                const searchQuery = document.getElementById('searchInput').value.trim();
                fetchDashboardData(searchQuery, 1);
                
                // Show success message
                if (typeof toastr !== 'undefined') {
                    toastr.success(data.message, { positionClass: "toast-top-right" });
                }
            } else {
                if (typeof toastr !== 'undefined') {
                    toastr.error(data.message || "Failed to delete agent", { positionClass: "toast-top-right" });
                }
            }
        })
        .catch(error => {
            console.error("Error:", error);
            toastr.error("An error occurred while deleting the agent", { positionClass: "toast-top-right" });
        });
    });
</script>



{% endblock %}  

